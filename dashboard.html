<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial;line-height:1.75}
    a{color:inherit;text-decoration:none}
    /* Topbar */
    .layout{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--brown);color:#fff;box-shadow:0 4px 16px rgba(62,36,32,.18);position:sticky;top:0;z-index:5}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}
    .who{opacity:.9;font-size:13px}
    /* Page */
    .page{padding:22px}
    /* Cards */
    .cards{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1100px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:650px){.cards{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:0 12px 28px rgba(62,36,32,.12);position:relative;overflow:hidden;transition:transform .2s ease, box-shadow .2s ease;cursor:pointer}
    .card:hover{transform:translateY(-4px);box-shadow:0 16px 36px rgba(62,36,32,.16)}
    .card h3{margin:0 0 8px;color:var(--brown);font-size:16px}
    .kpi{font-size:34px;font-weight:800;margin:6px 0 10px}
    .progress{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--beige);width:0%}
    .spark{position:absolute;inset:auto 10px 10px auto;font-size:12px;color:var(--muted)}
    /* Sections */
    .section{margin-top:22px}
    .section h2{margin:0 0 10px;color:var(--brown);font-size:20px}
    .grid2{display:grid;gap:14px;grid-template-columns:1.3fr .7fr}
    @media(max-width:1000px){.grid2{grid-template-columns:1fr}}
    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 6px 22px rgba(62,36,32,.10)}
    .panel .head{padding:14px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .panel .body{padding:10px 12px}
    .list{display:grid}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #f5f5f5}
    .item span.small{color:var(--muted);font-size:12px}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown)}
    /* Skeletons */
    .skeleton{position:relative;overflow:hidden;background:#f3f4f6}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(0,0,0,.04),transparent);animation:s 1.3s infinite}
    @keyframes s{100%{transform:translateX(100%)}}
    .footer{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19)}
    .link{color:var(--beige)}
  </style>
</head>
<body>
  <div class="layout">
    <header class="topbar">
      <div class="brand">
        <span class="brand-badge"></span>
        <div>
          <strong id="brandTitle">MZJ Workspace</strong>
          <div class="who" id="whois">â€¦</div>
        </div>
      </div>
      <nav class="nav">
        <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="projects.html">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
        <a href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
        <a href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </nav>
    </header>

    <main class="page">
      <!-- KPIs -->
      <section class="cards">
        <article class="card" id="card-today" title="Ù…Ù‡Ø§Ù… Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…">
          <h3>Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="kpi" id="kpi-today" aria-live="polite">0</div>
          <div class="progress"><span id="prog-today"></span></div>
          <div class="spark" id="spark-today">â€”</div>
        </article>

        <article class="card" id="card-late" title="Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©">
          <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</h3>
          <div class="kpi" id="kpi-late">0</div>
          <div class="progress"><span id="prog-late"></span></div>
          <div class="spark" id="spark-late">â€”</div>
        </article>

        <article class="card" id="card-projects" title="Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©">
          <h3>Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©</h3>
          <div class="kpi" id="kpi-projects">0</div>
          <div class="progress"><span id="prog-projects"></span></div>
          <div class="spark" id="spark-projects">â€”</div>
        </article>

        <article class="card" id="card-newreq" title="Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©">
          <h3>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <div class="kpi" id="kpi-new">0</div>
          <div class="progress"><span id="prog-new"></span></div>
          <div class="spark" id="spark-new">â€”</div>
        </article>
      </section>

      <!-- Lists -->
      <section class="grid2 section">
        <!-- My tasks -->
        <div class="panel">
          <div class="head">
            <strong>Ù…Ù‡Ø§Ù…ÙŠ</strong>
            <a class="link" id="goProjects" href="projects.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… â†—</a>
          </div>
          <div class="body">
            <div id="myTasks" class="list">
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
            </div>
          </div>
        </div>

        <!-- Team activity -->
        <div class="panel">
          <div class="head">
            <strong>Ù†Ø´Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ¬Ø¯Ø§Øª)</strong>
          </div>
          <div class="body">
            <div id="feed" class="list">
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Projects list -->
      <section class="section">
        <div class="panel">
          <div class="head">
            <strong>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong>
          </div>
          <div class="body">
            <div id="projList" class="list">
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
              <div class="item skeleton"><span>&nbsp;</span><span>&nbsp;</span></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></footer>
  </div>

  <!-- Firebase + Live Dashboard -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ğŸ”— Ø³ÙˆÙŠØªØ´Ø± Ø±ÙˆØ§Ø¨Ø· CodePen/Vercel (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§)
    const CODEPEN = {
      login:"https://codepen.io/evakkzkq-the-lessful/full/raxqmXB",
      register:"https://codepen.io/evakkzkq-the-lessful/full/raxqZod",
      dashboard:"https://codepen.io/evakkzkq-the-lessful/full/ogbaPOO",
      projects:"https://codepen.io/evakkzkq-the-lessful/full/PwZydvZ",
      members:"https://codepen.io/evakkzkq-the-lessful/full/GgoYXaJ",
      admin:"https://codepen.io/evakkzkq-the-lessful/full/EaPdeMp"
    };
    const LOCAL = {login:"login.html",register:"register.html",dashboard:"dashboard.html",projects:"projects.html",members:"members.html",admin:"admin.html"};
    const ON_VERCEL = /vercel\.app$/i.test(location.host) || (!/codepen\.io|cdpn\.io/i.test(location.host) && location.host !== '');
    const L = ON_VERCEL ? LOCAL : CODEPEN;

    // âš™ï¸ Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);

    const auth = getAuth();
    const db   = getFirestore();

    // ğŸ”’ Ø­Ø§Ø±Ø³ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    window.mzjLogout = async () => { await signOut(auth); location.href = L.login; };

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = L.login; return; }

      // Ø§Ø³Ù… ÙˆØ¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ users)
      try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");
        const u = await getDoc(doc(db,"users",user.uid));
        const name = u.exists()? (u.data().name||'Ù…Ø³ØªØ®Ø¯Ù…'): (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
        const role = u.exists()? (u.data().role||'member'): 'member';
        document.getElementById('whois').textContent = `${name} â€” ${role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ø¹Ø¶Ùˆ'}`;
      } catch {}

      // ğŸ”´ Ù…Ù‡Ù… Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡:
      // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙŠ Firestore ØªØ³Ù…Ø­ read Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘ÙÙ„:
      // match /{document=**} { allow read: if request.auth != null; }

      // === KPIs Live ===
      const kToday = document.getElementById('kpi-today'), pToday = document.getElementById('prog-today'), sToday=document.getElementById('spark-today');
      const kLate  = document.getElementById('kpi-late'),  pLate  = document.getElementById('prog-late'),  sLate =document.getElementById('spark-late');
      const kProj  = document.getElementById('kpi-projects'), pProj=document.getElementById('prog-projects'), sProj=document.getElementById('spark-projects');
      const kNew   = document.getElementById('kpi-new'), pNew=document.getElementById('prog-new'), sNew=document.getElementById('spark-new');

      const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      let allTasks = [];

      // Ù…Ù‡Ø§Ù…ÙŠ (assigneeUid = uid)
      const myTasksEl = document.getElementById('myTasks');
      const qMy = query(collection(db,'tasks'), where('assigneeUid','==', user.uid), orderBy('createdAt','desc'));
      onSnapshot(qMy, (snap)=>{
        myTasksEl.innerHTML = '';
        if (snap.empty) {
          myTasksEl.innerHTML = `<div class="item"><span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒÙ„Ù‘Ù Ø¨Ù‡Ø§.</span><span class="small">â€”</span></div>`;
          return;
        }
        snap.forEach(d=>{
          const t=d.data();
          const right = `<span class="small">${t.due||'-'}</span>`;
          const left  = `<span>${t.title||'-'} <span class="badge">${t.status||'-'}</span></span>`;
          const row = document.createElement('div'); row.className='item'; row.innerHTML = `${left}${right}`;
          myTasksEl.appendChild(row);
        });
      });

      // Ù†Ø´Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ (Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‡Ø§Ù…)
      const feedEl = document.getElementById('feed');
      const qFeed = query(collection(db,'tasks'), orderBy('createdAt','desc'));
      onSnapshot(qFeed, (snap)=>{
        feedEl.innerHTML = '';
        let i=0;
        snap.forEach(d=>{
          if (i++>=8) return;
          const t=d.data();
          const row = document.createElement('div');
          row.className='item';
          row.innerHTML = `<span>${t.title||'-'} <span class="badge">${t.status||'-'}</span></span><span class="small">${t.due||'-'}</span>`;
          feedEl.appendChild(row);
        });
      });

      // Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Ù„Ø§ÙŠÙ)
      const projList = document.getElementById('projList');
      onSnapshot(collection(db,'projects'), (snap)=>{
        projList.innerHTML = '';
        let count = 0;
        snap.forEach(d=>{
          count++;
          const p=d.data();
          const row = document.createElement('div');
          row.className='item';
          row.innerHTML = `<span>${p.name||'-'} <span class="badge">${p.department||'â€”'}</span></span><span class="small">${p.start||'â€”'}</span>`;
          projList.appendChild(row);
        });
        // KPI projects
        kProj.textContent = count; pProj.style.width = Math.min(100, count*10)+'%'; sProj.textContent = `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹`;
      });

      // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… (Ù„Ø­Ø³Ø§Ø¨ Today/Late/New KPIs)
      const qAll = query(collection(db,'tasks'), orderBy('createdAt','desc'));
      onSnapshot(qAll, (snap)=>{
        allTasks = [];
        let nToday=0, nLate=0, nNew=0;

        const now = new Date(today);
        snap.forEach(d=>{
          const t = d.data();
          allTasks.push(t);
          if (t.due === today) nToday++;
          // Ù…ØªØ£Ø®Ø±Ø© = ØªØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ù„ÙŠÙˆÙ… ÙˆÙ„Ù… ØªÙÙ†Ø¬Ø²
          if (t.due && t.status !== 'done') {
            const dd = new Date(t.due);
            if (dd < now) nLate++;
          }
          if (t.status === 'new') nNew++;
        });

        // Today
        kToday.textContent = nToday; pToday.style.width = Math.min(100,nToday*10)+'%'; sToday.textContent = today;
        // Late
        kLate.textContent  = nLate;  pLate.style.width  = Math.min(100,nLate*10)+'%';  sLate.textContent  = 'Ù‚Ø¨Ù„ Ø§Ù„ÙŠÙˆÙ…';
        // New
        kNew.textContent   = nNew;   pNew.style.width   = Math.min(100,nNew*10)+'%';   sNew.textContent   = 'status = new';
      });

      // ØªÙ†Ù‚Ù‘Ù„ Ø§Ù„ÙƒØ±ÙˆØª Ù„Ù„ØµÙØ­Ø§Øª
      document.getElementById('card-projects').onclick = ()=> location.href = L.projects;
      document.getElementById('card-today').onclick    = ()=> location.href = L.projects;
      document.getElementById('card-late').onclick     = ()=> location.href = L.projects;
      document.getElementById('card-newreq').onclick   = ()=> location.href = L.projects;

      // Ø±Ø§Ø¨Ø· Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
      document.getElementById('goProjects').href = L.projects;
    });
  </script>
</body>
</html>
