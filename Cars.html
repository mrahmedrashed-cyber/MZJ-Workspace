<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ — Production Tracker (Editor + Readonly Results)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --danger:#ef4444; --shadow:0 6px 20px rgba(0,0,0,.06) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.7}
  .container{max-width:1280px;margin:24px auto;padding:0 16px}
  .topbar{background:linear-gradient(135deg, rgba(62,36,32,.96), rgba(62,36,32,.85));color:#fff;border-radius:16px;padding:20px 18px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{width:42px;height:42px;border-radius:10px;background:var(--beige);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:inset 0 0 0 2px rgba(255,255,255,.35)}
  h1{margin:0;font-size:20px}
  .muted{color:#e8d9cf;font-size:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button,.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--beige);color:#fff}
  .btn-secondary{background:#ffffff1a;color:#fff;border:1px solid #ffffff3a}
  .btn-ghost{background:#fff;color:var(--brown);border:1px solid #ece1d9}
  .btn-danger{background:var(--danger);color:#fff}
  .panel{background:#fff;border:1px solid #f0e6df;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:14px}
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:1100px){ .grid-4{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid-4{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid #f0e6df;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .metric{display:flex;align-items:center;justify-content:space-between}
  .metric h3{margin:0;font-size:14px;color:var(--muted)}
  .metric strong{font-size:22px}
  label{font-weight:700;font-size:13px;color:var(--brown);display:block;margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e7dbd2;background:#fff;outline:none;font-size:14px}
  input:focus,select:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.18)}
  .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  @media (max-width:1100px){ .row{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  /* جداول */
  .table-soft{overflow:auto;border-radius:16px;border:1px solid #f0e6df}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:1400px;background:#fff}
  thead th{
    position:sticky;top:0;background:#fbf6f1;color:var(--brown);
    padding:12px 10px;border-bottom:1px solid #f0e6df;font-size:13px;z-index:2;text-align:right
  }
  tbody td{padding:10px;border-bottom:1px solid #f7eee7;font-size:13px;vertical-align:middle}
  tbody tr:nth-child(even){background:#fffdfa}

  /* شارات للقراءة فقط */
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #eaded6;font-weight:700;font-size:12px;background:#fff;white-space:nowrap}
  .p-green{background:#ecfdf5;border-color:#a7f3d0}
  .p-orange{background:#fff7ed;border-color:#fed7aa}
  .p-gray{background:#f3f4f6;border-color:#e5e7eb}
</style>
</head>
<body>
  <div class="container">
    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">MZJ</div>
        <div>
          <h1>لوحة متابعة إنتاج المحتوى للسيارات</h1>
          <div class="muted"> </div>
        </div>
      </div>
      <div class="actions">
        <button id="btnExportXLSX" class="btn btn-secondary">تصدير XLSX</button>
        <label class="btn btn-secondary" for="xlsxImport" style="cursor:pointer">استيراد XLSX (إضافة)</label>
        <input id="xlsxImport" type="file" accept=".xlsx" style="display:none"/>
        <button id="btnTemplate" class="btn btn-ghost">تحميل Template XLSX</button>
        <button id="btnReset" class="btn btn-danger">تفريغ البيانات</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-4 panel" style="margin-top:14px">
      <div class="card metric"><h3>إجمالي السيارات</h3><strong id="kTotal">0</strong></div>
      <div class="card metric"><h3>تم التصوير</h3><strong id="kShot">0</strong></div>
      <div class="card metric"><h3>تحت المونتاج</h3><strong id="kEditing">0</strong></div>
      <div class="card metric"><h3>داخل الأجندة</h3><strong id="kAgenda">0</strong></div>
    </div>

    <!-- إضافة سريعة + جدول التحرير -->
    <div class="panel">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">إضافة سيارة سريعة</h2>
      <div class="row">
        <div><label>العلامة</label><select id="iBrand"></select></div>
        <div><label>الموديل</label><select id="iModel" disabled></select></div>
        <div><label>السنة</label><input id="iYear" type="number" min="2015" max="2030" value="2026"></div>
        <div><label>الفئة</label><select id="iTrim"></select></div>
        <div><label>اللون الخارجي</label><input id="iColor" placeholder="مثال: أبيض لؤلؤي"></div>
        <div><label>اللون الداخلي</label><input id="iIntColor" placeholder="مثال: جلد بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Status – تصوير</label><select id="iShoot"></select></div>
        <div><label>Status – مونتاج</label><select id="iEdit"></select></div>
        <div><label>نوع المحتوى</label><select id="iType"></select></div>
        <div><label>تاريخ التصوير</label><input id="iShootDate" type="date"></div>
        <div><label>داخل الأجندة؟</label><select id="iInAgenda"></select></div>
        <div id="agendaFields" class="hidden">
          <label>تاريخ الأجندة</label>
          <div style="display:flex;gap:8px">
            <select id="iAgendaMonth"></select>
            <input id="iAgendaYear" type="number" min="2020" max="2035" value="">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>مرفوع على الموقع؟</label><select id="iOnSite"></select></div>
        <div id="siteLinkField" class="hidden" style="grid-column: span 2">
          <label>رابط صفحة السيارة (اختياري)</label>
          <input id="iSiteLink" placeholder="https://mzjcars.com/...">
        </div>
        <div style="grid-column: span 2"><label>ملاحظات</label><input id="iNotes" placeholder="مثلاً: ينتظر مراجعة SEO / صور ناقصة"></div>
        <div><label>&nbsp;</label><button id="btnAdd" class="btn btn-primary" style="width:100%">إضافة</button></div>
      </div>
      <div class="muted" style="margin-top:6px">* الحفظ تلقائي. الاستيراد XLSX يضيف على الموجود.</div>
    </div>

    <div class="panel table-soft" style="padding:0">
      <table id="carsTable">
        <thead>
          <tr>
            <th>العلامة</th><th>الموديل</th><th>السنة</th><th>الفئة</th>
            <th>اللون الخارجي</th><th>اللون الداخلي</th>
            <th>تصوير</th><th>مونتاج</th><th>نوع المحتوى</th>
            <th>تاريخ التصوير</th><th>داخل الأجندة؟</th><th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th><th>رابط الصفحة</th><th>ملاحظات</th><th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- الفلاتر + نتيجة الفلتر (عرض فقط) -->
    <div class="panel">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">نتيجة الفلتر (عرض فقط)</h2>
      <div class="row">
        <div><label>العلامة</label><select id="dBrand"><option value="">الكل</option></select></div>
        <div><label>الفئة</label><select id="dTrim"><option value="">الكل</option></select></div>
        <div><label>تصوير</label><select id="dShoot"><option value="">الكل</option></select></div>
        <div><label>مونتاج</label><select id="dEdit"><option value="">الكل</option></select></div>
        <div><label>اللون الخارجي</label><input id="dColor" placeholder="مثال: أبيض"></div>
        <div><label>اللون الداخلي</label><input id="dIntColor" placeholder="مثال: بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>داخل الأجندة؟</label><select id="dAgenda"><option value="">الكل</option></select></div>
        <div style="grid-column: span 5"><label>بحث نصّي</label><input id="dSearch" placeholder="ابحث في الموديل/الملاحظات/الألوان"></div>
      </div>
    </div>

    <div class="panel table-soft" style="padding:0;margin-top:8px">
      <table id="filteredTable">
        <thead>
          <tr>
            <th>العلامة</th>
            <th>الموديل</th>
            <th>السنة</th>
            <th>الفئة</th>
            <th>اللون الخارجي</th>
            <th>اللون الداخلي</th>
            <th>تصوير</th>
            <th>مونتاج</th>
            <th>نوع المحتوى</th>
            <th>تاريخ التصوير</th>
            <th>داخل الأجندة؟</th>
            <th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th>
            <th>رابط الصفحة</th>
            <th>ملاحظات</th>
          </tr>
        </thead>
        <tbody id="filteredTBody"></tbody>
      </table>
      <div class="muted" id="flatMeta" style="padding:10px"></div>
    </div>
  </div>

<script>
/* ===== البيانات الأساسية ===== */
const BRANDS = ["هيونداي","شانجان","شيري","فورد","ام جي","نيسان"];
const MODELS_BY_BRAND = {
  "هيونداي": ["سوناتا","النترا","اكسنت","جراند i10","كريتا","جراند كريتا","ستار جيزر","فينيو","ازيرا","سنتافي","توسان","كونا","ستاريا","بالسييد"],
  "شانجان": ["سي اس 75","سي اس 35","ايدو بلس","ال سيفن","يوني كي","يوني تي","يوني في","سي اس 95","يوني اس","هانتر اب"],
  "شيري": ["تيجو 2 برو","اريزو 8","اريزو 6 برو","اريزو 5 برو","أكسييد ال اكس","تيجو 8 برة","تيجو 7","تيجو 4 برو"],
  "فورد": ["رينجر","اكسبلور","تيريتوري","تورس"],
  "ام جي": ["جي تي","ام جي 3","ام جي 7","ام جي 5","اتش أس","ار اكس 5","ون","زد أس","تي 60","ار أكس 9","وال","ار أكس 8"],
  "نيسان": ["اكس تريل","ماجنايت","كيكس","صني","اكس تيرا","التيما"]
};
const TRIMS  = ["ستاندر","سمارت","سمارت بلس","كومفورت","فل كامل","ترند","امبيانتي","رويـال"];
const SHOOT_STATUS = ["لم يُصوّر","تم التصوير","بانتظار مراجعة"];
const EDIT_STATUS  = ["لم يبدأ","جاري","تم الانتهاء"];
const CONTENT_TYPES = ["صور","فيديو","ريل","موشن","AI"];
const YESNO = ["لا","نعم"];
const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

const LS_KEY = "mzj-cars-tracker";
let rows = loadRows() ?? sampleSeed();
let filters = {brand:"", trim:"", shoot:"", edit:"", color:"", intColor:"", agenda:"", q:""};

/* ===== Helpers ===== */
const $ = s=>document.querySelector(s);
function $fill(el, arr, withBlank=false, blankLabel="الكل"){
  el.innerHTML = withBlank ? `<option value="">${blankLabel}</option>` : "";
  arr.forEach(v=>{ const o=document.createElement("option"); o.value=v;o.textContent=v; el.appendChild(o); });
}
function $fillStrict(el, arr, withBlank=false){
  el.innerHTML = withBlank ? `<option value="">— اختر —</option>` : "";
  arr.forEach(v=>{ const o=document.createElement("option"); o.value=v;o.textContent=v; el.appendChild(o); });
}
function escapeHTML(s){ return (s+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

/* ===== تهيئة حقول الإضافة ===== */
$fillStrict($("#iBrand"), BRANDS, true);
$fillStrict($("#iTrim"), TRIMS);
$fillStrict($("#iShoot"), SHOOT_STATUS);
$fillStrict($("#iEdit"), EDIT_STATUS);
$fillStrict($("#iType"), CONTENT_TYPES);
$fillStrict($("#iInAgenda"), YESNO);
$fillStrict($("#iOnSite"), YESNO);
$fillStrict($("#iAgendaMonth"), MONTHS);
$("#iAgendaYear").value = new Date().getFullYear();

function refreshAddModels(){
  const b = $("#iBrand").value;
  const models = MODELS_BY_BRAND[b] || [];
  $("#iModel").disabled = models.length===0;
  $fillStrict($("#iModel"), models, true);
}
$("#iBrand").addEventListener("change", refreshAddModels);
refreshAddModels();

/* ===== فلاتر نتيجة العرض فقط ===== */
$fill($("#dBrand"), BRANDS, true, "الكل");
$fill($("#dTrim"), TRIMS, true, "الكل");
$fill($("#dShoot"), SHOOT_STATUS, true, "الكل");
$fill($("#dEdit"), EDIT_STATUS, true, "الكل");
$fill($("#dAgenda"), YESNO, true, "الكل");

/* ===== حقول شرطية بالإضافة ===== */
$("#iInAgenda").addEventListener("change", ()=>$("#agendaFields").classList.toggle("hidden", $("#iInAgenda").value!=="نعم"));
$("#iOnSite").addEventListener("change", ()=>$("#siteLinkField").classList.toggle("hidden", $("#iOnSite").value!=="نعم"));
$("#agendaFields").classList.toggle("hidden", $("#iInAgenda").value!=="نعم");
$("#siteLinkField").classList.toggle("hidden", $("#iOnSite").value!=="نعم");

/* ===== جدول التحرير ===== */
function textCell(key,val,idx){ return `<input data-idx="${idx}" data-key="${key}" value="${escapeHTML(val??'')}" />` }
function numberCell(key,val,idx){ return `<input type="number" data-idx="${idx}" data-key="${key}" value="${escapeHTML(val??'')}" style="width:110px"/>` }
function dateCell(key,val,idx){ return `<input type="date" data-idx="${idx}" data-key="${key}" value="${val??''}" style="width:150px"/>` }
function linkCell(key,val,idx,label){
  const safe = val? escapeHTML(val):"";
  return `<div style="display:flex;gap:6px;align-items:center">
      <input data-idx="${idx}" data-key="${key}" value="${safe}" placeholder="https://..." style="min-width:220px"/>
      ${val?`<a class="btn btn-ghost" href="${safe}" target="_blank" rel="noopener">فتح ${label}</a>`:""}
    </div>`;
}
function selectCell(key, arr, val, idx, dataType){
  const options = arr.map(v=>`<option ${v===val?'selected':''} value="${v}">${v}</option>`).join("");
  const dt = dataType?`data-type="${dataType}"`:"";
  return `<select data-idx="${idx}" data-key="${key}" ${dt}>${options}</select>`;
}
function modelCell(key, val, brand, idx){
  const models = MODELS_BY_BRAND[brand] || [];
  const opts = [...models];
  if(val && !opts.includes(val)) opts.unshift(val);
  return `<select data-idx="${idx}" data-key="${key}" data-type="model">
    ${opts.map(v=>`<option ${v===val?'selected':''} value="${v}">${v}</option>`).join("")}
  </select>`;
}

function renderEditor(){
  const tb = $("#tbody"); tb.innerHTML = "";
  rows.forEach((r,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${selectCell("brand", BRANDS, r.brand, idx, 'brand')}</td>
      <td>${modelCell("model", r.model, r.brand, idx)}</td>
      <td>${numberCell("year", r.year, idx)}</td>
      <td>${selectCell("trim", TRIMS, r.trim, idx)}</td>
      <td>${textCell("color", r.color??"", idx)}</td>
      <td>${textCell("intColor", r.intColor??"", idx)}</td>
      <td>${selectCell("shoot", SHOOT_STATUS, r.shoot, idx)}</td>
      <td>${selectCell("edit", EDIT_STATUS, r.edit, idx)}</td>
      <td>${selectCell("ctype", CONTENT_TYPES, r.ctype, idx)}</td>
      <td>${dateCell("shootDate", r.shootDate, idx)}</td>
      <td>${selectCell("inAgenda", YESNO, r.inAgenda, idx)}</td>
      <td>${textCell("agendaDate", r.agendaDate??"", idx)}</td>
      <td>${selectCell("onSite", YESNO, r.onSite, idx)}</td>
      <td>${linkCell("siteLink", r.siteLink||"", idx, "Page")}</td>
      <td>${textCell("notes", r.notes??"", idx)}</td>
      <td>
        <button class="btn btn-ghost" data-action="dup" data-idx="${idx}">نسخ</button>
        <button class="btn btn-danger" data-action="del" data-idx="${idx}">حذف</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== نتيجة الفلتر (عرض فقط) ===== */
function badgePill(val, kind){
  const cls = kind==="green"?"p-green":kind==="orange"?"p-orange":"p-gray";
  return `<span class="pill ${cls}">${escapeHTML(val)}</span>`;
}
function currentListReadonly(){
  return rows.filter(r=>{
    if(filters.brand && r.brand!==filters.brand) return false;
    if(filters.trim && r.trim!==filters.trim) return false;
    if(filters.shoot && r.shoot!==filters.shoot) return false;
    if(filters.edit && r.edit!==filters.edit) return false;
    if(filters.color && !(r.color||"").toLowerCase().includes(filters.color.toLowerCase())) return false;
    if(filters.intColor && !(r.intColor||"").toLowerCase().includes(filters.intColor.toLowerCase())) return false;
    if(filters.agenda && r.inAgenda!==filters.agenda) return false;
    if(filters.q){
      const q = filters.q.trim().toLowerCase();
      const hay = `${r.brand} ${r.model} ${r.trim} ${r.color||""} ${r.intColor||""} ${r.notes||""}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}
function renderFilteredTable(){
  const list = currentListReadonly();
  const tb = $("#filteredTBody");
  tb.innerHTML = "";
  if(!list.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="15" style="padding:14px">لا توجد نتائج مطابقة.</td>`;
    tb.appendChild(tr);
  } else {
    list.forEach(r=>{
      const shootP = r.shoot==="تم التصوير" ? badgePill(r.shoot,"green") :
                     r.shoot==="بانتظار مراجعة" ? badgePill(r.shoot,"orange") : badgePill(r.shoot,"gray");
      const editP  = r.edit==="تم الانتهاء" ? badgePill(r.edit,"green") :
                     r.edit==="جاري" ? badgePill(r.edit,"orange") : badgePill(r.edit,"gray");
      const agendaP= r.inAgenda==="نعم" ? badgePill("نعم","green") : badgePill("لا","gray");
      const siteP  = r.onSite==="نعم" ? badgePill("نعم","green") : badgePill("لا","gray");
      const link   = (r.onSite==="نعم" && r.siteLink) ? `<a href="${escapeHTML(r.siteLink)}" target="_blank" rel="noopener">${escapeHTML(r.siteLink)}</a>` : "—";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(r.brand||"—")}</td>
        <td>${escapeHTML(r.model||"—")}</td>
        <td>${escapeHTML(r.year||"—")}</td>
        <td>${escapeHTML(r.trim||"—")}</td>
        <td>${escapeHTML(r.color||"—")}</td>
        <td>${escapeHTML(r.intColor||"—")}</td>
        <td>${shootP}</td>
        <td>${editP}</td>
        <td>${escapeHTML(r.ctype||"—")}</td>
        <td>${escapeHTML(r.shootDate||"—")}</td>
        <td>${agendaP}</td>
        <td>${escapeHTML(r.agendaDate||"—")}</td>
        <td>${siteP}</td>
        <td>${link}</td>
        <td>${escapeHTML(r.notes||"—")}</td>
      `;
      tb.appendChild(tr);
    });
  }
  $("#flatMeta").textContent = `${list.length} نتيجة — عرض فقط (بدون تعديل)`;
}

/* ===== KPIs ===== */
function updateKPIs(){
  $("#kTotal").textContent   = rows.length;
  $("#kShot").textContent    = rows.filter(r=>r.shoot==="تم التصوير").length;
  $("#kEditing").textContent = rows.filter(r=>r.edit==="جاري").length;
  $("#kAgenda").textContent  = rows.filter(r=>r.inAgenda==="نعم").length;
}

/* ===== أحداث ===== */
document.addEventListener("change", e=>{
  const t = e.target;

  // فلاتر العرض فقط (لا تعدّل البيانات)
  if(t.matches("#dBrand,#dTrim,#dShoot,#dEdit,#dAgenda")){
    filters.brand = $("#dBrand").value;
    filters.trim  = $("#dTrim").value;
    filters.shoot = $("#dShoot").value;
    filters.edit  = $("#dEdit").value;
    filters.agenda= $("#dAgenda").value;
    renderFilteredTable();
  }

  // تغييرات جدول التحرير
  if(t.matches("select[data-idx], input[data-idx]") && !t.closest("#filteredTable")){
    const idx = +t.dataset.idx; const key = t.dataset.key; const val = t.value;
    if(Number.isInteger(idx) && rows[idx]){
      rows[idx][key] = val;
      if(key==="brand"){
        const allowed = MODELS_BY_BRAND[val] || [];
        if(!allowed.includes(rows[idx].model)){ rows[idx].model = allowed[0] || ""; }
      }
      saveRows(); updateKPIs(); renderEditor(); renderFilteredTable();
    }
  }
});
document.addEventListener("input", e=>{
  const t = e.target;
  if(t.id==="dSearch"){ filters.q = t.value; renderFilteredTable(); }
  if(t.id==="dColor"){ filters.color = t.value; renderFilteredTable(); }
  if(t.id==="dIntColor"){ filters.intColor = t.value; renderFilteredTable(); }
});

document.addEventListener("click", e=>{
  const btn = e.target.closest("button"); if(!btn) return;
  if(btn.id==="btnAdd"){ addQuick(); }
  if(btn.id==="btnExportXLSX"){ exportXLSX(); }
  if(btn.id==="btnTemplate"){ downloadTemplate(); }
  if(btn.id==="btnReset"){ if(confirm("مسح كل البيانات؟")){ rows=[]; saveRows(); updateKPIs(); renderEditor(); renderFilteredTable(); } }
  if(btn.dataset.action==="del"){ rows.splice(+btn.dataset.idx,1); saveRows(); updateKPIs(); renderEditor(); renderFilteredTable(); }
  if(btn.dataset.action==="dup"){ rows.splice(+btn.dataset.idx,0, JSON.parse(JSON.stringify(rows[+btn.dataset.idx])) ); saveRows(); updateKPIs(); renderEditor(); renderFilteredTable(); }
});

$("#xlsxImport").addEventListener("change", onImportXLSX);

/* ===== إضافة سريعة ===== */
function addQuick(){
  const agendaMonth = $("#iAgendaMonth").value; 
  const agendaYear  = ($("#iAgendaYear").value||"").trim();
  const agendaDate  = ($("#iInAgenda").value==="نعم" && agendaMonth && agendaYear) ? `${agendaMonth} ${agendaYear}` : "";

  const r = {
    brand: $("#iBrand").value || "",
    model: $("#iModel").value || "",
    year:  +($("#iYear").value || 2026),
    trim:  $("#iTrim").value || TRIMS[0],
    color: ($("#iColor").value || "").trim(),
    intColor: ($("#iIntColor").value || "").trim(),
    shoot: $("#iShoot").value || SHOOT_STATUS[0],
    edit:  $("#iEdit").value || EDIT_STATUS[0],
    ctype: $("#iType").value || CONTENT_TYPES[0],
    shootDate: $("#iShootDate").value || "",
    inAgenda: $("#iInAgenda").value || "لا",
    agendaDate,
    onSite: $("#iOnSite").value || "لا",
    siteLink: ($("#iOnSite").value==="نعم" ? ($("#iSiteLink").value||"") : ""),
    notes: $("#iNotes").value || ""
  };
  rows.unshift(r); saveRows();
  ["iModel","iColor","iIntColor","iNotes","iShootDate","iSiteLink"].forEach(id=>$("#"+id).value="");
  $("#iInAgenda").value = "لا"; $("#agendaFields").classList.add("hidden");
  $("#iOnSite").value = "لا"; $("#siteLinkField").classList.add("hidden");
  updateKPIs(); renderEditor(); renderFilteredTable();
}

/* ===== XLSX I/O ===== */
function xlsxHeaders(){ return ["brand","model","year","trim","color","intColor","shoot","edit","ctype","shootDate","inAgenda","agendaDate","onSite","siteLink","notes"]; }
function exportXLSX(){
  const headers = xlsxHeaders();
  const data = rows.map(r=>{ const o={}; headers.forEach(h=>o[h]=r[h]??""); return o; });
  const ws = XLSX.utils.json_to_sheet(data, {header: headers});
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "MZJ Cars");
  XLSX.writeFile(wb, "mzj-production-tracker.xlsx");
}
function onImportXLSX(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = (evt)=>{
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type: "array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:""});
    if(!json.length){ alert("الملف فارغ."); return; }
    const req = xlsxHeaders(); const cols = Object.keys(json[0]||{});
    const ok = req.every(h=>cols.includes(h));
    if(!ok){ alert("صيغة XLSX غير مطابقة. حمّل الـTemplate أعلاه."); return; }
    const imported = json.map(row=>{ const o={}; req.forEach(h=>o[h]=row[h]??""); o.year=+o.year||2026; return o; });
    rows = rows.concat(imported); saveRows(); updateKPIs(); renderEditor(); renderFilteredTable();
    alert(`تم استيراد ${imported.length} سيارة (إضافة).`);
  };
  reader.readAsArrayBuffer(file);
}
function downloadTemplate(){
  const headers = xlsxHeaders();
  const sample = [{
    brand:"هيونداي", model:"سوناتا", year:2026, trim:"سمارت",
    color:"أبيض لؤلؤي", intColor:"أسود", shoot:"تم التصوير", edit:"جاري",
    ctype:"ريل", shootDate:"2025-10-12", inAgenda:"نعم", agendaDate:"أكتوبر 2025",
    onSite:"لا", siteLink:"", notes:"مثال: ينتظر فويس"
  }];
  const ws = XLSX.utils.json_to_sheet(sample, {header: headers});
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "mzj-quick-add-template.xlsx");
}

/* ===== تخزين محلي + بيانات مثال ===== */
function saveRows(){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); }
function loadRows(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch(e){ return null; } }
function sampleSeed(){
  return [
    {brand:"هيونداي",model:"سوناتا",year:2026,trim:"سمارت",color:"أبيض لؤلؤي",intColor:"أسود",shoot:"تم التصوير",edit:"جاري",ctype:"ريل",shootDate:"2025-10-12",inAgenda:"نعم",agendaDate:"أكتوبر 2025",onSite:"لا",siteLink:"",notes:"بانتظار فويس سعودي"},
    {brand:"نيسان",model:"اكس تريل",year:2025,trim:"ستاندر",color:"رمادي",intColor:"بيج",shoot:"لم يُصوّر",edit:"لم يبدأ",ctype:"صور",shootDate:"",inAgenda:"لا",agendaDate:"",onSite:"لا",siteLink:"",notes:"أولوية عالية"},
    {brand:"فورد",model:"تيريتوري",year:2026,trim:"ترند",color:"أسود",intColor:"جلد بيج",shoot:"تم التصوير",edit:"تم الانتهاء",ctype:"فيديو",shootDate:"2025-09-28",inAgenda:"نعم",agendaDate:"أكتوبر 2025",onSite:"نعم",siteLink:"https://mzjcars.com/ford-territory-trend-2026",notes:"جاهز للموقع"}
  ];
}

/* ===== تشغيل أولي ===== */
function boot(){ updateKPIs(); renderEditor(); renderFilteredTable(); }
boot();
</script>
</body>
</html>
