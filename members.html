<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial;line-height:1.75}
    a{color:inherit;text-decoration:none}
    .layout{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--brown);color:#fff;box-shadow:0 4px 16px rgba(62,36,32,.18)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}

    .page{padding:20px;display:grid;gap:16px}

    /* Stats cards */
    .cards{display:grid;gap:14px;grid-template-columns:repeat(3,1fr)}
    @media(max-width:900px){.cards{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 10px 24px rgba(62,36,32,.12)}
    .card h3{margin:0 0 6px;color:var(--brown);font-size:16px}
    .kpi{font-size:32px;font-weight:800;margin:4px 0 8px}
    .progress{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--beige);width:0%}

    /* Tools */
    .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input, .select{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}

    /* Grid/list */
    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 8px 26px rgba(62,36,32,.10)}
    .panel .head{padding:14px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .panel .body{padding:10px 12px}
    .list{display:grid}
    .row{display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr .8fr;gap:10px;align-items:center;padding:10px 8px;border-bottom:1px solid #f5f5f5}
    @media(max-width:1100px){.row{grid-template-columns:1.2fr .8fr .8fr 1fr}}
    @media(max-width:700px){.row{grid-template-columns:1fr;gap:6px}}
    .row.head{font-weight:800;color:var(--brown);background:#fff8ef;border-top-left-radius:14px;border-top-right-radius:14px}
    .muted{color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);justify-self:start}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .mini.primary{background:var(--brown);border-color:var(--brown);color:#fff}
    .uid{direction:ltr;font-family:monospace;font-size:12px;background:#f8fafc;border:1px dashed #e5e7eb;padding:2px 6px;border-radius:8px}

    /* Admin form */
    .grid2{display:grid;grid-template-columns:1fr .8fr;gap:14px}
    @media(max-width:1100px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:8px 0 6px;font-weight:700;color:var(--brown)}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    input:focus,select:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}
    .footer{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19)}
  </style>
</head>
<body>
  <div class="layout">
    <header class="topbar">
      <div class="brand">
        <span class="brand-badge"></span>
        <strong>MZJ Workspace â€” Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</strong>
      </div>
      <nav class="nav">
        <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="projects.html">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
        <a href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
        <a href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </nav>
    </header>

    <main class="page">
      <!-- KPIs -->
      <section class="cards">
        <article class="card">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
          <div class="kpi" id="kpi-total">0</div>
          <div class="progress"><span id="prog-total"></span></div>
        </article>
        <article class="card">
          <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h3>
          <div class="kpi" id="kpi-admins">0</div>
          <div class="progress"><span id="prog-admins"></span></div>
        </article>
        <article class="card">
          <h3>Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</h3>
          <div class="kpi" id="kpi-active">0</div>
          <div class="progress"><span id="prog-active"></span></div>
        </article>
      </section>

      <!-- Tools -->
      <section class="panel">
        <div class="head">
          <div class="tools">
            <input id="search" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆâ€¦"/>
            <select id="roleFilter" class="select">
              <option value="">ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</option>
              <option value="admin">Ù…Ø¯ÙŠØ±</option>
              <option value="member">Ø¹Ø¶Ùˆ</option>
            </select>
            <button class="btn secondary" id="btnClear">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          </div>
          <div id="who" class="muted"></div>
        </div>
        <div class="body">
          <div class="list" id="membersList">
            <div class="row head">
              <div>Ø§Ù„Ø§Ø³Ù…</div>
              <div>Ø§Ù„Ø¯ÙˆØ±</div>
              <div>Ø§Ù„Ø­Ø§Ù„Ø©</div>
              <div>UID</div>
              <div>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
            </div>
            <!-- rows injected -->
          </div>
        </div>
      </section>

      <!-- Admin-only form -->
      <section class="grid2">
        <div class="panel">
          <div class="head"><strong>ØªØ¹Ø¯ÙŠÙ„/Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ (Directory)</strong><span class="muted">Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·</span></div>
          <div class="body">
            <label>UID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† Authentication)</label>
            <input id="fUid" placeholder="Ø§Ù„ØµÙ‚ UID Ù‡Ù†Ø§ â€” Ù…Ø«Ø§Ù„: A1Eoc...Mf2">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input id="fName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ â€” Ù…Ø«Ø§Ù„: Ahmed Naji">
            <label>Ø§Ù„Ø¯ÙˆØ±</label>
            <select id="fRole">
              <option value="member">Ø¹Ø¶Ùˆ</option>
              <option value="admin">Ù…Ø¯ÙŠØ±</option>
            </select>
            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fActive">
              <option value="true" selected>Ù†Ø´Ø·</option>
              <option value="false">Ù…ÙˆÙ‚Ù‘Ù</option>
            </select>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" id="btnUpsert">Ø­ÙØ¸</button>
              <button class="btn secondary" id="btnFormReset">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
              <span class="muted">Ù…Ù‡Ù…: Ù‡Ø°Ø§ ÙŠØ­Ø¯Ù‘Ø« Ù…Ø³ØªÙ†Ø¯ <code>users/{uid}</code>. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØªÙ… Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</span>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="head"><strong>Ø¯Ø¹ÙˆØ© Ø¹Ø¶Ùˆ</strong><span class="muted">Ø®Ø·ÙˆØ© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</span></div>
          <div class="body">
            <p class="muted">Ø§Ø¨Ø¹Ø« Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø¯Ø¹Ùˆ Ù„Ù„ØªØ³Ø¬ÙŠÙ„:</p>
            <div class="actions" style="margin:8px 0">
              <button class="mini primary" id="btnCopyRegister">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <span id="regInfo" class="muted"></span>
            </div>
            <p class="muted">Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ³Ø¬Ù‘Ù„ØŒ Ø§Ù†Ø³Ø® UID Ù…Ù† Authentication ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø«Ù… Ø§Ø¶ØºØ· "Ø­ÙØ¸".</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></footer>
  </div>

  <!-- Firebase + Members Directory -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, doc, setDoc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ğŸ”— Ø³ÙˆÙŠØªØ´Ø± Ø±ÙˆØ§Ø¨Ø· (Vercel / CodePen)
    const CODEPEN = {
      login:"https://codepen.io/evakkzkq-the-lessful/full/raxqmXB",
      register:"https://codepen.io/evakkzkq-the-lessful/full/raxqZod",
      dashboard:"https://codepen.io/evakkzkq-the-lessful/full/ogbaPOO",
      projects:"https://codepen.io/evakkzkq-the-lessful/full/PwZydvZ",
      members:"https://codepen.io/evakkzkq-the-lessful/full/GgoYXaJ",
      admin:"https://codepen.io/evakkzkq-the-lessful/full/EaPdeMp"
    };
    const LOCAL = {login:"login.html",register:"register.html",dashboard:"dashboard.html",projects:"projects.html",members:"members.html",admin:"admin.html"};
    const ON_VERCEL = /vercel\.app$/i.test(location.host) || (!/codepen\.io|cdpn\.io/i.test(location.host) && location.host !== '');
    const L = ON_VERCEL ? LOCAL : CODEPEN;

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    // Ø­Ø§Ø±Ø³ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    window.mzjLogout = async ()=>{ await signOut(auth); location.href = L.login; };
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { location.href = L.login; return; }
      try {
        const u = await getDoc(doc(db,"users", user.uid));
        const name = u.exists()? (u.data().name||user.email): (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
        const role = u.exists()? (u.data().role||'member'): 'member';
        document.getElementById('who').textContent = `${name} â€” ${role==='admin'?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;
        // Ø§Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ùˆ Ù…Ø´ Ù…Ø¯ÙŠØ±
        if (role !== 'admin') {
          document.querySelectorAll('.grid2 .panel')[0].style.display = 'none';
        }
      } catch {}
    });

    // KPI helpers
    function setKpi(idNum, idProg, n, max=10){
      document.getElementById(idNum).textContent = n;
      document.getElementById(idProg).style.width = Math.min(100, (n/max)*100) + '%';
    }

    // ==== Live Members ====
    const membersEl = document.getElementById('membersList');
    const searchEl  = document.getElementById('search');
    const roleEl    = document.getElementById('roleFilter');
    const btnClear  = document.getElementById('btnClear');

    let MEMBERS = []; // [{uid,name,role,active}]
    function render(){
      // remove old rows (keep header)
      [...membersEl.querySelectorAll('.row:not(.head)')].forEach(n=>n.remove());

      const q = (searchEl.value||'').toLowerCase().trim();
      const rf = roleEl.value||'';

      const filtered = MEMBERS.filter(m=>{
        const okQ = !q || (m.name?.toLowerCase().includes(q));
        const okR = !rf || (m.role===rf);
        return okQ && okR;
      });

      filtered.forEach(m=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div><strong>${m.name||'â€”'}</strong> <span class="muted">${m.email||''}</span></div>
          <div>
            <span class="badge" data-role>${m.role||'member'}</span>
          </div>
          <div>${m.active===false?'<span class="muted">Ù…ÙˆÙ‚Ù‘Ù</span>':'Ù†Ø´Ø·'}</div>
          <div><span class="uid" title="Ø§Ù†Ø³Ø® UID">${m.uid}</span></div>
          <div class="actions">
            <button class="mini" data-copy>Ù†Ø³Ø® UID</button>
            <button class="mini primary" data-toggle>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±</button>
            <button class="mini" data-toggleActive>${m.active===false?'ØªÙØ¹ÙŠÙ„':'Ø¥ÙŠÙ‚Ø§Ù'}</button>
          </div>
        `;
        // actions
        row.querySelector('[data-copy]').onclick = ()=> navigator.clipboard?.writeText(m.uid);
        row.querySelector('[data-toggle]').onclick = ()=> toggleRole(m.uid, m.role);
        row.querySelector('[data-toggleActive]').onclick = ()=> toggleActive(m.uid, m.active===false);
        membersEl.appendChild(row);
      });

      // KPIs
      const total = MEMBERS.length;
      const admins = MEMBERS.filter(m=>m.role==='admin').length;
      const active = MEMBERS.filter(m=>m.active!==false).length;
      setKpi('kpi-total','prog-total', total, Math.max(10,total));
      setKpi('kpi-admins','prog-admins', admins, Math.max(5,admins||5));
      setKpi('kpi-active','prog-active', active, Math.max(10,active||10));
    }

    onSnapshot(collection(db, 'users'), (snap)=>{
      MEMBERS = [];
      snap.forEach(d=>{
        const u = d.data()||{};
        MEMBERS.push({
          uid: d.id,
          name: u.name || d.id.slice(0,6),
          role: u.role || 'member',
          email: u.email || '',
          active: u.active !== false // default true
        });
      });
      render();
    }, (err)=>{
      console.error(err);
      alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore (read Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ†).');
    });

    searchEl.addEventListener('input', render);
    roleEl.addEventListener('change', render);
    btnClear.addEventListener('click', ()=>{
      searchEl.value=''; roleEl.value=''; render();
    });

    // ==== Role & Active updates (Admin only; Rules must allow it) ====
    async function toggleRole(uid, currentRole){
      const newRole = currentRole==='admin' ? 'member' : 'admin';
      try{
        await updateDoc(doc(db,'users', uid), { role: newRole });
      }catch(e){
        console.error(e);
        alert('âš ï¸ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±. Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
      }
    }
    async function toggleActive(uid, willBeActive){
      try{
        await updateDoc(doc(db,'users', uid), { active: willBeActive });
      }catch(e){
        console.error(e);
        alert('âš ï¸ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©. Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
      }
    }

    // ==== Admin directory upsert ====
    const fUid = document.getElementById('fUid');
    const fName= document.getElementById('fName');
    const fRole= document.getElementById('fRole');
    const fActive = document.getElementById('fActive');
    document.getElementById('btnUpsert').addEventListener('click', async ()=>{
      const uid = (fUid.value||'').trim();
      if (!uid) { alert('Ø§ÙƒØªØ¨ UID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Authentication'); return; }
      const payload = {
        name: (fName.value||'').trim() || uid.slice(0,6),
        role: fRole.value,
        active: fActive.value === 'true'
      };
      try{
        await setDoc(doc(db,'users', uid), payload, { merge: true });
        alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡');
      }catch(e){
        console.error(e);
        alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Firestore.');
      }
    });
    document.getElementById('btnFormReset').addEventListener('click', ()=>{
      fUid.value=''; fName.value=''; fRole.value='member'; fActive.value='true';
    });

    // ==== Invite helper ====
    document.getElementById('btnCopyRegister').addEventListener('click', ()=>{
      const url = L.register;
      navigator.clipboard?.writeText(url);
      const info = document.getElementById('regInfo');
      info.textContent = 'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ…';
      setTimeout(()=> info.textContent='', 2000);
    });
  </script>
</body>
</html>
