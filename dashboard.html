
<!DOCTYPE html>
<html dir="rtl" lang="ar"><head><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<meta content="light" name="color-scheme"/>
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Unified UI -->
<link href="./mzj-ui.css" rel="stylesheet"/>
<style id="noFlash">html{background:#fff8ef} body{background:#fff8ef}</style>
<style>
/* ===== Campaigns (Admin) â€” scoped to .camp ===== */
.camp{ display:block; }
.camp .camp-controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.camp .camp-select,.camp .camp-input{
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--card);
  font-family:inherit;
}
.camp .camp-btn{
  padding:10px 12px;
  border-radius:12px;
  border:0;
  background:var(--brown);
  color:#fff;
  cursor:pointer;
  font-weight:800;
}
.camp .camp-btn.secondary{
  background:transparent;
  color:var(--brown);
  border:1px solid var(--brown);
}
.camp .camp-btn.danger{ background:#b91c1c; color:#fff; }
.camp .camp-muted{ color:var(--muted); }
.camp .board{ display:grid; gap:14px; grid-template-columns:repeat(4,1fr); }
@media(max-width:1400px){ .camp .board{ grid-template-columns:repeat(3,1fr);} }
@media(max-width:980px){ .camp .board{ grid-template-columns:repeat(2,1fr);} }
@media(max-width:640px){ .camp .board{ grid-template-columns:1fr;} }

.camp .col{
  background:var(--card);
  border-radius:14px;
  display:flex;
  flex-direction:column;
  min-height:260px;
  position:relative;
  border:1px solid rgba(231,229,228,.8);
}
body.mzj.dark .camp .col{ border-color: rgba(255,255,255,.10); }

.camp .col-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  border-bottom:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  border-top-left-radius:14px;
  border-top-right-radius:14px;
}
body.mzj.dark .camp .col-head{
  background: rgba(255,255,255,.06);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.camp .col-title{ color:var(--brown); font-weight:800; }
.camp .col-actions{ display:flex; gap:6px; }
.camp .col-actions .icon{
  cursor:pointer;
  font-size:13px;
  padding:6px 8px;
  border:1px solid #e9d8cc;
  border-radius:10px;
  background:#fff;
}
body.mzj.dark .camp .col-actions .icon{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
  color: var(--text);
}
.camp .col-body{ padding:10px; display:grid; gap:10px; }
.camp .dropzone{
  min-height:140px;
  border:2px dashed transparent;
  border-radius:12px;
  transition:.15s;
}
.camp .dropzone.drag{
  border-color:#e5d2c6;
  background:#fffaf5;
}
body.mzj.dark .camp .dropzone.drag{
  background: rgba(255,255,255,.06);
  border-color: rgba(188,143,116,.5);
}

/* Task Cards */
.camp .task-card{
  background:var(--card);
  border:1px solid rgba(231,229,228,.8);
  border-radius:12px;
  padding:8px 9px 10px;
  box-shadow:0 8px 20px rgba(62,36,32,.06);
  cursor:pointer;
  transition:.12s transform, .12s box-shadow;
  min-height:80px;
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:13px;
}
body.mzj.dark .camp .task-card{ border-color: rgba(255,255,255,.10); box-shadow:none; }
.camp .task-card:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 24px rgba(62,36,32,.12);
}
.camp .card-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:6px; }
.camp .task-card h4{
  margin:0;
  color:var(--brown);
  font-size:14px;
  line-height:1.4;
  font-weight:800;
}
body.mzj.dark .camp .task-card h4{ color: #fff; }
.camp .card-actions{ display:flex; flex-direction:column; gap:2px; margin-inline-start:4px; }
.camp .card-move{
  border:1px solid #e5e7eb;
  border-radius:6px;
  background:#fff;
  font-size:10px;
  padding:2px 4px;
  cursor:pointer;
  line-height:1;
}
.camp .card-move:hover{ background:#fff8ef; border-color:#e5d2c6; }
body.mzj.dark .camp .card-move{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); color:#fff; }
.camp .card-hint{ margin:2px 0 0; font-size:11px; color:var(--muted); }

.camp .links-row{ display:flex; flex-wrap:wrap; gap:4px; margin-top:2px; }
.camp .task-link{
  font-size:11px;
  padding:3px 6px;
  border-radius:999px;
  border:1px dashed #e5d2c6;
  background:#fffaf5;
  color:var(--brown);
  text-decoration:none;
}
.camp .task-link:hover{ background:#f7e9e0; }
body.mzj.dark .camp .task-link{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color:#fff; }

.camp .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px; }
.camp .badge{
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  background:#f7e9e0;
  color:var(--brown);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
body.mzj.dark .camp .badge{ background: rgba(255,255,255,.08); color:#fff; }
.camp .badge .dot{ inline-size:8px; block-size:8px; border-radius:999px; background:var(--beige); }
.camp .small{ font-size:12px; color:var(--muted); }

/* Modals */
.camp .modal-campaign, .camp .modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  place-items:center;
  padding:18px;
  z-index:999;
}
.camp .modal.show, .camp .modal-campaign.show{ display:grid; }
.camp .campaign-sheet, .camp .sheet{
  background:var(--card);
  border-radius:16px;
  width:min(820px, 100%);
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 30px 80px rgba(62,36,32,.25);
  border:1px solid rgba(231,229,228,.8);
}
body.mzj.dark .camp .campaign-sheet, body.mzj.dark .camp .sheet{
  border-color: rgba(255,255,255,.10);
  box-shadow:none;
}
.camp .campaign-sheet .head, .camp .sheet .head{
  padding:12px 16px;
  border-bottom:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  font-weight:800;
  font-size:18px;
  color:var(--brown);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
body.mzj.dark .camp .campaign-sheet .head, body.mzj.dark .camp .sheet .head{
  background: rgba(255,255,255,.06);
  border-bottom:1px solid rgba(255,255,255,.10);
  color:#fff;
}
.camp .campaign-sheet .body, .camp .sheet .body{
  padding:16px;
  overflow-y:auto;
  display:grid;
  gap:14px;
}
.camp .campaign-sheet .footer, .camp .sheet .footer{
  padding:12px 16px;
  border-top:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
body.mzj.dark .camp .campaign-sheet .footer, body.mzj.dark .camp .sheet .footer{
  background: rgba(255,255,255,.06);
  border-top:1px solid rgba(255,255,255,.10);
}

/* Form */
.camp .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:900px){ .camp .grid2{ grid-template-columns:1fr; } }
.camp label{ display:block; margin:4px 0 4px; font-weight:700; color:var(--brown); font-size:13px; }
body.mzj.dark .camp label{ color:#fff; }
.camp input, .camp select, .camp textarea{
  width:100%;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#fff;
  font-family:inherit;
  font-size:14px;
}
body.mzj.dark .camp input, body.mzj.dark .camp select, body.mzj.dark .camp textarea{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
  color:#fff;
}
.camp textarea{ min-height:90px; resize:vertical; }
.camp input:focus, .camp select:focus, .camp textarea:focus{
  outline:3px solid rgba(188,143,116,.25);
  border-color:var(--beige);
}

/* Date inputs helpers */
.camp .date-input-wrap{
  display:flex;
  align-items:center;
  border-radius:12px;
  border:1px solid #e5e7eb;
  background:#fff;
  padding-inline:6px;
  transition:.15s border-color, .15s box-shadow, .15s background;
}
.camp .date-input-wrap:focus-within{
  border-color:var(--beige);
  box-shadow:0 0 0 3px rgba(188,143,116,.15);
  background:#fffbf7;
}
body.mzj.dark .camp .date-input-wrap{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
}
.camp .date-input-wrap input{ border:0; background:transparent; padding:8px 6px; }
.camp .date-input-wrap input:focus{ outline:none; box-shadow:none; }
.camp .date-icon{ font-size:15px; color:var(--muted); padding-inline:4px; }
.camp .date-helper{ font-size:11px; color:var(--muted); }

/* Quill boxes */
.camp #campaignDescEditor, .camp #editCampDescEditor{
  height:230px;
  border:1px solid #ddd;
  border-radius:12px;
  background:#fff;
}
body.mzj.dark .camp #campaignDescEditor, body.mzj.dark .camp #editCampDescEditor{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
}
.camp .dropdown-menu{
  position:fixed;
  background:#fff;
  border:1px solid #eee;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(62,36,32,.12);
  display:none;
  min-width:260px;
  max-height:260px;
  overflow:auto;
  z-index:1000;
}
body.mzj.dark .camp .dropdown-menu{
  background: rgba(17,17,19,.92);
  border-color: rgba(255,255,255,.10);
  color:#fff;
  box-shadow:none;
}
.camp .dd-item{
  padding:8px 10px;
  border-bottom:1px solid #f3f3f3;
  cursor:pointer;
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
}
.camp .dd-item:hover{ background:#fff8ef; }
body.mzj.dark .camp .dd-item{ border-bottom-color: rgba(255,255,255,.08); }
body.mzj.dark .camp .dd-item:hover{ background: rgba(255,255,255,.06); }

/* Links form */
.camp .links-form{ display:flex; flex-direction:column; gap:6px; margin-bottom:6px; }
.camp .link-row{ display:flex; gap:6px; align-items:center; }
.camp .link-row input{ flex:1; }
.camp .link-row .link-title{ max-width:190px; }
.camp .link-remove{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  cursor:pointer;
  font-size:12px;
}
.camp .link-remove:hover{ background:#fff8ef; border-color:#e5d2c6; }
body.mzj.dark .camp .link-remove{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); color:#fff; }

.camp .btn-link-add{ margin-top:4px; padding:6px 10px; font-size:12px; }
</style>
</link><title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | MZJ Workspace</title></head><body class="mzj"><header class="mzj-topbar">
<div class="topbar-left">
<button aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" class="icon-btn" id="mzjSidebarBtn"><i class="fa-solid fa-bars"></i></button>
<div class="brand">
<div class="brand-mark">MZJ</div>
<div class="brand-text">
<div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
<div class="brand-sub">Workspace</div>
</div>
</div>
</div>
<div class="topbar-center">
<div class="mzj-breadcrumb">
<span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
<i class="fa-solid fa-chevron-left"></i>
<span class="crumb current">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
</div>
</div>
<div class="topbar-right">
<div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
<button class="mzj-btn mzj-btn-ghost" id="btnSignOut" style="display:none" type="button">
<i class="fa-solid fa-right-from-bracket"></i>
<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
</button> <div class="mzj-user">
<div class="avatar">DB</div>
<div class="user-text">
<div class="user-name">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
<div class="user-role">Dashboard</div>
</div>
</div>
</div>
</header><div class="mzj-shell" id="mzjShell">
<aside class="mzj-sidebar" data-mzj-sidebar="workspace" id="mzjSidebar">
<div class="side-section">
<div class="side-title">Workspace</div>
<nav class="side-nav" id="mzjSideNav">
<!-- ÙŠÙØ¨Ù†Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† mzj-ui.js -->
</nav>
</div>
</aside>
<div class="mzj-backdrop" id="mzjBackdrop"></div>
<main class="mzj-content">
<section class="mzj-pagehead">
<div class="pagehead-left">
<h1 class="page-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
<p class="page-desc">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ â€” KPI / ØªÙ‚Ø§Ø±ÙŠØ± / Ù…ØªØ§Ø¨Ø¹Ø©</p>
</div>
<div class="pagehead-right" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
<select class="mzj-topselect" id="spaceSelect" style="min-width:200px;"></select>
<button class="mzj-btn mzj-btn-primary" id="btnExportPdf" type="button"><i class="fa-regular fa-file-pdf"></i> Ø­ÙØ¸ PDF</button>
<button class="mzj-btn mzj-btn-ghost" id="btnLogout" type="button"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>
</section>
<main class="page" id="reportRoot">
<!-- KPIs -->
<section class="panel">
<div class="head">
<div style="display:flex;align-items:center;gap:10px">
<strong>Ù…Ù„Ø®Øµ Ø§Ù„Ù€ Space Ø§Ù„Ø­Ø§Ù„ÙŠ</strong>
<span class="chip" id="who">â€”</span>
</div>
<div class="muted" id="todayChip"></div>
</div>
<div class="body">
<div class="kpis" id="kpis">
<div class="kpi">
<div class="lbl"><span class="ico">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z" stroke="#bc8f74" stroke-width="1.5"></path></svg>
</span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
<div class="val" id="k_total">â€”</div>
<div class="hint">ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</div>
</div>
<div class="kpi">
<div class="lbl"><span class="ico">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18"><path d="M12 7v5l3 3" stroke="#bc8f74" stroke-linecap="round" stroke-width="1.5"></path><circle cx="12" cy="12" r="9" stroke="#bc8f74" stroke-width="1.5"></circle></svg>
</span>Ù…ØªØ£Ø®Ø±Ø©</div>
<div class="val" id="k_overdue">â€”</div>
<div class="hint">ØªØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
</div>
<div class="kpi">
<div class="lbl"><span class="ico">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18"><rect height="16" rx="2" stroke="#bc8f74" stroke-width="1.5" width="18" x="3" y="5"></rect><path d="M3 10h18" stroke="#bc8f74" stroke-width="1.5"></path><path d="M8 3v4M16 3v4" stroke="#bc8f74" stroke-linecap="round" stroke-width="1.5"></path></svg>
</span>ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙŠÙˆÙ…</div>
<div class="val" id="k_today">â€”</div>
<div class="hint">Due Today</div>
</div>
<div class="kpi">
<div class="lbl"><span class="ico">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18"><path d="M5 4h14a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H8l-5 5V6a2 2 0 0 1 2-2z" stroke="#bc8f74" stroke-width="1.5"></path></svg>
</span>ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
<div class="val" id="k_review">â€”</div>
<div class="hint">Ø¹Ù…ÙˆØ¯ â€œØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©â€</div>
</div>
<div class="kpi">
<div class="lbl"><span class="ico">
<svg fill="none" height="18" viewbox="0 0 24 24" width="18"><path d="M12 12a5 5 0 1 0-5-5" stroke="#bc8f74" stroke-width="1.5"></path><path d="M20 21a8 8 0 0 0-16 0" stroke="#bc8f74" stroke-width="1.5"></path><path d="M4 4l16 16" stroke="#bc8f74" stroke-width="1.5"></path></svg>
</span>ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†Ø©</div>
<div class="val" id="k_unassigned">â€”</div>
<div class="hint">Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¤ÙˆÙ„</div>
</div>
</div>
</div>
</section>
<!-- Daily Task Monthly + Weekly Summary -->
<section class="panel">
<div class="head">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<strong>ğŸ—“ Daily Task â€” Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</strong>
<span class="muted" id="dailySpaceLabel">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„ÙØ¹Ù‘Ø§Ù„Ø© ÙÙ‚Ø·</span>
</div>
<select class="select" id="dailyMonthSelect" style="padding:6px 10px;font-size:13px;min-width:170px;"></select>
</div>
<div class="body" id="dailyMonthlyWrap">
<div class="empty">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Daily Task ...</div>
</div>
</section>
<!-- Columns counters -->
<section class="panel">
<div class="head">
<div style="display:flex;align-items:center;gap:10px">
<strong>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</strong>
<span class="chip">
<svg fill="none" height="14" viewbox="0 0 24 24" width="14">
<path d="M3 6h18M3 12h18M3 18h18" stroke="#3e2420" stroke-linecap="round" stroke-width="2"></path>
</svg>
            Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª / Ø±ÙŠÙ„ Ù‚ØµÙŠØ± / ØªØµÙ…ÙŠÙ… ØµÙˆØ± / ÙŠÙˆØªÙŠÙˆØ¨ ...
          </span>
</div>
</div>
<div class="body"><div class="cols" id="cols"></div></div>
</section>
<!-- Soon + Assignees -->
<div class="grid two">
<section class="panel">
<div class="head"><strong>Ø£Ù‚Ø±Ø¨ ØªØ³Ù„ÙŠÙ… (Top 10)</strong><span class="chip" id="todayInfo"></span></div>
<div class="body"><div id="soonWrap"></div></div>
</section>
<section class="panel">
<div class="head"><strong>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</strong></div>
<div class="body"><div id="assigneesWrap"></div></div>
</section>
</div>
<!-- Per-member details -->
<section class="panel">
<div class="head"><strong>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ â€” Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… + Ø²Ù…Ù† Ø§Ù„ØªÙ†ÙÙŠØ°</strong></div>
<div class="body"><div id="membersTableWrap"></div></div>
</section>
<!-- Charts base -->
<section class="panel">
<div class="head"><strong>Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ©</strong><span class="muted">Per Member + Status Mix</span></div>
<div class="body">
<div class="charts">
<div><canvas height="180" id="barPerUser"></canvas></div>
<div><canvas height="180" id="pieStatuses"></canvas></div>
</div>
</div>
</section>
<!-- Lead/Cycle + Throughput -->
<div class="grid 2-1">
<section class="panel">
<div class="head"><strong>Lead Time &amp; Cycle Time (Days)</strong><span class="muted">Median per Week</span></div>
<div class="body"><canvas height="200" id="lineLeadCycle"></canvas></div>
</section>
<section class="panel">
<div class="head"><strong>Throughput Weekly</strong><span class="muted">Completed Tasks / Week</span></div>
<div class="body"><canvas height="200" id="barThroughput"></canvas></div>
</section>
</div>
<!-- SLA Breach + Completion by Column -->
<div class="grid 1-2">
<section class="panel">
<div class="head"><strong>SLA Breach</strong><span class="muted">Completed after Due Date</span></div>
<div class="body"><canvas height="220" id="gaugeSLA"></canvas></div>
</section>
<section class="panel">
<div class="head"><strong>Completion Rate by Column</strong><span class="muted">Done vs Remaining</span></div>
<div class="body"><canvas height="220" id="barByColumn"></canvas></div>
</section>
</div>
<!-- Workload Heatmap -->
<section class="panel">
<div class="head"><strong>Member Workload Heatmap</strong><span class="muted">Next 14 days by Due Date</span></div>
<div class="body">
<div class="heatmap">
<div class="legend">
<span class="chip">Intensity: 0</span>
<span class="chip warn">Medium</span>
<span class="chip danger">High</span>
</div>
<div class="hm-grid" id="hmWrap"></div>
</div>
</div>
</section>
<!-- Activity -->
<section class="panel">
<div class="head"><strong>Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«</strong><span class="muted">Ø¢Ø®Ø± 15 ØªØ­Ø¯ÙŠØ«</span></div>
<div class="body" id="activityWrap"></div>
</section>
</main></main>
</div><script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, onSnapshot,
      query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Firebase Config */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    /* UI refs */
    const spaceSelect      = document.getElementById('spaceSelect');
    const whoEl            = document.getElementById('who');
    const btnLogout        = document.getElementById('btnLogout');
    const btnExport        = document.getElementById('btnExportPdf');
    const todayChip        = document.getElementById('todayChip');
    const todayInfo        = document.getElementById('todayInfo');
    const dailyMonthlyWrap = document.getElementById('dailyMonthlyWrap');
    const dailySpaceLabel  = document.getElementById('dailySpaceLabel');
    const dailyMonthSelect = document.getElementById('dailyMonthSelect');

    // KPI refs
    const kTotal=document.getElementById('k_total');
    const kOver=document.getElementById('k_overdue');
    const kToday=document.getElementById('k_today');
    const kRev  =document.getElementById('k_review');
    const kUnas =document.getElementById('k_unassigned');
    const colsBox = document.getElementById('cols');
    const soonWrap = document.getElementById('soonWrap');
    const assigneesWrap = document.getElementById('assigneesWrap');
    const activityWrap  = document.getElementById('activityWrap');
    const membersTableWrap = document.getElementById('membersTableWrap');

    // Charts refs
    const barUser = document.getElementById('barPerUser');
    const pieStatus = document.getElementById('pieStatuses');
    const lineLeadCycle = document.getElementById('lineLeadCycle');
    const barThroughput = document.getElementById('barThroughput');
    const gaugeSLA = document.getElementById('gaugeSLA');
    const barByColumn = document.getElementById('barByColumn');

    let cBarUser, cPieStatus, cLineLC, cBarTP, cGaugeSLA, cBarCol;

    /* State */
    let CURRENT_USER=null, IS_ADMIN=false;
    let CURRENT_SPACE=null, SPACE_COLUMNS=["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨","ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
    let unsubTasks=null;
    let TASKS=[];

    // Daily Task (Ù…Ù† Collection: dailyTasks Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹)
    let DAILY_TASKS_ALL = [];
    let DAILY_MONTHS_MAP = {};
    let DAILY_SELECTED_KEY = null;

    const MONTHS_NAMES=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];

    /* Utils */
    const fmtDate = (ymd)=> {
      if(!ymd) return '';
      const [y,m,d] = ymd.split('-').map(Number);
      const js = new Date(y, m-1, d);
      return js.toLocaleDateString('en-GB');
    };
    const todayYMD = ()=>{
      const d=new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const toMillis = (v)=>{
      if(!v) return null;
      if(typeof v === 'string') return new Date(v).getTime();
      if(v.seconds) return v.seconds*1000;
      if(v.toDate) try{ return v.toDate().getTime(); }catch{}
      if(v instanceof Date) return v.getTime();
      return null;
    };
    const isDone = (t)=>{
      const s=(t.status||'').trim().toLowerCase();
      return s==="ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" || s==="done" || s==="completed";
    };
    const isReview = (t)=> (t.status==="ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");

    function countUp(el, to){
      const target = Number(to)||0;
      const dur = 600; const start=performance.now();
      const from = Number(el.dataset.from||0);
      function step(ts){
        const p = Math.min(1,(ts-start)/dur);
        el.textContent = Math.round(from + (target-from)*p);
        if(p<1) requestAnimationFrame(step); else el.dataset.from = target;
      }
      requestAnimationFrame(step);
    }

    // Export PDF
    btnLogout.onclick = async()=>{ await signOut(auth); location.href="login.html"; };
    btnExport.onclick = ()=> {
      const node = document.getElementById('reportRoot');
      const opt = {
        margin: [6,6,6,6],
        filename: `dashboard_${new Date().toISOString().slice(0,10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          backgroundColor: '#fff8ef',
          windowWidth: document.body.scrollWidth
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
      };
      // @ts-ignore
      html2pdf().from(node).set(opt).save();
    };

    // Auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER=user;
      const u = await getDoc(doc(db,'users', user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'User');
      const role = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = role === 'admin';
      whoEl.textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;

      todayChip.innerHTML = `<span class="chip">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="16" rx="2" stroke="#1e90ff" stroke-width="1.5"/><path d="M3 10h18" stroke="#1e90ff" stroke-width="1.5"/><path d="M8 3v4M16 3v4" stroke="#1e90ff" stroke-width="1.5" stroke-linecap="round"/></svg>
        ${new Date().toLocaleDateString('en-GB')}
      </span>`;

      if(!IS_ADMIN){
        document.getElementById('navMembers').style.display='none';
        document.getElementById('navAdmin').style.display='none';
        location.href="projects.html";
        return;
      }
      bootSpaces();
      bootDailyTasksDashboard();   // <-- Ù…Ù† dailyTasks
    });

    // Spaces dropdown
    async function bootSpaces(){
      onSnapshot(collection(db,'spaces'), (snap)=>{
        const items=[];
        snap.forEach(d=>{
          const data=d.data()||{};
          if(data.active!==false) items.push({ id:d.id, ...data });
        });
        items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

        spaceSelect.innerHTML='';
        items.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s.id; opt.textContent=s.name;
          spaceSelect.appendChild(opt);
        });

        if(!CURRENT_SPACE && items.length){
          CURRENT_SPACE = items[0].id;
          SPACE_COLUMNS = (items[0].columns && items[0].columns.length)? items[0].columns.slice() : SPACE_COLUMNS;
          if(!SPACE_COLUMNS.includes('ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')) SPACE_COLUMNS.push('ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
          spaceSelect.value = CURRENT_SPACE;
          listenTasks();
        }
      });

      spaceSelect.addEventListener('change', async (e)=>{
        CURRENT_SPACE = e.target.value;
        const d=await getDoc(doc(db,'spaces', CURRENT_SPACE));
        if(d.exists()){
          const cols = d.data().columns || [];
          SPACE_COLUMNS = cols.length? cols.slice() : ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
          if(!SPACE_COLUMNS.includes('ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')) SPACE_COLUMNS.push('ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
        }
        listenTasks(true);
      });
    }

    // Main space tasks
    function listenTasks(){
      if(unsubTasks){ unsubTasks(); unsubTasks=null; }
      if(!CURRENT_SPACE) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasks = onSnapshot(qy, (snap)=>{
        TASKS=[]; snap.forEach(d=> TASKS.push({ id:d.id, ...(d.data()||{}) }));
        renderAll();
      }, (err)=>{ console.error(err); });
    }

    /* ===========================
       Daily Task Dashboard (dailyTasks)
       =========================== */

    function bootDailyTasksDashboard(){
      // Ù†Ø³Ù…Ø¹ Ø¹Ù„Ù‰ Collection: dailyTasks (Ù†ÙØ³ Ø´ØºÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹/Ø§Ù„ØªØ§Ø¨)
      const qDaily = collection(db,'dailyTasks');
      onSnapshot(qDaily, (snap)=>{
        DAILY_TASKS_ALL = [];
        snap.forEach(d=> DAILY_TASKS_ALL.push({ id:d.id, ...(d.data()||{}) }));
        rebuildDailyMonthsFromTasks();
      }, (err)=>{
        console.error(err);
        dailyMonthlyWrap.innerHTML = `<div class="empty">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Daily Task.</div>`;
      });

      dailyMonthSelect.addEventListener('change', ()=>{
        DAILY_SELECTED_KEY = dailyMonthSelect.value || null;
        renderDailyMonthlyForSelected();
      });
    }

    function rebuildDailyMonthsFromTasks(){
      DAILY_MONTHS_MAP = {};

      if(!DAILY_TASKS_ALL.length){
        dailyMonthSelect.innerHTML = '';
        dailyMonthlyWrap.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ© (Daily Task) Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>`;
        return;
      }

      DAILY_TASKS_ALL.forEach(t=>{
        const mk = (t.monthKey || '').toString(); // Ù…Ø«Ø§Ù„: "2025-11"
        if(!mk || mk.length<7) return;
        const parts = mk.split('-').map(Number);
        if(parts.length<2 || !parts[0] || !parts[1]) return;
        const y = parts[0];
        const m = parts[1];

        if(!DAILY_MONTHS_MAP[mk]) DAILY_MONTHS_MAP[mk] = {
          year:y, month:m,
          total:0, done:0, remaining:0,
          weeks:{}
        };
        const bucket = DAILY_MONTHS_MAP[mk];

        const completed = !!t.completed;
        bucket.total++;
        if(completed) bucket.done++; else bucket.remaining++;

        let w = Number(t.week||0);
        if(w>=1 && w<=4){
          if(!bucket.weeks[w]) bucket.weeks[w]={ total:0, done:0, remaining:0 };
          const wb = bucket.weeks[w];
          wb.total++;
          if(completed) wb.done++; else wb.remaining++;
        }
      });

      const keys = Object.keys(DAILY_MONTHS_MAP).sort(); // YYYY-MM ØªØµØ§Ø¹Ø¯ÙŠ
      if(!keys.length){
        dailyMonthSelect.innerHTML = '';
        dailyMonthlyWrap.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ± ÙØ¹Ù‘Ø§Ù„Ø© Ù„Ù„Ù€ Daily Task.</div>`;
        return;
      }

      const prev = DAILY_SELECTED_KEY;
      dailyMonthSelect.innerHTML = '';
      keys.forEach(key=>{
        const mData = DAILY_MONTHS_MAP[key];
        const label = `Ø£Ø¬Ù†Ø¯Ø© ${MONTHS_NAMES[mData.month-1]} ${mData.year}`;
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = label;
        dailyMonthSelect.appendChild(opt);
      });

      let selected = prev && keys.includes(prev) ? prev : keys[keys.length-1];
      DAILY_SELECTED_KEY = selected;
      dailyMonthSelect.value = selected;

      renderDailyMonthlyForSelected();
    }

    function renderDailyMonthlyForSelected(){
      if(!DAILY_SELECTED_KEY || !DAILY_MONTHS_MAP[DAILY_SELECTED_KEY]){
        dailyMonthlyWrap.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>`;
        return;
      }
      const mData = DAILY_MONTHS_MAP[DAILY_SELECTED_KEY];
      const monthLabel = `Ø£Ø¬Ù†Ø¯Ø© ${MONTHS_NAMES[mData.month-1]} ${mData.year}`;
      const monthPct = mData.total ? Math.round(mData.done/mData.total*100) : 0;

      const headerLine = `
        <div style="margin-bottom:10px;font-weight:700;color:var(--brown);font-size:15px;">
          ${monthLabel}
          <span style="margin-inline-start:12px;font-weight:500;color:var(--muted);">
            Ù…Ù‡Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„: ${mData.remaining} | ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°: ${mData.done}
          </span>
          <span style="margin-inline-start:12px;font-weight:500;color:var(--muted);">
            Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: ${monthPct}% 
          </span>
        </div>
      `;

      let rows = `
        <tr style="background:#fffaf5">
          <td><strong>${monthLabel}</strong> (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±)</td>
          <td>${mData.total}</td>
          <td style="color:var(--ok);font-weight:700">${mData.done}</td>
          <td style="color:var(--danger);font-weight:700">${mData.remaining}</td>
          <td>${monthPct}%</td>
        </tr>
      `;

      [1,2,3,4].forEach(wk=>{
        const w = mData.weeks[wk];
        if(!w) return;
        const wPct = w.total ? Math.round(w.done/w.total*100) : 0;
        rows += `
          <tr>
            <td style="padding-right:24px;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${wk} (Ø³Ø¨Øªâ€“Ø®Ù…ÙŠØ³)</td>
            <td>${w.total}</td>
            <td style="color:var(--ok);font-weight:700">${w.done}</td>
            <td style="color:var(--danger);font-weight:700">${w.remaining}</td>
            <td>${wPct}%</td>
          </tr>
        `;
      });

      dailyMonthlyWrap.innerHTML = `
        ${headerLine}
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø´Ù‡Ø± / Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</th>
              <th>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>Ù…ØªØ¨Ù‚Ù‘ÙŠ</th>
              <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    /* ============ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ============ */

    function renderAll(){
      const today = todayYMD();
      const total = TASKS.length;
      const overdue = TASKS.filter(t=> t.due && t.due < today).length;
      const dueToday= TASKS.filter(t=> t.due && t.due === today).length;
      const review  = TASKS.filter(isReview).length;
      const unas    = TASKS.filter(t=> !t.assignee || !t.assignee.uid).length;

      countUp(kTotal, total);
      countUp(kOver, overdue);
      countUp(kToday, dueToday);
      countUp(kRev, review);
      countUp(kUnas, unas);

      todayInfo.textContent = `Today: ${new Date().toLocaleDateString('en-GB')}`;

      // Column counters
      colsBox.innerHTML='';
      SPACE_COLUMNS.forEach(c=>{
        const n = TASKS.filter(t=> t.status===c).length;
        const box=document.createElement('div');
        box.className='colbox';
        box.innerHTML=`
          <div class="title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="#3e2420" stroke-width="2" stroke-linecap="round"/></svg>
            ${c}
          </div>
          <div class="num">${n}</div>`;
        colsBox.appendChild(box);
      });

      // Soon due (top 10)
      const soon = TASKS.filter(t=> t.due).slice().sort((a,b)=> (a.due>b.due?1:-1)).slice(0,10);
      soonWrap.innerHTML = soon.length? `
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Due</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody>
            ${soon.map(t=>`
              <tr>
                <td>${t.name||'-'}</td>
                <td>${t.assignee?`<span class="badge"><span class="dot" style="background:${t.assignee.color||'#bc8f74'}"></span>${t.assignee.name||''}</span>`:'â€”'}</td>
                <td>${fmtDate(t.due)||'â€”'}</td>
                <td>${t.status||'â€”'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø±ÙŠØ¨Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>`;

      // Assignees distribution
      const mapAss={};
      TASKS.forEach(t=>{
        const key = t.assignee?.name || 'ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†';
        mapAss[key] = (mapAss[key]||0)+1;
      });
      const rowsAss = Object.entries(mapAss).sort((a,b)=> b[1]-a[1]).slice(0,10);
      assigneesWrap.innerHTML = rowsAss.length? `
        <table>
          <thead><tr><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…</th></tr></thead>
          <tbody>
            ${rowsAss.map(([n,c])=> `<tr><td>${n}</td><td>${c}</td></tr>`).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">Ù„Ø§ Ù…Ù‡Ø§Ù… Ù…Ø³Ù†Ø¯Ø© Ø¨Ø¹Ø¯.</div>`;

      // Per-member details + pie
      const perMember = new Map();
      const perStatus = { todo:0, review:0, done:0 };

      TASKS.forEach(t=>{
        const name = t.assignee?.name || 'ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†';
        if(!perMember.has(name)) perMember.set(name,{
          total:0,
          done:0,
          review:0,
          remaining:0,
          durations:[],
          reviewRounds:[]
        });
        const m = perMember.get(name);
        m.total++;
        if(isDone(t)){ m.done++; perStatus.done++; }
        else if(isReview(t)){ m.review++; perStatus.review++; }
        else { m.remaining++; perStatus.todo++; }

        // Ø²Ù…Ù† Ø§Ù„ØªÙ†ÙÙŠØ° Ù…Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø­ØªÙ‰ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø´Ø±/Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
        if(isDone(t)){
          const startMs =
            toMillis(t.assignedAt) ||
            toMillis(t.createdAt) ||
            toMillis(t.startedAt);
          const endMs =
            toMillis(t.readyToPublishAt) ||
            toMillis(t.approvedAt) ||
            toMillis(t.completedAt);
          if(startMs && endMs && endMs >= startMs){
            const days = (endMs - startMs) / 86400000;
            m.durations.push(days);
          }
          // Ø¹Ø¯Ø¯ Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
          if(Array.isArray(t.reviewCycles) && t.reviewCycles.length){
            m.reviewRounds.push(t.reviewCycles.length);
          }
        }
      });

      const ordered = Array.from(perMember.entries()).sort((a,b)=> b[1].total - a[1].total);
      membersTableWrap.innerHTML = ordered.length ? `
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</th>
              <th>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
              <th>Ù…ØªØ¨Ù‚Ù‘ÙŠ</th>
              <th>Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠÙˆÙ…)</th>
              <th>Ø£Ø³Ø±Ø¹ Ù…Ù‡Ù…Ø©</th>
              <th>Ø£Ø¨Ø·Ø£ Ù…Ù‡Ù…Ø©</th>
              <th>Ù…ØªÙˆØ³Ø· Ù…Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
            </tr>
          </thead>
          <tbody>
            ${ordered.map(([n,v])=>{
              const pct = v.total? Math.round(v.done/v.total*100):0;
              let avgDur='â€”', minDur='â€”', maxDur='â€”', avgRev='â€”';
              if(v.durations && v.durations.length){
                let sum=0, min=v.durations[0], max=v.durations[0];
                v.durations.forEach(d=>{
                  sum += d;
                  if(d<min) min=d;
                  if(d>max) max=d;
                });
                avgDur = (sum / v.durations.length).toFixed(1);
                minDur = min.toFixed(1);
                maxDur = max.toFixed(1);
              }
              if(v.reviewRounds && v.reviewRounds.length){
                let sumR = 0;
                v.reviewRounds.forEach(r=> sumR += r);
                avgRev = (sumR / v.reviewRounds.length).toFixed(1);
              }
              return `
                <tr>
                  <td>
                    <strong>${n}</strong>
                    <div style="font-size:11px;color:var(--muted);margin-top:2px;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: ${pct}%</div>
                  </td>
                  <td>${v.total}</td>
                  <td style="color:var(--ok);font-weight:700">${v.done}</td>
                  <td style="color:var(--warn);font-weight:700">${v.review}</td>
                  <td style="color:var(--danger);font-weight:700">${v.remaining}</td>
                  <td>${avgDur}</td>
                  <td>${minDur}</td>
                  <td>${maxDur}</td>
                  <td>${avgRev}</td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</div>`;

      const labelsUser = ordered.map(([n])=>n);
      const doneArr = ordered.map(([,v])=>v.done);
      const remArr  = ordered.map(([,v])=>v.remaining);

      if(cBarUser) cBarUser.destroy();
      cBarUser = new Chart(barUser, {
        type:'bar',
        data:{
          labels: labelsUser,
          datasets:[
            { label:'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', data:doneArr, backgroundColor:'#16a34a' },
            { label:'Ù…ØªØ¨Ù‚Ù‘ÙŠ',      data:remArr,  backgroundColor:'#dc2626' }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ x:{stacked:true}, y:{stacked:true,ticks:{precision:0}} },
          plugins:{ legend:{labels:{font:{family:'Tajawal'}}}, tooltip:{rtl:true} },
          animation:{ duration:500 }
        }
      });

      if(cPieStatus) cPieStatus.destroy();
      cPieStatus = new Chart(pieStatus, {
        type:'doughnut',
        data:{
          labels:['ØºÙŠØ± Ù…Ù†Ø¬Ø²','ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'],
          datasets:[{ data:[perStatus.todo, perStatus.review, perStatus.done], backgroundColor:['#64748b','#f59e0b','#16a34a'] }]
        },
        options:{
          responsive:true, maintainAspectRatio:false, cutout:'58%',
          plugins:{ legend:{ position:'bottom', labels:{ font:{family:'Tajawal'} } }, tooltip:{ rtl:true } },
          animation:{ duration:500 }
        }
      });

      // Lead/Cycle
      const weeks = {};
      TASKS.forEach(t=>{
        if(!isDone(t)) return;
        const cAt = toMillis(t.createdAt);
        const sAt = toMillis(t.startedAt) || cAt;
        const dAt = toMillis(t.completedAt);
        if(!dAt || !cAt) return;
        const leadDays = (dAt - cAt) / 86400000;
        const cycDays  = (dAt - sAt) / 86400000;
        const d = new Date(dAt);
        const key = weekKey(d);
        if(!weeks[key]) weeks[key]={lead:[],cycle:[]};
        weeks[key].lead.push(leadDays);
        weeks[key].cycle.push(cycDays);
      });
      const weekLabels = Object.keys(weeks).sort();
      const medLead = weekLabels.map(k=> median(weeks[k].lead));
      const medCycle= weekLabels.map(k=> median(weeks[k].cycle));

      if(cLineLC) cLineLC.destroy();
      cLineLC = new Chart(lineLeadCycle, {
        type:'line',
        data:{
          labels: weekLabels,
          datasets:[
            { label:'Lead (days)', data: medLead, borderColor:'#1e90ff', tension:.2 },
            { label:'Cycle (days)', data: medCycle, borderColor:'#bc8f74', tension:.2 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{labels:{font:{family:'Tajawal'}}}, tooltip:{rtl:true } },
          scales:{ y:{ ticks:{ precision:0 } } }
        }
      });

      // Throughput
      const throughput = {};
      TASKS.forEach(t=>{
        if(!isDone(t)) return;
        const dAt = toMillis(t.completedAt);
        if(!dAt) return;
        const key = weekKey(new Date(dAt));
        throughput[key] = (throughput[key]||0) + 1;
      });
      const tpLabels = Object.keys(throughput).sort();
      const tpVals   = tpLabels.map(k=> throughput[k]);

      if(cBarTP) cBarTP.destroy();
      cBarTP = new Chart(barThroughput, {
        type:'bar',
        data:{ labels: tpLabels, datasets:[{ label:'Completed / Week', data: tpVals, backgroundColor:'#16a34a' }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{labels:{font:{family:'Tajawal'}}}, tooltip:{rtl:true } },
          scales:{ y:{ ticks:{ precision:0 } } }
        }
      });

      // SLA
      let totalCompleted=0, breaches=0;
      TASKS.forEach(t=>{
        if(!isDone(t)) return;
        const dAt = toMillis(t.completedAt);
        if(!dAt) return;
        totalCompleted++;
        const dueYMD = t.due;
        if(dueYMD){
          const [y,m,da]= dueYMD.split('-').map(Number);
          const dueMs = new Date(y, m-1, da, 23,59,59).getTime();
          if(dAt > dueMs) breaches++;
        }
      });
      const breachPct = totalCompleted? Math.round(breaches/totalCompleted*100) : 0;
      if(cGaugeSLA) cGaugeSLA.destroy();
      cGaugeSLA = new Chart(gaugeSLA, {
        type:'doughnut',
        data:{
          labels:['Breach','On time'],
          datasets:[{ data:[breachPct, 100-breachPct], backgroundColor:['#dc2626','#16a34a'] }]
        },
        options:{
          responsive:true, maintainAspectRatio:false, circumference:180, rotation:270, cutout:'65%',
          plugins:{ legend:{ display:false }, tooltip:{ rtl:true } }
        }
      });

      // Completion by column
      const colDone=[], colRem=[], colLabels=[];
      SPACE_COLUMNS.forEach(c=>{
        colLabels.push(c);
        let d=0, r=0;
        TASKS.forEach(t=>{
          if(t.status!==c) return;
          if(isDone(t)) d++; else if(!isReview(t)) r++;
        });
        colDone.push(d); colRem.push(r);
      });
      if(cBarCol) cBarCol.destroy();
      cBarCol = new Chart(barByColumn, {
        type:'bar',
        data:{
          labels: colLabels,
          datasets:[
            { label:'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', data: colDone, backgroundColor:'#16a34a' },
            { label:'ØºÙŠØ± Ù…Ù†Ø¬Ø²',    data: colRem,  backgroundColor:'#64748b' }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ x:{ stacked:true }, y:{ stacked:true, ticks:{precision:0} } },
          plugins:{ legend:{labels:{font:{family:'Tajawal'}}}, tooltip:{rtl:true } }
        }
      });

      // Heatmap
      renderHeatmap();

      // Activity
      const sorted = TASKS.slice().sort((a,b)=> (toMillis(b.createdAt)||0)-(toMillis(a.createdAt)||0)).slice(0,15);
      activityWrap.innerHTML = sorted.length? `
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Created</th><th>Ø±ÙˆØ§Ø¨Ø·</th></tr></thead>
          <tbody>
            ${sorted.map(t=>{
              const linksCount = Array.isArray(t.links)? t.links.length : 0;
              const created = toMillis(t.createdAt)? new Date(toMillis(t.createdAt)).toLocaleDateString('en-GB') : 'â€”';
              return `
                <tr>
                  <td>${t.name||'-'}</td>
                  <td>${t.assignee?`<span class="badge"><span class="dot" style="background:${t.assignee.color||'#bc8f74'}"></span>${t.assignee.name||''}</span>`:'â€”'}</td>
                  <td>${t.status||'â€”'}</td>
                  <td>${created}</td>
                  <td>${linksCount}</td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">Ù„Ø§ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«.</div>`;
    }

    function weekKey(d){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart)/86400000)+1)/7);
      return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function median(arr){
      const a = arr.slice().filter(x=>isFinite(x)).sort((x,y)=>x-y);
      const n=a.length; if(!n) return 0;
      const mid = Math.floor(n/2);
      return n%2? a[mid] : (a[mid-1]+a[mid])/2;
    }

    function renderHeatmap(){
      const hm = document.getElementById('hmWrap');
      hm.innerHTML='';
      const horizonDays = 14;
      const today = new Date(); today.setHours(0,0,0,0);
      const days = [];
      for(let i=0;i<horizonDays;i++){
        const d = new Date(today.getTime()+i*86400000);
        days.push(d);
      }
      const memberMap = new Map();
      TASKS.forEach(t=>{
        const name = t.assignee?.name || 'ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†';
        const due = t.due;
        if(!due) return;
        const [y,m,da]= due.split('-').map(Number);
        const dueDate = new Date(y, m-1, da); dueDate.setHours(0,0,0,0);
        const idx = Math.round((dueDate - today)/86400000);
        if(idx<0 || idx>=horizonDays) return;
        if(!memberMap.has(name)) memberMap.set(name, Array(horizonDays).fill(0));
        memberMap.get(name)[idx] += 1;
      });
      const ranked = Array.from(memberMap.entries())
        .map(([n,arr])=> [n, arr, arr.reduce((a,b)=>a+b,0)])
        .sort((a,b)=> b[2]-a[2])
        .slice(0,8);

      hm.appendChild(cell('Member / Date','hm-head'));
      days.forEach(d=> hm.appendChild(cell(d.toLocaleDateString('en-GB'), 'hm-head')));

      ranked.forEach(([name,arr])=>{
        hm.appendChild(cell(name,'hm-name'));
        arr.forEach(v=>{
          const c = document.createElement('div');
          c.className = 'hm-cell';
          if(v>=3){ c.style.background='#fef2f2'; c.style.borderColor='#fee2e2'; }
          else if(v>=1){ c.style.background='#fff7ed'; c.style.borderColor='#ffedd5'; }
          c.textContent = v? v : '';
          hm.appendChild(c);
        });
      });

      function cell(text, cls){
        const d=document.createElement('div');
        d.className = 'hm-cell ' + (cls||'');
        d.textContent = text;
        return d;
      }
    }
  </script><script src="./mzj-ui.js"></script>
<script>
(function(){
  try{
    var p=(location.pathname||'').split('/').pop()||'dashboard.html';
    document.querySelectorAll('#mzjSideNav a').forEach(function(a){
      var h=(a.getAttribute('href')||'').split('/').pop();
      if(h===p) a.classList.add('active');
    });
  }catch(e){}
})();
</script>
</body></html>
