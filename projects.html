<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MZJ Workspace â€” Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg: #0b0c10;
      --bg-alt:#151823;
      --card:#1f2430;
      --accent:#f1b36a;
      --accent-soft:rgba(241,179,106,0.09);
      --accent-soft2:rgba(241,179,106,0.18);
      --text:#f5f5f5;
      --muted:#9ca3af;
      --danger:#f97373;
      --success:#4ade80;
      --border:#2d3343;
      --badge-bg:#111827;
      --shadow-soft:0 18px 45px rgba(0,0,0,0.5);
    }

    *{
      box-sizing:border-box;
      scroll-behavior:smooth;
    }

    body{
      margin:0;
      padding:16px;
      font-family:'Tajawal',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color:var(--text);
      min-height:100vh;
    }

    h1,h2,h3,h4{
      margin:0;
      font-weight:600;
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0,2.1fr) minmax(0,1.4fr);
      gap:18px;
      align-items:flex-start;
    }

    @media(max-width:1100px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    /* ==== Panels ==== */
    .panel{
      background:linear-gradient(135deg, rgba(15,23,42,0.97), rgba(15,23,42,0.96));
      border-radius:18px;
      padding:16px 18px 14px;
      border:1px solid rgba(148,163,184,0.18);
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(18px);
      position:relative;
      overflow:hidden;
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:-80px;
      background:
        radial-gradient(circle at top right, rgba(248,250,252,0.12), transparent 60%),
        radial-gradient(circle at bottom left, rgba(56,189,248,0.08), transparent 60%);
      opacity:0.6;
      pointer-events:none;
      z-index:0;
    }

    .panel > *{
      position:relative;
      z-index:1;
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }

    .panel-header-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:17px;
    }

    .badge-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 9px 3px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 0 0 0.5px rgba(15,23,42,0.9);
    }

    .badge-pill span.icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:17px;
      height:17px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 0, #fef9c3, #f97316);
      color:#020617;
      font-size:11px;
      box-shadow:0 0 0 1px rgba(15,23,42,0.9);
    }

    .panel-subtitle{
      font-size:12px;
      color:var(--muted);
    }

    .panel-subtitle strong{
      color:#e5e7eb;
    }

    .panel-header .controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      gap:6px;
    }

    .muted{
      font-size:11px;
      color:var(--muted);
    }

    .muted strong{
      color:#e5e7eb;
    }

    .body{
      margin-top:2px;
    }

    /* Tabs */
    .tabs{
      display:inline-flex;
      padding:3px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.3);
      box-shadow:0 10px 30px rgba(0,0,0,0.45);
    }

    .tab{
      border-radius:999px;
      padding:4px 12px 5px;
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
      transition:all .18s ease;
    }

    .tab span.dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:rgba(148,163,184,0.7);
      box-shadow:0 0 0 2px rgba(15,23,42,0.85);
    }

    .tab.active{
      background:radial-gradient(circle at top left, #fbbf24, #f97316);
      color:#020617;
      box-shadow:0 10px 25px rgba(248,250,252,0.25);
    }

    .tab.active span.dot{
      background:#0f172a;
    }

    /* Form controls */
    .input, select{
      background:rgba(15,23,42,0.88);
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      color:var(--text);
      padding:5px 10px;
      font-size:11px;
      outline:none;
      min-height:26px;
    }

    .input::placeholder{
      color:rgba(148,163,184,0.8);
    }

    select{
      padding-inline-end:24px;
      background-image:
        linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position:
        calc(100% - 11px) 9px,
        calc(100% - 7px) 9px;
      background-size:4px 4px,4px 4px;
      background-repeat:no-repeat;
      appearance:none;
    }

    .btn{
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:11px;
      padding:5px 11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,#fbbf24,#f97316);
      color:#020617;
      box-shadow:0 12px 25px rgba(248,250,252,0.18);
      font-weight:600;
    }

    .btn.secondary{
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.5);
      box-shadow:none;
    }

    .btn.ghost{
      background:transparent;
      color:var(--muted);
      border:1px dashed rgba(148,163,184,0.4);
      box-shadow:none;
    }

    .btn.sm{
      padding:4px 9px;
      font-size:10px;
    }

    .btn.danger{
      background:linear-gradient(135deg,#fecaca,#f87171);
      color:#111827;
    }

    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Board */
    .board{
      display:flex;
      gap:10px;
      align-items:flex-start;
      overflow-x:auto;
      padding-bottom:4px;
      margin-top:6px;
    }

    .column{
      min-width:210px;
      max-width:210px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.25);
      padding:8px 8px 10px;
      box-shadow:0 16px 35px rgba(0,0,0,0.6);
      position:relative;
    }

    .column-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }

    .column-title{
      font-size:12px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .column-title .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 1px rgba(15,23,42,0.9);
    }

    .column-title span.count{
      font-size:10px;
      color:var(--muted);
      padding-inline-start:2px;
    }

    .column-actions{
      display:flex;
      gap:4px;
      align-items:center;
    }

    .column-actions button{
      border-radius:999px;
      border:none;
      background:rgba(15,23,42,0.9);
      color:var(--muted);
      width:19px;
      height:19px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      cursor:pointer;
      transition:background .15s ease,color .15s ease,transform .08s ease;
    }

    .column-actions button:hover{
      background:rgba(30,64,175,0.9);
      color:#e5e7eb;
      transform:translateY(-1px);
    }

    .dropzone{
      min-height:60px;
      border-radius:12px;
      padding:4px;
      background:rgba(15,23,42,0.9);
      border:1px dashed rgba(75,85,99,0.8);
      box-shadow:inset 0 0 0 1px rgba(15,23,42,0.9);
    }

    .dropzone.empty::before{
      content:"Ø§Ø³Ø­Ø¨ ÙˆØ£Ø³Ù‚Ø· Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ù‡Ù†Ø§";
      display:block;
      text-align:center;
      font-size:10px;
      color:rgba(148,163,184,0.8);
      padding:20px 4px;
    }

    /* Cards */
    .card{
      background:radial-gradient(circle at top left, rgba(30,64,175,0.7), rgba(15,23,42,0.98));
      border-radius:12px;
      padding:7px 8px 7px;
      margin-bottom:5px;
      border:1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      box-shadow:0 12px 35px rgba(15,23,42,0.9);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top, rgba(248,250,252,0.18), transparent 60%);
      opacity:0.5;
      pointer-events:none;
    }

    .card-main{
      position:relative;
      z-index:1;
    }

    .card-title{
      font-size:12px;
      font-weight:500;
      margin-bottom:2px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .card-title span.tag{
      font-size:9px;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(148,163,184,0.5);
      color:#e5e7eb;
    }

    .card-sub{
      font-size:10px;
      color:rgba(226,232,240,0.9);
      margin-bottom:2px;
    }

    .card-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:10px;
      margin-top:3px;
      color:rgba(209,213,219,0.9);
    }

    .card-meta .left{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }

    .badge-date{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
      font-size:9px;
    }

    .badge-date span.dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:#22c55e;
    }

    .avatar-stack{
      display:flex;
      align-items:center;
    }

    .avatar{
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      color:#020617;
      border:1.5px solid rgba(15,23,42,0.95);
      box-shadow:0 0 0 1px rgba(15,23,42,0.95);
      position:relative;
    }

    .avatar + .avatar{
      margin-right:-6px;
    }

    /* Detail modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
    }

    .modal-backdrop.show{
      display:flex;
    }

    .modal{
      background:radial-gradient(circle at top left,#111827,#020617);
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid rgba(148,163,184,0.35);
      width:min(520px,100% - 24px);
      max-height:90vh;
      overflow:auto;
      box-shadow:0 25px 70px rgba(0,0,0,0.8);
      position:relative;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }

    .modal-title{
      font-size:16px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .modal-title .subtitle{
      font-size:11px;
      color:var(--muted);
    }

    .modal-close{
      border-radius:999px;
      border:none;
      width:22px;
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.95);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
    }

    .modal-section{
      background:rgba(15,23,42,0.95);
      border-radius:14px;
      padding:8px 10px;
      border:1px solid rgba(55,65,81,0.7);
      margin-bottom:8px;
    }

    .modal-section h4{
      font-size:12px;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .modal-section h4 span.icon{
      width:16px;
      height:16px;
      border-radius:5px;
      background:radial-gradient(circle at top left,#f97316,#facc15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:#020617;
    }

    .modal-section p{
      margin:0;
      font-size:11px;
      color:#e5e7eb;
      line-height:1.5;
    }

    .modal-footer{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .modal-footer .btn-group{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .badge-status{
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
      display:inline-flex;
      align-items:center;
      gap:5px;
    }

    .badge-status span.dot{
      width:7px;
      height:7px;
      border-radius:50%;
      background:var(--accent);
    }

    /* Create/Edit task modal */
    .modal-xl{
      width:min(620px,100% - 24px);
    }

    .form-grid{
      display:grid;
      grid-template-columns: minmax(0,1.15fr) minmax(0,1.1fr);
      gap:8px 12px;
      margin-top:4px;
    }

    @media(max-width:720px){
      .form-grid{
        grid-template-columns:1fr;
      }
    }

    .form-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:11px;
    }

    .form-label{
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:4px;
    }

    .textarea{
      background:rgba(15,23,42,0.9);
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      color:var(--text);
      padding:7px 9px;
      font-size:11px;
      min-height:70px;
      resize:vertical;
      outline:none;
    }

    .textarea.campaign-full-desc{
      min-height:110px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }

    .chip{
      border-radius:999px;
      padding:3px 7px;
      font-size:10px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .chip-avatar{
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      color:#020617;
      border:1.5px solid rgba(15,23,42,0.95);
    }

    .chip-remove{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:11px;
    }

    .assignee-search-wrapper{
      position:relative;
    }

    .assignee-menu{
      position:absolute;
      inset-inline:0;
      top:100%;
      margin-top:4px;
      background:#020617;
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.8);
      padding:4px;
      z-index:50;
      max-height:180px;
      overflow:auto;
      box-shadow:0 18px 40px rgba(0,0,0,0.85);
    }

    .assignee-menu-item{
      padding:5px 7px;
      border-radius:10px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      font-size:11px;
      color:#e5e7eb;
    }

    .assignee-menu-item:hover{
      background:rgba(30,64,175,0.7);
    }

    .assignee-menu-item .avatar{
      width:20px;
      height:20px;
    }

    .badge-tag{
      font-size:9px;
      color:var(--muted);
    }

    .color-input{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .color-input input[type="color"]{
      width:30px;
      height:18px;
      padding:0;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:transparent;
    }

    .modal-footer-right{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Campaign description box */
    .campaign-desc-wrapper{
      margin-top:6px;
      margin-bottom:6px;
    }

    .campaign-desc-box{
      background:rgba(15,23,42,0.95);
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      padding:6px 8px;
      font-size:11px;
      color:#e5e7eb;
      max-height:58px;
      overflow:hidden;
      position:relative;
    }

    .campaign-desc-box.expanded{
      max-height:none;
    }

    .campaign-desc-box::after{
      content:"";
      position:absolute;
      inset-inline:0;
      bottom:0;
      height:18px;
      background:linear-gradient(to bottom, rgba(15,23,42,0), rgba(15,23,42,1));
      pointer-events:none;
    }

    .campaign-desc-toggle{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    /* Daily campaigns (right panel bottom) */
    .daily-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }

    .daily-cards{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }

    .daily-card{
      background:radial-gradient(circle at top left, rgba(56,189,248,0.5), rgba(15,23,42,0.97));
      border-radius:12px;
      padding:7px 8px;
      border:1px solid rgba(148,163,184,0.35);
      cursor:pointer;
      box-shadow:0 16px 35px rgba(15,23,42,0.85);
    }

    .daily-card-title{
      margin:0;
      font-size:12px;
      font-weight:500;
    }

    .daily-card-desc{
      margin:2px 0 0;
      font-size:11px;
      color:#e5e7eb;
    }

    /* Small toggle pills for admin/member selection in header */
    .user-role-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.4);
      font-size:10px;
      color:var(--muted);
    }

    .user-role-pill strong{
      color:#e5e7eb;
    }

    /* Hidden helper */
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="layout">
    <!-- ÙŠØ³Ø§Ø±: Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Spaces + Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰) -->
    <div class="panel" id="panelSpacesRoot">
      <div class="panel-header">
        <div class="panel-header-main">
          <div class="panel-title">
            <span class="badge-pill">
              <span class="icon">â˜…</span>
              Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ & Ø§Ù„Ø­Ù…Ù„Ø§Øª
            </span>
          </div>
          <div class="panel-subtitle">
            Ø¥Ø¯Ø§Ø±Ø© <strong>Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø¹Ù…Ù„</strong> Ù„ÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ‚: <strong>Spaces</strong> Ø¹Ø§Ù…Ø© + <strong>Ø­Ù…Ù„Ø§Øª ÙƒØ¨Ø±Ù‰</strong> Ø¨Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶Ø­.
          </div>
          <div class="muted">
            <span id="userRoleLabel"></span>
          </div>
        </div>

        <div class="panel-header-controls">
          <div class="tabs">
            <button class="tab active" id="tabSpaces">
              <span class="dot"></span>
              Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Spaces)
            </button>
            <button class="tab" id="tabCampaigns">
              <span class="dot"></span>
              Ø­Ù…Ù„Ø§Øª ÙƒØ¨Ø±Ù‰
            </button>
          </div>
        </div>
      </div>

      <!-- Spaces Panel -->
      <div id="panelSpaces">
        <div class="panel-header" style="margin-bottom:4px;">
          <div class="panel-header-main">
            <div class="panel-title">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Spaces)</span>
            </div>
            <div class="panel-subtitle">
              Ø§Ø®ØªØ± Ø§Ù„Ù€SpaceØŒ Ø«Ù… Ø§Ø³Ø­Ø¨ ÙˆØ£Ø³Ù‚Ø· Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©. Ø§Ù„Ø®Ø§ØµÙŠØ© Ù…ØªØ§Ø­Ø© Ù„ÙƒÙ„ <strong>Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</strong>.
            </div>
          </div>
          <div class="controls">
            <select id="spaceSelect">
              <option value="">Ø§Ø®ØªØ± Space...</option>
            </select>
            <input id="newGroupName" class="input" type="text" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: ØªØµÙ…ÙŠÙ…)" style="width:140px;"/>
            <button class="btn sm" id="btnAddGroup">â• Ø¹Ù…ÙˆØ¯</button>
            <button class="btn ghost sm" id="btnSpaceManage">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€Space</button>
            <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
            <button class="btn secondary" id="btnExportSpace">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
            <input id="memberFilterSpaces" class="input" placeholder="ÙÙ„ØªØ± Ø¨Ø§Ù„Ø¹Ø¶Ùˆ (Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ)">
          </div>
          <div class="muted" id="who"></div>
        </div>
        <div class="body">
          <div class="board" id="boardSpaces"></div>
        </div>
      </div>

      <!-- Campaigns Panel -->
      <div id="panelCampaigns" class="hidden">
        <div class="panel-header" style="margin-bottom:4px;">
          <div class="panel-header-main">
            <div class="panel-title">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰</span>
            </div>
            <div class="panel-subtitle">
              Ù„ÙƒÙ„ <strong>Ø­Ù…Ù„Ø© ÙƒØ¨Ø±Ù‰</strong> Ù„ÙˆØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø©ØŒ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶Ø­ Ù…Ø¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.
            </div>
          </div>
          <div class="controls">
            <select id="campaignSelect">
              <option value="">Ø§Ø®ØªØ± Ø­Ù…Ù„Ø©...</option>
            </select>
            <button class="btn sm" id="btnNewCampaignTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯ (Ø­Ù…Ù„Ø©)</button>
            <button class="btn secondary" id="btnNewCampaign" style="display:none">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <input id="memberFilterCampaigns" class="input" placeholder="ÙÙ„ØªØ± Ø¨Ø§Ù„Ø¹Ø¶Ùˆ (Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ)">
          </div>
          <!-- ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ (Ù…Ø¹ Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯) -->
          <div class="campaign-desc-wrapper">
            <div class="campaign-desc-box" id="campaignDescBox"></div>
            <div class="campaign-desc-toggle" id="campaignDescToggle" style="display:none;">
              <span>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</span>
              <span>â¬‡ï¸</span>
            </div>
          </div>
          <div class="muted" id="campaignDates"></div>
        </div>
        <div class="body">
          <div class="board" id="boardCampaigns"></div>
        </div>
      </div>
    </div>

    <!-- ÙŠÙ…ÙŠÙ†: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© + Ø­Ù…Ù„Ø§Øª ÙŠÙˆÙ…ÙŠØ© -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-header-main">
          <div class="panel-title">
            <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© & Ø­Ù…Ù„Ø§Øª ÙŠÙˆÙ…ÙŠØ©</span>
          </div>
          <div class="panel-subtitle">
            Ø±Ø§Ù‚Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ ÙˆØªØ§Ø¨Ø¹ <strong>Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</strong> ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†.
          </div>
        </div>
        <div class="panel-header-controls">
          <span class="user-role-pill">
            ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
            <strong id="currentUserName">...</strong>
          </span>
        </div>
      </div>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© -->
      <div class="body">
        <div class="muted" style="margin-bottom:6px;">
          Ø§Ø®ØªØ± Ø£ÙŠ ØªØ§Ø³Ùƒ Ù…Ù† Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡ Ù‡Ù†Ø§ØŒ Ø«Ù… Ù†ÙÙ‘Ø° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø£Ùˆ ØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.
        </div>
        <div id="selectedTaskSummary" class="muted" style="margin-bottom:6px;"></div>
        <div style="margin-bottom:10px; display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn sm" id="btnOpenDetailModal" disabled>ğŸ” ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button class="btn secondary sm" id="btnMarkDoneSelect" disabled>âœ… Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</button>
        </div>
      </div>

      <hr style="border-color:rgba(55,65,81,0.7); border-width:0 0 1px; margin:8px 0 10px;">

      <!-- Ø­Ù…Ù„Ø§Øª ÙŠÙˆÙ…ÙŠØ© -->
      <div class="body">
        <div class="daily-header">
          <div>
            <div class="panel-title" style="font-size:13px;">Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Daily)</div>
            <div class="muted">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ø£Ù‡Ù… Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ ÙˆØµÙ Ø¨Ø³ÙŠØ· Ù„Ù„Ù‡Ø¯Ù.</div>
          </div>
          <button class="btn ghost sm" id="btnRefreshDaily">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="dailyCampaignsList" class="daily-cards"></div>
      </div>
    </div>
  </div>

  <!-- Modal: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© -->
  <div class="modal-backdrop" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span id="dTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</span>
          <span class="subtitle" id="dSubtitle"></span>
        </div>
        <button class="modal-close" id="btnCloseDetail">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="modal-section">
          <h4>
            <span class="icon">â„¹ï¸</span>
            Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
          </h4>
          <p id="dBasic"></p>
        </div>

        <div class="modal-section">
          <h4>
            <span class="icon">ğŸ“</span>
            Ø§Ù„ÙˆØµÙ
          </h4>
          <p id="dDesc"></p>
        </div>

        <div class="modal-section">
          <h4>
            <span class="icon">ğŸš—</span>
            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          </h4>
          <p id="dCar"></p>
        </div>

        <div class="modal-section">
          <h4>
            <span class="icon">ğŸ‘¥</span>
            Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ†
          </h4>
          <p id="dAssignees"></p>
        </div>

        <div class="modal-section">
          <h4>
            <span class="icon">ğŸ”—</span>
            Ø±ÙˆØ§Ø¨Ø· / Ù…Ø±Ø§Ø¬Ø¹
          </h4>
          <div id="dLinks"></div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left">
          <span class="badge-status" id="dStatusBadge">
            <span class="dot"></span>
            <span id="dStatusText">Ø§Ù„Ø­Ø§Ù„Ø©</span>
          </span>
        </div>
        <div class="modal-footer-right">
          <div class="btn-group">
            <button class="btn secondary sm" id="btnMoveNext">â¡ï¸ Ù†Ù‚Ù„ Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="btn secondary sm" id="btnMarkDoneDetail">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</button>
          </div>
          <div class="btn-group">
            <button class="btn sm" id="btnEditTask">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            <button class="btn danger sm" id="btnDeleteTask">ğŸ—‘ Ø­Ø°Ù</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ø¥Ù†Ø´Ø§Ø¡ / ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ -->
  <div class="modal-backdrop" id="taskModal">
    <div class="modal modal-xl">
      <div class="modal-header">
        <div class="modal-title">
          <span id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</span>
          <span class="subtitle" id="taskModalSubtitle">Ø§ÙƒØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù„ÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ‚.</span>
        </div>
        <button class="modal-close" id="btnCloseTaskModal">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <input id="tName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆÙ†ØªØ§Ø¬ ÙÙŠØ¯ÙŠÙˆ Ø­Ù…Ù„Ø© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§" />
          </div>
          <div class="form-group">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ù…ÙˆØ¹Ø¯ Ø¯Ø§Ø®Ù„ÙŠ)</label>
            <input id="tDue" class="input" type="date"/>
          </div>
        </div>

        <div class="form-group" style="margin-top:8px;">
          <label class="form-label">Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</label>
          <textarea id="tDesc" class="textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„ØªÙØµÙŠÙ„: Ø§Ù„Ù…Ù†ØµØ§ØªØŒ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§ØªØŒ Ø§Ù„Ù…Ø¯Ø©ØŒ Ø§Ù„Ø¨Ø±ÙŠÙ..."></textarea>
        </div>

        <div class="form-grid" style="margin-top:8px;">
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø¹Ù…ÙˆØ¯ / Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
            <select id="tGroup"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Ù„ÙˆÙ† Ø§Ù„Ù…Ù‡Ù…Ø© (Ù„Ù„Ø¹ÙØ¶Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)</label>
            <div class="color-input">
              <input type="color" id="tColor" value="#bc8f74" />
              <span class="muted">ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±ÙˆØª</span>
            </div>
          </div>
        </div>

        <div class="form-grid" style="margin-top:10px;">
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ†</label>
            <div class="assignee-search-wrapper">
              <input id="tAssigneeSearch" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø£Ùˆ Ø§Ù„ØªØ§Ø¬ @tag"/>
              <div class="assignee-menu" id="assigneeMenu" style="display:none;"></div>
            </div>
            <div class="chips" id="assigneeChip" style="margin-top:6px;"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="form-grid" style="grid-template-columns: repeat(2,minmax(0,1fr)); gap:4px;">
              <select id="carBrand" class="input">
                <option value="">Ø§Ù„Ù…Ø§Ø±ÙƒØ©</option>
              </select>
              <select id="carModel" class="input">
                <option value="">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>
              </select>
              <input id="carTrim" class="input" placeholder="Ø§Ù„ÙØ¦Ø© (ÙƒÙˆÙ…ÙÙˆØ±ØªØŒ Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ…...)" />
              <input id="carEngine" class="input" placeholder="Ø§Ù„Ù…Ø­Ø±Ùƒ (Ù…Ø«Ø§Ù„: 2000 Ø³ÙŠ Ø³ÙŠ)" />
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left">
          <span class="muted">ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… <strong>@tag</strong> ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø³Ø±Ø¹Ø©.</span>
        </div>
        <div class="modal-footer-right">
          <button class="btn secondary sm" id="btnGenerateName">ğŸ§  Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          <button class="btn sm" id="btnSaveTask">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBvHcM-b1OstCKjoYQsSQ41ep3jxXg9hS4",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.appspot.com",
      messagingSenderId: "1046189442051",
      appId: "1:1046189442051:web:d0467f7c8fba52f22a42c7",
      measurementId: "G-R4V91QNXG5"
    };

    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const auth  = getAuth(app);

    /* ========= Helpers ========= */
    function el(tag, cls){
      const e=document.createElement(tag);
      if(cls) e.className=cls;
      return e;
    }

    function formatDate(date){
      if(!date) return '';
      const d=new Date(date);
      if(isNaN(d.getTime())) return date;
      return d.toLocaleDateString('ar-SA',{year:'numeric',month:'short',day:'numeric'});
    }

    function firstLetters(name){
      if(!name) return '?';
      const parts=name.split(' ');
      return (parts[0]?.[0]||'') + (parts[1]?.[0]||'');
    }

    function taskMembersArray(task){
      if(!task || !task.assignees) return [];
      return task.assignees;
    }

    function getStatusColumns(space){
      if(!space || !space.columns || !Array.isArray(space.columns)) return [];
      return space.columns;
    }

    const DEFAULT_COLUMNS = ["To Do","In progress","Review"];
    const DONE_STATUS_SPACES = "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°";

    const CAMPAIGN_DEFAULT_COLS = ["ØªØ­Ø¶ÙŠØ±","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°","Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©","ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯"];
    const DONE_STATUS_CAMPAIGN = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";

    /* ========= DOM Elements ========= */
    const panelSpacesRoot = document.getElementById('panelSpacesRoot');
    const panelSpaces     = document.getElementById('panelSpaces');
    const panelCampaigns  = document.getElementById('panelCampaigns');
    const tabSpaces       = document.getElementById('tabSpaces');
    const tabCampaigns    = document.getElementById('tabCampaigns');

    const spaceSelect     = document.getElementById('spaceSelect');
    const newGroupNameEl  = document.getElementById('newGroupName');
    const btnAddGroup     = document.getElementById('btnAddGroup');
    const btnSpaceManage  = document.getElementById('btnSpaceManage');
    const boardSpaces     = document.getElementById('boardSpaces');
    const btnExportSpace  = document.getElementById('btnExportSpace');
    const memberFilterSpacesInput = document.getElementById('memberFilterSpaces');

    const whoEl           = document.getElementById('who');

    const campaignSelect     = document.getElementById('campaignSelect');
    const boardCampaigns     = document.getElementById('boardCampaigns');
    const btnNewCampaignTask = document.getElementById('btnNewCampaignTask');
    const btnNewCampaign     = document.getElementById('btnNewCampaign');
    const campaignDates      = document.getElementById('campaignDates');
    const campaignToggle     = document.getElementById('campaignToggle');
    const memberFilterCampaignsInput = document.getElementById('memberFilterCampaigns');

    const btnOpenDetailModal  = document.getElementById('btnOpenDetailModal');
    const btnMarkDoneSelect   = document.getElementById('btnMarkDoneSelect');
    const selectedTaskSummary = document.getElementById('selectedTaskSummary');

    const dailyList     = document.getElementById('dailyCampaignsList');
    const btnRefreshDaily = document.getElementById('btnRefreshDaily');

    const userRoleLabel   = document.getElementById('userRoleLabel');
    const currentUserName = document.getElementById('currentUserName');

    /* Detail modal DOM */
    const detailModal   = document.getElementById('detailModal');
    const btnCloseDetail= document.getElementById('btnCloseDetail');
    const dTitle        = document.getElementById('dTitle');
    const dSubtitle     = document.getElementById('dSubtitle');
    const dBasic        = document.getElementById('dBasic');
    const dDesc         = document.getElementById('dDesc');
    const dCar          = document.getElementById('dCar');
    const dAssignees    = document.getElementById('dAssignees');
    const dStatusBadge  = document.getElementById('dStatusBadge');
    const dStatusText   = document.getElementById('dStatusText');
    const btnMoveNext   = document.getElementById('btnMoveNext');
    const btnMarkDoneDetail= document.getElementById('btnMarkDoneDetail');
    const btnEditTaskBtn   = document.getElementById('btnEditTask');
    const btnDeleteTaskBtn = document.getElementById('btnDeleteTask');

    /* Task modal DOM */
    const taskModal         = document.getElementById('taskModal');
    const btnCloseTaskModal = document.getElementById('btnCloseTaskModal');
    const tName             = document.getElementById('tName');
    const tDue              = document.getElementById('tDue');
    const tDesc             = document.getElementById('tDesc');
    const tGroup            = document.getElementById('tGroup');
    const tColor            = document.getElementById('tColor');
    const tAssigneeSearch   = document.getElementById('tAssigneeSearch');
    const assigneeMenu      = document.getElementById('assigneeMenu');
    const assigneeChip      = document.getElementById('assigneeChip');
    const btnSaveTask       = document.getElementById('btnSaveTask');
    const btnGenerateName   = document.getElementById('btnGenerateName');

    const carBrand  = document.getElementById('carBrand');
    const carModel  = document.getElementById('carModel');
    const carTrim   = document.getElementById('carTrim');
    const carEngine = document.getElementById('carEngine');

    const btnNewTask = document.getElementById('btnNewTask');
    const btnNewTask2 = btnNewCampaignTask; 

    const campaignDescBox    = document.getElementById('campaignDescBox');
    const campaignDescToggle = document.getElementById('campaignDescToggle');

    /* ========= Global State ========= */
    let CURRENT_USER = null;
    let USERS = [];
    let IS_ADMIN = false;

    let CURRENT_SPACE=null; let SPACE_COLUMNS=DEFAULT_COLUMNS.slice();
    let TASKS_SPACES=[]; let unsubTasksSpaces=null; let OPEN_TASK=null;
    let SPACES_CACHE = new Map(); // id -> name
    let MEMBER_FILTER_SPACES = '';

    let CURRENT_CAMPAIGN = null;
    let CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
    let TASKS_CAMPAIGNS  = [];
    let unsubTasksCampaigns = null;
    let CAMPAIGNS = [];
    let MEMBER_FILTER_CAMPAIGNS = '';

    let SELECTED_ASSIGNEES=[];
    let EDIT_TASK = null;
    let EDIT_TASK_ID = null;

    /* === Car Selector Data === */
    const CAR_MAP = {
      "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": ["Ø§Ø²ÙŠØ±Ø§","ØªÙˆØ³Ø§Ù†","Ø³ÙˆÙ†Ø§ØªØ§","Ø§Ù„Ù†ØªØ±Ø§","Ø£ÙƒØ³Ù†Øª","Ø³Ù†ØªØ§ÙÙŠ"],
      "ØªÙˆÙŠÙˆØªØ§": ["ÙƒØ§Ù…Ø±ÙŠ","Ù‡Ø§ÙŠÙ„ÙƒØ³","ÙƒÙˆØ±ÙˆÙ„Ø§","Ø±Ø§Ù ÙÙˆØ±","Ø§ÙØ§Ù„ÙˆÙ†"],
      "Ø´Ø§Ù†Ø¬Ø§Ù†":["CS35","CS75","UNI-T","UNI-K"],
      "ÙÙˆØ±Ø¯":["ØªÙˆØ±Ø³","ØªÙŠØ±ÙŠØªÙˆØ±ÙŠ","Ø§ÙƒØ³Ø¨Ù„ÙˆØ±Ø±","Ø§ÙƒØ³Ø¨Ø¯ÙŠØ´Ù†"],
      "MG":["RX5","5","ZS","RX8"],
      "Ù†ÙŠØ³Ø§Ù†":["Ø¨Ø§ØªØ±ÙˆÙ„","ØµÙ†ÙŠ","Ø§Ù„ØªÙŠÙ…Ø§","Ø§ÙƒØ³ ØªØ±ÙŠÙ„"]
    };

    function initCarSelectors(){
      carBrand.innerHTML='<option value="">Ø§Ù„Ù…Ø§Ø±ÙƒØ©</option>';
      Object.keys(CAR_MAP).forEach(b=>{
        const op=document.createElement('option');
        op.value=b; op.textContent=b;
        carBrand.appendChild(op);
      });
      carModel.innerHTML='<option value="">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>';
      carTrim.value='';
      carEngine.value='';
    }

    function fillModels(brandVal){
      carModel.innerHTML='<option value="">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>';
      if(!brandVal || !CAR_MAP[brandVal]) return;
      CAR_MAP[brandVal].forEach(m=>{
        const op=document.createElement('option');
        op.value=m; op.textContent=m;
        carModel.appendChild(op);
      });
    }

    if(carBrand){
      carBrand.addEventListener('change', e=>{
        fillModels(e.target.value);
      });
    }

    function fillGroupSelect(cols=SPACE_COLUMNS){
      tGroup.innerHTML='';
      (cols||[]).forEach(col=>{
        const op=document.createElement('option');
        op.value=col;
        op.textContent=col;
        tGroup.appendChild(op);
      });
    }

    function resetCreateForm(){
      tName.value=''; tDesc.value='';
      tDesc.classList.remove('campaign-full-desc');
      tDue.value='';
      tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.style.display='none';
      SELECTED_ASSIGNEES=[]; assigneeChip.innerHTML=''; tColor.value='#bc8f74';
      EDIT_TASK = null;
      EDIT_TASK_ID = null;
      const titleEl = document.getElementById('taskModalTitle');
      if(titleEl){ titleEl.textContent = 'ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯'; }
      fillGroupSelect();
      initCarSelectors();
    }

    function openCreate(cols=SPACE_COLUMNS){
      if(IS_ADMIN){
        EDIT_TASK = null;
        EDIT_TASK_ID = null;
        const titleEl = document.getElementById('taskModalTitle');
        if(titleEl){ titleEl.textContent = 'ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯'; }

        const isCampaignTab = !panelCampaigns.classList.contains('hidden');
        if(isCampaignTab){
          tDesc.classList.add('campaign-full-desc');
        }else{
          tDesc.classList.remove('campaign-full-desc');
        }

        taskModal.classList.add('show');
        fillGroupSelect(cols);
        initCarSelectors();
        renderAssigneeChips();
      }
    }
    function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

    function openEditTask(task){
      if(!IS_ADMIN || !task) return;
      EDIT_TASK = task;
      EDIT_TASK_ID = task.id;
      resetCreateForm();

      const isCampaign = (task.spaceId && task.spaceId === CURRENT_CAMPAIGN);
      const cols = isCampaign ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      const titleEl = document.getElementById('taskModalTitle');
      if(titleEl){ titleEl.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©'; }

      if(isCampaign){
        tDesc.classList.add('campaign-full-desc');
      }else{
        tDesc.classList.remove('campaign-full-desc');
      }

      fillGroupSelect(cols);
      if(task.status && cols.includes(task.status)){
        tGroup.value = task.status;
      }

      if(task.car){
        if(carBrand){ carBrand.value = task.car.brand || ''; }
        if(typeof fillModels === 'function'){
          fillModels(carBrand.value || '');
        }
        if(carModel){ carModel.value = task.car.model || ''; }
        if(carTrim){ carTrim.value = task.car.trim || ''; }
        if(carEngine){ carEngine.value = task.car.engine || ''; }
      }

      tName.value = task.name || '';
      tDesc.value = task.description || '';
      tDue.value  = task.due || '';

      const members = taskMembersArray(task);
      SELECTED_ASSIGNEES = members.map(m=>({
        uid: m.uid,
        name: m.name,
        color: m.color || '#bc8f74'
      }));

      if(SELECTED_ASSIGNEES.length){
        tColor.value = SELECTED_ASSIGNEES[0].color || '#bc8f74';
      }else{
        tColor.value = '#bc8f74';
      }

      renderAssigneeChips();
      taskModal.classList.add('show');
    }

    btnNewTask.addEventListener('click', ()=> openCreate(SPACE_COLUMNS));
    btnNewCampaignTask.addEventListener('click', ()=> openCreate(CAMPAIGN_COLUMNS));

    btnCloseTaskModal.addEventListener('click', closeCreate);
    taskModal.addEventListener('click', e=>{
      if(e.target===taskModal) closeCreate();
    });

    function renderAssigneeChips(){
      assigneeChip.innerHTML='';
      SELECTED_ASSIGNEES.forEach(u=>{
        const c=el('div','chip');
        const av=el('div','chip-avatar');
        av.textContent=firstLetters(u.name);
        av.style.background=u.color||'#facc15';
        const span=el('span'); span.textContent=u.name;
        const remove=el('button','chip-remove');
        remove.textContent='Ã—';
        remove.onclick=()=>{
          SELECTED_ASSIGNEES=SELECTED_ASSIGNEES.filter(x=>x.uid!==u.uid);
          renderAssigneeChips();
        };
        c.appendChild(av);
        c.appendChild(span);
        c.appendChild(remove);
        assigneeChip.appendChild(c);
      });
    }

    async function loadUsers(){
      const snapshot=await getDocs(collection(db,'users'));
      USERS=snapshot.docs.map(d=>({uid:d.id,...d.data()}));
    }

    async function getCurrentUserRole(uid){
      const userDoc=await getDoc(doc(db,'users',uid));
      if(!userDoc.exists()) return {role:'member',name:'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'};
      const data=userDoc.data();
      return {
        role: data.role||'member',
        name: data.name||data.displayName||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'
      };
    }

    function buildAvatarStack(task){
      const cont=el('div','avatar-stack');
      const members=taskMembersArray(task);
      if(!members.length){
        const av=el('div','avatar');
        av.textContent='-';
        cont.appendChild(av);
        return cont;
      }
      members.slice(0,3).forEach(u=>{
        const av=el('div','avatar');
        av.textContent=firstLetters(u.name);
        av.style.background = u.color || '#facc15';
        cont.appendChild(av);
      });
      if(members.length>3){
        const more=el('div','avatar');
        more.textContent='+'+(members.length-3);
        more.style.background='#0f172a';
        more.style.color='#e5e7eb';
        cont.appendChild(more);
      }
      return cont;
    }

    function taskCard(task){
      const card=el('div','card');
      card.dataset.id=task.id;

      const main=el('div','card-main');

      const titleRow=el('div','card-title');
      const spanTitle=el('span');
      spanTitle.textContent=task.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      titleRow.appendChild(spanTitle);

      if(task.car && (task.car.brand || task.car.model)){
        const tag=el('span','tag');
        tag.textContent=(task.car.brand||'')+' '+(task.car.model||'');
        titleRow.appendChild(tag);
      }

      main.appendChild(titleRow);

      if(task.description){
        const sub=el('div','card-sub');
        sub.textContent = task.description.length>90 ? task.description.slice(0,87)+'...' : task.description;
        main.appendChild(sub);
      }

      const meta=el('div','card-meta');
      const left=el('div','left');

      if(task.due){
        const b=el('span','badge-date');
        const dot=el('span','dot');
        b.appendChild(dot);
        const t=el('span');
        t.textContent=formatDate(task.due);
        b.appendChild(t);
        left.appendChild(b);
      }

      const right=buildAvatarStack(task);
      meta.appendChild(left);
      meta.appendChild(right);

      main.appendChild(meta);
      card.appendChild(main);
      return card;
    }

    function renderBoardColumns(board, cols, doneLabel){
      board.innerHTML='';
      [...cols, doneLabel].forEach(status=>{
        const col=el('div','column');
        col.dataset.status=status;

        const header=el('div','column-header');
        const ct=el('div','column-title');

        const dot=el('span','dot');
        ct.appendChild(dot);

        const nameSpan=el('span');
        nameSpan.textContent=status;
        ct.appendChild(nameSpan);

        const count=el('span','count');
        count.textContent='0';
        ct.appendChild(count);

        header.appendChild(ct);

        const actions=el('div','column-actions');

        if(IS_ADMIN){
          const btnRename=el('button');
          btnRename.textContent='âœ';
          btnRename.title='ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯';
          btnRename.onclick=()=>{
            const newName=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:',status);
            if(!newName) return;
            if(board===boardSpaces){
              SPACE_COLUMNS=SPACE_COLUMNS.map(c=>c===status?newName:c);
              saveSpaceColumns();
              renderBoardColumns(boardSpaces, SPACE_COLUMNS, DONE_STATUS_SPACES);
              renderTasksSpaces();
            }else{
              CAMPAIGN_COLUMNS=CAMPAIGN_COLUMNS.map(c=>c===status?newName:c);
              saveCampaignColumns();
              renderBoardColumns(boardCampaigns, CAMPAIGN_COLUMNS, DONE_STATUS_CAMPAIGN);
              renderTasksCampaigns();
            }
          };
          actions.appendChild(btnRename);

          const btnDelete=el('button');
          btnDelete.textContent='ğŸ—‘';
          btnDelete.title='Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯';
          btnDelete.onclick=()=>{
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ØŸ Ø³ÙŠØªÙ… Ù†Ù‚Ù„ ÙƒØ±ÙˆØªÙ‡ Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°".')) return;
            if(board===boardSpaces){
              SPACE_COLUMNS=SPACE_COLUMNS.filter(c=>c!==status);
              TASKS_SPACES.forEach(t=>{
                if(t.status===status) t.status=DONE_STATUS_SPACES;
              });
              saveSpaceColumns(true);
              renderBoardColumns(boardSpaces, SPACE_COLUMNS, DONE_STATUS_SPACES);
              renderTasksSpaces();
            }else{
              CAMPAIGN_COLUMNS=CAMPAIGN_COLUMNS.filter(c=>c!==status);
              TASKS_CAMPAIGNS.forEach(t=>{
                if(t.status===status) t.status=DONE_STATUS_CAMPAIGN;
              });
              saveCampaignColumns(true);
              renderBoardColumns(boardCampaigns, CAMPAIGN_COLUMNS, DONE_STATUS_CAMPAIGN);
              renderTasksCampaigns();
            }
          };
          actions.appendChild(btnDelete);
        }

        header.appendChild(actions);
        col.appendChild(header);

        const dz=el('div','dropzone');
        dz.dataset.status=status;
        dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.borderColor='#facc15'; dz.style.background='rgba(30,64,175,0.85)'; });
        dz.addEventListener('dragleave', ()=>{ dz.style.borderColor='rgba(75,85,99,0.8)'; dz.style.background='rgba(15,23,42,0.9)'; });
        dz.addEventListener('drop', e=>{
          e.preventDefault();
          dz.style.borderColor='rgba(75,85,99,0.8)';
          dz.style.background='rgba(15,23,42,0.9)';
          const id=e.dataTransfer.getData('text/plain');
          if(!id) return;
          moveTaskToStatus(id,status,board===boardSpaces?'spaces':'campaigns');
        });

        col.appendChild(dz);
        board.appendChild(col);
      });
    }

    function moveTaskToStatus(taskId,status,type){
      const arr= type==='spaces' ? TASKS_SPACES : TASKS_CAMPAIGNS;
      const task=arr.find(t=>t.id===taskId);
      if(!task) return;
      updateDoc(doc(db,'tasks',taskId),{status})
        .catch(err=>alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+err.message));
    }

    function saveSpaceColumns(withTasks=false){
      if(!CURRENT_SPACE) return;
      const ref=doc(db,'spaces', CURRENT_SPACE);
      const payload={ columns: SPACE_COLUMNS };
      setDoc(ref,payload,{merge:true});
      if(withTasks){
        TASKS_SPACES.forEach(t=>{
          if(!SPACE_COLUMNS.includes(t.status) && t.status!==DONE_STATUS_SPACES){
            t.status = DONE_STATUS_SPACES;
          }
        });
      }
    }

    function saveCampaignColumns(withTasks=false){
      if(!CURRENT_CAMPAIGN) return;
      const ref=doc(db,'campaigns', CURRENT_CAMPAIGN);
      const payload={ columns: CAMPAIGN_COLUMNS };
      setDoc(ref,payload,{merge:true});
      if(withTasks){
        TASKS_CAMPAIGNS.forEach(t=>{
          if(!CAMPAIGN_COLUMNS.includes(t.status) && t.status!==DONE_STATUS_CAMPAIGN){
            t.status = DONE_STATUS_CAMPAIGN;
          }
        });
      }
    }

    async function loadSpaces(){
      const snap=await getDocs(collection(db,'spaces'));
      SPACES_CACHE = new Map();
      spaceSelect.innerHTML='<option value="">Ø§Ø®ØªØ± Space...</option>';
      snap.forEach(docSnap=>{
        const data=docSnap.data();
        SPACES_CACHE.set(docSnap.id, data.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…');
        const op=document.createElement('option');
        op.value=docSnap.id;
        op.textContent=data.name || ('Space Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… ('+docSnap.id+')');
        spaceSelect.appendChild(op);
      });
    }

    function updateWhoLabel(){
      if(!CURRENT_SPACE){
        whoEl.textContent='Ø§Ø®ØªØ± Space Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª.';
        return;
      }
      const name = SPACES_CACHE.get(CURRENT_SPACE) || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      whoEl.innerHTML = `Space Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${name}</strong>`;
    }

    function renderTasksSpaces(){
      const board=boardSpaces;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={}; ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(s=> byStatus[s]=[]);
      const filter = (MEMBER_FILTER_SPACES || '').toLowerCase();
      TASKS_SPACES.forEach(t=>{
        if(filter){
          const members = taskMembersArray(t);
          const match = members.some(m => ((m.name||'')+'').toLowerCase().includes(filter));
          if(!match) return;
        }
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(status=>{
        const dz = board.querySelector(`.dropzone[data-status="${status}"]`);
        const col = dz?.closest('.column');
        const countEl = col ? col.querySelector('.count') : null;

        const list = byStatus[status] || [];
        if(dz){
          dz.innerHTML='';
          if(list.length===0) dz.classList.add('empty'); else dz.classList.remove('empty');
          list.forEach(t=>{
            const c=taskCard(t);
            c.draggable=true;
            c.addEventListener('dragstart', e=>{
              e.dataTransfer.setData('text/plain',t.id);
            });
            c.addEventListener('click', ()=> selectTaskFromBoard(t, 'spaces'));
            dz.appendChild(c);
          });
        }
        if(countEl) countEl.textContent=list.length;
      });
    }

    function listenTasksSpaces(){
      if(unsubTasksSpaces){ unsubTasksSpaces(); unsubTasksSpaces=null; }
      if(!CURRENT_SPACE) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasksSpaces = onSnapshot(qy,(snap)=>{
        TASKS_SPACES = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderTasksSpaces();
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Spaces).'); });

      if(memberFilterSpacesInput){
        memberFilterSpacesInput.addEventListener('input', (e)=>{
          MEMBER_FILTER_SPACES = (e.target.value||'').trim().toLowerCase();
          renderTasksSpaces();
        });
      }

    }

    const dailyRef = collection(db,'daily_campaigns');
    async function loadDailyCampaigns(){
      dailyList.innerHTML='';
      try{
        const snap=await getDocs(dailyRef);
        if(snap.empty){
          const p=el('p','muted');
          p.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª ÙŠÙˆÙ…ÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
          dailyList.appendChild(p);
          return;
        }
        snap.forEach(docSnap=>{
          const data=docSnap.data();
          const card=dailyCard(data);
          dailyList.appendChild(card);
        });
      }catch(e){
        const p=el('p','muted');
        p.textContent='ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.';
        dailyList.appendChild(p);
      }
    }

    function dailyCard(data){
      const card=el('div','daily-card');
      card.dataset.id=data.id;

      const title = data.title || '-';
      const desc  = data.description || '';

      card.innerHTML = `
        <p class="daily-card-title">${title}</p>
        ${desc?`<p class="daily-card-desc">${desc}</p>`:''}
      `;
      return card;
    }

    function buildTaskSummary(task){
      if(!task) return 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø³Ùƒ Ø¨Ø¹Ø¯.';
      const spaceName = task.spaceId && SPACES_CACHE.get(task.spaceId) ? SPACES_CACHE.get(task.spaceId) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      const members = taskMembersArray(task);
      const names = members.map(m=>m.name).join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const due   = task.due ? formatDate(task.due) : 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
      return `Ø§Ù„Ù…Ù‡Ù…Ø©: <strong>${task.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong> â€” Space: <strong>${spaceName}</strong> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: <strong>${due}</strong> â€” Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: <strong>${names}</strong>`;
    }

    function selectTaskFromBoard(task, source){
      OPEN_TASK = {...task, _source:source};
      btnOpenDetailModal.disabled=false;
      btnMarkDoneSelect.disabled=false;
      selectedTaskSummary.innerHTML = buildTaskSummary(OPEN_TASK);
    }

    function openDetailModal(){
      if(!OPEN_TASK) return;
      const task = OPEN_TASK;
      detailModal.classList.add('show');

      dTitle.textContent = task.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      const spaceName = task.spaceId && SPACES_CACHE.get(task.spaceId) ? SPACES_CACHE.get(task.spaceId) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      const sourceLabel = task._source === 'campaigns' ? 'Ø­Ù…Ù„Ø© ÙƒØ¨Ø±Ù‰' : 'Space';
      dSubtitle.textContent = `${sourceLabel} â€” ${spaceName}`;

      const createdBy = task.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const due = task.due ? formatDate(task.due) : 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
      dBasic.innerHTML = `
        <strong>Space / Ø­Ù…Ù„Ø©:</strong> ${spaceName}<br>
        <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ${due}<br>
        <strong>Ø£Ù†Ø´Ø£Ù‡Ø§:</strong> ${createdBy}
      `;

      dDesc.textContent = task.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙƒØªÙˆØ¨.';

      if(task.car && (task.car.brand || task.car.model || task.car.trim || task.car.engine)){
        const parts=[];
        if(task.car.brand) parts.push(`Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${task.car.brand}`);
        if(task.car.model) parts.push(`Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${task.car.model}`);
        if(task.car.trim)  parts.push(`Ø§Ù„ÙØ¦Ø©: ${task.car.trim}`);
        if(task.car.engine)parts.push(`Ø§Ù„Ù…Ø­Ø±Ùƒ: ${task.car.engine}`);
        dCar.innerHTML = parts.join(' â€” ');
      }else{
        dCar.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø³ÙŠØ§Ø±Ø© Ù…Ø¹ÙŠÙ†Ø©.';
      }

      const members = taskMembersArray(task);
      if(members.length){
        const names = members.map(m=>m.name).join('ØŒ ');
        dAssignees.innerHTML = `<strong>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</strong> ${names}`;
      }else{
        dAssignees.textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø­Ø¯Ø¯ÙŠÙ†.';
      }

      dStatusText.textContent = task.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const dot = dStatusBadge.querySelector('.dot');
      if(dot){
        if(task.status===DONE_STATUS_SPACES || task.status===DONE_STATUS_CAMPAIGN || task.status==='ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'){
          dot.style.background='#22c55e';
        }else if(task.status && task.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©')){
          dot.style.background='#facc15';
        }else{
          dot.style.background='#38bdf8';
        }
      }

      const showActions = IS_ADMIN;
      btnMoveNext.style.display = showActions ? '' : 'none';
      btnMarkDoneDetail.style.display = showActions ? '' : 'none';
      btnEditTask.style.display = showActions ? '' : 'none';
      btnDeleteTask.style.display = showActions ? '' : 'none';

      const linksEl=document.getElementById('dLinks');
      linksEl.innerHTML='';
      (task.links||[]).forEach((l, idx)=>{
        const chip=document.createElement('span'); chip.className='chip'; chip.dataset.idx=idx;
        const title = l.title || l.url;
        chip.innerHTML = `
          ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${title}</a>
          ${showActions?`
            <span class="chip-actions">
              <button class="link-edit" data-idx="${idx}" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
              <button class="link-delete" data-idx="${idx}" title="Ø­Ø°Ù">ğŸ—‘</button>
            </span>`:''}
        `;
        linksEl.appendChild(chip);
      });

      if(showActions){
        const btnAddLink=el('button','btn ghost sm');
        btnAddLink.textContent='â• Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·';
        btnAddLink.onclick=()=> addLinkToTask(task);
        linksEl.appendChild(document.createElement('br'));
        linksEl.appendChild(document.createElement('br'));
        linksEl.appendChild(btnAddLink);

        linksEl.addEventListener('click', async (e)=>{
          if(e.target.classList.contains('link-edit')){
            const idx=parseInt(e.target.dataset.idx,10);
            const current=task.links[idx];
            const newTitle=prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:', current.title||''); if(newTitle===null) return;
            const newUrl=prompt('Ø§Ù„Ø±Ø§Ø¨Ø· (URL):', current.url||''); if(newUrl===null) return;
            const newLinks=[...(task.links||[])];
            newLinks[idx]={...newLinks[idx],title:newTitle,url:newUrl};
            try{
              await updateDoc(doc(db,'tasks',task.id),{links:newLinks});
              task.links=newLinks;
              openDetailModal();
            }catch(err){ alert('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·: '+err.message); }
          }
          if(e.target.classList.contains('link-delete')){
            const idx=parseInt(e.target.dataset.idx,10);
            if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·ØŸ')) return;
            const newLinks=(task.links||[]).filter((_,i)=>i!==idx);
            try{
              await updateDoc(doc(db,'tasks',task.id),{links:newLinks});
              task.links=newLinks;
              openDetailModal();
            }catch(err){ alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·: '+err.message); }
          }
        },{once:true});
      }
    }

    async function addLinkToTask(task){
      const title=prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù„Ù Ø§Ù„Ø¨Ø±ÙŠÙ Ø¹Ù„Ù‰ Google Docs):');
      if(!title) return;
      const url=prompt('Ø±Ø§Ø¨Ø· URL:');
      if(!url) return;
      const newLinks=[...(task.links||[]),{title,url}];
      try{
        await updateDoc(doc(db,'tasks',task.id),{links:newLinks});
        task.links=newLinks;
        openDetailModal();
      }catch(err){
        alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø·: '+err.message);
      }
    }

    btnOpenDetailModal.addEventListener('click', openDetailModal);
    btnCloseDetail.addEventListener('click', ()=> detailModal.classList.remove('show'));
    detailModal.addEventListener('click', e=>{
      if(e.target===detailModal) detailModal.classList.remove('show');
    });

    btnMarkDoneSelect.addEventListener('click', ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const type = OPEN_TASK._source==='campaigns' ? 'campaigns' : 'spaces';
      const status = type==='campaigns' ? DONE_STATUS_CAMPAIGN : DONE_STATUS_SPACES;
      moveTaskToStatus(OPEN_TASK.id, status, type);
    });

    btnMoveNext.addEventListener('click', ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const type=OPEN_TASK._source==='campaigns'?'campaigns':'spaces';
      const cols = type==='campaigns'?CAMPAIGN_COLUMNS:SPACE_COLUMNS;
      const done = type==='campaigns'?DONE_STATUS_CAMPAIGN:DONE_STATUS_SPACES;
      const all=[...cols,done];
      const idx=all.indexOf(OPEN_TASK.status);
      const nextStatus = idx===-1 || idx===all.length-1 ? done : all[idx+1];
      moveTaskToStatus(OPEN_TASK.id,nextStatus,type);
    });

    btnMarkDoneDetail.addEventListener('click', ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const type = OPEN_TASK._source==='campaigns'?'campaigns':'spaces';
      const done = type==='campaigns'?DONE_STATUS_CAMPAIGN:DONE_STATUS_SPACES;
      moveTaskToStatus(OPEN_TASK.id,done,type);
    });

    document.getElementById('btnEditTask').addEventListener('click', ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const detailModal = document.getElementById('detailModal');
      if(detailModal){ detailModal.classList.remove('show'); }
      openEditTask(OPEN_TASK);
    });

    document.getElementById('btnDeleteTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
      try{
        await deleteDoc(doc(db,'tasks', OPEN_TASK.id));
        detailModal.classList.remove('show');
      }catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message); }
    });

    spaceSelect.addEventListener('change', ()=>{
      CURRENT_SPACE=spaceSelect.value || null;
      updateWhoLabel();
      if(!CURRENT_SPACE){
        boardSpaces.innerHTML='';
        if(unsubTasksSpaces){unsubTasksSpaces();unsubTasksSpaces=null;}
        return;
      }
      loadSpaceMeta(CURRENT_SPACE);
      listenTasksSpaces();
    });

    async function loadSpaceMeta(id){
      const ref=doc(db,'spaces',id);
      const snap=await getDoc(ref);
      if(!snap.exists()){
        SPACE_COLUMNS=DEFAULT_COLUMNS.slice();
      }else{
        const data=snap.data();
        SPACE_COLUMNS = getStatusColumns(data).length ? getStatusColumns(data) : DEFAULT_COLUMNS.slice();
      }
      renderBoardColumns(boardSpaces, SPACE_COLUMNS, DONE_STATUS_SPACES);
      renderTasksSpaces();
    }

    async function loadCampaigns(){
      const snap=await getDocs(collection(db,'campaigns'));
      CAMPAIGNS = snap.docs.map(d=>({id:d.id,...d.data()}));
      campaignSelect.innerHTML='<option value="">Ø§Ø®ØªØ± Ø­Ù…Ù„Ø©...</option>';
      CAMPAIGNS.forEach(c=>{
        const op=document.createElement('option');
        op.value=c.id;
        op.textContent=c.name || ('Ø­Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… ('+c.id+')');
        campaignSelect.appendChild(op);
      });
    }

    campaignSelect.addEventListener('change', ()=>{
      CURRENT_CAMPAIGN = campaignSelect.value || null;
      if(!CURRENT_CAMPAIGN){
        boardCampaigns.innerHTML='';
        campaignDates.textContent='';
        campaignDescBox.textContent='';
        campaignDescToggle.style.display='none';
        if(unsubTasksCampaigns){unsubTasksCampaigns();unsubTasksCampaigns=null;}
        return;
      }
      loadCampaignMeta(CURRENT_CAMPAIGN);
      listenTasksCampaigns();
    });

    async function loadCampaignMeta(id){
      const ref=doc(db,'campaigns',id);
      const snap=await getDoc(ref);
      if(!snap.exists()){
        CAMPAIGN_COLUMNS=CAMPAIGN_DEFAULT_COLS.slice();
        campaignDates.textContent='';
        campaignDescBox.textContent='';
        campaignDescToggle.style.display='none';
      }else{
        const data=snap.data();
        CAMPAIGN_COLUMNS = Array.isArray(data.columns)&&data.columns.length?data.columns:CAMPAIGN_DEFAULT_COLS.slice();
        const start = data.startDate ? formatDate(data.startDate) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const end   = data.endDate   ? formatDate(data.endDate)   : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        campaignDates.innerHTML = `Ù…Ù† <strong>${start}</strong> Ø¥Ù„Ù‰ <strong>${end}</strong>`;

        const desc=data.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙƒØªÙˆØ¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©.';
        campaignDescBox.textContent=desc;
        campaignDescBox.classList.remove('expanded');
        if(desc.length>140){
          campaignDescToggle.style.display='';
          campaignDescToggle.innerHTML='<span>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</span><span>â¬‡ï¸</span>';
        }else{
          campaignDescToggle.style.display='none';
        }
      }
      renderBoardColumns(boardCampaigns, CAMPAIGN_COLUMNS, DONE_STATUS_CAMPAIGN);
      renderTasksCampaigns();
    }

    campaignDescToggle.addEventListener('click', ()=>{
      if(!campaignDescBox.textContent) return;
      const expanded = campaignDescBox.classList.toggle('expanded');
      if(expanded){
        campaignDescToggle.innerHTML='<span>Ø¹Ø±Ø¶ Ø£Ù‚Ù„</span><span>â¬†ï¸</span>';
      }else{
        campaignDescToggle.innerHTML='<span>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</span><span>â¬‡ï¸</span>';
      }
    });

    function renderTasksCampaigns(){
      const board=boardCampaigns;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={};
      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(s=> byStatus[s]=[]);
      const filter = (MEMBER_FILTER_CAMPAIGNS || '').toLowerCase();
      TASKS_CAMPAIGNS.forEach(t=>{
        if(filter){
          const members = taskMembersArray(t);
          const match = members.some(m => ((m.name||'')+'').toLowerCase().includes(filter));
          if(!match) return;
        }
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(status=>{
        const dz = board.querySelector(`.dropzone[data-status="${status}"]`);
        const col = dz?.closest('.column');
        const countEl = col ? col.querySelector('.count') : null;

        const list = byStatus[status] || [];
        if(dz){
          dz.innerHTML='';
          if(list.length===0) dz.classList.add('empty'); else dz.classList.remove('empty');
          list.forEach(t=>{
            const c=taskCard(t);
            c.draggable=true;
            c.addEventListener('dragstart', e=>{
              e.dataTransfer.setData('text/plain',t.id);
            });
            c.addEventListener('click', ()=> selectTaskFromBoard(t,'campaigns'));
            dz.appendChild(c);
          });
        }
        if(countEl) countEl.textContent=list.length;
      });
    }

    function listenTasksCampaigns(){
      if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
      if(!CURRENT_CAMPAIGN) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_CAMPAIGN));
      unsubTasksCampaigns = onSnapshot(qy,(snap)=>{
        TASKS_CAMPAIGNS = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderTasksCampaigns();
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Ø§Ù„Ø­Ù…Ù„Ø§Øª).'); });

      if(memberFilterCampaignsInput){
        memberFilterCampaignsInput.addEventListener('input', (e)=>{
          MEMBER_FILTER_CAMPAIGNS = (e.target.value||'').trim().toLowerCase();
          renderTasksCampaigns();
        });
      }

    }

    async function createMentionNotifications({taskId, taskName, taskDescription, spaceId, status, assignees}){
      try{
        if(!assignees || !assignees.length) return;
        for(const u of assignees){
          const notifRef = doc(collection(db,'notifications'));
          await setDoc(notifRef,{
            userId: u.uid,
            type: 'task_mention',
            taskId,
            taskName,
            taskDescription,
            spaceId,
            status,
            createdAt: serverTimestamp(),
            read: false
          });
        }
      }catch(err){
        console.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù†',err);
      }
    }

    btnSaveTask.addEventListener('click', async ()=>{
      const isCampaignTab = !panelCampaigns.classList.contains('hidden');
      const targetSpaceId = isCampaignTab ? CURRENT_CAMPAIGN : CURRENT_SPACE;
      const targetCols    = isCampaignTab ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      if(!IS_ADMIN) return alert('Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ†');
      if(!EDIT_TASK_ID && !targetSpaceId) return alert('Ø§Ø®ØªØ± Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹');

      if(!tName.value.trim()) buildAutoTaskName();
      const name=tName.value.trim();
      if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');

      const due=tDue.value||null;
      const description=tDesc.value||null;
      const color=(document.getElementById('tColor').value||'#bc8f74').trim();
      const status=tGroup.value || (targetCols[0]||'Ø¹Ù…ÙˆØ¯');

      const car = {
        brand:  carBrand?.value?.trim()  || null,
        model:  carModel?.value?.trim()  || null,
        trim:   carTrim?.value?.trim()   || null,
        engine: carEngine?.value?.trim() || null
      };

      const assigneesPayload = SELECTED_ASSIGNEES.map(u=>({
        uid: u.uid,
        name: u.name,
        color: color
      }));

      try{
        for(const u of assigneesPayload){
          await setDoc(doc(db,'users', u.uid), { color }, { merge:true });
          const idx=USERS.findIndex(x=>x.uid===u.uid);
          if(idx>-1) USERS[idx].color=color;
        }

        if(EDIT_TASK_ID){
          const taskRef = doc(db,'tasks', EDIT_TASK_ID);
          const patch = {
            name,
            description,
            due,
            status,
            car,
            assignees: assigneesPayload.length ? assigneesPayload : null,
            assignee: assigneesPayload.length ? assigneesPayload[0] : null
          };
          await updateDoc(taskRef, patch);
          alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©');
          closeCreate();
        }else{
          const payload = {
            spaceId: targetSpaceId, name, description, due, status,
            car,
            assignees: assigneesPayload.length ? assigneesPayload : null,
            assignee: assigneesPayload.length ? assigneesPayload[0] : null,
            links: [],
            createdBy: CURRENT_USER?.uid || null,
            createdAt: serverTimestamp(),
            active:true,
            order: Date.now()
          };
          const ref = await addDoc(collection(db,'tasks'), payload);

          await createMentionNotifications({
            taskId: ref.id,
            taskName: name,
            taskDescription: description,
            spaceId: targetSpaceId,
            status,
            assignees: assigneesPayload
          });

          alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ');
          closeCreate();
        }
      }catch(e){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+(e?.message||e)); }
    });

    function buildAutoTaskName(){
      const brand=carBrand?.value?.trim();
      const model=carModel?.value?.trim();
      const spaceName = CURRENT_SPACE && SPACES_CACHE.get(CURRENT_SPACE) ? SPACES_CACHE.get(CURRENT_SPACE) : '';
      let name='';
      if(brand || model){
        name = [brand,model].filter(Boolean).join(' ');
      }
      if(!name && tDesc.value){
        name = tDesc.value.slice(0,40)+'...';
      }
      if(!name && spaceName){
        name = 'ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯ - '+spaceName;
      }
      if(!name){
        name = 'ØªØ§Ø³Ùƒ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      }
      tName.value=name;
    }

    btnGenerateName.addEventListener('click', buildAutoTaskName);

    function filterUsers(term){
      term = term.trim();
      if(!term) return USERS;
      const lower=term.toLowerCase();
      if(term.startsWith('@')){
        const tag=lower.slice(1);
        return USERS.filter(u=>(u.tag||'').toLowerCase().includes(tag));
      }
      return USERS.filter(u=>(u.name||'').toLowerCase().includes(lower));
    }

    tAssigneeSearch.addEventListener('input', ()=>{
      const term=tAssigneeSearch.value;
      const list=filterUsers(term);
      assigneeMenu.innerHTML='';
      if(!list.length){
        assigneeMenu.style.display='none';
        return;
      }
      list.forEach(u=>{
        const item=el('div','assignee-menu-item');
        const av=el('div','avatar');
        av.textContent=firstLetters(u.name||u.tag);
        av.style.background = u.color || '#facc15';
        item.appendChild(av);
        const info=el('div');
        const nameSpan=el('div');
        nameSpan.textContent=u.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        const tagSpan=el('div','badge-tag');
        if(u.tag) tagSpan.textContent='@'+u.tag;
        info.appendChild(nameSpan);
        if(u.tag) info.appendChild(tagSpan);
        item.appendChild(info);
        item.onclick=()=>{
          if(!SELECTED_ASSIGNEES.find(x=>x.uid===u.uid)){
            SELECTED_ASSIGNEES.push({
              uid:u.uid,
              name:u.name || u.tag || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
              color: tColor.value || u.color || '#facc15'
            });
            renderAssigneeChips();
          }
          assigneeMenu.style.display='none';
          tAssigneeSearch.value='';
        };
        assigneeMenu.appendChild(item);
      });
      assigneeMenu.style.display='block';
    });

    document.addEventListener('click', (e)=>{
      if(!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch){
        assigneeMenu.style.display='none';
      }
    });

    tabSpaces.addEventListener('click', ()=>{
      tabSpaces.classList.add('active');
      tabCampaigns.classList.remove('active');
      panelSpaces.classList.remove('hidden');
      panelCampaigns.classList.add('hidden');
    });

    tabCampaigns.addEventListener('click', ()=>{
      tabCampaigns.classList.add('active');
      tabSpaces.classList.remove('active');
      panelCampaigns.classList.remove('hidden');
      panelSpaces.classList.add('hidden');
    });

    btnRefreshDaily.addEventListener('click', loadDailyCampaigns);

    btnExportSpace.addEventListener('click', async ()=>{
      if(!CURRENT_SPACE){
        alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return;
      }
      if(!TASKS_SPACES.length){
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ù„Ù„ØªØµØ¯ÙŠØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù€Space.');
        return;
      }
      try{
        let csv = 'Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©,Ø§Ù„ÙˆØµÙ,Ø§Ù„Ø­Ø§Ù„Ø©,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…,Space,Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†,Ø§Ù„Ù…Ø§Ø±ÙƒØ©,Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„,Ø§Ù„ÙØ¦Ø©,Ø§Ù„Ù…Ø­Ø±Ùƒ\\n';
        TASKS_SPACES.forEach(t=>{
          const members = taskMembersArray(t).map(m=>m.name).join(' / ');
          const spaceName = SPACES_CACHE.get(t.spaceId) || '';
          const car = t.car || {};
          const row = [
            (t.name||'').replace(/,/g,'ØŒ'),
            (t.description||'').replace(/,/g,'ØŒ'),
            (t.status||'').replace(/,/g,'ØŒ'),
            t.due||'',
            spaceName.replace(/,/g,'ØŒ'),
            members.replace(/,/g,'ØŒ'),
            (car.brand||'').replace(/,/g,'ØŒ'),
            (car.model||'').replace(/,/g,'ØŒ'),
            (car.trim||'').replace(/,/g,'ØŒ'),
            (car.engine||'').replace(/,/g,'ØŒ')
          ].join(',');
          csv += row + '\\n';
        });

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href=url;
        const spaceName = SPACES_CACHE.get(CURRENT_SPACE) || 'space';
        a.download = `tasks_${spaceName}_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }catch(err){
        alert('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: '+(err.message||err));
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        CURRENT_USER=null;
        currentUserName.textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        userRoleLabel.innerHTML='Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ (Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)</strong>';
        return;
      }
      CURRENT_USER=user;
      currentUserName.textContent=user.displayName || user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';

      await loadUsers();
      const {role,name} = await getCurrentUserRole(user.uid);
      IS_ADMIN = (role==='admin' || role==='manager');
      currentUserName.textContent = name || currentUserName.textContent;
      userRoleLabel.innerHTML = `Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${IS_ADMIN?'Ø£Ø¯Ù…Ù† / Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ ÙØ±ÙŠÙ‚'}</strong>`;

      if(!IS_ADMIN){
        btnSpaceManage.style.display='none';
        btnAddGroup.style.display='none';
        newGroupNameEl.style.display='none';
        btnNewCampaign.style.display='none';
      }else{
        btnSpaceManage.style.display='';
        btnAddGroup.style.display='';
        newGroupNameEl.style.display='';
        btnNewCampaign.style.display='';
      }

      await loadSpaces();
      await loadCampaigns();
      await loadDailyCampaigns();
    });
  </script>

</body>
</html>
