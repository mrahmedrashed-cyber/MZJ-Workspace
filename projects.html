

<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€” MZJ Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<meta content="light" name="color-scheme"/>
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Unified UI -->
<link href="mzj-ui (1)_fixed.css?v=1" rel="stylesheet"/>
<style id="noFlash">html{background:#fff8ef} body{background:#fff8ef}</style>
<style>
/* ===== Campaigns (Admin) â€” scoped to .camp ===== */
.camp{ display:block; }
.camp .camp-controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.camp .camp-select,.camp .camp-input{
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--card);
  font-family:inherit;
}
.camp .camp-btn{
  padding:10px 12px;
  border-radius:12px;
  border:0;
  background:var(--brown);
  color:#fff;
  cursor:pointer;
  font-weight:800;
}
.camp .camp-btn.secondary{
  background:transparent;
  color:var(--brown);
  border:1px solid var(--brown);
}
.camp .camp-btn.danger{ background:#b91c1c; color:#fff; }
.camp .camp-muted{ color:var(--muted); }
.camp .board{ display:grid; gap:14px; grid-template-columns:repeat(4,1fr); }
@media(max-width:1400px){ .camp .board{ grid-template-columns:repeat(3,1fr);} }
@media(max-width:980px){ .camp .board{ grid-template-columns:repeat(2,1fr);} }
@media(max-width:640px){ .camp .board{ grid-template-columns:1fr;} }

.camp .col{
  background:var(--card);
  border-radius:14px;
  display:flex;
  flex-direction:column;
  min-height:260px;
  position:relative;
  border:1px solid rgba(231,229,228,.8);
}
body.mzj.dark .camp .col{ border-color: rgba(255,255,255,.10); }

.camp .col-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  border-bottom:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  border-top-left-radius:14px;
  border-top-right-radius:14px;
}
body.mzj.dark .camp .col-head{
  background: rgba(255,255,255,.06);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.camp .col-title{ color:var(--brown); font-weight:800; }
.camp .col-actions{ display:flex; gap:6px; }
.camp .col-actions .icon{
  cursor:pointer;
  font-size:13px;
  padding:6px 8px;
  border:1px solid #e9d8cc;
  border-radius:10px;
  background:#fff;
}
body.mzj.dark .camp .col-actions .icon{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
  color: var(--text);
}
.camp .col-body{ padding:10px; display:grid; gap:10px; }
.camp .dropzone{
  min-height:140px;
  border:2px dashed transparent;
  border-radius:12px;
  transition:.15s;
}
.camp .dropzone.drag{
  border-color:#e5d2c6;
  background:#fffaf5;
}
body.mzj.dark .camp .dropzone.drag{
  background: rgba(255,255,255,.06);
  border-color: rgba(188,143,116,.5);
}

/* Task Cards */
.camp .task-card{
  background:var(--card);
  border:1px solid rgba(231,229,228,.8);
  border-radius:12px;
  padding:8px 9px 10px;
  box-shadow:0 8px 20px rgba(62,36,32,.06);
  cursor:pointer;
  transition:.12s transform, .12s box-shadow;
  min-height:80px;
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:13px;
}
body.mzj.dark .camp .task-card{ border-color: rgba(255,255,255,.10); box-shadow:none; }
.camp .task-card:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 24px rgba(62,36,32,.12);
}
.camp .card-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:6px; }
.camp .task-card h4{
  margin:0;
  color:var(--brown);
  font-size:14px;
  line-height:1.4;
  font-weight:800;
}
body.mzj.dark .camp .task-card h4{ color: #fff; }
.camp .card-actions{ display:flex; flex-direction:column; gap:2px; margin-inline-start:4px; }
.camp .card-move{
  border:1px solid #e5e7eb;
  border-radius:6px;
  background:#fff;
  font-size:10px;
  padding:2px 4px;
  cursor:pointer;
  line-height:1;
}
.camp .card-move:hover{ background:#fff8ef; border-color:#e5d2c6; }
body.mzj.dark .camp .card-move{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); color:#fff; }
.camp .card-hint{ margin:2px 0 0; font-size:11px; color:var(--muted); }

.camp .links-row{ display:flex; flex-wrap:wrap; gap:4px; margin-top:2px; }
.camp .task-link{
  font-size:11px;
  padding:3px 6px;
  border-radius:999px;
  border:1px dashed #e5d2c6;
  background:#fffaf5;
  color:var(--brown);
  text-decoration:none;
}
.camp .task-link:hover{ background:#f7e9e0; }
body.mzj.dark .camp .task-link{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color:#fff; }

.camp .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px; }
.camp .badge{
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  background:#f7e9e0;
  color:var(--brown);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
body.mzj.dark .camp .badge{ background: rgba(255,255,255,.08); color:#fff; }
.camp .badge .dot{ inline-size:8px; block-size:8px; border-radius:999px; background:var(--beige); }
.camp .small{ font-size:12px; color:var(--muted); }

/* Modals */
.camp .modal-campaign, .camp .modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  place-items:center;
  padding:18px;
  z-index:999;
}
.camp .modal.show, .camp .modal-campaign.show{ display:grid; }
.camp .campaign-sheet, .camp .sheet{
  background:var(--card);
  border-radius:16px;
  width:min(820px, 100%);
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 30px 80px rgba(62,36,32,.25);
  border:1px solid rgba(231,229,228,.8);
}
body.mzj.dark .camp .campaign-sheet, body.mzj.dark .camp .sheet{
  border-color: rgba(255,255,255,.10);
  box-shadow:none;
}
.camp .campaign-sheet .head, .camp .sheet .head{
  padding:12px 16px;
  border-bottom:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  font-weight:800;
  font-size:18px;
  color:var(--brown);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
body.mzj.dark .camp .campaign-sheet .head, body.mzj.dark .camp .sheet .head{
  background: rgba(255,255,255,.06);
  border-bottom:1px solid rgba(255,255,255,.10);
  color:#fff;
}
.camp .campaign-sheet .body, .camp .sheet .body{
  padding:16px;
  overflow-y:auto;
  display:grid;
  gap:14px;
}
.camp .campaign-sheet .footer, .camp .sheet .footer{
  padding:12px 16px;
  border-top:1px solid rgba(231,229,228,.8);
  background:rgba(255,248,239,.70);
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
body.mzj.dark .camp .campaign-sheet .footer, body.mzj.dark .camp .sheet .footer{
  background: rgba(255,255,255,.06);
  border-top:1px solid rgba(255,255,255,.10);
}

/* Form */
.camp .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:900px){ .camp .grid2{ grid-template-columns:1fr; } }
.camp label{ display:block; margin:4px 0 4px; font-weight:700; color:var(--brown); font-size:13px; }
body.mzj.dark .camp label{ color:#fff; }
.camp input, .camp select, .camp textarea{
  width:100%;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#fff;
  font-family:inherit;
  font-size:14px;
}
body.mzj.dark .camp input, body.mzj.dark .camp select, body.mzj.dark .camp textarea{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
  color:#fff;
}
.camp textarea{ min-height:90px; resize:vertical; }
.camp input:focus, .camp select:focus, .camp textarea:focus{
  outline:3px solid rgba(188,143,116,.25);
  border-color:var(--beige);
}

/* Date inputs helpers */
.camp .date-input-wrap{
  display:flex;
  align-items:center;
  border-radius:12px;
  border:1px solid #e5e7eb;
  background:#fff;
  padding-inline:6px;
  transition:.15s border-color, .15s box-shadow, .15s background;
}
.camp .date-input-wrap:focus-within{
  border-color:var(--beige);
  box-shadow:0 0 0 3px rgba(188,143,116,.15);
  background:#fffbf7;
}
body.mzj.dark .camp .date-input-wrap{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
}
.camp .date-input-wrap input{ border:0; background:transparent; padding:8px 6px; }
.camp .date-input-wrap input:focus{ outline:none; box-shadow:none; }
.camp .date-icon{ font-size:15px; color:var(--muted); padding-inline:4px; }
.camp .date-helper{ font-size:11px; color:var(--muted); }

/* Quill boxes */
.camp #campaignDescEditor, .camp #editCampDescEditor{
  height:230px;
  border:1px solid #ddd;
  border-radius:12px;
  background:#fff;
}
body.mzj.dark .camp #campaignDescEditor, body.mzj.dark .camp #editCampDescEditor{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
}
.camp .dropdown-menu{
  position:fixed;
  background:#fff;
  border:1px solid #eee;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(62,36,32,.12);
  display:none;
  min-width:260px;
  max-height:260px;
  overflow:auto;
  z-index:1000;
}
body.mzj.dark .camp .dropdown-menu{
  background: rgba(17,17,19,.92);
  border-color: rgba(255,255,255,.10);
  color:#fff;
  box-shadow:none;
}
.camp .dd-item{
  padding:8px 10px;
  border-bottom:1px solid #f3f3f3;
  cursor:pointer;
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
}
.camp .dd-item:hover{ background:#fff8ef; }
body.mzj.dark .camp .dd-item{ border-bottom-color: rgba(255,255,255,.08); }
body.mzj.dark .camp .dd-item:hover{ background: rgba(255,255,255,.06); }

/* Links form */
.camp .links-form{ display:flex; flex-direction:column; gap:6px; margin-bottom:6px; }
.camp .link-row{ display:flex; gap:6px; align-items:center; }
.camp .link-row input{ flex:1; }
.camp .link-row .link-title{ max-width:190px; }
.camp .link-remove{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  cursor:pointer;
  font-size:12px;
}
.camp .link-remove:hover{ background:#fff8ef; border-color:#e5d2c6; }
body.mzj.dark .camp .link-remove{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); color:#fff; }

.camp .btn-link-add{ margin-top:4px; padding:6px 10px; font-size:12px; }
</style>
</link><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/><style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--brown);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 20px rgba(62,36,32,.2)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}

    /* Notifications */
    .notif-wrapper{position:relative;margin-inline-start:4px}
    .notif-bell{
      background:none;border:none;cursor:pointer;
      position:relative;padding:6px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      transition:background .15s;
    }
    .notif-bell:hover{background:rgba(255,255,255,.18)}
    .notif-badge{
      position:absolute;top:-2px;left:-2px;
      min-width:16px;height:16px;border-radius:999px;
      background:#ef4444;color:#fff;font-size:10px;
      display:none;align-items:center;justify-content:center;
      padding:0 4px;
    }
    .notif-dropdown{
      position:absolute;top:130%;inset-inline-end:0;
      width:320px;max-height:360px;overflow-y:auto;
      background:#fff;border-radius:12px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      padding:8px 0;z-index:40;display:none;
    }
    .notif-dropdown-header{
      padding:8px 14px;border-bottom:1px solid #e5e7eb;
      display:flex;align-items:center;justify-content:space-between;
      font-size:13px;color:var(--brown);font-weight:700;
    }
    .notif-dropdown-header button{
      background:none;border:none;color:var(--muted);
      font-size:11px;cursor:pointer;
    }
    .notif-list{max-height:300px;overflow-y:auto}
    .notif-item{
      width:100%;text-align:right;background:none;border:0;
      padding:8px 14px;cursor:pointer;
      display:flex;flex-direction:column;gap:4px;
      border-bottom:1px solid #f3f4f6;
    }
    .notif-item.unread{background:#fff8ef}
    .notif-item-message{font-size:13px;color:var(--text)}
    .notif-item-meta{font-size:11px;color:var(--muted)}

    .page{padding:18px;display:grid;gap:16px}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:800;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .hidden{display:none !important}

    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 12px 30px rgba(62,36,32,.12)}
    .panel .head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .panel .body{padding:12px 14px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select,.input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}
    .btn.danger{background:#b91c1c;color:#fff}
    .btn.xs{padding:4px 8px;font-size:11px;border-radius:999px}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}

    /* Board Ø¹Ø§Ù… */
    .board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}
    .col{background:#fff;border-radius:14px;display:flex;flex-direction:column;min-height:240px;position:relative}
    .col-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #f2e7df;background:#fff8ef;border-top-left-radius:14px;border-top-right-radius:14px;cursor:grab}
    .col-title{color:var(--brown);font-weight:800}
    .col-actions{display:none;gap:6px}
    .col-actions .icon{cursor:pointer;font-size:13px;padding:6px 8px;border:1px solid #e9d8cc;border-radius:10px;background:#fff}
    .col-body{padding:10px;display:grid;gap:10px}
    .dropzone{min-height:120px;border:2px dashed transparent;border-radius:12px;transition:.15s}
    .dropzone.drag{border-color:#e5d2c6;background:#fffaf5}

    .grip{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#6b7280;user-select:none}
    .grip .dots{letter-spacing:2px;font-weight:700}

    /* Cards */
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px;box-shadow:0 8px 20px rgba(62,36,32,.06);cursor:grab}
    .card h4{margin:0;color:var(--brown);font-size:15px;line-height:1.4}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row.between{justify-content:space-between;align-items:flex-start}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .badge .dot{inline-size:8px;block-size:8px;border-radius:999px;background:#bc8f74}
    .small{font-size:12px;color:var(--muted)}
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØ§Ø±Øª Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙÙˆÙ‚Ù‡ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ */
    .card.drag-over{
      outline:2px dashed #e5d2c6;
      outline-offset:2px;
    }

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:16px;z-index:99}
    .modal.show{display:grid}
    .sheet{background:#fff;border-radius:16px;max-width:760px;width:100%;box-shadow:0 30px 80px rgba(62,36,32,.25);display:flex;flex-direction:column;max-height:90vh}
    .sheet .head{padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .sheet .body{padding:12px 12px;display:grid;gap:8px;flex:1;overflow:auto}
    .sheet .footer{padding:10px 12px;border-top:1px solid #eee;background:#fff8ef;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;position:sticky;bottom:0}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:800px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 4px;font-weight:700;color:var(--brown);font-size:13px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-family:inherit;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fff;font-size:12px}
    .chip .chip-actions{display:inline-flex;gap:6px}
    .chip button{border:0;background:#fff;padding:4px 6px;border-radius:8px;cursor:pointer;font-size:11px}
    .chip button:hover{background:#fff8ef}

    /* Ù…Ø±Ø¨Ø¹ ÙˆØµÙ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© (detail) */
    .desc-box{
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      min-height:220px;
      max-height:420px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.6;
      font-size:14px;
      font-family:inherit;
    }

    /* Ù…Ø±Ø¨Ø¹ ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Campaign Task) */
    .campaign-full-desc{
      width: 100%;
      min-height: 520px;
      height: auto;
      max-height: none;
      resize: vertical;
      padding: 14px;
      font-size: 15px;
      line-height: 1.8;
      border: 1px solid #d8b9a4;
      border-radius: 14px;
      background: #fffdfa;
      box-shadow: 0 4px 14px rgba(188,143,116,.25);
      overflow-y: visible;
      white-space: pre-wrap;
    }

    .campaign-desc-wrapper{
      flex:1;
      min-width:260px;
      max-width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .campaign-desc{
      background:#fffdfa;
      border:1px solid #f2e7df;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      line-height:1.8;
      max-height:130px;
      overflow:hidden;
      position:relative;
      color:var(--text);
    }
    .campaign-desc::after{
      content:"";
      position:absolute;
      left:0;right:0;bottom:0;
      height:40px;
      background:linear-gradient(to top,#fffdfa,rgba(255,253,250,0));
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .campaign-desc.expanded{
      max-height:none;
    }
    .campaign-desc.expanded::after{
      opacity:0;
    }
    .btn-see-more{
      align-self:flex-end;
      font-size:12px;
      padding:4px 10px;
    }

    .dropdown-menu{position:absolute;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(62,36,32,.12);display:none;min-width:280px;max-height:260px;overflow:auto;z-index:100}

    @media (max-width: 600px){
      .sheet{max-height:92vh}
      .sheet .footer{position:sticky;bottom:0}
    }

    /* === Daily Task board === */
    .daily-board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.daily-board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:1024px){.daily-board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.daily-board{grid-template-columns:1fr}}

    .daily-week-body{display:grid;gap:10px}
    .daily-day{background:#fdf7f2;border:1px dashed #ecd8c8;border-radius:12px;padding:6px}
    .daily-day-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .daily-day-name{font-size:13px;font-weight:700;color:var(--brown)}
    .day-add{border:0;border-radius:999px;padding:2px 8px;font-size:11px;background:#fff;color:var(--brown);border:1px solid #e5d2c6;cursor:pointer}
    .day-add:hover{background:#fff8ef}
    .daily-drop{min-height:60px;border:2px dashed transparent;border-radius:10px;padding:4px;transition:.15s}
    .daily-drop.drag{border-color:#e5d2c6;background:#fffaf5}

    .daily-card{cursor:grab}
    .daily-card-title{font-size:14px;font-weight:700;color:var(--brown);margin:0 0 2px}
    .daily-card-desc{font-size:12px;color:var(--muted);margin:0;margin-top:2px}

    .daily-done-col .col-head{background:#e1f7ea;border-bottom-color:#bbdec6}
    .daily-done-col .col-title{color:#166534}

    /* Campaign done column */
    .campaign-done-col .col-head{background:#e1f7ea;border-bottom-color:#bbdec6}
    .campaign-done-col .col-title{color:#166534}
  
  .member-filter{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #e0d5c8;
    background:#fff8ef;
    margin-inline-start:8px;
  }
  .member-filter-label{
    font-size:12px;
    color:#3e2420;
    white-space:nowrap;
  }
  .member-filter-select{
    border:none;
    background:transparent;
    padding:0;
    min-width:120px;
    font-size:13px;
  }
  .member-filter-select:focus{
    outline:none;
    box-shadow:none;
  }
</style><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script></head>
<body class="mzj">
<!-- MZJ Unified Topbar -->
<header class="mzj-topbar">
<div class="topbar-left">
<button aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" class="icon-btn" id="mzjSidebarBtn"><i class="fa-solid fa-bars"></i></button>
<div class="brand">
<div class="brand-mark">MZJ</div>
<div class="brand-text">
<div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
<div class="brand-sub">Workspace</div>
</div>
</div>
</div>
<div class="topbar-center">
<div class="mzj-breadcrumb">
<span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
<i class="fa-solid fa-chevron-left"></i>
<span class="crumb current">Ø§Ù„Ø­Ù…Ù„Ø§Øª</span>
</div>
</div>
<div class="topbar-right">
<div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
<button class="mzj-btn mzj-btn-ghost" id="btnSignOut" style="display:none" type="button">
<i class="fa-solid fa-right-from-bracket"></i>
<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
</button> <div class="mzj-user">
<div class="avatar">DB</div>
<div class="user-text">
<div class="user-name">Ø§Ù„Ø­Ù…Ù„Ø§Øª</div>
<div class="user-role">Dashboard</div>
</div>
</div>
</div>
</header>
<div class="mzj-shell" id="mzjShell">
<aside class="mzj-sidebar" data-mzj-sidebar="workspace" id="mzjSidebar">
<div class="side-section">
<div class="side-title">Workspace</div>
<nav class="side-nav" id="mzjSideNav">
<!-- ÙŠÙØ¨Ù†Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† mzj-ui.js -->
</nav>
</div>
</aside>
<div class="mzj-backdrop" id="mzjBackdrop"></div>
<main class="mzj-content"><section class="mzj-pagehead">
<div class="pagehead-left">
<h1 class="page-title">Ø§Ù„Ø­Ù…Ù„Ø§Øª</h1>
<p class="page-desc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª ÙˆØ§Ù„Ù…Ù‡Ø§Ù… â€” Kanban</p>
</div>
</section><main class="page">
<!-- Tabs -->
<div class="tabs">
<button class="tab active" id="tabSpaces">Spaces</button>
<button class="tab" id="tabCampaigns">Campaign</button>
<button class="tab" id="tabDaily">ğŸ—“ Daily Task â€” Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
</div>
<!-- ===== ØªØ¨ÙˆÙŠØ¨ Spaces ===== -->
<section class="panel" id="panelSpaces">
<div class="head">
<div class="controls">
<select class="select" id="spaceSelect"></select>
<input class="input" id="newGroupName" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ â€” Ù…Ø«Ø§Ù„: ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§" style="min-width:220px;display:none"/>
<button class="btn secondary" id="btnAddGroup" style="display:none">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
<button class="btn secondary" id="btnNewSpace" style="display:none">Space Ø¬Ø¯ÙŠØ¯</button>
<button class="btn" id="btnNewTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</button>
<button class="btn secondary" id="btnSpaceManage" style="display:none">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€Space</button>
<div class="member-filter">
<span class="member-filter-label">ğŸ‘¤ Ø§Ù„Ø¹Ø¶Ùˆ</span>
<select class="select member-filter-select" id="spaceMemberFilter">
<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</option>
</select>
</div>
<!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
<button class="btn secondary" id="btnExportSpace">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
</div>
<div class="muted" id="who"></div>
</div>
<div class="body">
<div class="board" id="boardSpaces"></div>
</div>
</section>
<!-- ===== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ù…Ù„Ø§Øª ===== -->
<section class="panel hidden" id="panelCampaigns">
<div class="head">
<div class="controls">
<select class="select" id="campaignSelect"></select>
<div class="member-filter">
<span class="member-filter-label">ğŸ‘¤ Ø§Ù„Ø¹Ø¶Ùˆ</span>
<select class="select member-filter-select" id="campaignMemberFilter">
<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</option>
</select>
</div>
<button class="btn" id="btnNewCampaignTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯ (Ø­Ù…Ù„Ø©)</button>
<button class="btn secondary" id="btnNewCampaign" style="display:none">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
</div>
<!-- ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ (Ù…Ø¹ Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯) -->
<div class="campaign-desc-wrapper">
<div class="campaign-desc" id="campaignDates">Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>
<button class="btn secondary btn-see-more" id="campaignToggle" style="display:none">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
</div>
</div>
<div class="body">
<div class="board" id="boardCampaigns"></div>
</div>
</section>
<!-- ===== ØªØ¨ÙˆÙŠØ¨ Daily Task ===== -->
<section class="panel hidden" id="panelDaily">
<div class="head">
<div class="controls">
<select class="select" id="dailyMonthSelect"></select>
<span class="muted">Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© â€” Ù…Ù‚Ø³Ù‘Ù… Ø¥Ù„Ù‰ Ù¤ Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø§Ù„Ø³Ø¨Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ù…ÙŠØ³)</span>
</div>
<div class="muted" id="dailyMeta"></div>
</div>
<div class="body">
<div class="daily-board" id="dailyBoard"></div>
</div>
</section>
</main></main>
</div>
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
<script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);

    const auth = getAuth();
    const db   = getFirestore();

    /* State */
    let CURRENT_USER=null;
    let CURRENT_ROLE='member';
    let IS_ADMIN=false;

    let USERS=[];
    let CURRENT_CAMPAIGN=null;
    let COLUMNS=[];
    let TASKS=[];
    let unsubTasks=null;

    let DRAG_TASK_ID = null;

    /* Quill editors */
    let quill = null;
    let quillEdit = null;

    /* Task modal state */
    let SELECTED_ASSIGNEES=[];
    let EDITING_TASK=null;
    let PRESELECT_STATUS=null;

    /* Elements */
    const signOutBtn = document.getElementById('btnSignOut');
    if(signOutBtn){ signOutBtn.style.display='inline-flex'; }

    const campaignSelect     = document.getElementById('campaignSelect');
    const campStartEl        = document.getElementById('campStart');
    const campDueEl          = document.getElementById('campDue');
    const campaignDates      = document.getElementById('campaignDates');
    const board              = document.getElementById('board');
    const campaignDescBox    = document.getElementById('campaignDescriptionBox');

    const btnNewCampaign     = document.getElementById('btnNewCampaign');
    const btnRenameCampaign  = document.getElementById('btnRenameCampaign');
    const btnEditCampDesc    = document.getElementById('btnEditCampDesc');
    const btnArchiveCampaign = document.getElementById('btnArchiveCampaign');
    const btnDeleteCampaign  = document.getElementById('btnDeleteCampaign');
    const btnAddColumn       = document.getElementById('btnAddColumn');
    const btnSaveDates       = document.getElementById('btnSaveDates');

    /* Task modal refs */
    const taskModal      = document.getElementById('taskModal');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const btnCancelTask  = document.getElementById('btnCancelTask');
    const btnSaveTask    = document.getElementById('btnSaveTask');
    const tName          = document.getElementById('tName');
    const tDue           = document.getElementById('tDue');
    const tDesc          = document.getElementById('tDesc');
    const tAssigneeSearch= document.getElementById('tAssigneeSearch');
    const assigneeMenu   = document.getElementById('assigneeMenu');
    const assigneeChip   = document.getElementById('assigneeChip');
    const tColor         = document.getElementById('tColor');
    const linksContainer = document.getElementById('linksContainer');
    const btnAddLink     = document.getElementById('btnAddLink');

    /* Init Quill editors */
    window.addEventListener('DOMContentLoaded', () => {
      quill = new Quill('#campaignDescEditor', {
        theme: 'snow',
        modules: { toolbar: '#campaignDescToolbar' }
      });

      quillEdit = new Quill('#editCampDescEditor', {
        theme: 'snow',
        modules: { toolbar: '#editDescToolbar' }
      });
    });

    function escapeHtml(str){
      return (str || '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function taskSort(a,b){
      const ao = (typeof a.order === 'number')
        ? a.order
        : 999999 + (a.createdAt?.seconds || 0);
      const bo = (typeof b.order === 'number')
        ? b.order
        : 999999 + (b.createdAt?.seconds || 0);
      return ao - bo;
    }

    document.getElementById('btnSignOut').onclick = async ()=>{
      await signOut(auth);
      location.href = "login.html";
    };

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }

      CURRENT_USER = user;

      const u = await getDoc(doc(db,"users", user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
      CURRENT_ROLE = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = (CURRENT_ROLE === 'admin');

      document.getElementById('who').textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;

      if(!IS_ADMIN){
        alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·');
        location.href="projects.html";
        return;
      }

      await loadUsers();
      bootCampaigns();
    });

    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS=[];
      snap.forEach(d=>{
        const u = d.data() || {};
        USERS.push({
          uid:d.id,
          name:u.name || d.id,
          role:u.role || 'member',
          color:u.color || '#bc8f74'
        });
      });
    }

    const CAMPAIGN_DEFAULT_COLS = [
      "Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´",
      "Ù…ÙˆØ´Ù† - ÙƒØ§Ø´",
      "Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´",
      "Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·",
      "AI Generate - Ø§Ù‚Ø³Ø§Ø·",
      "Ø¬Ø±Ø§ÙÙŠÙƒ Ø§Ù‚Ø³Ø§Ø·",
      "Ø§Ù‚Ø³Ø§Ø· Ø´Ø±ÙƒØ§Øª - Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§",
      "Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"
    ];

    function bootCampaigns(){
      onSnapshot(
        query(collection(db,'spaces'), where('type','==','campaign')),
        (snap)=>{
          const items=[];
          snap.forEach(d=>{
            const x=d.data()||{};
            if(x.active !== false){
              items.push({ id:d.id, ...x });
            }
          });

          items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

          campaignSelect.innerHTML='';
          items.forEach(s=>{
            const opt=document.createElement('option');
            opt.value=s.id;
            opt.textContent=s.name;
            campaignSelect.appendChild(opt);
          });

          if(!CURRENT_CAMPAIGN && items.length){
            selectCampaign(items[0].id);
          }
        }
      );

      campaignSelect.addEventListener('change', e=>{
        selectCampaign(e.target.value);
      });
    }

    async function selectCampaign(id){
      CURRENT_CAMPAIGN=id;

      const d = await getDoc(doc(db,'spaces', id));
      const data = d.data() || {};

      COLUMNS = Array.isArray(data.columns) ? data.columns : CAMPAIGN_DEFAULT_COLS.slice();

      const desc = data.description || "<em class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„Ø­Ù…Ù„Ø©</em>";
      campaignDescBox.innerHTML = desc;

      const start = data.start || '';
      const due   = data.due   || '';

      campStartEl.value = start || '';
      campDueEl.value   = due   || '';
      campaignDates.textContent = `ğŸ“… ${start||'â€”'} â†’ ${due||'â€”'}`;

      renderBoard();
      listenTasks();
    }

    document.getElementById('saveNewCamp').onclick = async ()=>{
      const name = document.getElementById('newCampName').value.trim();
      if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©");

      const descriptionHTML = quill.root.innerHTML;

      const ref = await addDoc(collection(db,'spaces'), {
        name,
        description: descriptionHTML,
        type:'campaign',
        columns: [],
        createdAt: serverTimestamp(),
        active:true,
        start:null,
        due:null
      });

      CURRENT_CAMPAIGN = ref.id;
      COLUMNS = [];

      document.getElementById('newCampaignModal').classList.remove('show');
      renderBoard();
      listenTasks();
      alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
    };

    btnNewCampaign.onclick = ()=>{
      document.getElementById('newCampName').value="";
      quill.setContents([]);
      document.getElementById('newCampaignModal').classList.add('show');
    };

    document.getElementById('cancelNewCamp').onclick = ()=>{
      document.getElementById('newCampaignModal').classList.remove('show');
    };

    btnEditCampDesc.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return;

      const d = await getDoc(doc(db,'spaces', CURRENT_CAMPAIGN));
      const desc = d.data()?.description || "";

      quillEdit.root.innerHTML = desc;
      document.getElementById('editCampDescModal').classList.add('show');
    };

    document.getElementById('cancelEditDesc').onclick = ()=>{
      document.getElementById('editCampDescModal').classList.remove('show');
    };

    document.getElementById('saveEditCampDesc').onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return;

      const newDesc = quillEdit.root.innerHTML;

      await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), {
        description:newDesc
      });

      campaignDescBox.innerHTML = newDesc;
      document.getElementById('editCampDescModal').classList.remove('show');

      alert("âœ” ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø©");
    };

    btnRenameCampaign.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return;

      const nm = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø­Ù…Ù„Ø©:");
      if(!nm) return;

      await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { name:nm });
    };

    btnArchiveCampaign.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return;

      if(!confirm("Ø£Ø±Ø´ÙØ© Ø§Ù„Ø­Ù…Ù„Ø©ØŸ")) return;

      await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { active:false });
      CURRENT_CAMPAIGN=null;
      board.innerHTML='';
      campaignDescBox.innerHTML="<em class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ</em>";
    };

    btnDeleteCampaign.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return alert("Ø§Ø®ØªØ± Ø­Ù…Ù„Ø©");

      if(!confirm("ØªØ­Ø°ÙŠØ±: Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±ØŸ")) return;

      const qTasks = query(collection(db,'tasks'), where('spaceId','==', CURRENT_CAMPAIGN));
      const snap = await getDocs(qTasks);

      const batch = writeBatch(db);
      snap.forEach(d=> batch.delete(d.ref));

      await batch.commit();
      await deleteDoc(doc(db,'spaces', CURRENT_CAMPAIGN));

      CURRENT_CAMPAIGN=null;
      board.innerHTML="";
      campaignDescBox.innerHTML="";
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§");
    };

    btnSaveDates.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return;

      const start = campStartEl.value || null;
      const due   = campDueEl.value || null;

      await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { start, due });

      campaignDates.textContent = `ğŸ“… ${start||'â€”'} â†’ ${due||'â€”'}`;
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®");
    };

    function attachDragAndDrop(){
      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', (ev)=>{
          ev.preventDefault();
          ev.dataTransfer.dropEffect = 'move';
          zone.classList.add('drag');
        });
        zone.addEventListener('dragleave', ()=>{
          zone.classList.remove('drag');
        });
        zone.addEventListener('drop', async (ev)=>{
          ev.preventDefault();
          zone.classList.remove('drag');
          const id = DRAG_TASK_ID || ev.dataTransfer.getData('text/plain');
          if(!id) return;
          const status = zone.dataset.zone;
          const task = TASKS.find(t=> t.id === id);
          if(!task) return;

          let newStatus = status;
          let newOrder  = 1;

          let maxOrder = 0;
          TASKS.filter(t=> t.status === newStatus).forEach(t=>{
            if(typeof t.order === 'number' && t.order > maxOrder){
              maxOrder = t.order;
            }
          });
          newOrder = maxOrder + 1 || 1;

          try{
            await updateDoc(doc(db,'tasks', id), {
              status:newStatus,
              order:newOrder
            });
          }catch(e){
            console.error('drop move error', e);
          }
        });
      });
    }

    function renderBoard(){
      board.innerHTML='';

      COLUMNS.forEach((col, index)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.index=index;
        sec.dataset.status=col;

        sec.innerHTML = `
          <div class="col-head">
            <span class="col-title">${col}</span>
            <div class="col-actions">
              <button class="icon" data-act="rename" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©">âœ</button>
              <button class="icon" data-act="delete" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ—‘</button>
              <button class="icon" data-act="newtask" title="ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯">â•</button>
            </div>
          </div>

          <div class="col-body">
            <div class="dropzone" data-zone="${col}"></div>
          </div>
        `;

        board.appendChild(sec);
      });

      (function(){
        const doneCol = 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°';
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=doneCol;

        sec.innerHTML = `
          <div class="col-head">
            <span class="col-title">${doneCol}</span>
            <div class="col-actions" style="display:none"></div>
          </div>
          <div class="col-body">
            <div class="dropzone" data-zone="${doneCol}"></div>
          </div>
        `;

        board.appendChild(sec);
      })();

      attachColumnActions();
      attachDragAndDrop();
      renderTasks();
    }


    async function renameColumnStatus(oldStatus, newStatus){
      if(!CURRENT_CAMPAIGN || !oldStatus || !newStatus || oldStatus === newStatus) return;

      try{
        const updatedIds = new Set();

        const q1 = query(
          collection(db,'tasks'),
          where('spaceId','==', CURRENT_CAMPAIGN),
          where('status','==', oldStatus)
        );
        const q2 = query(
          collection(db,'tasks'),
          where('campaignId','==', CURRENT_CAMPAIGN),
          where('status','==', oldStatus)
        );

        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);

        const batch = writeBatch(db);

        snap1.forEach(d=>{
          if(updatedIds.has(d.id)) return;
          updatedIds.add(d.id);
          batch.update(d.ref, { status:newStatus });
        });

        snap2.forEach(d=>{
          if(updatedIds.has(d.id)) return;
          updatedIds.add(d.id);
          batch.update(d.ref, { status:newStatus });
        });

        if(updatedIds.size){
          await batch.commit();
        }
      }catch(e){
        console.error('renameColumnStatus error', e);
      }
    }

    function attachColumnActions(){
      board.querySelectorAll('.col').forEach(colEl=>{
        const status = colEl.dataset.status;
        const actions = colEl.querySelector('.col-actions');
        if(!actions) return;

        actions.onclick = async (e)=>{
          const btn = e.target.closest('.icon');
          if(!btn) return;
          const act = btn.dataset.act;
          if(!act) return;

          if(act === 'newtask'){
            openTaskModal({ status });
          }else if(act === 'rename'){
            const nn = prompt("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", status);
            if(!nn || nn === status) return;
            COLUMNS = COLUMNS.map(c=> c===status ? nn : c);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø­Ù…Ù„Ø©
            await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { columns:COLUMNS });

            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            await renameColumnStatus(status, nn);

            renderBoard();
          }else if(act === 'delete'){
            if(COLUMNS.length <= 1){
              alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯.");
              return;
            }
            if(!confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ "${status}"ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;
            COLUMNS = COLUMNS.filter(c=> c!==status);
            await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { columns:COLUMNS });
            renderBoard();
          }
        };
      });
    }

    function listenTasks(){
      if (unsubTasks) {
        try { unsubTasks(); } catch(e) {}
        unsubTasks = null;
      }

      if (!CURRENT_CAMPAIGN) return;

      const tasksMap = new Map();

      function applySnap(snap){
        let changed = false;
        snap.docChanges().forEach(change => {
          const d = change.doc;
          if (change.type === 'removed') {
            if (tasksMap.delete(d.id)) changed = true;
          } else {
            tasksMap.set(d.id, { id:d.id, ...(d.data()) });
            changed = true;
          }
        });
        if (changed) {
          TASKS = Array.from(tasksMap.values());
          renderTasks();
        }
      }

      const qSpace   = query(collection(db,'tasks'), where('spaceId','==', CURRENT_CAMPAIGN));
      const qCampaign= query(collection(db,'tasks'), where('campaignId','==', CURRENT_CAMPAIGN));

      const unsub1 = onSnapshot(qSpace, applySnap);
      const unsub2 = onSnapshot(qCampaign, applySnap);

      unsubTasks = () => {
        try { unsub1(); } catch(e) {}
        try { unsub2(); } catch(e) {}
      };
    }

    async function moveTask(taskId, status, dir){
      const colTasks = TASKS
        .filter(t=> t.status === status)
        .slice()
        .sort(taskSort);

      const idx = colTasks.findIndex(t=> t.id === taskId);
      if(idx === -1) return;
      if(dir === 'up' && idx === 0) return;
      if(dir === 'down' && idx === colTasks.length - 1) return;

      const otherIdx = dir === 'up' ? idx - 1 : idx + 1;
      const cur   = colTasks[idx];
      const other = colTasks[otherIdx];

      const curOrder   = (typeof cur.order === 'number') ? cur.order : (idx+1);
      const otherOrder = (typeof other.order === 'number') ? other.order : (otherIdx+1);

      try{
        await Promise.all([
          updateDoc(doc(db,'tasks', cur.id),   { order: otherOrder }),
          updateDoc(doc(db,'tasks', other.id), { order: curOrder })
        ]);
      }catch(e){
        console.error('moveTask error', e);
      }
    }

    function renderTasks(){
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const grouped = {};
      COLUMNS.forEach(c => grouped[c] = []);
      grouped['ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'] = grouped['ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'] || [];

      TASKS.forEach(t => {
        let st = (t.status || '').trim();
        if (st === 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡') { st = 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'; }

        let key = st;

        // Ù„Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¶Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù†Ø­Ø·Ù‡Ø§ ÙÙŠ Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ ÙƒØ­Ù„ Ø¢Ù…Ù†
        if (!COLUMNS.includes(key) && key !== 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°') {
          key = COLUMNS[0] || 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°';
        }

        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      const allStatuses = COLUMNS.concat('ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°');

      allStatuses.forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        if(!zone) return;

        const list = (grouped[status] || []).slice().sort(taskSort);

        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='task-card';
          card.dataset.id=t.id;
          card.draggable = true;

          const assignees = Array.isArray(t.assignees) && t.assignees.length
            ? t.assignees
            : (t.assignee ? [t.assignee] : []);

          let assigneesHtml = '';
          if(assignees.length){
            const shown = assignees.slice(0,3);
            assigneesHtml = shown.map(a=>`
              <span class="badge">
                <span class="dot" style="background:${a.color || '#bc8f74'}"></span>
                ${escapeHtml(a.name || '')}
              </span>
            `).join('');
            if(assignees.length > 3){
              assigneesHtml += `<span class="small">+${assignees.length - 3}</span>`;
            }
          }

          const descText = (t.description || '').trim();

          let linksHtml = '';
          if(Array.isArray(t.links) && t.links.length){
            const limited = t.links.slice(0,3);
            linksHtml = `
              <div class="links-row">
                ${limited.map((l,idx)=>{
                  let title = '';
                  let url   = '';
                  if(typeof l === 'string'){
                    url = l;
                    title = `Ø±Ø§Ø¨Ø· ${idx+1}`;
                  }else{
                    url = l.url || '';
                    title = l.title || `Ø±Ø§Ø¨Ø· ${idx+1}`;
                  }
                  if(!url) return '';
                  return `
                    <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="task-link">
                      ğŸ”— ${escapeHtml(title)}
                    </a>
                  `;
                }).join('')}
                ${t.links.length > 3 ? `<span class="small">+${t.links.length - 3}</span>` : ''}
              </div>
            `;
          }

          card.innerHTML=`
            <div class="card-top">
              <h4>${escapeHtml(t.name || '-')}</h4>
              <div class="card-actions">
                <button class="card-move" data-dir="up" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰">â–²</button>
                <button class="card-move" data-dir="down" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„">â–¼</button>
              </div>
            </div>
            ${linksHtml}
            <div class="row">
              ${assigneesHtml}
              ${t.due ? `<span class="small">ğŸ“… ${escapeHtml(t.due)}</span>` : '' }
            </div>
            ${descText ? `<div class="card-hint">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ</div>` : ''}
          `;

          card.addEventListener('click', ()=> openTaskModal({ edit:t }));

          card.addEventListener('dragstart',(ev)=>{
            DRAG_TASK_ID = t.id;
            ev.dataTransfer.setData('text/plain', t.id);
            ev.dataTransfer.effectAllowed = 'move';
          });
          card.addEventListener('dragend',()=>{
            DRAG_TASK_ID = null;
            board.querySelectorAll('.dropzone.drag').forEach(z=> z.classList.remove('drag'));
          });

          card.querySelectorAll('.card-move').forEach(btn=>{
            btn.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              const dir = btn.dataset.dir;
              moveTask(t.id, status, dir);
            });
          });

          zone.appendChild(card);
        });
      });
    }

    function renderAssigneeChips(){
      if(!SELECTED_ASSIGNEES.length){
        assigneeChip.innerHTML = '';
        return;
      }
      assigneeChip.innerHTML = SELECTED_ASSIGNEES.map(a=>`
        <span class="chip" data-uid="${a.uid}">
          <span class="dot" style="background:${a.color || '#bc8f74'};width:10px;height:10px;border-radius:999px"></span>
          <span>${escapeHtml(a.name)}</span>
          <span class="chip-remove" title="Ø¥Ø²Ø§Ù„Ø©">Ã—</span>
        </span>
      `).join('');
    }

    assigneeChip.addEventListener('click',(e)=>{
      const removeBtn = e.target.closest('.chip-remove');
      if(!removeBtn) return;
      const chip = removeBtn.closest('.chip');
      const uid  = chip?.dataset.uid;
      if(!uid) return;
      SELECTED_ASSIGNEES = SELECTED_ASSIGNEES.filter(a=> a.uid !== uid);
      renderAssigneeChips();
    });

    function positionAssigneeMenu(){
      const r = tAssigneeSearch.getBoundingClientRect();
      assigneeMenu.style.top   = (r.bottom + 4) + 'px';
      assigneeMenu.style.right = (window.innerWidth - r.right) + 'px';
      assigneeMenu.style.minWidth = r.width + 'px';
    }

    function renderAssigneeMenu(filter){
      const f=(filter||'').toLowerCase();
      assigneeMenu.innerHTML='';
      const list = USERS.filter(u=> (u.name || '').toLowerCase().includes(f));
      if(!list.length){
        assigneeMenu.style.display='none';
        return;
      }

      positionAssigneeMenu();

      list.forEach(u=>{
        const it=document.createElement('div');
        it.className='dd-item';
        it.innerHTML = `
          <span class="badge">
            <span class="dot" style="background:${u.color}"></span>
            ${escapeHtml(u.name)}
          </span>
          <span class="small">(${escapeHtml(u.role)})</span>
        `;
        it.onclick = ()=>{
          const exists = SELECTED_ASSIGNEES.some(a=> a.uid === u.uid);
          if(!exists){
            SELECTED_ASSIGNEES.push({...u});
            if(SELECTED_ASSIGNEES.length === 1){
              SELECTED_ASSIGNEES[0].color = (tColor.value || u.color || '#bc8f74');
            }
            renderAssigneeChips();
          }
          assigneeMenu.style.display='none';
        };
        assigneeMenu.appendChild(it);
      });
      assigneeMenu.style.display='block';
    }

    tAssigneeSearch.addEventListener('input', (e)=>{
      const v = e.target.value.trim();
      renderAssigneeMenu(v);
    });
    tAssigneeSearch.addEventListener('focus', ()=>{
      renderAssigneeMenu(tAssigneeSearch.value.trim());
    });
    document.addEventListener('click', (e)=>{
      if(!assigneeMenu.contains(e.target) && e.target !== tAssigneeSearch){
        assigneeMenu.style.display='none';
      }
    });
    window.addEventListener('resize', ()=>{
      if(assigneeMenu.style.display==='block'){
        positionAssigneeMenu();
      }
    });

    function clearLinksForm(){
      linksContainer.innerHTML = '';
    }

    function addLinkRow(data = { title:'', url:'' }){
      const row = document.createElement('div');
      row.className = 'link-row';
      row.innerHTML = `
        <input class="link-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø·" value="${escapeHtml(data.title || '')}">
        <input class="link-url" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø· (URL)" value="${escapeHtml(data.url || '')}">
        <button type="button" class="link-remove" title="Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·">âœ•</button>
      `;
      row.querySelector('.link-remove').onclick = ()=> row.remove();
      linksContainer.appendChild(row);
    }

    btnAddLink.addEventListener('click', ()=>{
      addLinkRow();
    });

    function getLinksFromForm(){
      const rows = Array.from(linksContainer.querySelectorAll('.link-row'));
      const links = [];
      rows.forEach(r=>{
        const title = (r.querySelector('.link-title')?.value || '').trim();
        const url   = (r.querySelector('.link-url')?.value || '').trim();
        if(url){
          links.push({ title, url });
        }
      });
      return links;
    }

    function openTaskModal(opts={}){
      SELECTED_ASSIGNEES=[];
      EDITING_TASK=null;
      PRESELECT_STATUS=null;

      tName.value='';
      tDue.value='';
      tDesc.value='';
      tAssigneeSearch.value='';
      tColor.value='#bc8f74';
      assigneeChip.innerHTML='';
      clearLinksForm();

      if(opts.status) PRESELECT_STATUS = opts.status;

      if(opts.edit){
        const t = opts.edit;
        EDITING_TASK = t;
        taskModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ';
        tName.value = t.name || '';
        tDue.value  = t.due  || '';
        tDesc.value = t.description || '';

        if(Array.isArray(t.links) && t.links.length){
          t.links.forEach(l=>{
            if(typeof l === 'string'){
              addLinkRow({ title:'', url:l });
            }else{
              addLinkRow({ title:l.title || '', url:l.url || '' });
            }
          });
        }else{
          addLinkRow();
        }

        const assignees = Array.isArray(t.assignees) && t.assignees.length
          ? t.assignees
          : (t.assignee ? [t.assignee] : []);

        if(assignees.length){
          SELECTED_ASSIGNEES = assignees.map(a=>({
            uid:a.uid,
            name:a.name,
            color:a.color || '#bc8f74'
          }));
          tColor.value = SELECTED_ASSIGNEES[0].color;
          renderAssigneeChips();
        }
      }else{
        taskModalTitle.textContent = 'ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯';
        addLinkRow();
      }

      taskModal.classList.add('show');
    }

    function closeTaskModal(){
      taskModal.classList.remove('show');
      assigneeMenu.style.display='none';
    }

    btnCancelTask.onclick = closeTaskModal;
    taskModal.addEventListener('click', (e)=>{
      if(e.target === taskModal) closeTaskModal();
    });

    btnSaveTask.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return alert('Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
      const name = tName.value.trim();
      if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');

      const due = tDue.value || null;
      const description = tDesc.value || null;
      const mainColor = (tColor.value || '#bc8f74').trim();

      const links = getLinksFromForm();

      if(SELECTED_ASSIGNEES.length){
        SELECTED_ASSIGNEES = SELECTED_ASSIGNEES.map((a,idx)=>({
          ...a,
          color: idx===0 ? mainColor : (a.color || mainColor)
        }));
      }

      for(const u of SELECTED_ASSIGNEES){
        try{
          await updateDoc(doc(db,'users', u.uid), { color:u.color || mainColor });
        }catch(e){}
      }

      const assigneesPayload = SELECTED_ASSIGNEES.map(a=>({
        uid:a.uid,
        name:a.name,
        color:a.color || mainColor
      }));
      const singleAssignee = assigneesPayload[0] || null;
      const assigneesNames = assigneesPayload.map(a=>a.name||'').filter(Boolean).join(', ');
      const assigneesIds   = assigneesPayload.map(a=>a.uid);

      try{
        if(EDITING_TASK){
          await updateDoc(doc(db,'tasks', EDITING_TASK.id), {
            name,
            description,
            due,
            links,
            assignees: assigneesPayload,
            assignee: singleAssignee,
            assigneesNames,
            assigneesIds
          });
        }else{
          const status = PRESELECT_STATUS || (COLUMNS[0] || 'Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´');

          let maxOrder = 0;
          TASKS.filter(t=> t.status === status).forEach(t=>{
            if(typeof t.order === 'number' && t.order > maxOrder){
              maxOrder = t.order;
            }
          });
          const nextOrder = maxOrder + 1 || 1;

          await addDoc(collection(db,'tasks'), {
            spaceId: CURRENT_CAMPAIGN,
            campaignId: CURRENT_CAMPAIGN,
            workspaceType: 'campaign',
            name,
            description,
            due,
            status,
            links,
            order: nextOrder,
            assignees: assigneesPayload,
            assignee: singleAssignee,
            assigneesNames,
            assigneesIds,
            createdBy: CURRENT_USER?.uid || null,
            createdAt: serverTimestamp()
          });
        }
        closeTaskModal();
      }catch(e){
        alert('âš  ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ: ' + e.message);
      }
    };

    btnAddColumn.onclick = async ()=>{
      if(!CURRENT_CAMPAIGN) return alert('Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
      const title = prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
      if(!title) return;
      COLUMNS.push(title);
      await updateDoc(doc(db,'spaces', CURRENT_CAMPAIGN), { columns:COLUMNS });
      renderBoard();
    };

  </script>
<script src="mzj-ui (1).js"></script>
<script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp, arrayUnion, Timestamp, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth(); const db = getFirestore();

    /* Tabs */
    const tabSpaces    = document.getElementById('tabSpaces');
    const tabCampaigns = document.getElementById('tabCampaigns');
    const tabDaily     = document.getElementById('tabDaily');

    const panelSpaces    = document.getElementById('panelSpaces');
    const panelCampaigns = document.getElementById('panelCampaigns');
    const panelDaily     = document.getElementById('panelDaily');

    function switchTab(which){
      const tabs   = { spaces:tabSpaces, campaigns:tabCampaigns, daily:tabDaily };
      const panels = { spaces:panelSpaces, campaigns:panelCampaigns, daily:panelDaily };

      Object.keys(tabs).forEach(k=>{
        if(tabs[k]) tabs[k].classList.toggle('active', k===which);
      });
      Object.keys(panels).forEach(k=>{
        if(panels[k]) panels[k].classList.toggle('hidden', k!==which);
      });
    }
    tabSpaces.onclick    = ()=> switchTab('spaces');
    tabCampaigns.onclick = ()=> switchTab('campaigns');
    tabDaily.onclick     = ()=> switchTab('daily');

    function initMemberFilters(){
      if(spaceMemberFilter){
        spaceMemberFilter.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡';
        spaceMemberFilter.appendChild(optAll);
        USERS.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.uid;
          opt.textContent = u.name;
          spaceMemberFilter.appendChild(opt);
        });
        spaceMemberFilter.addEventListener('change', (e) => {
          FILTER_MEMBER_SPACES = e.target.value || null;
          renderTasksSpaces();
        });
      }

      if(campaignMemberFilter){
        campaignMemberFilter.innerHTML = '';
        const optAll2 = document.createElement('option');
        optAll2.value = '';
        optAll2.textContent = 'ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡';
        campaignMemberFilter.appendChild(optAll2);
        USERS.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.uid;
          opt.textContent = u.name;
          campaignMemberFilter.appendChild(opt);
        });
        campaignMemberFilter.addEventListener('change', (e) => {
          FILTER_MEMBER_CAMPAIGNS = e.target.value || null;
          renderTasksCampaigns();
        });
      }
    }

    /* Auth / Roles */
    let CURRENT_USER=null, CURRENT_ROLE='member', IS_ADMIN=false;
    let CURRENT_USER_NAME='';
    window.mzjLogout = async ()=>{ await signOut(auth); location.href="login.html"; };

    /* ===== Notifications helpers ===== */
    function initNotifications(currentUser){
      const bell       = document.getElementById('notifBell');
      const dropdown   = document.getElementById('notifDropdown');
      const list       = document.getElementById('notifList');
      const badge      = document.getElementById('notifBadge');
      const markAllBtn = document.getElementById('markAllReadBtn');
      const clearBtn   = document.getElementById('clearAllNotifBtn');
      const soundEl    = document.getElementById('notifSound');

      if(!bell || !dropdown || !list || !badge) return;

      let lastDocs = [];

      bell.addEventListener('click',(e)=>{
        e.stopPropagation();
        const open = dropdown.style.display === 'block';
        dropdown.style.display = open ? 'none' : 'block';
      });

      document.addEventListener('click',(e)=>{
        if(!dropdown.contains(e.target) && e.target!==bell && !bell.contains(e.target)){
          dropdown.style.display='none';
        }
      });

      const notifCol = collection(db,'notifications');
      const qy = query(
        notifCol,
        where('recipientUid','==', currentUser.uid),
        limit(40)
      );

      onSnapshot(qy,(snapshot)=>{
        lastDocs = snapshot.docs;
        list.innerHTML='';
        let unreadCount=0;

        snapshot.docChanges().forEach(change=>{
          const data = change.doc.data()||{};
          if(change.type==='added' && data.read === false && soundEl){
            soundEl.play().catch(()=>{});
          }
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø­ÙŠØ« Ø§Ù„Ø£Ø­Ø¯Ø« ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
        const docsSorted = snapshot.docs.slice().sort((a,b)=>{
          const ad = a.data()?.createdAt;
          const bd = b.data()?.createdAt;
          const at = (ad && ad.toDate) ? ad.toDate().getTime() : 0;
          const bt = (bd && bd.toDate) ? bd.toDate().getTime() : 0;
          return bt - at;
        });

        docsSorted.forEach(docSnap=>{
          const data = docSnap.data()||{};
          const id   = docSnap.id;
          const isUnread = data.read === false;
          if(isUnread) unreadCount++;

          const btn = document.createElement('button');
          btn.type='button';
          btn.className='notif-item'+(isUnread?' unread':'');

          const from = data.senderName || 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹';
          let timeStr='';
          try{
            if(data.createdAt && data.createdAt.toDate){
              const d = data.createdAt.toDate();
              timeStr = d.toLocaleString('ar-SA',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
            }
          }catch{}

          btn.innerHTML = `
            <span class="notif-item-message">${data.message||''}</span>
            <span class="notif-item-meta">${from}${timeStr ? ' â€¢ '+timeStr : ''}</span>
          `;

          btn.addEventListener('click', async ()=>{
            if(isUnread){
              try{ await updateDoc(doc(db,'notifications', id), { read:true }); }catch{}
            }

            // ÙØªØ­ Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
            const taskId = data.taskId;
            if(taskId){
              let opened = false;
              try{
                if(Array.isArray(TASKS_SPACES)){
                  const task = TASKS_SPACES.find(t=> t.id === taskId);
                  if(task){
                    openDetail(task);
                    opened = true;
                  }
                }
              }catch(e){
                console.error('openDetail from cache error', e);
              }

              if(!opened){
                try{
                  const snapTask = await getDoc(doc(db,'tasks', taskId));
                  if(snapTask.exists()){
                    const tdata = snapTask.data()||{};
                    const taskObj = {
                      id: taskId,
                      name: tdata.name||'ØªØ§Ø³Ùƒ',
                      description: tdata.description||'',
                      due: tdata.due||'',
                      status: tdata.status||'',
                      car: tdata.car||null,
                      assignees: tdata.assignees||[],
                      links: tdata.links||[]
                    };
                    openDetail(taskObj);
                    opened = true;
                  }
                }catch(e){
                  console.error('load task by notif error', e);
                }
              }

              if(opened && dropdown){
                dropdown.style.display='none';
              }
            }
          });

          list.appendChild(btn);
        });

        if(unreadCount>0){
          badge.style.display='flex';
          badge.textContent = unreadCount>99?'99+':String(unreadCount);
        }else{
          badge.style.display='none';
        }
      },(err)=>{
        console.error('notifications error', err);
      });

      if(markAllBtn){
        markAllBtn.addEventListener('click', async ()=>{
          const promises=[];
          lastDocs.forEach(d=>{
            const data = d.data()||{};
            if(data.read === false){
              promises.push(updateDoc(doc(db,'notifications', d.id), { read:true }));
            }
          });
          if(promises.length){
            try{ await Promise.all(promises); }catch(e){ console.error(e); }
          }
        });
      }

      if(clearBtn){
        clearBtn.addEventListener('click', async ()=>{
          if(!lastDocs.length) return;
          const promises = [];
          lastDocs.forEach(d=>{
            promises.push(deleteDoc(doc(db,'notifications', d.id)));
          });
          if(promises.length){
            try{ await Promise.all(promises); }catch(e){ console.error(e); }
          }
        });
      }
    }

    /* Common helpers */
    const MIME_TASK   = "application/x-mzj-task";
    const MIME_COLUMN = "application/x-mzj-column";
    const MIME_DAILY  = "application/x-mzj-daily";

    let USERS=[];
    const spaceMemberFilter = document.getElementById('spaceMemberFilter');
    const campaignMemberFilter = document.getElementById('campaignMemberFilter');
    let FILTER_MEMBER_SPACES = null;
    let FILTER_MEMBER_CAMPAIGNS = null;
    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS=[];
      snap.forEach(d=>{
        const u=d.data()||{};
        const tag = (u.tag || u.username || (u.name ? u.name.split(' ')[0] : d.id.slice(0,6))).toLowerCase();
        USERS.push({
          uid: d.id,
          name: u.name||d.id.slice(0,6),
          role: u.role||'member',
          color: u.color||'#bc8f74',
          email: u.email || u.mail || null,
          tag
        });
      });
    }

    function taskBelongsToMember(task, memberUid){
      if(!memberUid) return true;
      const members = taskMembersArray(task);
      return members.some(m => (m.uid || m.id || m) === memberUid);
    }

    function taskMembersArray(task){
      if(Array.isArray(task.assignees) && task.assignees.length) return task.assignees;
      if(task.assignee) return [task.assignee];
      return [];
    }

    function canManageLinks(task){
      if(IS_ADMIN) return true;
      const members = taskMembersArray(task);
      const myUid = CURRENT_USER?.uid || '';
      return members.some(m=>m.uid === myUid);
    }

    function isCurrentUserTaskMember(task){
      const members = taskMembersArray(task);
      const myUid   = CURRENT_USER?.uid || '';
      return members.some(m => (m.uid === myUid));
    }

    function canUserMarkCampaignDone(task){
      if(IS_ADMIN) return true;
      return isCurrentUserTaskMember(task);
    }


    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ù† Ø§Ù„Ù†Øµ @tag
    function extractMentions(text){
      if(!text) return [];
      const regex = /@([\u0600-\u06FF\w_.-]+)/g;
      const tags = [];
      let m;
      while((m = regex.exec(text)) !== null){
        tags.push(m[1]);
      }
      return [...new Set(tags)];
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ù† Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙØ¹Ù„ÙŠÙŠÙ† Ù…Ù† USERS
    function resolveMentionRecipients(tags){
      const unique = [...new Set((tags||[]).map(t=>t.toLowerCase()))];
      const recipients=[];
      unique.forEach(tag=>{
        const found = USERS.find(u=>{
          const tagField  = (u.tag||'').toLowerCase();
          const nameFirst = (u.name||'').split(' ')[0].toLowerCase();
          const emailUser = (u.email||'').split('@')[0].toLowerCase();
          return tagField===tag || nameFirst===tag || emailUser===tag;
        });
        if(found && !recipients.find(r=>r.uid===found.uid)){
          recipients.push(found);
        }
      });
      return recipients;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù†
    async function createMentionNotifications({taskId, taskName, taskDescription, spaceId, status, assignees}){
      const text = `${taskName||''}\n${taskDescription||''}`;
      const tags = extractMentions(text);
      let recipients = [];

      // 1) Ù„Ùˆ ÙÙŠ Ù…Ù†Ø´Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… @ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„ÙˆØµÙ
      if(tags.length){
        recipients = resolveMentionRecipients(tags).filter(u=> u.uid !== (CURRENT_USER?.uid||''));
      }else if(Array.isArray(assignees) && assignees.length){
        // 2) Ù„Ùˆ Ù…Ø§ÙÙŠØ´ @ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙƒÙ…Ø³ØªÙ„Ù…ÙŠÙ†
        recipients = assignees
          .map(a=> USERS.find(u=> u.uid === (a.uid || a.id || a)))
          .filter(u=> u && u.uid !== (CURRENT_USER?.uid||''));
      }

      if(!recipients.length) return;

      const notifCol = collection(db,'notifications');
      const senderName = CURRENT_USER_NAME || CURRENT_USER?.email || 'Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚';

      const promises = recipients.map(u=>{
        const msg = `ØªÙ… Ù…Ù†Ø´Ù† ${u.tag||u.name} ÙÙŠ ØªØ§Ø³Ùƒ: ${taskName||'-'}`;
        return addDoc(notifCol,{
          recipientUid: u.uid,
          recipientName: u.name,
          senderUid: CURRENT_USER?.uid || null,
          senderName,
          spaceId: spaceId || null,
          taskId,
          status: status || null,
          message: msg,
          type: 'mention',
          createdAt: serverTimestamp(),
          read: false
        });
      });

      try{ await Promise.all(promises); }catch(e){ console.error('mention notifications error', e); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER = user;
      const u = await getDoc(doc(db,"users", user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
      CURRENT_ROLE = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = CURRENT_ROLE==='admin';
      CURRENT_USER_NAME = name;

      document.getElementById('who').textContent  = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;
      document.getElementById('who2') && (document.getElementById('who2').textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`);

      ['btnNewSpace','btnAddGroup','newGroupName','btnNewTask','btnSpaceManage','btnNewCampaignTask','btnNewCampaign'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display = IS_ADMIN? '' : 'none';
      });
      document.querySelectorAll('.col-actions').forEach(el=> el.style.display = IS_ADMIN? 'flex' : 'none');

      if(!IS_ADMIN){
        document.getElementById('navDashboard').style.display='none';
        document.getElementById('navMembers').style.display='none';
        document.getElementById('navAdmin').style.display='none';
        if(tabDaily) tabDaily.style.display='none'; // Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¹Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
      }else{
        if(tabDaily) tabDaily.style.display='inline-flex';
      }

      await loadUsers();
      initMemberFilters();
      initNotifications(user);
      bootSpaces();
      bootCampaigns();
      if(IS_ADMIN) bootDailyTasks(); // Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·
    });

    /* ===== Spaces logic ===== */
    const DEFAULT_COLUMNS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
    const REVIEW_COLUMN   = "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    const DONE_STATUS_SPACES = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";

    const spaceSelect     = document.getElementById('spaceSelect');
    const newGroupNameEl  = document.getElementById('newGroupName');
    const btnAddGroup     = document.getElementById('btnAddGroup');
    const btnSpaceManage  = document.getElementById('btnSpaceManage');
    const boardSpaces     = document.getElementById('boardSpaces');
    const btnExportSpace  = document.getElementById('btnExportSpace');

    let CURRENT_SPACE=null; let SPACE_COLUMNS=DEFAULT_COLUMNS.slice();
    let TASKS_SPACES=[]; let unsubTasksSpaces=null; let OPEN_TASK=null;
    let SPACES_CACHE = new Map(); // id -> name

    async function ensureReviewColumn(){
      if (!CURRENT_SPACE) return;
      if (SPACE_COLUMNS.includes(REVIEW_COLUMN)) return;
      const cols = SPACE_COLUMNS.concat([REVIEW_COLUMN]);
      try{
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS = cols;
        renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      }catch(e){ console.error(e); }
    }

    async function ensureDefaultSpace(){
      const qy = query(collection(db,'spaces'), where('active','!=', false), where('type','==', null));
      const snap = await getDocs(qy);
      if (snap.empty){
        const label = new Date().toLocaleDateString('ar-SA',{ year:'numeric', month:'long' });
        const ref = await addDoc(collection(db,'spaces'), {
          name:label, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true
        });
        SPACES_CACHE.set(ref.id, label);
        return ref.id;
      } else {
        let id=null, ts=0;
        snap.forEach(d=>{
          const data=d.data()||{};
          const s=data.createdAt?.seconds||0;
          SPACES_CACHE.set(d.id, data.name||d.id);
          if(s>=ts){ts=s; id=d.id;}
        });
        return id;
      }
    }

    function fillSpaceDropdown(list, selectedId){
      spaceSelect.innerHTML='';
      list.forEach(s=>{
        if(s.type==='campaign') return;
        const opt=document.createElement('option');
        opt.value=s.id; opt.textContent=s.name;
        spaceSelect.appendChild(opt);
        SPACES_CACHE.set(s.id, s.name||s.id);
      });
      if(selectedId) spaceSelect.value=selectedId;
    }

    onSnapshot(collection(db,'spaces'), snap=>{
      const items=[];
      snap.forEach(d=>{
        const data=d.data()||{};
        if(data.active!==false) items.push({id:d.id, ...data});
      });
      const onlySpaces = items.filter(s=> !s.type);
      onlySpaces.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      fillSpaceDropdown(onlySpaces, CURRENT_SPACE);
      if(!CURRENT_SPACE && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect(); ensureReviewColumn();
      }else if(CURRENT_SPACE && !onlySpaces.find(x=>x.id===CURRENT_SPACE) && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
      }
    });

    document.getElementById('btnNewSpace')?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù€Space (Ù…Ø«Ø§Ù„: Ù†ÙˆÙÙ…Ø¨Ø± 2025):');
      if(!name) return;
      const ref = await addDoc(collection(db,'spaces'), {
        name, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true
      });
      SPACES_CACHE.set(ref.id, name);
      CURRENT_SPACE = ref.id; SPACE_COLUMNS = DEFAULT_COLUMNS.slice();
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnSpaceManage?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const action = prompt('Ø§ÙƒØªØ¨:\nrename Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©\narchive Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€Space');
      if(!action) return;
      if(action.toLowerCase()==='rename'){
        const nm = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù€Space:'); if(!nm) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { name:nm });
        SPACES_CACHE.set(CURRENT_SPACE, nm);
      } else if(action.toLowerCase()==='archive'){
        if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€SpaceØŸ')) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), {
          active:false, archivedAt:serverTimestamp()
        });
      }
    });

    spaceSelect.addEventListener('change', async (e)=>{
      CURRENT_SPACE = e.target.value;
      const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
      SPACES_CACHE.set(CURRENT_SPACE, d.data()?.name||CURRENT_SPACE);
      SPACE_COLUMNS = d.exists()
        ? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS)
        : DEFAULT_COLUMNS;
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnAddGroup?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const name = (newGroupNameEl.value || 'ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§').trim();
      if(!name) return;
      if(SPACE_COLUMNS.includes(name)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');
      const cols = SPACE_COLUMNS.concat([name]);
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS = cols; newGroupNameEl.value='';
      renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
    });

    /* === EXPORT: Space to XLSX === */
    btnExportSpace?.addEventListener('click', ()=>{
      if(!CURRENT_SPACE){ alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{
        const data = TASKS_SPACES.map(t=>{
          const createdAt = t.createdAt?.seconds ? new Date(t.createdAt.seconds*1000) : null;
          const links = Array.isArray(t.links) ? t.links.map(l=> (l.title||l.url)+': '+l.url).join(' | ') : '';
          const members = taskMembersArray(t);
          const membersNames = members.map(m=>m.name).join(' | ');
          const membersUids  = members.map(m=>m.uid).join(' | ');
          const membersColors= members.map(m=>m.color).join(' | ');
          return {
            "Space": SPACES_CACHE.get(t.spaceId)||t.spaceId,
            "Ø§Ù„Ø¹Ù…ÙˆØ¯/Ø§Ù„Ø­Ø§Ù„Ø©": t.status||'',
            "Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ": t.name||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…": t.due||'',
            "Ø§Ù„ÙˆØµÙ": t.description||'',
            "Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersNames,
            "Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersColors,
            "UID Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersUids,
            "Ù…Ø§Ø±ÙƒØ©": t.car?.brand||'',
            "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„": t.car?.model||'',
            "Ø§Ù„ÙØ¦Ø©": t.car?.trim||'',
            "Ø§Ù„Ù…Ø­Ø±Ùƒ": t.car?.engine||'',
            "Ø±ÙˆØ§Ø¨Ø·": links,
            "Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©": t.createdBy||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡": createdAt ? createdAt.toLocaleString('ar-SA') : '',
            "Ù†Ø´Ø·": t.active===false? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
            "Doc ID": t.id
          };
        });

        const counts = SPACE_COLUMNS.map(col=>{
          const n = TASKS_SPACES.filter(t=>t.status===col).length;
          return { "Ø§Ù„Ø¹Ù…ÙˆØ¯": col, "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…": n };
        });

        const wb = XLSX.utils.book_new();
        const wsTasks = XLSX.utils.json_to_sheet(data);
        const wsCols  = XLSX.utils.json_to_sheet(counts);

        XLSX.utils.book_append_sheet(wb, wsTasks, 'Tasks');
        XLSX.utils.book_append_sheet(wb, wsCols,  'Columns');

        const fit = (rows)=> Object.keys(rows[0]||{}).map(k=>{
          const max = rows.reduce((m,r)=> Math.max(m, String(r[k]??'').length), k.length);
          return { wch: Math.min(Math.max(12, max+2), 60) };
        });
        if(data.length)   wsTasks['!cols'] = fit(data);
        if(counts.length) wsCols['!cols']  = fit(counts);

        const spaceName = (SPACES_CACHE.get(CURRENT_SPACE)||'Space').replace(/[\/\\:*?"<>|]/g,'-');
        const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const filename = `MZJ-Space-${spaceName}-${ymd}.xlsx`;
        XLSX.writeFile(wb, filename);
      }catch(err){
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: '+ (err?.message||err));
      }
    });

    /* Users on Spaces modal (Ø¥Ù†Ø´Ø§Ø¡/Ø­ÙØ¸ ØªØ§Ø³Ùƒ) */
    const taskModal      = document.getElementById('taskModal');
    const btnNewTask     = document.getElementById('btnNewTask');
    const btnCloseModal  = document.getElementById('btnCloseModal');
    const btnCancelTask  = document.getElementById('btnCancelTask');
    const btnSaveTask    = document.getElementById('btnSaveTask');

    const tName          = document.getElementById('tName');
    const tDesc          = document.getElementById('tDesc');
    const tDue           = document.getElementById('tDue');
    const tAssigneeSearch= document.getElementById('tAssigneeSearch');
    const assigneeMenu   = document.getElementById('assigneeMenu');
    const assigneeChip   = document.getElementById('assigneeChip');
    const tColor         = document.getElementById('tColor');
    const tGroup         = document.getElementById('tGroup');
    let SELECTED_ASSIGNEES=[];
    let EDITING_TASK = null;

    /* === Car Selector Data === */
    const CAR_MAP = {
      "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": [
        "Ø³ÙˆÙ†Ø§ØªØ§","Ø§Ù„Ù†ØªØ±Ø§","Ø§ÙƒØ³Ù†Øª","Ø¬Ø±Ø§Ù†Ø¯ i10","ÙƒØ±ÙŠØªØ§","Ø¬Ø±Ø§Ù†Ø¯ ÙƒØ±ÙŠØªØ§","Ø³ØªØ§Ø± Ø¬ÙŠØ²Ø±",
        "ÙÙŠÙ†ÙŠÙˆ","Ø§Ø²ÙŠØ±Ø§","Ø³Ù†ØªØ§ÙÙŠ","ØªÙˆØ³Ø§Ù†","ÙƒÙˆÙ†Ø§","Ø³ØªØ§Ø±ÙŠØ§","Ø¨Ø§Ù„Ø³ÙŠÙŠØ¯"
      ],
      "Ø´Ø§Ù†Ø¬Ø§Ù†": [
        "Ø³ÙŠ Ø§Ø³ 75","Ø³ÙŠ Ø§Ø³ 35","Ø§ÙŠØ¯Ùˆ Ø¨Ù„Ø³","Ø§Ù„ Ø³ÙŠÙÙ†","ÙŠÙˆÙ†ÙŠ ÙƒÙŠ","ÙŠÙˆÙ†ÙŠ ØªÙŠ","ÙŠÙˆÙ†ÙŠ ÙÙŠ",
        "Ø³ÙŠ Ø§Ø³ 95","ÙŠÙˆÙ†ÙŠ Ø§Ø³","Ù‡Ø§Ù†ØªØ± Ø§Ø¨"
      ],
      "Ø´ÙŠØ±ÙŠ": [
        "ØªÙŠØ¬Ùˆ 2 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 8","Ø§Ø±ÙŠØ²Ùˆ 6 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 5 Ø¨Ø±Ùˆ",
        "Ø£ÙƒØ³ÙŠÙŠØ¯ Ø§Ù„ Ø§ÙƒØ³","ØªÙŠØ¬Ùˆ 8 Ø¨Ø±Ùˆ","ØªÙŠØ¬Ùˆ 7","ØªÙŠØ¬Ùˆ 4 Ø¨Ø±Ùˆ"
      ],
      "ÙÙˆØ±Ø¯": ["Ø±ÙŠÙ†Ø¬Ø±","Ø§ÙƒØ³Ø¨Ù„ÙˆØ±","ØªÙŠØ±ÙŠØªÙˆØ±ÙŠ","ØªÙˆØ±Ø³"],
      "Ø¥Ù… Ø¬ÙŠ": ["Ø¬ÙŠ ØªÙŠ","Ø§Ù… Ø¬ÙŠ 3","Ø§Ù… Ø¬ÙŠ 7","Ø§Ù… Ø¬ÙŠ 5","Ø§ØªØ´ Ø£Ø³","Ø§Ø± Ø§ÙƒØ³ 5","ÙˆÙ†","Ø²Ø¯ Ø£Ø³","ØªÙŠ 60","Ø§Ø± Ø£ÙƒØ³ 9","ÙˆØ§Ù„","Ø§Ø± Ø£ÙƒØ³ 8"],
      "Ù†ÙŠØ³Ø§Ù†": ["Ø§ÙƒØ³ ØªØ±ÙŠÙ„","Ù…Ø§Ø¬Ù†Ø§ÙŠØª","ÙƒÙŠÙƒØ³","ØµÙ†ÙŠ","Ø§ÙƒØ³ ØªÙŠØ±Ø§","Ø§Ù„ØªÙŠÙ…Ø§"]
    };

    const carBrand  = document.getElementById('carBrand');
    const carModel  = document.getElementById('carModel');
    const carTrim   = document.getElementById('carTrim');
    const carEngine = document.getElementById('carEngine');

    function fillBrands(){
      carBrand.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© â€”</option>';
      Object.keys(CAR_MAP).forEach(b=>{
        const opt=document.createElement('option'); opt.value=b; opt.textContent=b;
        carBrand.appendChild(opt);
      });
    }
    function fillModels(brand){
      carModel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ â€”</option>';
      (CAR_MAP[brand]||[]).forEach(m=>{
        const opt=document.createElement('option'); opt.value=m; opt.textContent=m;
        carModel.appendChild(opt);
      });
    }
    function buildAutoTaskName(){
      const parts = [
        carBrand?.value?.trim() || '',
        carModel?.value?.trim() || '',
        carTrim?.value?.trim() || '',
        carEngine?.value?.trim() || ''
      ].filter(Boolean);
      const auto = parts.join(' ').replace(/\s+/g,' ').trim();
      if(auto) tName.value = auto;
    }
    carBrand?.addEventListener('change', ()=>{
      fillModels(carBrand.value);
      buildAutoTaskName();
    });
    [carModel, carTrim, carEngine].forEach(el=>{
      el?.addEventListener('input', buildAutoTaskName);
      el?.addEventListener('change', buildAutoTaskName);
    });
    function initCarSelectors(){
      fillBrands();
      fillModels(carBrand.value||'');
      carTrim.value=''; carEngine.value='';
    }

    function fillGroupSelect(cols=SPACE_COLUMNS){
      tGroup.innerHTML='';
      (cols||[]).forEach(col=>{
        const opt=document.createElement('option'); opt.value=col; opt.textContent=col;
        tGroup.appendChild(opt);
      });
    }

    function renderAssigneeChips(){
      assigneeChip.innerHTML = '';
      if(!SELECTED_ASSIGNEES.length){
        assigneeChip.innerHTML = '<span class="small muted">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯</span>';
        return;
      }
      SELECTED_ASSIGNEES.forEach(u=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.uid = u.uid;
        chip.innerHTML = `
          <span class="badge">
            <span class="dot" style="background:${u.color||'#bc8f74'}"></span>
            ${u.name}
          </span>
          <span class="chip-actions">
            <button type="button" class="chip-remove" title="Ø¥Ø²Ø§Ù„Ø©">âœ•</button>
          </span>
        `;
        chip.querySelector('.chip-remove').onclick = ()=>{
          SELECTED_ASSIGNEES = SELECTED_ASSIGNEES.filter(a=>a.uid!==u.uid);
          renderAssigneeChips();
        };
        assigneeChip.appendChild(chip);
      });
    }

    function openCreate(cols=SPACE_COLUMNS){
      if(!IS_ADMIN) return;
      EDITING_TASK = null;
      const titleEl = document.getElementById('taskModalTitle');
      if(titleEl) titleEl.textContent = 'ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯';

      resetCreateForm();
      fillGroupSelect(cols);

      const isCampaignTab = !panelCampaigns.classList.contains('hidden');
      if(isCampaignTab){
        tDesc.classList.add('campaign-full-desc');
      }else{
        tDesc.classList.remove('campaign-full-desc');
      }

      renderAssigneeChips();
      taskModal.classList.add('show');
    }
    
    function openEditTask(task){
      if(!IS_ADMIN || !task) return;
      EDITING_TASK = task;

      const titleEl = document.getElementById('taskModalTitle');
      if(titleEl) titleEl.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';

      const isCampaignBoard = CAMPAIGNS && CAMPAIGNS.some(c => c.id === task.spaceId);
      const cols = isCampaignBoard ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      resetCreateForm();
      fillGroupSelect(cols);

      const car = task.car || {};
      if(carBrand){
        carBrand.value = car.brand || '';
        fillModels(carBrand.value || '');
        carModel.value = car.model || '';
        carTrim.value = car.trim || '';
        carEngine.value = car.engine || '';
      }

      tName.value = task.name || '';
      tDesc.value = task.description || '';
      tDue.value = task.due || '';

      const members = taskMembersArray(task);
      SELECTED_ASSIGNEES = members.map(m => ({
        uid: m.uid || m.id || m,
        name: m.name || '',
        color: m.color || '#bc8f74'
      }));
      if(SELECTED_ASSIGNEES.length){
        tColor.value = SELECTED_ASSIGNEES[0].color;
      }
      renderAssigneeChips();

      if(task.status && cols.includes(task.status)){
        tGroup.value = task.status;
      }

      if(isCampaignBoard){
        tDesc.classList.add('campaign-full-desc');
      }else{
        tDesc.classList.remove('campaign-full-desc');
      }

      taskModal.classList.add('show');
    }

function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

    btnNewTask.addEventListener('click', ()=> openCreate(SPACE_COLUMNS));
    btnCloseModal.addEventListener('click', ()=> closeCreate());
    btnCancelTask.addEventListener('click', ()=> closeCreate());
    taskModal.addEventListener('click', (e)=>{ if(e.target===taskModal) closeCreate(); });

    function resetCreateForm(){
      EDITING_TASK = null;
      tName.value=''; tDesc.value='';
      tDesc.classList.remove('campaign-full-desc');
      tDue.value='';
      tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.style.display='none';
      SELECTED_ASSIGNEES=[];
      tColor.value='#bc8f74';
      fillGroupSelect();
      initCarSelectors();
      renderAssigneeChips();
    }

    function renderAssigneeMenu(filter){
      const f=(filter||'').toLowerCase();
      assigneeMenu.innerHTML='';
      USERS.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const it=document.createElement('div');
        it.className='dd-item';
        it.style.padding='8px 10px';
        it.style.cursor='pointer';
        it.innerHTML=`<span class="row"><span class="color-dot" style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${u.color||'#bc8f74'}"></span> ${u.name} <span class="muted">(${u.role})</span></span>`;
        it.onclick=()=> selectAssignee(u);
        assigneeMenu.appendChild(it);
      });
      assigneeMenu.style.display= USERS.length && assigneeMenu.innerHTML ? 'block' : 'none';
    }
    function selectAssignee(user){
      if(!user) return;
      if(!SELECTED_ASSIGNEES.find(u=>u.uid===user.uid)){
        SELECTED_ASSIGNEES.push({...user});
      }
      if(SELECTED_ASSIGNEES.length===1 && user.color){
        tColor.value = user.color;
      }
      assigneeMenu.style.display='none';
      renderAssigneeChips();
    }
    tAssigneeSearch.addEventListener('input', (e)=> renderAssigneeMenu(e.target.value.trim()));
    tAssigneeSearch.addEventListener('focus', ()=> renderAssigneeMenu(tAssigneeSearch.value));
    document.addEventListener('click', (e)=>{
      if(!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch) assigneeMenu.style.display='none';
    });

    /* ===== Campaign logic ===== */
    const CAMPAIGN_DEFAULT_COLS = [
      "Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´",
      "Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","Ø§Ù‚Ø³Ø§Ø· - Ai Generate","Ø¬Ø±Ø§ÙÙŠÙƒ - Ø§Ù‚Ø³Ø§Ø·",
      "Ø§Ù‚Ø³Ø§Ø· Ø´Ø±ÙƒØ§Øª - Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"
    ];

    const campaignSelect     = document.getElementById('campaignSelect');
    const boardCampaigns     = document.getElementById('boardCampaigns');
    const btnNewCampaignTask = document.getElementById('btnNewCampaignTask');
    const btnNewCampaign     = document.getElementById('btnNewCampaign');
    const campaignDates      = document.getElementById('campaignDates');
    const campaignToggle     = document.getElementById('campaignToggle');

    function setCampaignDescription(html){
      if(!campaignDates) return;
      const content = html || "Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
      campaignDates.innerHTML = content;
      campaignDates.classList.remove('expanded');
      if(campaignToggle){
        requestAnimationFrame(()=>{
          const needsToggle = campaignDates.scrollHeight > campaignDates.clientHeight + 4;
          campaignToggle.style.display = needsToggle ? 'inline-flex' : 'none';
          campaignToggle.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
        });
      }
    }

    if(campaignToggle){
      campaignToggle.addEventListener('click', ()=>{
        const expanded = campaignDates.classList.toggle('expanded');
        campaignToggle.textContent = expanded ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØµÙ' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
      });
    }

    let CURRENT_CAMPAIGN = null;
    let CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
    let TASKS_CAMPAIGNS  = [];
    let unsubTasksCampaigns = null;
    let CAMPAIGNS = [];

    function fillCampaignDropdown(list, selectedId){
      campaignSelect.innerHTML='';
      if(!list.length){
        const opt=document.createElement('option');
        opt.value=''; opt.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª â€” Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        campaignSelect.appendChild(opt);
        campaignSelect.disabled = true;
        return;
      }
      campaignSelect.disabled = false;
      list.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.name || 'Ø­Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        campaignSelect.appendChild(opt);
      });
      if(selectedId && list.find(c=>c.id===selectedId)){
        campaignSelect.value=selectedId;
      }else{
        campaignSelect.value=list[0].id;
      }
    }

    function updateCampaignInfo(campaign){
      if(!campaignDates) return;
      if(!campaign){
        setCampaignDescription("Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.");
        return;
      }
      const desc  = campaign.description || campaign.desc || '';
      const start = campaign.startDate || '';
      const end   = campaign.endDate   || '';
      let html = "";

      if(start || end){
        html += `<p style="margin:0 0 6px;font-weight:700;color:var(--brown);">Ø§Ù„ÙØªØ±Ø©: <span style="font-weight:400;">${start || 'â€”'} Ø¥Ù„Ù‰ ${end || 'â€”'}</span></p>`;
      }
      if(desc){
        html += desc;
      }
      if(!html){
        setCampaignDescription("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©.");
      }else{
        setCampaignDescription(html);
      }
    }

    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù…Ù„Ø§Øª type="campaign" Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø­Ù…Ù„Ø© Ø«Ø§Ø¨ØªØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    onSnapshot(
      query(collection(db,'spaces'), where('type','==','campaign')),
      snap=>{
        const arr=[];
        snap.forEach(d=>{
          const data=d.data()||{};
          if(data.active===false) return;
          arr.push({ id:d.id, ...data });
          SPACES_CACHE.set(d.id, data.name||d.id);
        });

        let defaultCampaign =
          arr.find(c=>c.isDefault === true) ||
          arr.find(c=>(c.name||'').includes('Ø­Ù…Ù„Ø© Ø«Ø§Ø¨ØªØ©'));

        if(defaultCampaign){
          arr.sort((a,b)=>{
            if(a.id === defaultCampaign.id) return -1;
            if(b.id === defaultCampaign.id) return 1;
            return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);
          });
        }else{
          arr.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        }

        CAMPAIGNS = arr;

        if(!CAMPAIGNS.length){
          CURRENT_CAMPAIGN = null;
          fillCampaignDropdown([], null);
          boardCampaigns.innerHTML='';
          setCampaignDescription("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø±.");
          if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
          return;
        }

        if(!CURRENT_CAMPAIGN || !CAMPAIGNS.find(c=>c.id===CURRENT_CAMPAIGN)){
          CURRENT_CAMPAIGN = defaultCampaign
            ? defaultCampaign.id
            : (CAMPAIGNS[0]?.id || null);
        }

        fillCampaignDropdown(CAMPAIGNS, CURRENT_CAMPAIGN);

        const found = CAMPAIGNS.find(c=>c.id===CURRENT_CAMPAIGN) || CAMPAIGNS[0];
        CURRENT_CAMPAIGN   = found?.id || null;
        CAMPAIGN_COLUMNS   = found?.columns?.length ? found.columns : CAMPAIGN_DEFAULT_COLS.slice();
        renderBoardSkeletonCampaigns();
        listenTasksCampaigns();
        updateCampaignInfo(found);
      },
      err=>{
        console.error(err);
        setCampaignDescription("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª");
      }
    );

    function bootCampaigns(){
      setCampaignDescription("Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ø­Ù…Ù„Ø©.");

      campaignSelect.addEventListener('change', async (e)=>{
        const id = e.target.value || null;
        CURRENT_CAMPAIGN = id;
        if(!id){
          boardCampaigns.innerHTML='';
          if(unsubTasksCampaigns){unsubTasksCampaigns();unsubTasksCampaigns=null;}
          updateCampaignInfo(null);
          return;
        }
        const d = await getDoc(doc(db,'spaces', id));
        const data = d.data()||{};
        CAMPAIGN_COLUMNS = data.columns?.length ? data.columns : CAMPAIGN_DEFAULT_COLS.slice();
        renderBoardSkeletonCampaigns();
        listenTasksCampaigns();
        updateCampaignInfo({ id, ...data });
      });

      btnNewCampaignTask?.addEventListener('click', ()=>{
        if(!CURRENT_CAMPAIGN) return alert('Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
        fillGroupSelect(CAMPAIGN_COLUMNS);
        openCreate(CAMPAIGN_COLUMNS);
      });

      btnNewCampaign?.addEventListener('click', async ()=>{
        if(!IS_ADMIN) return;
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©:');
        if(!name) return;
        try{
          const ref = await addDoc(collection(db,'spaces'), {
            name,
            type:'campaign',
            columns: CAMPAIGN_DEFAULT_COLS,
            createdAt: serverTimestamp(),
            active: true,
            isDefault: false
          });
          CURRENT_CAMPAIGN = ref.id;
          CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
          renderBoardSkeletonCampaigns();
          listenTasksCampaigns();
        }catch(err){
          console.error(err);
          alert('âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: '+(err?.message||err));
        }
      });

      boardCampaigns.addEventListener('click', async (e)=>{
        const doneBtn = e.target.closest('.campaign-done-btn');
        if(!doneBtn) return;
        e.stopPropagation();
        const id = doneBtn.dataset.id;
        if(!id) return;

        const task = TASKS_CAMPAIGNS.find(t=> t.id === id);
        if(!task || !canUserMarkCampaignDone(task)){
          alert('Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´Ù† ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
          return;
        }

        try{
          const newOrder = computeOrderAtEnd("ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡");
          await updateTaskStatusAndOrder(id, "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", newOrder);
        }catch(err){
          console.error(err);
          alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
        }
      });
    }

    function renderBoardSkeletonCampaigns(){
      const board=boardCampaigns;
      board.innerHTML='';

      (CAMPAIGN_COLUMNS||[]).forEach((col)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.innerHTML=`
          <div class="col-head" style="cursor:default">
            <span class="col-title">${col}</span>
            <div class="col-actions" style="${IS_ADMIN?'display:flex':'display:none'}">
              <button class="icon" data-act="newtask" title="ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯">â•</button>
            </div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;
        board.appendChild(sec);
        sec.querySelector('.col-actions').addEventListener('click',(e)=>{
          const act=e.target.dataset.act;
          if(act==='newtask'){
            fillGroupSelect(CAMPAIGN_COLUMNS);
            tGroup.value=col;
            openCreate(CAMPAIGN_COLUMNS);
          }
        });
      });
      // Ø¹Ù…ÙˆØ¯ Ø«Ø§Ø¨Øª Ù„Ù€Ù€ "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù„ÙˆØ­Ø©
      (function(){
        const doneCol = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=doneCol;
        sec.innerHTML = `
          <div class="col-head" style="cursor:default">
            <span class="col-title">${doneCol}</span>
            <div class="col-actions" style="display:none"></div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${doneCol}"></div></div>
        `;
        board.appendChild(sec);
      })();

      const doneCol = document.createElement('section');
      doneCol.className = 'col campaign-done-col';
      doneCol.dataset.status = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
      doneCol.innerHTML = `
        <div class="col-head" style="cursor:default">
          <span class="col-title">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
        </div>
        <div class="col-body"><div class="dropzone" data-zone="ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"></div></div>
      `;
      board.appendChild(doneCol);

      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          const newOrder = computeOrderAtEnd(newStatus);
          await updateTaskStatusAndOrder(cardId, newStatus, newOrder);
        });
      });
    }

    function renderMembersBadges(members){
      if(!members.length) return '';
      if(members.length<=2){
        return members.map(m=>`
          <span class="badge">
            <span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}
          </span>
        `).join('');
      }
      const firstTwo = members.slice(0,2).map(m=>`
        <span class="badge">
          <span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}
        </span>
      `).join('');
      const more = members.length-2;
      return firstTwo + `<span class="small">+${more}</span>`;
    }

    function taskOrderValue(t){
      if(typeof t.order === 'number') return t.order;
      if(t.createdAt?.seconds) return t.createdAt.seconds;
      return 0;
    }

    async function updateTaskStatusAndOrder(taskId, newStatus, newOrder){
      const patch = { status:newStatus };
      if(typeof newOrder === 'number' && !Number.isNaN(newOrder)){
        patch.order = newOrder;
      }
      try{
        await updateDoc(doc(db,'tasks', taskId), patch);
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ù‚Ù„: '+(err?.message||err));
      }
    }

    function computeOrderForDrop(status, targetTaskId, position){
      const tasks = TASKS_CAMPAIGNS
        .filter(t=>t.status===status)
        .slice()
        .sort((a,b)=> taskOrderValue(a)-taskOrderValue(b));

      if(!tasks.length) return 1;

      const idx = tasks.findIndex(t=>t.id===targetTaskId);
      if(idx===-1){
        const last = tasks[tasks.length-1];
        return taskOrderValue(last)+1;
      }

      const target = tasks[idx];
      const targetVal = taskOrderValue(target);

      if(position === 'before'){
        if(idx===0){
          return targetVal - 1;
        }
        const prev = tasks[idx-1];
        const prevVal = taskOrderValue(prev);
        return (prevVal + targetVal)/2;
      }else{
        if(idx===tasks.length-1){
          return targetVal + 1;
        }
        const next = tasks[idx+1];
        const nextVal = taskOrderValue(next);
        return (targetVal + nextVal)/2;
      }
    }

    function computeOrderAtEnd(status){
      const tasks = TASKS_CAMPAIGNS.filter(t=>t.status===status);
      if(!tasks.length) return 1;
      let max = tasks.reduce((m,t)=> Math.max(m, taskOrderValue(t)), 0);
      return max + 1;
    }

    function renderTasksCampaigns(){
      const board=boardCampaigns;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const source = FILTER_MEMBER_CAMPAIGNS
        ? TASKS_CAMPAIGNS.filter(t => taskBelongsToMember(t, FILTER_MEMBER_CAMPAIGNS))
        : TASKS_CAMPAIGNS;

      const byStatus={};
      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(s=> byStatus[s]=[]);
      source.forEach(t=>{
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        if(!zone) return;
        const list = byStatus[status]||[];
        list.sort((a,b)=> taskOrderValue(a)-taskOrderValue(b));
        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='card';
          card.dataset.id=t.id;
          const members = taskMembersArray(t);
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';

          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
          `;

          const footer = document.createElement('div');
          footer.className = 'row between';
          const left = document.createElement('div');
          left.innerHTML = `
            ${members.length? renderMembersBadges(members):''}
            ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
          `;
          footer.appendChild(left);

          const canDone = canUserMarkCampaignDone(t);
          if(t.status !== "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" && canDone){
            const right = document.createElement('div');
            const btn = document.createElement('button');
            btn.className = 'btn secondary xs campaign-done-btn';
            btn.textContent = 'âœ“';
            btn.title = 'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
            btn.dataset.id = t.id;
            right.appendChild(btn);
            footer.appendChild(right);
          }

          card.appendChild(footer);

          card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });

          card.addEventListener('dragover', e=>{
            if(e.dataTransfer.types.includes(MIME_TASK)){
              e.preventDefault();
              card.classList.add('drag-over');
            }
          });
          card.addEventListener('dragleave', ()=>{
            card.classList.remove('drag-over');
          });
          card.addEventListener('drop', async (e)=>{
            if(!e.dataTransfer.types.includes(MIME_TASK)) return;
            e.preventDefault();
            card.classList.remove('drag-over');
            const draggedId = e.dataTransfer.getData(MIME_TASK);
            if(!draggedId || draggedId === t.id) return;
            const zoneEl = card.closest('.dropzone');
            if(!zoneEl) return;
            const status = zoneEl.dataset.zone;
            const rect = card.getBoundingClientRect();
            const mid = rect.top + rect.height/2;
            const position = e.clientY < mid ? 'before' : 'after';
            const newOrder = computeOrderForDrop(status, t.id, position);
            await updateTaskStatusAndOrder(draggedId, status, newOrder);
          });

          card.addEventListener('click', (e)=>{
            if(e.target.closest('.campaign-done-btn')) return;
            openDetail(t);
          });
          zone.appendChild(card);
        });
      });
    }

        function listenTasksCampaigns(){
      if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
      if(!CURRENT_CAMPAIGN) return;

      const tasksMap = new Map();
      const col = collection(db,'tasks');

      const handleSnap = (snap)=>{
        let changed = false;
        snap.docChanges().forEach(change=>{
          const id = change.doc.id;
          if(change.type === 'removed'){
            if(tasksMap.has(id)){
              tasksMap.delete(id);
              changed = true;
            }
          }else{
            const data = change.doc.data()||{};
            tasksMap.set(id, { id, ...data });
            changed = true;
          }
        });
        if(!changed) return;

        TASKS_CAMPAIGNS = Array.from(tasksMap.values());
        renderTasksCampaigns();
      };

      const unsub1 = onSnapshot(
        query(col, where('spaceId','==', CURRENT_CAMPAIGN)),
        handleSnap,
        (err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (spaceId) (Ø§Ù„Ø­Ù…Ù„Ø§Øª).'); }
      );

      const unsub2 = onSnapshot(
        query(col, where('campaignId','==', CURRENT_CAMPAIGN)),
        handleSnap,
        (err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (campaignId) (Ø§Ù„Ø­Ù…Ù„Ø§Øª).'); }
      );

      unsubTasksCampaigns = ()=>{
        try{ unsub1 && unsub1(); }catch{}
        try{ unsub2 && unsub2(); }catch{}
      };
    }

    /* Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ (Spaces / Campaign) + Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù† */
    btnSaveTask.addEventListener('click', async ()=>{
      const isCampaignTab = !panelCampaigns.classList.contains('hidden');
      const targetSpaceId = isCampaignTab ? CURRENT_CAMPAIGN : CURRENT_SPACE;
      const targetCols    = isCampaignTab ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      if(!IS_ADMIN) return alert('Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ†');
      if(!EDITING_TASK && !targetSpaceId) return alert('Ø§Ø®ØªØ± Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹');

      if(!tName.value.trim()) buildAutoTaskName();
      const name=tName.value.trim();
      if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');

      const due=tDue.value||null;
      const description=tDesc.value||null;
      const color=(document.getElementById('tColor').value||'#bc8f74').trim();
      const status=tGroup.value || (targetCols[0]||'Ø¹Ù…ÙˆØ¯');

      const car = {
        brand:  carBrand?.value?.trim()  || null,
        model:  carModel?.value?.trim()  || null,
        trim:   carTrim?.value?.trim()   || null,
        engine: carEngine?.value?.trim() || null
      };

      const assigneesPayload = SELECTED_ASSIGNEES.map(u=>({
        uid: u.uid,
        name: u.name,
        color: color
      }));

      try{
        for(const u of assigneesPayload){
          await setDoc(doc(db,'users', u.uid), { color }, { merge:true });
          const idx=USERS.findIndex(x=>x.uid===u.uid);
          if(idx>-1) USERS[idx].color=color;
        }

        if(EDITING_TASK){
          const patch = {
            name,
            description,
            due,
            status,
            car,
            assignees: assigneesPayload.length ? assigneesPayload : null,
            assignee: assigneesPayload.length ? assigneesPayload[0] : null
          };
          await updateDoc(doc(db,'tasks', EDITING_TASK.id), patch);
          alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ');
        }else{
          const payload = {
            spaceId: targetSpaceId,
            name,
            description,
            due,
            status,
            car,
            assignees: assigneesPayload.length ? assigneesPayload : null,
            assignee: assigneesPayload.length ? assigneesPayload[0] : null,
            links: [],
            createdBy: CURRENT_USER?.uid || null,
            createdAt: serverTimestamp(),
            active:true,
            order: Date.now()
          };

          if(isCampaignTab && CURRENT_CAMPAIGN){
            payload.campaignId   = CURRENT_CAMPAIGN;
            payload.workspaceType = 'campaign';
          }else{
            payload.workspaceType = 'space';
          }

          const ref = await addDoc(collection(db,'tasks'), payload);

          // ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù†
          await createMentionNotifications({
            taskId: ref.id,
            taskName: name,
            taskDescription: description,
            spaceId: targetSpaceId,
            status,
            assignees: assigneesPayload
          });

          alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ');
        }

        closeCreate();
      }catch(e){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+(e?.message||e)); }
    });

    /* Board & Details â€” Spaces */
    function renderColumnHeaderActionsSpaces(container, columnName){
      const actions=document.createElement('div');
      actions.className='col-actions';
      actions.style.display=IS_ADMIN?'flex':'none';

      const btnRename=document.createElement('button');
      btnRename.className='icon';
      btnRename.textContent='âœï¸';
      btnRename.title='Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnRename.onclick=async ()=>{
        if(!IS_ADMIN) return;
        const nn=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', columnName);
        if(!nn||nn===columnName) return;
        const cols=SPACE_COLUMNS.map(c=>c===columnName?nn:c);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };

      const btnDelete=document.createElement('button');
      btnDelete.className='icon';
      btnDelete.textContent='ğŸ—‘ï¸';
      btnDelete.title='Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnDelete.onclick=async ()=>{
        if(!IS_ADMIN) return;
        if(SPACE_COLUMNS.length<=1) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯.');
        const target=prompt(`Ø³ÙŠØªÙ… Ø­Ø°Ù "${columnName}". Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰: \n${SPACE_COLUMNS.join(', ')}`);
        if(!target || !SPACE_COLUMNS.includes(target) || target===columnName) return;
        const affected=TASKS_SPACES.filter(t=>t.status===columnName);
        for(const t of affected){
          try{ await updateDoc(doc(db,'tasks', t.id), { status:target }); }catch{}
        }
        const cols=SPACE_COLUMNS.filter(c=>c!==columnName);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };

      actions.appendChild(btnRename);
      actions.appendChild(btnDelete);
      container.appendChild(actions);
    }

    async function persistColumnsOrderSpaces(newOrder){
      if (!CURRENT_SPACE) return;
      try{ await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: newOrder }); }
      catch(e){ console.error(e); alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.'); }
    }

    function renderBoardSkeletonSpaces(){
      const board=boardSpaces;
      board.innerHTML='';
      (SPACE_COLUMNS||[]).forEach((col, index)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.dataset.index=index;

        sec.innerHTML=`
          <div class="col-head">
            <span class="col-title">${col}</span>
            <span class="grip"><span class="dots">â‹®â‹®</span> Ø§Ø³Ø­Ø¨</span>
            <div class="__actions"></div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;

        const grip = sec.querySelector('.grip');
        if (IS_ADMIN && grip){
          grip.setAttribute('draggable','true');
          grip.addEventListener('dragstart',(e)=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_COLUMN, String(index));
          });
        }
        sec.addEventListener('dragover',(e)=>{
          if (e.dataTransfer.types.includes(MIME_COLUMN)){
            e.preventDefault(); e.dataTransfer.dropEffect='move';
          }
        });
        sec.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_COLUMN)) return;
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData(MIME_COLUMN),10);
          const to   = parseInt(sec.dataset.index,10);
          if (isNaN(from)||isNaN(to)||from===to) return;
          const newOrder = SPACE_COLUMNS.slice();
          const [moved] = newOrder.splice(from,1);
          newOrder.splice(to,0,moved);
          SPACE_COLUMNS = newOrder;
          renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
          await persistColumnsOrderSpaces(newOrder);
        });

        board.appendChild(sec);
        renderColumnHeaderActionsSpaces(sec.querySelector('.__actions'), col);
      });

      // Ø¹Ù…ÙˆØ¯ "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù„ÙˆØ­Ø©
      {
        const sec = document.createElement('section');
        sec.className = 'col daily-done-col';
        sec.dataset.status = DONE_STATUS_SPACES;
        sec.innerHTML = `
          <div class="col-head" style="cursor:default">
            <span class="col-title">${DONE_STATUS_SPACES}</span>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${DONE_STATUS_SPACES}"></div></div>
        `;
        board.appendChild(sec);
      }


      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          try{ await updateDoc(doc(db,'tasks', cardId), { status:newStatus }); }
          catch(err){ alert('âš ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§ÙÙŠØ©.'); }
        });
      });
    }

    
    // Ø²Ø±Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ ÙÙŠ Ù„ÙˆØ­Ø© Spaces (ÙŠÙ†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)
    boardSpaces.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.space-done-btn');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      const task = TASKS_SPACES.find(t=> t.id === id);
      if(!task) return;
      try{
        await updateDoc(doc(db,'tasks', id), { status: DONE_STATUS_SPACES });
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
      }
    });

function renderTasksSpaces(){
      const board=boardSpaces;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const source = FILTER_MEMBER_SPACES
        ? TASKS_SPACES.filter(t => taskBelongsToMember(t, FILTER_MEMBER_SPACES))
        : TASKS_SPACES;

      const byStatus={}; ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(s=> byStatus[s]=[]);
      source.forEach(t=>{
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        const list = byStatus[status]||[];
        list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='card';
          card.dataset.id=t.id;
          const members = taskMembersArray(t);
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';
          const canDoneSpace = true;
          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
            <div class="row between" style="margin-top:6px">
              <div class="row">
                ${members.length? renderMembersBadges(members):''}
                ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
              </div>
              ${t.status !== DONE_STATUS_SPACES && canDoneSpace ? `
                <button class="btn secondary xs space-done-btn" data-id="${t.id}" title="Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡">âœ“</button>
              ` : ''}
            </div>`;          
card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });
          card.addEventListener('click', ()=> openDetail(t));
          zone?.appendChild(card);
        });
      });
    }

        function listenTasksSpaces(){
      if(unsubTasksSpaces){ unsubTasksSpaces(); unsubTasksSpaces=null; }
      if(!CURRENT_SPACE) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasksSpaces = onSnapshot(qy,(snap)=>{
        const raw = [];
        snap.forEach(d=> raw.push({ id:d.id, ...(d.data()||{}) }));
        console.log('tasks snapshot spaces', raw);

        // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙÙ„ØªØ±Ø©
        TASKS_SPACES = raw;

        renderTasksSpaces();
        if(OPEN_TASK){
          const now = TASKS_SPACES.find(t=>t.id===OPEN_TASK.id);
          if(now) openDetail(now);
        }
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Spaces).'); });
    }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© + Ø±ÙˆØ§Ø¨Ø· (Ù…Ø´ØªØ±ÙƒØ©) */
    function renderDetailAssignees(task){
      const el = document.getElementById('dAssignee');
      el.innerHTML = '';
      const members = taskMembersArray(task);
      if(!members.length){
        el.innerHTML = '<span class="muted">â€”</span>';
        return;
      }
      members.forEach(m=>{
        const span = document.createElement('span');
        span.className='badge';
        span.innerHTML = `<span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}`;
        el.appendChild(span);
      });
    }

    function openDetail(task){
      OPEN_TASK=task;
      document.getElementById('dTitle').textContent=task.name||'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
      const dDesc = document.getElementById('dDesc');
      dDesc.value = task.description || '';
      renderDetailAssignees(task);
      document.getElementById('dDue').textContent=task.due||'â€”';
      document.getElementById('dStatus').textContent=task.status||'â€”';

      const showActions = canManageLinks(task);
      document.getElementById('dActions').style.display = showActions ? 'block' : 'none';
      document.getElementById('btnEditTask').style.display = IS_ADMIN ? '' : 'none';
      document.getElementById('btnDeleteTask').style.display = IS_ADMIN ? '' : 'none';

      const reviewBtn = document.getElementById('btnMarkReviewed');
      if (reviewBtn){
        if (task.status === 'assigned'){
          reviewBtn.textContent = 'Ø¨Ø¯Ø£Øª Ø§Ù„Ø´ØºÙ„';
          reviewBtn.style.display = '';
        } else if (task.status === 'in_progress'){
          reviewBtn.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
          reviewBtn.style.display = '';
        } else if (task.status === 'changes_requested'){
          reviewBtn.textContent = 'Ø¹Ø¯Ù„Øª Ùˆ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
          reviewBtn.style.display = '';
        } else {
          reviewBtn.style.display = 'none';
        }
      }

      const linksEl=document.getElementById('dLinks');
      linksEl.innerHTML='';
      (task.links||[]).forEach((l, idx)=>{
        const chip=document.createElement('span'); chip.className='chip'; chip.dataset.idx=idx;
        const title = l.title || l.url;
        chip.innerHTML = `
          ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${title}</a>
          ${showActions?`
            <span class="chip-actions">
              <button class="link-edit" data-idx="${idx}" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
              <button class="link-del"  data-idx="${idx}" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
            </span>`:''}
        `;
        linksEl.appendChild(chip);
      });

      document.getElementById('detailModal').classList.add('show');
    }
    document.getElementById('btnCloseDetail').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
    document.getElementById('detailModal').addEventListener('click', (e)=>{ if(e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('show'); });

    document.getElementById('btnMarkReviewed').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return;
      try{
        const taskRef = doc(db,'tasks', OPEN_TASK.id);
        const snap = await getDoc(taskRef);
        const data = snap.exists() ? (snap.data() || {}) : {};
        const currentStatus = data.status || OPEN_TASK.status || '';
        const now = Timestamp.now();
        const existingTimestamps = data.timestamps || {};
        const existingReviewCycles = Array.isArray(data.reviewCycles) ? data.reviewCycles.slice() : [];

        if (currentStatus === 'assigned'){
          const updatePayload = { status: 'in_progress' };
          if (!existingTimestamps.startedAt){
            updatePayload['timestamps.startedAt'] = now;
          }
          await updateDoc(taskRef, updatePayload);
        } else if (currentStatus === 'in_progress' || currentStatus === 'changes_requested'){
          const round = (existingReviewCycles.length || 0) + 1;
          existingReviewCycles.push({
            round,
            sentForReviewAt: now,
            feedbackAt: null,
            result: 'pending'
          });

          const updatePayload = {
            status: 'ready_for_review',
            reviewCycles: existingReviewCycles,
            'timestamps.lastReadyForReviewAt': now
          };
          if (!existingTimestamps.firstReadyForReviewAt){
            updatePayload['timestamps.firstReadyForReviewAt'] = now;
          }
          await updateDoc(taskRef, updatePayload);
        } else {
          document.getElementById('detailModal').classList.remove('show');
          return;
        }

        document.getElementById('detailModal').classList.remove('show');
      }catch(e){
        console.error(e);
        alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+(e && e.message ? e.message : e));
      }
    });

    document.getElementById('btnEditTask').addEventListener('click', ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      document.getElementById('detailModal').classList.remove('show');
      openEditTask(OPEN_TASK);
    });

    document.getElementById('btnDeleteTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
      try{
        await deleteDoc(doc(db,'tasks', OPEN_TASK.id));
        document.getElementById('detailModal').classList.remove('show');
      }catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message); }
    });

    document.getElementById('btnAddLink').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return alert('Ø§ÙØªØ­ Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
      if(!canManageLinks(OPEN_TASK)) return alert('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·');
      const title = (document.getElementById('dLinkTitle').value||'Ø±Ø§Ø¨Ø·').trim();
      const url   = (document.getElementById('dLinkUrl').value||'').trim();
      if(!url || !/^https?:\/\//i.test(url)) return alert('Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://');

      try{
        await updateDoc(doc(db,'tasks', OPEN_TASK.id), {
          links: arrayUnion({ title, url, by: CURRENT_USER?.uid || null, at: Timestamp.now() })
        });
        document.getElementById('dLinkTitle').value='';
        document.getElementById('dLinkUrl').value='';
      }catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: '+e.message); }
    });

    /* Boot spaces default */
    async function bootSpaces(){
      if(!CURRENT_SPACE){
        CURRENT_SPACE = await ensureDefaultSpace();
        const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
        SPACE_COLUMNS = d.exists()
          ? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS)
          : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect();
      }
    }

    /* ===== Daily Task logic ===== */

    const DAILY_DAYS = [
      { key:'sat', label:'Ø§Ù„Ø³Ø¨Øª' },
      { key:'sun', label:'Ø§Ù„Ø£Ø­Ø¯' },
      { key:'mon', label:'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†' },
      { key:'tue', label:'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' },
      { key:'wed', label:'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡' },
      { key:'thu', label:'Ø§Ù„Ø®Ù…ÙŠØ³' }
    ];
    const DAILY_WEEKS = [1,2,3,4];

    const dailyMonthSelect = document.getElementById('dailyMonthSelect');
    const dailyBoard       = document.getElementById('dailyBoard');
    const dailyMeta        = document.getElementById('dailyMeta');

    const dailyModal       = document.getElementById('dailyModal');
    const dailyModalTitle  = document.getElementById('dailyModalTitle');
    const dailyTitleInput  = document.getElementById('dailyTitle');
    const dailyDescInput   = document.getElementById('dailyDesc');
    const btnDailySave     = document.getElementById('btnDailySave');
    const btnDailyCancel   = document.getElementById('btnDailyCancel');
    const btnDailyDelete   = document.getElementById('btnDailyDelete');

    let DAILY_MONTH_KEY = null;
    let DAILY_TASKS = [];
    let unsubDailyTasks = null;
    let CURRENT_DAILY_EDIT = null;
    let CURRENT_DAILY_WEEK = null;
    let CURRENT_DAILY_DAY  = null;

    function currentMonthKey(){
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function fillDailyMonthOptions(){
      if(!dailyMonthSelect) return;
      dailyMonthSelect.innerHTML='';
      const now=new Date();
      const year=now.getFullYear();
      for(let m=1;m<=12;m++){
        const key = `${year}-${String(m).padStart(2,'0')}`;
        const monthDate = new Date(year, m-1, 1);
        const label = monthDate.toLocaleDateString('ar-EG-u-ca-gregory',{month:'long'});
        const opt=document.createElement('option');
        opt.value=key; opt.textContent=label;
        dailyMonthSelect.appendChild(opt);
      }
      DAILY_MONTH_KEY = DAILY_MONTH_KEY || currentMonthKey();
      dailyMonthSelect.value = DAILY_MONTH_KEY;
      updateDailyMeta();
    }

    function updateDailyMeta(){
      if(!dailyMeta) return;
      const label = dailyMonthSelect.options[dailyMonthSelect.selectedIndex]?.textContent || '';
      const countMonth = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && !t.completed && t.dayKey!=='note').length;
      const countDone  = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.completed && t.dayKey!=='note').length;
      dailyMeta.textContent = `${label} â€” Ù…Ù‡Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„: ${countMonth} | ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${countDone}`;
    }

    function listenDailyTasks(){
      if(unsubDailyTasks){ unsubDailyTasks(); unsubDailyTasks=null; }
      unsubDailyTasks = onSnapshot(collection(db,'dailyTasks'), (snap)=>{
        DAILY_TASKS=[];
        snap.forEach(d=> DAILY_TASKS.push({ id:d.id, ...(d.data()||{}) }));
        renderDailyBoard();
      },(err)=>{
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.');
      });
    }

    function openDailyModal(mode, task=null){
      if(!IS_ADMIN) return;
      if(mode==='new'){
        CURRENT_DAILY_EDIT = null;
        dailyModalTitle.textContent='ØªØ§Ø³Ùƒ ÙŠÙˆÙ…ÙŠ Ø¬Ø¯ÙŠØ¯';
        dailyTitleInput.value='';
        dailyDescInput.value='';
        btnDailyDelete.style.display='none';
      }else if(mode==='edit' && task){
        CURRENT_DAILY_EDIT = task.id;
        CURRENT_DAILY_WEEK = task.week;
        CURRENT_DAILY_DAY  = task.dayKey;
        dailyModalTitle.textContent= task.dayKey === 'note' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©' : 'ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ ÙŠÙˆÙ…ÙŠ';
        dailyTitleInput.value = task.title || '';
        dailyDescInput.value  = task.description || '';
        btnDailyDelete.style.display='';
      }
      dailyModal.classList.add('show');
    }

    function closeDailyModal(){
      dailyModal.classList.remove('show');
    }

    btnDailyCancel.addEventListener('click', ()=> closeDailyModal());
    dailyModal.addEventListener('click', (e)=>{ if(e.target===dailyModal) closeDailyModal(); });

    btnDailySave.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
      const title = (dailyTitleInput.value||'').trim();
      const desc  = (dailyDescInput.value||'').trim() || null;
      if(!title) return alert('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.');

      try{
        if(CURRENT_DAILY_EDIT){
          await updateDoc(doc(db,'dailyTasks', CURRENT_DAILY_EDIT), {
            title,
            description: desc
          });
        }else{
          if(!CURRENT_DAILY_WEEK || !CURRENT_DAILY_DAY){
            alert('Ø§Ù„ÙŠÙˆÙ… ØºÙŠØ± Ù…Ø­Ø¯Ø¯ØŒ Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„.');
            return;
          }
          await addDoc(collection(db,'dailyTasks'), {
            monthKey: DAILY_MONTH_KEY,
            week: CURRENT_DAILY_WEEK,
            dayKey: CURRENT_DAILY_DAY,
            title,
            description: desc,
            completed:false,
            createdAt: serverTimestamp(),
            createdBy: CURRENT_USER?.uid || null
          });
        }
        closeDailyModal();
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: '+(err?.message||err));
      }
    });

    btnDailyDelete.addEventListener('click', async ()=>{
      if(!IS_ADMIN || !CURRENT_DAILY_EDIT) return;
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
      try{
        await deleteDoc(doc(db,'dailyTasks', CURRENT_DAILY_EDIT));
        closeDailyModal();
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: '+(err?.message||err));
      }
    });

    function bootDailyTasks(){
      fillDailyMonthOptions();
      dailyMonthSelect.addEventListener('change', ()=>{
        DAILY_MONTH_KEY = dailyMonthSelect.value;
        renderDailyBoard();
      });
      listenDailyTasks();

      if(dailyBoard){
        dailyBoard.addEventListener('click', async (e)=>{
          const addBtn = e.target.closest('.day-add');
          const noteBtn = e.target.closest('.note-add');

          if(noteBtn){
            if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.');
            const text = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:');
            if(!text || !text.trim()) return;
            try{
              await addDoc(collection(db,'dailyTasks'), {
                monthKey: DAILY_MONTH_KEY,
                week: 0,
                dayKey: 'note',
                title: text.trim(),
                description: null,
                completed:false,
                createdAt: serverTimestamp(),
                createdBy: CURRENT_USER?.uid || null,
                type: 'note'
              });
            }catch(err){
              console.error(err);
              alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: '+(err?.message||err));
            }
            return;
          }

          if(addBtn && !addBtn.classList.contains('note-add')){
            if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.');
            const week = parseInt(addBtn.dataset.week,10);
            const dayKey = addBtn.dataset.day;
            CURRENT_DAILY_EDIT = null;
            CURRENT_DAILY_WEEK = week;
            CURRENT_DAILY_DAY  = dayKey;
            openDailyModal('new');
            return;
          }

          const doneBtn = e.target.closest('.daily-done-btn');
          if(doneBtn){
            const id = doneBtn.dataset.id;
            const task = DAILY_TASKS.find(t=>t.id===id);
            if(!task) return;
            try{
              await updateDoc(doc(db,'dailyTasks', id), {
                completed:true,
                completedAt: serverTimestamp()
              });
            }catch(err){
              console.error(err);
              alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
            }
            return;
          }

          const cardEl = e.target.closest('.daily-card');
          if(cardEl && !e.target.closest('.daily-done-btn')){
            if(!IS_ADMIN) return;
            const id = cardEl.dataset.id;
            const task = DAILY_TASKS.find(t=>t.id===id);
            if(task){
              CURRENT_DAILY_WEEK = task.week;
              CURRENT_DAILY_DAY  = task.dayKey;
              openDailyModal('edit', task);
            }
          }
        });
      }
    }

    function renderDailyBoard(){
      if(!dailyBoard) return;
      DAILY_MONTH_KEY = DAILY_MONTH_KEY || currentMonthKey();
      if(dailyMonthSelect && dailyMonthSelect.value!==DAILY_MONTH_KEY){
        dailyMonthSelect.value = DAILY_MONTH_KEY;
      }

      dailyBoard.innerHTML='';

      DAILY_WEEKS.forEach(week=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.week=week;
        sec.innerHTML=`
          <div class="col-head" style="cursor:default">
            <span class="col-title">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week}</span>
          </div>
          <div class="col-body daily-week-body"></div>
        `;
        const body=sec.querySelector('.daily-week-body');

        DAILY_DAYS.forEach(day=>{
          const dayBox=document.createElement('div');
          dayBox.className='daily-day';
          dayBox.dataset.week=week;
          dayBox.dataset.day=day.key;
          dayBox.innerHTML=`
            <div class="daily-day-head">
              <span class="daily-day-name">${day.label}</span>
              ${IS_ADMIN?`<button class="day-add" data-week="${week}" data-day="${day.key}">â•</button>`:''}
            </div>
            <div class="daily-drop" data-week="${week}" data-day="${day.key}"></div>
          `;
          body.appendChild(dayBox);
        });

        dailyBoard.appendChild(sec);
      });

      const notesCol=document.createElement('section');
      notesCol.className='col';
      notesCol.dataset.week='notes';
      notesCol.innerHTML=`
        <div class="col-head" style="cursor:default">
          <span class="col-title">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
          ${IS_ADMIN?`<button class="day-add note-add">â•</button>`:''}
        </div>
        <div class="col-body">
          <div class="daily-drop" data-week="notes" data-day="note"></div>
        </div>
      `;
      dailyBoard.appendChild(notesCol);

      const doneCol=document.createElement('section');
      doneCol.className='col daily-done-col';
      doneCol.innerHTML=`
        <div class="col-head" style="cursor:default">
          <span class="col-title">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
        </div>
        <div class="col-body">
          <div class="daily-drop" data-week="done" data-day="done"></div>
        </div>
      `;
      dailyBoard.appendChild(doneCol);

      const activeTasks = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && !t.completed && t.dayKey!=='note');
      const notesTasks  = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.dayKey==='note');
      const doneTasks   = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.completed && t.dayKey!=='note');

      activeTasks.forEach(t=>{
        const zone = dailyBoard.querySelector(`.daily-drop[data-week="${t.week}"][data-day="${t.dayKey}"]`);
        if(!zone) return;
        const card = buildDailyCard(t,false);
        zone.appendChild(card);
      });

      const notesZone = dailyBoard.querySelector('.daily-drop[data-week="notes"][data-day="note"]');
      notesTasks.forEach(t=>{
        if(!notesZone) return;
        const card = buildNoteCard(t);
        notesZone.appendChild(card);
      });

      const doneZone = dailyBoard.querySelector('.daily-drop[data-week="done"][data-day="done"]');
      doneTasks.forEach(t=>{
        if(!doneZone) return;
        const card = buildDailyCard(t,true);
        doneZone.appendChild(card);
      });

      dailyBoard.querySelectorAll('.daily-drop').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if(zone.dataset.week==='notes') return;
          if(e.dataTransfer.types.includes(MIME_DAILY)){
            e.preventDefault();
            zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if(zone.dataset.week==='notes') return;
          if(!e.dataTransfer.types.includes(MIME_DAILY)) return;
          e.preventDefault();
          zone.classList.remove('drag');
          const id = e.dataTransfer.getData(MIME_DAILY);
          const task = DAILY_TASKS.find(t=>t.id===id);
          if(!task) return;
          const week = zone.dataset.week;
          const day  = zone.dataset.day;
          try{
            if(week==='done'){
              await updateDoc(doc(db,'dailyTasks', id), {
                completed:true,
                completedAt: serverTimestamp()
              });
            }else{
              await updateDoc(doc(db,'dailyTasks', id), {
                week: parseInt(week,10),
                dayKey: day,
                completed:false
              });
            }
          }catch(err){
            console.error(err);
            alert('âš ï¸ ØªØ¹Ø°Ø± Ù†Ù‚Ù„ Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ: '+(err?.message||err));
          }
        });
      });

      updateDailyMeta();
    }

    function buildDailyCard(t, isDone){
      const card=document.createElement('article');
      card.className='card daily-card';
      card.dataset.id=t.id;
      card.setAttribute('draggable','true');

      const title = t.title || '-';
      const desc  = t.description || '';

      const inner=document.createElement('div');
      inner.className='row between';
      const left=document.createElement('div');
      left.innerHTML = `
        <p class="daily-card-title">${title}</p>
        ${desc?`<p class="daily-card-desc">${desc}</p>`:''}
      `;
      inner.appendChild(left);

      if(!isDone){
        const right=document.createElement('div');
        if(IS_ADMIN){
          const btn=document.createElement('button');
          btn.className='btn secondary xs daily-done-btn';
          btn.textContent='ØªÙ…';
          btn.dataset.id=t.id;
          right.appendChild(btn);
        }
        inner.appendChild(right);
      }

      card.appendChild(inner);

      card.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData(MIME_DAILY, t.id);
      });

      return card;
    }

    function buildNoteCard(t){
      const card=document.createElement('article');
      card.className='card daily-card';
      card.dataset.id=t.id;

      const title = t.title || '-';
      const desc  = t.description || '';

      card.innerHTML = `
        <p class="daily-card-title">${title}</p>
        ${desc?`<p class="daily-card-desc">${desc}</p>`:''}
      `;
      return card;
    }
  </script></body>
</html>
