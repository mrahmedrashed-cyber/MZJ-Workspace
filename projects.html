<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--brown);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 20px rgba(62,36,32,.2)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}

    .page{padding:18px;display:grid;gap:16px}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:800;color:var(--brown)}
    .tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .hidden{display:none !important}

    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 12px 30px rgba(62,36,32,.12)}
    .panel .head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .panel .body{padding:12px 14px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select,.input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}
    .btn.danger{background:#b91c1c;color:#fff}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}

    /* Board */
    .board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}
    .col{background:#fff;border-radius:14px;display:flex;flex-direction:column;min-height:240px;position:relative}
    .col-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #f2e7df;background:#fff8ef;border-top-left-radius:14px;border-top-right-radius:14px;cursor:grab}
    .col-title{color:var(--brown);font-weight:800}
    .col-actions{display:none;gap:6px}
    .col-actions .icon{cursor:pointer;font-size:13px;padding:6px 8px;border:1px solid #e9d8cc;border-radius:10px;background:#fff}
    .col-body{padding:10px;display:grid;gap:10px}
    .dropzone{min-height:120px;border:2px dashed transparent;border-radius:12px;transition:.15s}
    .dropzone.drag{border-color:#e5d2c6;background:#fffaf5}

    .grip{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#6b7280;user-select:none}
    .grip .dots{letter-spacing:2px;font-weight:700}

    /* Cards */
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px;box-shadow:0 8px 20px rgba(62,36,32,.06);cursor:grab}
    .card h4{margin:0;color:var(--brown);font-size:15px;line-height:1.4}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .badge .dot{inline-size:8px;block-size:8px;border-radius:999px;background:#bc8f74}
    .small{font-size:12px;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:16px;z-index:99}
    .modal.show{display:grid}
    .sheet{background:#fff;border-radius:16px;max-width:760px;width:100%;box-shadow:0 30px 80px rgba(62,36,32,.25);display:flex;flex-direction:column;max-height:90vh}
    .sheet .head{padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .sheet .body{padding:12px 12px;display:grid;gap:8px;flex:1;overflow:auto}
    .sheet .footer{padding:10px 12px;border-top:1px solid #eee;background:#fff8ef;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;position:sticky;bottom:0}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:800px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 4px;font-weight:700;color:var(--brown);font-size:13px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-family:inherit;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fff}
    .chip .chip-actions{display:inline-flex;gap:6px}
    .chip button{border:0;background:#fff;padding:4px 6px;border-radius:8px;cursor:pointer}
    .chip button:hover{background:#fff8ef}

    .desc-box{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;max-height:32vh;overflow:auto;white-space:pre-wrap;line-height:1.6;font-size:14px}
    .dropdown-menu{position:absolute;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(62,36,32,.12);display:none;min-width:280px;max-height:260px;overflow:auto}

    @media (max-width: 600px){
      .sheet{max-height:92vh}
      .sheet .footer{position:sticky;bottom:0}
    }
  </style>

  <!-- SheetJS (Ù„Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-badge"></span>
      <strong>MZJ Workspace â€” Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</strong>
    </div>
    <nav class="nav">
      <a id="navDashboard" href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a id="navProjects"  href="projects.html" style="background:rgba(255,255,255,.18)">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
      <a id="navMembers"   href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
      <a id="navAdmin"     href="admin.html">Ø§Ù„Ø­Ù…Ù„Ø§Øª</a>
      <a href="cars.html">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a href="Whiteboard.html">ÙˆØ§ÙŠØª Ø¨ÙˆØ±Ø¯</a>
      <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </nav>
  </header>

  <main class="page">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="tabSpaces">Spaces</button>
      <button class="tab" id="tabCampaigns">Campaign</button>
    </div>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ Spaces ===== -->
    <section class="panel" id="panelSpaces">
      <div class="head">
        <div class="controls">
          <select id="spaceSelect" class="select"></select>
          <input id="newGroupName" class="input" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ â€” Ù…Ø«Ø§Ù„: ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§" style="min-width:220px;display:none">
          <button class="btn secondary" id="btnAddGroup" style="display:none">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
          <button class="btn secondary" id="btnNewSpace" style="display:none">Space Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn" id="btnNewTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn secondary" id="btnSpaceManage" style="display:none">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€Space</button>
          <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
          <button class="btn secondary" id="btnExportSpace">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <div class="muted" id="who"></div>
      </div>
      <div class="body">
        <div class="board" id="boardSpaces"></div>
      </div>
    </section>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ù…Ù„Ø§Øª ===== -->
    <section class="panel hidden" id="panelCampaigns">
      <div class="head">
        <div class="controls">
          <select id="campaignSelect" class="select"></select>
          <button class="btn" id="btnNewCampaignTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯ (Ø­Ù…Ù„Ø©)</button>
          <span class="muted" id="campaignDates">â€”</span>
        </div>
        <div class="muted" id="who2"></div>
      </div>
      <div class="body">
        <div class="board" id="boardCampaigns"></div>
      </div>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (Ù†ÙØ³Ù‡Ø§ Ù…Ù† Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø©) -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="head"><strong id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong></div>
      <div class="body">

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</label>
            <select id="carBrand"></select>
          </div>
          <div>
            <label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
            <select id="carModel"></select>
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Ø§Ù„ÙØ¦Ø© (Ø§Ù„ØªØ±Ù…)</label>
            <input id="carTrim" placeholder="Ù…Ø«Ø§Ù„: Ø³Ù…Ø§Ø±Øª / ÙÙ„ ÙƒØ§Ù…Ù„">
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø­Ø±Ùƒ</label>
            <input id="carEngine" placeholder="Ù…Ø«Ø§Ù„: 2000 Ø³ÙŠ Ø³ÙŠ / 1.5 ØªØ±Ø¨Ùˆ">
          </div>
        </div>

        <div class="grid2" style="margin-top:4px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ù„Ù†ØªØ±Ø§ 30 Ø«Ø§Ù†ÙŠØ©">
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="tDue" type="date" placeholder="dd-mm-yyyy">
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="tDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©â€¦"></textarea>

        <div class="grid2">
          <div style="position:relative">
            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input id="tAssigneeSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆâ€¦">
            <div id="assigneeMenu" class="dropdown-menu" style="right:0;top:60px;"></div>
            <div id="assigneeChip" class="chips"></div>
          </div>
          <div>
            <label>Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¶Ùˆ</label>
            <div class="row">
              <input id="tColor" type="color" value="#bc8f74" style="width:70px;height:44px;padding:4px">
              <span class="muted">ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙŠØ­ÙØ¸ Ù„Ù„Ø¹Ø¶Ùˆ</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯ / Ø§Ù„Ø¬Ø±ÙˆØ¨</label>
            <select id="tGroup"></select>
          </div>
          <div></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn secondary" id="btnCancelTask">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="btnSaveTask">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ</button>
        <button class="btn secondary" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„ ØªØ§Ø³Ùƒ -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="head"><strong id="dTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</strong></div>
      <div class="body">
        <label class="small muted" style="margin-top:2px">Ø§Ù„ÙˆØµÙ</label>
        <div id="dDesc" class="desc-box"></div>

        <div class="info" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div><div class="small muted">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div><div id="dAssignee"></div></div>
          <div><div class="small muted">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div id="dDue"></div></div>
          <div><div class="small muted">Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ø¹Ù…ÙˆØ¯</div><div id="dStatus"></div></div>
        </div>

        <hr/>

        <div>
          <div class="small muted">Ø±ÙˆØ§Ø¨Ø·</div>
          <div id="dLinks" class="chips"></div>
        </div>

        <div id="dActions" style="margin-top:10px;display:block">
          <div>
            <label>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø±Ø§Ø¨Ø·</label>
            <input id="dLinkTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ">
            <input id="dLinkUrl" class="input" placeholder="https://â€¦">
            <button class="btn secondary" id="btnAddLink" style="margin-top:8px">Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          </div>
          <p class="hint">* Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: Ø§Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©.</p>
        </div>
      </div>
      <div class="footer">
        <button class="btn secondary" id="btnMarkReviewed">âœ… ØªÙ… Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <span style="flex:1"></span>
        <button class="btn" id="btnEditTask" style="display:none">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" id="btnDeleteTask" style="display:none">Ø­Ø°Ù</button>
        <button class="btn secondary" id="btnCloseDetail">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <footer class="footer" style="padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19);">
    <small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small>
  </footer>

  <!-- Firebase & App -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp, arrayUnion, Timestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth(); const db = getFirestore();

    /* Tabs */
    const tabSpaces = document.getElementById('tabSpaces');
    const tabCampaigns = document.getElementById('tabCampaigns');
    const panelSpaces = document.getElementById('panelSpaces');
    const panelCampaigns = document.getElementById('panelCampaigns');

    function switchTab(which){
      if(which==='spaces'){
        tabSpaces.classList.add('active'); tabCampaigns.classList.remove('active');
        panelSpaces.classList.remove('hidden'); panelCampaigns.classList.add('hidden');
      }else{
        tabCampaigns.classList.add('active'); tabSpaces.classList.remove('active');
        panelCampaigns.classList.remove('hidden'); panelSpaces.classList.add('hidden');
      }
    }
    tabSpaces.onclick = ()=> switchTab('spaces');
    tabCampaigns.onclick = ()=> switchTab('campaigns');

    /* Auth / Roles */
    let CURRENT_USER=null, CURRENT_ROLE='member', IS_ADMIN=false;
    window.mzjLogout = async ()=>{ await signOut(auth); location.href="login.html"; };

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER = user;
      const u = await getDoc(doc(db,"users", user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
      CURRENT_ROLE = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = CURRENT_ROLE==='admin';
      document.getElementById('who').textContent  = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;
      document.getElementById('who2').textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;

      ['btnNewSpace','btnAddGroup','newGroupName','btnNewTask','btnSpaceManage','btnNewCampaignTask'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display = IS_ADMIN? '' : 'none';
      });
      document.querySelectorAll('.col-actions').forEach(el=> el.style.display = IS_ADMIN? 'flex' : 'none');

      if(!IS_ADMIN){
        document.getElementById('navDashboard').style.display='none';
        document.getElementById('navMembers').style.display='none';
        document.getElementById('navAdmin').style.display='none';
      }

      await loadUsers();
      bootSpaces();
      bootCampaigns();
    });

    /* Common helpers */
    const MIME_TASK="application/x-mzj-task";
    const MIME_COLUMN="application/x-mzj-column";

    let USERS=[];
    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS=[]; snap.forEach(d=>{
        const u=d.data()||{};
        USERS.push({ uid:d.id, name:u.name||d.id.slice(0,6), role:u.role||'member', color:u.color||'#bc8f74' });
      });
    }

    /* ===== Spaces logic ===== */
    const DEFAULT_COLUMNS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
    const REVIEW_COLUMN   = "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";

    const spaceSelect     = document.getElementById('spaceSelect');
    const newGroupNameEl  = document.getElementById('newGroupName');
    const btnAddGroup     = document.getElementById('btnAddGroup');
    const btnSpaceManage  = document.getElementById('btnSpaceManage');
    const boardSpaces     = document.getElementById('boardSpaces');
    const btnExportSpace  = document.getElementById('btnExportSpace');

    let CURRENT_SPACE=null; let SPACE_COLUMNS=DEFAULT_COLUMNS.slice();
    let TASKS_SPACES=[]; let unsubTasksSpaces=null; let OPEN_TASK=null;
    let SPACES_CACHE = new Map(); // id -> name

    function canManageLinks(task){ return IS_ADMIN || (task?.assignee?.uid && task.assignee.uid === (CURRENT_USER?.uid||'')); }

    async function ensureReviewColumn(){
      if (!CURRENT_SPACE) return;
      if (SPACE_COLUMNS.includes(REVIEW_COLUMN)) return;
      const cols = SPACE_COLUMNS.concat([REVIEW_COLUMN]);
      try{
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS = cols;
        renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      }catch(e){ console.error(e); }
    }

    async function ensureDefaultSpace(){
      const qy = query(collection(db,'spaces'), where('active','!=', false), where('type','==', null));
      const snap = await getDocs(qy);
      if (snap.empty){
        const label = new Date().toLocaleDateString('ar-SA',{ year:'numeric', month:'long' });
        const ref = await addDoc(collection(db,'spaces'), { name:label, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true });
        SPACES_CACHE.set(ref.id, label);
        return ref.id;
      } else {
        let id=null, ts=0; snap.forEach(d=>{
          const s=d.data()?.createdAt?.seconds||0;
          SPACES_CACHE.set(d.id, d.data()?.name||d.id);
          if(s>=ts){ts=s; id=d.id;}
        });
        return id;
      }
    }

    function fillSpaceDropdown(list, selectedId){
      spaceSelect.innerHTML='';
      list.forEach(s=>{
        if(s.type==='campaign') return;
        const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name;
        spaceSelect.appendChild(opt);
        SPACES_CACHE.set(s.id, s.name||s.id);
      });
      if(selectedId) spaceSelect.value=selectedId;
    }

    onSnapshot(collection(db,'spaces'), snap=>{
      const items=[];
      snap.forEach(d=>{
        const data=d.data()||{};
        if(data.active!==false) items.push({id:d.id, ...data});
      });
      const onlySpaces = items.filter(s=> !s.type);
      onlySpaces.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      fillSpaceDropdown(onlySpaces, CURRENT_SPACE);
      if(!CURRENT_SPACE && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect(); ensureReviewColumn();
      }else if(CURRENT_SPACE && !onlySpaces.find(x=>x.id===CURRENT_SPACE) && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
      }
    });

    document.getElementById('btnNewSpace')?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù€Space (Ù…Ø«Ø§Ù„: Ù†ÙˆÙÙ…Ø¨Ø± 2025):'); if(!name) return;
      const ref = await addDoc(collection(db,'spaces'), { name, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true });
      SPACES_CACHE.set(ref.id, name);
      CURRENT_SPACE = ref.id; SPACE_COLUMNS = DEFAULT_COLUMNS.slice();
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnSpaceManage?.addEventListener('click', async ()=>{
      if(!IS_ADMIN || !CURRENT_SPACE) return;
      const action = prompt('Ø§ÙƒØªØ¨:\nrename Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©\narchive Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€Space');
      if(!action) return;
      if(action.toLowerCase()==='rename'){
        const nm = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù€Space:'); if(!nm) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { name:nm });
        SPACES_CACHE.set(CURRENT_SPACE, nm);
      } else if(action.toLowerCase()==='archive'){
        if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€SpaceØŸ')) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { active:false, archivedAt:serverTimestamp() });
      }
    });

    spaceSelect.addEventListener('change', async (e)=>{
      CURRENT_SPACE = e.target.value;
      const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
      SPACES_CACHE.set(CURRENT_SPACE, d.data()?.name||CURRENT_SPACE);
      SPACE_COLUMNS = d.exists()? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS) : DEFAULT_COLUMNS;
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnAddGroup?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const name = (newGroupNameEl.value || 'ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§').trim();
      if(!name) return;
      if(SPACE_COLUMNS.includes(name)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');
      const cols = SPACE_COLUMNS.concat([name]);
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS = cols; newGroupNameEl.value=''; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
    });

    /* === EXPORT: Space to XLSX === */
    btnExportSpace?.addEventListener('click', ()=>{
      if(!CURRENT_SPACE){ alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{
        const data = TASKS_SPACES.map(t=>{
          const createdAt = t.createdAt?.seconds ? new Date(t.createdAt.seconds*1000) : null;
          const links = Array.isArray(t.links) ? t.links.map(l=> (l.title||l.url)+': '+l.url).join(' | ') : '';
          return {
            "Space": SPACES_CACHE.get(t.spaceId)||t.spaceId,
            "Ø§Ù„Ø¹Ù…ÙˆØ¯/Ø§Ù„Ø­Ø§Ù„Ø©": t.status||'',
            "Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ": t.name||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…": t.due||'',
            "Ø§Ù„ÙˆØµÙ": t.description||'',
            "Ø§Ù„Ø¹Ø¶Ùˆ": t.assignee?.name||'',
            "Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¶Ùˆ": t.assignee?.color||'',
            "UID Ø§Ù„Ø¹Ø¶Ùˆ": t.assignee?.uid||'',
            "Ù…Ø§Ø±ÙƒØ©": t.car?.brand||'',
            "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„": t.car?.model||'',
            "Ø§Ù„ÙØ¦Ø©": t.car?.trim||'',
            "Ø§Ù„Ù…Ø­Ø±Ùƒ": t.car?.engine||'',
            "Ø±ÙˆØ§Ø¨Ø·": links,
            "Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©": t.createdBy||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡": createdAt ? createdAt.toLocaleString('ar-SA') : '',
            "Ù†Ø´Ø·": t.active===false? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
            "Doc ID": t.id
          };
        });

        // ÙˆØ±Ù‚Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Counts per Column)
        const counts = SPACE_COLUMNS.map(col=>{
          const n = TASKS_SPACES.filter(t=>t.status===col).length;
          return { "Ø§Ù„Ø¹Ù…ÙˆØ¯": col, "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…": n };
        });

        const wb = XLSX.utils.book_new();
        const wsTasks = XLSX.utils.json_to_sheet(data);
        const wsCols  = XLSX.utils.json_to_sheet(counts);

        XLSX.utils.book_append_sheet(wb, wsTasks, 'Tasks');
        XLSX.utils.book_append_sheet(wb, wsCols,  'Columns');

        // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        const fit = (rows)=> Object.keys(rows[0]||{}).map(k=>{
          const max = rows.reduce((m,r)=> Math.max(m, String(r[k]??'').length), k.length);
          return { wch: Math.min(Math.max(12, max+2), 60) };
        });
        wsTasks['!cols'] = fit(data);
        wsCols['!cols']  = fit(counts);

        const spaceName = (SPACES_CACHE.get(CURRENT_SPACE)||'Space').replace(/[\/\\:*?"<>|]/g,'-');
        const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const filename = `MZJ-Space-${spaceName}-${ymd}.xlsx`;
        XLSX.writeFile(wb, filename);
      }catch(err){
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: '+ (err?.message||err));
      }
    });

    /* Users on Spaces modal (Ø¥Ù†Ø´Ø§Ø¡/Ø­ÙØ¸ ØªØ§Ø³Ùƒ) */
    const taskModal = document.getElementById('taskModal');
    const btnNewTask = document.getElementById('btnNewTask');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancelTask = document.getElementById('btnCancelTask');
    const btnSaveTask = document.getElementById('btnSaveTask');

    const tName = document.getElementById('tName');
    const tDesc = document.getElementById('tDesc');
    const tDue  = document.getElementById('tDue');
    const tAssigneeSearch = document.getElementById('tAssigneeSearch');
    const assigneeMenu = document.getElementById('assigneeMenu');
    const assigneeChip = document.getElementById('assigneeChip');
    const tColor = document.getElementById('tColor');
    const tGroup = document.getElementById('tGroup');
    let SELECTED_ASSIGNEE=null;

    /* === Car Selector Data === */
    const CAR_MAP = {
      "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": [
        "Ø³ÙˆÙ†Ø§ØªØ§","Ø§Ù„Ù†ØªØ±Ø§","Ø§ÙƒØ³Ù†Øª","Ø¬Ø±Ø§Ù†Ø¯ i10","ÙƒØ±ÙŠØªØ§","Ø¬Ø±Ø§Ù†Ø¯ ÙƒØ±ÙŠØªØ§","Ø³ØªØ§Ø± Ø¬ÙŠØ²Ø±",
        "ÙÙŠÙ†ÙŠÙˆ","Ø§Ø²ÙŠØ±Ø§","Ø³Ù†ØªØ§ÙÙŠ","ØªÙˆØ³Ø§Ù†","ÙƒÙˆÙ†Ø§","Ø³ØªØ§Ø±ÙŠØ§","Ø¨Ø§Ù„Ø³ÙŠÙŠØ¯"
      ],
      "Ø´Ø§Ù†Ø¬Ø§Ù†": [
        "Ø³ÙŠ Ø§Ø³ 75","Ø³ÙŠ Ø§Ø³ 35","Ø§ÙŠØ¯Ùˆ Ø¨Ù„Ø³","Ø§Ù„ Ø³ÙŠÙÙ†","ÙŠÙˆÙ†ÙŠ ÙƒÙŠ","ÙŠÙˆÙ†ÙŠ ØªÙŠ","ÙŠÙˆÙ†ÙŠ ÙÙŠ",
        "Ø³ÙŠ Ø§Ø³ 95","ÙŠÙˆÙ†ÙŠ Ø§Ø³","Ù‡Ø§Ù†ØªØ± Ø§Ø¨"
      ],
      "Ø´ÙŠØ±ÙŠ": [
        "ØªÙŠØ¬Ùˆ 2 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 8","Ø§Ø±ÙŠØ²Ùˆ 6 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 5 Ø¨Ø±Ùˆ",
        "Ø£ÙƒØ³ÙŠÙŠØ¯ Ø§Ù„ Ø§ÙƒØ³","ØªÙŠØ¬Ùˆ 8 Ø¨Ø±Ùˆ","ØªÙŠØ¬Ùˆ 7","ØªÙŠØ¬Ùˆ 4 Ø¨Ø±Ùˆ"
      ],
      "ÙÙˆØ±Ø¯": ["Ø±ÙŠÙ†Ø¬Ø±","Ø§ÙƒØ³Ø¨Ù„ÙˆØ±","ØªÙŠØ±ÙŠØªÙˆØ±ÙŠ","ØªÙˆØ±Ø³"],
      "Ø¥Ù… Ø¬ÙŠ": ["Ø¬ÙŠ ØªÙŠ","Ø§Ù… Ø¬ÙŠ 3","Ø§Ù… Ø¬ÙŠ 7","Ø§Ù… Ø¬ÙŠ 5","Ø§ØªØ´ Ø£Ø³","Ø§Ø± Ø§ÙƒØ³ 5","ÙˆÙ†","Ø²Ø¯ Ø£Ø³","ØªÙŠ 60","Ø§Ø± Ø£ÙƒØ³ 9","ÙˆØ§Ù„","Ø§Ø± Ø£ÙƒØ³ 8"],
      "Ù†ÙŠØ³Ø§Ù†": ["Ø§ÙƒØ³ ØªØ±ÙŠÙ„","Ù…Ø§Ø¬Ù†Ø§ÙŠØª","ÙƒÙŠÙƒØ³","ØµÙ†ÙŠ","Ø§ÙƒØ³ ØªÙŠØ±Ø§","Ø§Ù„ØªÙŠÙ…Ø§"]
    };

    const carBrand  = document.getElementById('carBrand');
    const carModel  = document.getElementById('carModel');
    const carTrim   = document.getElementById('carTrim');
    const carEngine = document.getElementById('carEngine');

    function fillBrands(){
      carBrand.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© â€”</option>';
      Object.keys(CAR_MAP).forEach(b=>{
        const opt=document.createElement('option'); opt.value=b; opt.textContent=b;
        carBrand.appendChild(opt);
      });
    }
    function fillModels(brand){
      carModel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ â€”</option>';
      (CAR_MAP[brand]||[]).forEach(m=>{
        const opt=document.createElement('option'); opt.value=m; opt.textContent=m;
        carModel.appendChild(opt);
      });
    }
    function buildAutoTaskName(){
      const parts = [
        carBrand?.value?.trim() || '',
        carModel?.value?.trim() || '',
        carTrim?.value?.trim() || '',
        carEngine?.value?.trim() || ''
      ].filter(Boolean);
      const auto = parts.join(' ').replace(/\s+/g,' ').trim();
      if(auto) tName.value = auto;
    }
    carBrand?.addEventListener('change', ()=>{
      fillModels(carBrand.value);
      buildAutoTaskName();
    });
    [carModel, carTrim, carEngine].forEach(el=>{
      el?.addEventListener('input', buildAutoTaskName);
      el?.addEventListener('change', buildAutoTaskName);
    });
    function initCarSelectors(){
      fillBrands();
      fillModels(carBrand.value||'');
      carTrim.value=''; carEngine.value='';
    }

    function fillGroupSelect(cols=SPACE_COLUMNS){
      tGroup.innerHTML='';
      (cols||[]).forEach(col=>{
        const opt=document.createElement('option'); opt.value=col; opt.textContent=col; tGroup.appendChild(opt);
      });
    }

    function openCreate(cols=SPACE_COLUMNS){
      if(IS_ADMIN){
        taskModal.classList.add('show');
        fillGroupSelect(cols);
        initCarSelectors();
      }
    }
    function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

    btnNewTask.addEventListener('click', ()=> openCreate(SPACE_COLUMNS));
    btnCloseModal.addEventListener('click', ()=> closeCreate());
    btnCancelTask.addEventListener('click', ()=> closeCreate());
    taskModal.addEventListener('click', (e)=>{ if(e.target===taskModal) closeCreate(); });

    function resetCreateForm(){
      tName.value=''; tDesc.value=''; tDue.value='';
      tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.style.display='none';
      assigneeChip.innerHTML=''; SELECTED_ASSIGNEE=null; tColor.value='#bc8f74';
      fillGroupSelect();
      initCarSelectors();
    }

    function renderAssigneeMenu(filter){
      const f=(filter||'').toLowerCase();
      assigneeMenu.innerHTML='';
      USERS.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const it=document.createElement('div');
        it.className='dd-item';
        it.style.padding='8px 10px';
        it.innerHTML=`<span class="row"><span class="color-dot" style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${u.color||'#bc8f74'}"></span> ${u.name} <span class="muted">(${u.role})</span></span>`;
        it.onclick=()=> selectAssignee(u);
        assigneeMenu.appendChild(it);
      });
      assigneeMenu.style.display='block';
    }
    function selectAssignee(u){
      SELECTED_ASSIGNEE = {...u};
      assigneeChip.innerHTML = `<span class="badge"><span class="dot" style="background:${u.color}"></span>${u.name}</span>`;
      tColor.value = u.color || '#bc8f74';
      assigneeMenu.style.display='none';
    }
    tAssigneeSearch.addEventListener('input', (e)=> renderAssigneeMenu(e.target.value.trim()));
    tAssigneeSearch.addEventListener('focus', ()=> renderAssigneeMenu(tAssigneeSearch.value));
    document.addEventListener('click', (e)=>{ if(!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch) assigneeMenu.style.display='none'; });

    btnSaveTask.addEventListener('click', async ()=>{
      const isCampaignTab = !panelCampaigns.classList.contains('hidden');
      const targetSpaceId = isCampaignTab ? CURRENT_CAMPAIGN : CURRENT_SPACE;
      const targetCols    = isCampaignTab ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      if(!targetSpaceId) return alert('Ø§Ø®ØªØ± Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹');
      if(!IS_ADMIN) return alert('Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ†');

      if(!tName.value.trim()) buildAutoTaskName();
      const name=tName.value.trim(); if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');

      const due=tDue.value||null;
      const description=tDesc.value||null;
      const assigneeUid=SELECTED_ASSIGNEE?.uid||null;
      const assigneeName=SELECTED_ASSIGNEE?.name||null;
      const color=(document.getElementById('tColor').value||'#bc8f74').trim();
      const status=tGroup.value || (targetCols[0]||'Ø¹Ù…ÙˆØ¯');

      const car = {
        brand:  carBrand?.value?.trim()  || null,
        model:  carModel?.value?.trim()  || null,
        trim:   carTrim?.value?.trim()   || null,
        engine: carEngine?.value?.trim() || null
      };

      try{
        if(assigneeUid){
          await setDoc(doc(db,'users', assigneeUid), { color }, { merge:true });
          const idx=USERS.findIndex(u=>u.uid===assigneeUid); if(idx>-1) USERS[idx].color=color;
        }
        const payload = {
          spaceId: targetSpaceId, name, description, due, status,
          car,
          assignee: assigneeUid ? { uid:assigneeUid, name:assigneeName, color } : null,
          links: [],
          createdBy: CURRENT_USER?.uid || null, createdAt: serverTimestamp(), active:true
        };
        await addDoc(collection(db,'tasks'), payload);
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ');
        closeCreate();
      }catch(e){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+(e?.message||e)); }
    });

    /* Board & Details â€” Spaces */
    function renderColumnHeaderActionsSpaces(container, columnName){
      const actions=document.createElement('div'); actions.className='col-actions'; actions.style.display=IS_ADMIN?'flex':'none';
      const btnRename=document.createElement('button'); btnRename.className='icon'; btnRename.textContent='âœï¸'; btnRename.title='Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnRename.onclick=async ()=>{
        if(!IS_ADMIN) return;
        const nn=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', columnName); if(!nn||nn===columnName) return;
        const cols=SPACE_COLUMNS.map(c=>c===columnName?nn:c); await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };
      const btnDelete=document.createElement('button'); btnDelete.className='icon'; btnDelete.textContent='ğŸ—‘ï¸'; btnDelete.title='Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnDelete.onclick=async ()=>{
        if(!IS_ADMIN) return;
        if(SPACE_COLUMNS.length<=1) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯.');
        const target=prompt(`Ø³ÙŠØªÙ… Ø­Ø°Ù "${columnName}". Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰: \n${SPACE_COLUMNS.join(', ')}`);
        if(!target || !SPACE_COLUMNS.includes(target) || target===columnName) return;
        const affected=TASKS_SPACES.filter(t=>t.status===columnName);
        for(const t of affected){ try{ await updateDoc(doc(db,'tasks', t.id), { status:target }); }catch{} }
        const cols=SPACE_COLUMNS.filter(c=>c!==columnName);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };
      actions.appendChild(btnRename); actions.appendChild(btnDelete); container.appendChild(actions);
    }

    async function persistColumnsOrderSpaces(newOrder){
      if (!CURRENT_SPACE) return;
      try{ await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: newOrder }); }
      catch(e){ console.error(e); alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.'); }
    }

    function renderBoardSkeletonSpaces(){
      const board=boardSpaces;
      board.innerHTML='';
      (SPACE_COLUMNS||[]).forEach((col, index)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.dataset.index=index;

        sec.innerHTML=`
          <div class="col-head">
            <span class="col-title">${col}</span>
            <div class="grip"><span class="dots">â‹®â‹®</span> Ø§Ø³Ø­Ø¨</div>
            <div class="__actions"></div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;

        const grip = sec.querySelector('.grip');
        if (IS_ADMIN && grip){
          grip.setAttribute('draggable','true');
          grip.addEventListener('dragstart',(e)=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_COLUMN, String(index));
          });
        }
        sec.addEventListener('dragover',(e)=>{
          if (e.dataTransfer.types.includes(MIME_COLUMN)){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
        });
        sec.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_COLUMN)) return;
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData(MIME_COLUMN),10);
          const to   = parseInt(sec.dataset.index,10);
          if (isNaN(from)||isNaN(to)||from===to) return;
          const newOrder = SPACE_COLUMNS.slice();
          const [moved] = newOrder.splice(from,1);
          newOrder.splice(to,0,moved);
          SPACE_COLUMNS = newOrder;
          renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
          await persistColumnsOrderSpaces(newOrder);
        });

        board.appendChild(sec);
        renderColumnHeaderActionsSpaces(sec.querySelector('.__actions'), col);
      });

      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          try{ await updateDoc(doc(db,'tasks', cardId), { status:newStatus }); }
          catch(err){ alert('âš ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§ÙÙŠØ©.'); }
        });
      });
    }

    function renderTasksSpaces(){
      const board=boardSpaces;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={}; (SPACE_COLUMNS||[]).forEach(s=> byStatus[s]=[]);
      TASKS_SPACES.forEach(t=>{ (byStatus[t.status]||(byStatus[t.status]=[])).push(t); });

      (SPACE_COLUMNS||[]).forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        const list = byStatus[status]||[];
        list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        list.forEach(t=>{
          const card=document.createElement('article'); card.className='card'; card.dataset.id=t.id;
          const ass=t.assignee;
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';
          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
            <div class="row" style="margin-top:6px">
              ${ass?`<span class="badge"><span class="dot" style="background:${ass.color||'#bc8f74'}"></span>${ass.name||''}</span>`:''}
              ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
            </div>`;
          card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });
          card.addEventListener('click', ()=> openDetail(t));
          zone?.appendChild(card);
        });
      });
    }

    function listenTasksSpaces(){
      if(unsubTasksSpaces){ unsubTasksSpaces(); unsubTasksSpaces=null; }
      if(!CURRENT_SPACE) return;
      const qy=query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasksSpaces=onSnapshot(qy,(snap)=>{
        TASKS_SPACES=[]; snap.forEach(d=> TASKS_SPACES.push({ id:d.id, ...(d.data()||{}) }));
        renderTasksSpaces();
        if(OPEN_TASK){
          const now = TASKS_SPACES.find(t=>t.id===OPEN_TASK.id);
          if(now) openDetail(now);
        }
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Spaces).'); });
    }

    /* ===== Campaigns logic ===== */
    const CAMPAIGN_DEFAULT_COLS = [
      "Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´",
      "Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","AI Generate - Ø§Ù‚Ø³Ø§Ø·","Ø¬Ø±Ø§ÙÙŠÙƒ Ø§Ù‚Ø³Ø§Ø·",
      "Ø§Ù‚Ø³Ø§Ø· Ø´Ø±ÙƒØ§Øª - Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"
    ];
    const CAMPAIGN_NAME_MAP = new Map([
      ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´"],
      ["Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´"],
      ["ØªØµÙ…ÙŠÙ… ØµÙˆØ±","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´"],
      ["ÙŠÙˆØªÙŠÙˆØ¨","Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·"],
      ["ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ù‹Ø§","AI Generate - Ø§Ù‚Ø³Ø§Ø·"],
      ["ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§","AI Generate - Ø§Ù‚Ø³Ø§Ø·"],
      ["Ù…Ø­ØªÙˆÙ‰ Ø·ÙˆÙŠÙ„","Ø¬Ø±Ø§ÙÙŠÙƒ Ø§Ù‚Ø³Ø§Ø·"],
      ["Ø­Ù…Ù„Ø© Ù…Ù…ÙˆÙ„Ø©","Ø§Ù‚Ø³Ø§Ø· Ø´Ø±ÙƒØ§Øª - Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§"],
      ["ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"]
    ]);

    const campaignSelect = document.getElementById('campaignSelect');
    const boardCampaigns = document.getElementById('boardCampaigns');
    const btnNewCampaignTask = document.getElementById('btnNewCampaignTask');
    const campaignDates = document.getElementById('campaignDates');

    let CURRENT_CAMPAIGN=null;
    let CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
    let TASKS_CAMPAIGNS=[]; let unsubTasksCampaigns=null;

    function bootCampaigns(){
      onSnapshot(query(collection(db,'spaces'), where('type','==','campaign'), where('active','!=', false)), (snap)=>{
        const items=[]; snap.forEach(d=> items.push({ id:d.id, ...(d.data()||{}) }));
        items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        campaignSelect.innerHTML='';
        items.forEach(s=>{ const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; campaignSelect.appendChild(opt); });
        if(!CURRENT_CAMPAIGN && items.length) selectCampaign(items[0].id);
      });
      campaignSelect.addEventListener('change', (e)=> selectCampaign(e.target.value));
      btnNewCampaignTask?.addEventListener('click', ()=> openCreate(CAMPAIGN_COLUMNS));
    }

    async function selectCampaign(id){
      CURRENT_CAMPAIGN = id;
      if(!id){ boardCampaigns.innerHTML=''; return; }
      const d = await getDoc(doc(db,'spaces', id));
      let cols = d.exists()? (Array.isArray(d.data().columns)? d.data().columns.slice() : []) : [];
      if(!cols.length) cols = CAMPAIGN_DEFAULT_COLS.slice();

      let changed=false;
      cols = cols.map(c=>{ const m=CAMPAIGN_NAME_MAP.get(c)||c; if(m!==c) changed=true; return m; });
      CAMPAIGN_DEFAULT_COLS.forEach(def=>{ if(!cols.includes(def)){ cols.push(def); changed=true; } });
      if(changed) await updateDoc(doc(db,'spaces', id), { columns: cols });

      CAMPAIGN_COLUMNS = cols;

      const start = d.data()?.start || null;
      const due   = d.data()?.due   || null;
      campaignDates.textContent = `ğŸ“… ${start||'â€”'} â†’ ${due||'â€”'}`;

      renderBoardSkeletonCampaigns();
      listenTasksCampaigns();
    }

    function renderBoardSkeletonCampaigns(){
      const board=boardCampaigns;
      board.innerHTML='';
      (CAMPAIGN_COLUMNS||[]).forEach((col)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.innerHTML=`
          <div class="col-head">
            <span class="col-title">${col}</span>
            <div class="col-actions" style="${IS_ADMIN?'display:flex':'display:none'}">
              <button class="icon" data-act="newtask" title="ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯">â•</button>
            </div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;
        board.appendChild(sec);
        sec.querySelector('.col-actions').addEventListener('click',(e)=>{
          const act=e.target.dataset.act;
          if(act==='newtask') { fillGroupSelect(CAMPAIGN_COLUMNS); tGroup.value=col; openCreate(CAMPAIGN_COLUMNS); }
        });
      });

      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          try{ await updateDoc(doc(db,'tasks', cardId), { status:newStatus }); }
          catch(err){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ù‚Ù„: '+err.message); }
        });
      });
    }

    function renderTasksCampaigns(){
      const board=boardCampaigns;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={}; (CAMPAIGN_COLUMNS||[]).forEach(s=> byStatus[s]=[]);
      TASKS_CAMPAIGNS.forEach(t=>{ (byStatus[t.status]||(byStatus[t.status]=[])).push(t); });

      (CAMPAIGN_COLUMNS||[]).forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        const list = byStatus[status]||[];
        list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        list.forEach(t=>{
          const card=document.createElement('article'); card.className='card'; card.dataset.id=t.id;
          const ass=t.assignee;
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';
          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
            <div class="row" style="margin-top:6px">
              ${ass?`<span class="badge"><span class="dot" style="background:${ass.color||'#bc8f74'}"></span>${ass.name||''}</span>`:''}
              ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
            </div>`;
          card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });
          card.addEventListener('click', ()=> openDetail(t));
          zone?.appendChild(card);
        });
      });
    }

    function listenTasksCampaigns(){
      if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
      if(!CURRENT_CAMPAIGN) return;
      const qy=query(collection(db,'tasks'), where('spaceId','==', CURRENT_CAMPAIGN));
      unsubTasksCampaigns=onSnapshot(qy,(snap)=>{
        TASKS_CAMPAIGNS=[]; snap.forEach(d=> TASKS_CAMPAIGNS.push({ id:d.id, ...(d.data()||{}) }));
        renderTasksCampaigns();
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Ø§Ù„Ø­Ù…Ù„Ø§Øª).'); });
    }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© + Ø±ÙˆØ§Ø¨Ø· (Ù…Ø´ØªØ±ÙƒØ©) */
    function openDetail(task){
      OPEN_TASK=task;
      document.getElementById('dTitle').textContent=task.name||'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
      document.getElementById('dDesc').textContent=task.description||'â€”';
      document.getElementById('dAssignee').innerHTML = task.assignee
        ? `<span class="badge"><span class="dot" style="background:${task.assignee.color||'#bc8f74'}"></span>${task.assignee.name||''}</span>`
        : '<span class="muted">â€”</span>';
      document.getElementById('dDue').textContent=task.due||'â€”';
      document.getElementById('dStatus').textContent=task.status||'â€”';

      const showActions = canManageLinks(task);
      document.getElementById('dActions').style.display = showActions ? 'block' : 'none';
      document.getElementById('btnEditTask').style.display = IS_ADMIN ? '' : 'none';
      document.getElementById('btnDeleteTask').style.display = IS_ADMIN ? '' : 'none';

      const linksEl=document.getElementById('dLinks'); linksEl.innerHTML='';
      (task.links||[]).forEach((l, idx)=>{
        const chip=document.createElement('span'); chip.className='chip'; chip.dataset.idx=idx;
        const title = l.title || l.url;
        chip.innerHTML = `
          ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${title}</a>
          ${showActions?`
            <span class="chip-actions">
              <button class="link-edit" data-idx="${idx}" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
              <button class="link-del"  data-idx="${idx}" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
            </span>`:''}
        `;
        linksEl.appendChild(chip);
      });

      document.getElementById('detailModal').classList.add('show');
    }
    document.getElementById('btnCloseDetail').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
    document.getElementById('detailModal').addEventListener('click', (e)=>{ if(e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('show'); });

    document.getElementById('btnMarkReviewed').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return;
      try{ await updateDoc(doc(db,'tasks', OPEN_TASK.id), { status: "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" }); document.getElementById('detailModal').classList.remove('show'); }
      catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+e.message); }
    });

    document.getElementById('btnEditTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const newName=prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:', OPEN_TASK.name||''); if(newName===null) return;
      const newDesc=prompt('Ø§Ù„ÙˆØµÙ:', OPEN_TASK.description||''); if(newDesc===null) return;
      const newDue =prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD):', OPEN_TASK.due||''); if(newDue===null) return;
      try{ await updateDoc(doc(db,'tasks', OPEN_TASK.id), { name:newName, description:newDesc, due:newDue }); }
      catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message); }
    });

    document.getElementById('btnDeleteTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
      try{ await deleteDoc(doc(db,'tasks', OPEN_TASK.id)); document.getElementById('detailModal').classList.remove('show'); }
      catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message); }
    });

    document.getElementById('btnAddLink').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return alert('Ø§ÙØªØ­ Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
      if(!canManageLinks(OPEN_TASK)) return alert('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·');
      const title = (document.getElementById('dLinkTitle').value||'Ø±Ø§Ø¨Ø·').trim();
      const url   = (document.getElementById('dLinkUrl').value||'').trim();
      if(!url || !/^https?:\/\//i.test(url)) return alert('Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://');

      try{
        await updateDoc(doc(db,'tasks', OPEN_TASK.id), {
          links: arrayUnion({ title, url, by: CURRENT_USER?.uid || null, at: Timestamp.now() })
        });
        document.getElementById('dLinkTitle').value=''; document.getElementById('dLinkUrl').value='';
      }catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: '+e.message); }
    });

    /* Boot spaces default */
    async function bootSpaces(){
      if(!CURRENT_SPACE){
        CURRENT_SPACE = await ensureDefaultSpace();
        const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
        SPACE_COLUMNS = d.exists()? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS) : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect();
      }
    }
  </script>
</body>
</html>
