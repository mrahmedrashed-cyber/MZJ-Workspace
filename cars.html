<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ — Production Tracker (Isolated)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --danger:#ef4444; --shadow:0 6px 20px rgba(0,0,0,.06) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.7}
  .container{max-width:1280px;margin:24px auto;padding:0 16px}
  .topbar{background:linear-gradient(135deg, rgba(62,36,32,.96), rgba(62,36,32,.85));color:#fff;border-radius:16px;padding:20px 18px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{width:42px;height:42px;border-radius:10px;background:var(--beige);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:inset 0 0 0 2px rgba(255,255,255,.35)}
  h1{margin:0;font-size:20px}
  .muted{color:#e8d9cf;font-size:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button,.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--beige);color:#fff}
  .btn-secondary{background:#ffffff1a;color:#fff;border:1px solid #ffffff3a}
  .btn-ghost{background:#fff;color:var(--brown);border:1px solid #ece1d9}
  .btn-danger{background:var(--danger);color:#fff}
  .panel{background:#fff;border:1px solid #f0e6df;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:14px}
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:1100px){ .grid-4{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid-4{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid #f0e6df;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .metric{display:flex;align-items:center;justify-content:space-between}
  .metric h3{margin:0;font-size:14px;color:var(--muted)}
  .metric strong{font-size:22px}
  label{font-weight:700;font-size:13px;color:var(--brown);display:block;margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e7dbd2;background:#fff;outline:none;font-size:14px}
  input:focus,select:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.18)}
  .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  @media (max-width:1100px){ .row{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  .table-soft{overflow:auto;border-radius:16px;border:1px solid #f0e6df}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:1400px;background:#fff}
  thead th{position:sticky;top:0;background:#fbf6f1;color:var(--brown);padding:12px 10px;border-bottom:1px solid #f0e6df;font-size:13px;z-index:2;text-align:right}
  tbody td{padding:10px;border-bottom:1px solid #f7eee7;font-size:13px;vertical-align:middle}
  tbody tr:nth-child(even){background:#fffdfa}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #eaded6;font-weight:700;font-size:12px;background:#fff;white-space:nowrap}
  .p-green{background:#ecfdf5;border-color:#a7f3d0}
  .p-orange{background:#fff7ed;border-color:#fed7aa}
  .p-gray{background:#f3f4f6;border-color:#e5e7eb}

  .banner{margin:10px 0;padding:10px 12px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="container">
    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">MZJ</div>
        <div>
          <h1>لوحة متابعة إنتاج المحتوى للسيارات</h1>
          <div class="muted">هذه الصفحة محفوظة ومعزولة — لا تؤثر على أي صفحة أخرى</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnExportXLSX" class="btn btn-secondary">تصدير XLSX</button>
        <label id="lblImport" class="btn btn-secondary" for="xlsxImport" style="cursor:pointer">استيراد XLSX (إضافة)</label>
        <input id="xlsxImport" type="file" accept=".xlsx" style="display:none"/>
        <button id="btnTemplate" class="btn btn-ghost">تحميل Template XLSX</button>
        <button id="btnReset" class="btn btn-danger">تفريغ البيانات (محلي)</button>
      </div>
    </div>

    <div id="authBanner" class="banner hidden"></div>

    <!-- KPIs -->
    <div class="grid grid-4 panel" style="margin-top:14px">
      <div class="card metric"><h3>إجمالي السيارات</h3><strong id="kTotal">0</strong></div>
      <div class="card metric"><h3>تم التصوير</h3><strong id="kShot">0</strong></div>
      <div class="card metric"><h3>تحت المونتاج</h3><strong id="kEditing">0</strong></div>
      <div class="card metric"><h3>داخل الأجندة</h3><strong id="kAgenda">0</strong></div>
    </div>

    <!-- إضافة سريعة + جدول التحرير -->
    <div class="panel" id="editorPanel">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">إضافة سيارة سريعة</h2>
      <div class="row">
        <div><label>العلامة</label><select id="iBrand"></select></div>
        <div><label>الموديل</label><select id="iModel" disabled></select></div>
        <div><label>السنة</label><input id="iYear" type="number" min="2015" max="2030" value="2026"></div>
        <div><label>الفئة</label><select id="iTrim"></select></div>
        <div><label>اللون الخارجي</label><input id="iColor" placeholder="مثال: أبيض لؤلؤي"></div>
        <div><label>اللون الداخلي</label><input id="iIntColor" placeholder="مثال: جلد بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Status – تصوير</label><select id="iShoot"></select></div>
        <div><label>Status – مونتاج</label><select id="iEdit"></select></div>
        <div><label>نوع المحتوى</label><select id="iType"></select></div>
        <div><label>تاريخ التصوير</label><input id="iShootDate" type="date"></div>
        <div><label>داخل الأجندة؟</label><select id="iInAgenda"></select></div>
        <div id="agendaFields" class="hidden">
          <label>تاريخ الأجندة</label>
          <div style="display:flex;gap:8px">
            <select id="iAgendaMonth"></select>
            <input id="iAgendaYear" type="number" min="2020" max="2035" value="">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>مرفوع على الموقع؟</label><select id="iOnSite"></select></div>
        <div id="siteLinkField" class="hidden" style="grid-column: span 2">
          <label>رابط صفحة السيارة (اختياري)</label>
          <input id="iSiteLink" placeholder="https://mzjcars.com/...">
        </div>
        <div style="grid-column: span 2"><label>ملاحظات</label><input id="iNotes" placeholder="مثلاً: ينتظر مراجعة SEO / صور ناقصة"></div>
        <div><label>&nbsp;</label><button id="btnAdd" class="btn btn-primary" style="width:100%">إضافة</button></div>
      </div>
      <div class="muted" style="margin-top:6px">* الحفظ السحابي على Firestore. زر التفريغ يمسح النسخة المحلية فقط.</div>
    </div>

    <div class="panel table-soft" style="padding:0">
      <table id="carsTable">
        <thead>
          <tr>
            <th>العلامة</th><th>الموديل</th><th>السنة</th><th>الفئة</th>
            <th>اللون الخارجي</th><th>اللون الداخلي</th>
            <th>تصوير</th><th>مونتاج</th><th>نوع المحتوى</th>
            <th>تاريخ التصوير</th><th>داخل الأجندة؟</th><th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th><th>رابط الصفحة</th><th>ملاحظات</th><th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- الفلاتر + نتيجة الفلتر (عرض فقط) -->
    <div class="panel">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">نتيجة الفلتر (عرض فقط)</h2>
      <div class="row">
        <div><label>العلامة</label><select id="dBrand"><option value="">الكل</option></select></div>
        <div><label>الفئة</label><select id="dTrim"><option value="">الكل</option></select></div>
        <div><label>تصوير</label><select id="dShoot"><option value="">الكل</option></select></div>
        <div><label>مونتاج</label><select id="dEdit"><option value="">الكل</option></select></div>
        <div><label>اللون الخارجي</label><input id="dColor" placeholder="مثال: أبيض"></div>
        <div><label>اللون الداخلي</label><input id="dIntColor" placeholder="مثال: بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>داخل الأجندة؟</label><select id="dAgenda"><option value="">الكل</option></select></div>
        <div style="grid-column: span 5"><label>بحث نصّي</label><input id="dSearch" placeholder="ابحث في الموديل/الملاحظات/الألوان"></div>
      </div>
    </div>

    <div class="panel table-soft" style="padding:0;margin-top:8px">
      <table id="filteredTable">
        <thead>
          <tr>
            <th>العلامة</th><th>الموديل</th><th>السنة</th><th>الفئة</th>
            <th>اللون الخارجي</th><th>اللون الداخلي</th>
            <th>تصوير</th><th>مونتاج</th><th>نوع المحتوى</th>
            <th>تاريخ التصوير</th><th>داخل الأجندة؟</th><th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th><th>رابط الصفحة</th><th>ملاحظات</th>
          </tr>
        </thead>
        <tbody id="filteredTBody"></tbody>
      </table>
      <div class="muted" id="flatMeta" style="padding:10px"></div>
    </div>
  </div>

<!-- ===== Firebase (isolated to this page) ===== -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, where, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  /* ===== Config — SAME project, isolated collection ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
    authDomain: "mzj-workspace.firebaseapp.com",
    projectId: "mzj-workspace",
    storageBucket: "mzj-workspace.firebasestorage.app",
    appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
  };
  if (!getApps().length) initializeApp(firebaseConfig);
  const auth = getAuth();
  const db   = getFirestore();

  const WORKSPACE_ID = "production-tracker";      // عزلة تامة
  const CARS_COLL    = "cars_production";         // Collection خاصة بالصفحة
  let CURRENT_USER=null, CURRENT_ROLE="member", IS_ADMIN=false;

  /* ====== Data & Lookups ====== */
  const BRANDS = ["هيونداي","شانجان","شيري","فورد","ام جي","نيسان"];
  const MODELS_BY_BRAND = {
    "هيونداي": ["سوناتا","النترا","اكسنت","جراند i10","كريتا","جراند كريتا","ستار جيزر","فينيو","ازيرا","سنتافي","توسان","كونا","ستاريا","بالسييد"],
    "شانجان": ["سي اس 75","سي اس 35","ايدو بلس","ال سيفن","يوني كي","يوني تي","يوني في","سي اس 95","يوني اس","هانتر اب"],
    "شيري": ["تيجو 2 برو","اريزو 8","اريزو 6 برو","اريزو 5 برو","أكسييد ال اكس","تيجو 8 برة","تيجو 7","تيجو 4 برو"],
    "فورد": ["رينجر","اكسبلور","تيريتوري","تورس"],
    "ام جي": ["جي تي","ام جي 3","ام جي 7","ام جي 5","اتش أس","ار اكس 5","ون","زد أس","تي 60","ار أكس 9","وال","ار أكس 8"],
    "نيسان": ["اكس تريل","ماجنايت","كيكس","صني","اكس تيرا","التيما"]
  };
  const TRIMS  = ["ستاندر","سمارت","سمارت بلس","كومفورت","فل كامل","ترند","امبيانتي","رويـال"];
  const SHOOT_STATUS = ["لم يُصوّر","تم التصوير","بانتظار مراجعة"];
  const EDIT_STATUS  = ["لم يبدأ","جاري","تم الانتهاء"];
  const CONTENT_TYPES = ["صور","فيديو","ريل","موشن","AI"];
  const YESNO = ["لا","نعم"];
  const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

  const $ = s=>document.querySelector(s);
  const authBanner = $("#authBanner");
  const editorPanel = $("#editorPanel");
  const lblImport = $("#lblImport");

  let rows = [];   // Snapshot من Firestore
  let filters = {brand:"", trim:"", shoot:"", edit:"", color:"", intColor:"", agenda:"", q:""};

  /* ===== Fill helpers ===== */
  function $fill(el, arr, withBlank=false, blankLabel="الكل"){
    el.innerHTML = withBlank ? `<option value="">${blankLabel}</option>` : "";
    arr.forEach(v=>{ const o=document.createElement("option"); o.value=v;o.textContent=v; el.appendChild(o); });
  }
  function $fillStrict(el, arr, withBlank=false){
    el.innerHTML = withBlank ? `<option value="">— اختر —</option>` : "";
    arr.forEach(v=>{ const o=document.createElement("option"); o.value=v;o.textContent=v; el.appendChild(o); });
  }
  function escapeHTML(s){ return (s+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

  /* ===== Init selectors (Add form) ===== */
  function initAddSelectors(){
    $fillStrict($("#iBrand"), BRANDS, true);
    $fillStrict($("#iTrim"), TRIMS);
    $fillStrict($("#iShoot"), SHOOT_STATUS);
    $fillStrict($("#iEdit"), EDIT_STATUS);
    $fillStrict($("#iType"), CONTENT_TYPES);
    $fillStrict($("#iInAgenda"), YESNO);
    $fillStrict($("#iOnSite"), YESNO);
    $fillStrict($("#iAgendaMonth"), MONTHS);
    $("#iAgendaYear").value = new Date().getFullYear();

    function refreshAddModels(){
      const b = $("#iBrand").value;
      const models = MODELS_BY_BRAND[b] || [];
      $("#iModel").disabled = models.length===0;
      $fillStrict($("#iModel"), models, true);
    }
    $("#iBrand").addEventListener("change", refreshAddModels);
    refreshAddModels();

    $("#iInAgenda").addEventListener("change", ()=>$("#agendaFields").classList.toggle("hidden", $("#iInAgenda").value!=="نعم"));
    $("#iOnSite").addEventListener("change", ()=>$("#siteLinkField").classList.toggle("hidden", $("#iOnSite").value!=="نعم"));
    $("#agendaFields").classList.toggle("hidden", $("#iInAgenda").value!=="نعم");
    $("#siteLinkField").classList.toggle("hidden", $("#iOnSite").value!=="نعم");
  }

  /* ===== Filters (readonly table) ===== */
  function initFilterSelectors(){
    $fill($("#dBrand"), BRANDS, true, "الكل");
    $fill($("#dTrim"), TRIMS, true, "الكل");
    $fill($("#dShoot"), SHOOT_STATUS, true, "الكل");
    $fill($("#dEdit"), EDIT_STATUS, true, "الكل");
    $fill($("#dAgenda"), YESNO, true, "الكل");
  }

  /* ===== Firestore listen ===== */
  let unsubCars=null;
  function listenCars(){
    if(unsubCars) { unsubCars(); unsubCars=null; }
    const qy = query(collection(db, CARS_COLL), where("workspaceId","==", WORKSPACE_ID));
    unsubCars = onSnapshot(qy, (snap)=>{
      rows = [];
      snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
      rows.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      updateKPIs(); renderEditor(); renderFilteredTable();
    }, (err)=> {
      console.error(err);
      alert("⚠️ تعذر قراءة البيانات. تأكد من قواعد Firestore.");
    });
  }

  /* ===== Auth & role ===== */
  async function loadRole(uid){
    try{
      const u = await getDoc(doc(db,"users", uid));
      return u.exists()? (u.data().role||"member") : "member";
    }catch{ return "member"; }
  }

  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user||null;
    if(!user){
      IS_ADMIN=false; CURRENT_ROLE="guest";
      authBanner.classList.remove("hidden");
      authBanner.textContent = "أنت غير مسجل دخول — العرض فقط متاح. (لن تتمكن من الإضافة/التعديل)";
      // عرض فقط
      editorPanel.style.display = "none";
      lblImport.style.display = "none";
      initAddSelectors(); initFilterSelectors(); listenCars();
      return;
    }

    CURRENT_ROLE = await loadRole(user.uid);
    IS_ADMIN = CURRENT_ROLE === "admin";

    authBanner.classList.remove("hidden");
    authBanner.textContent = `UID: ${user.uid.slice(0,6)} • Role: ${CURRENT_ROLE} • Workspace: ${WORKSPACE_ID}`;

    // الأذونات
    editorPanel.style.display = IS_ADMIN ? "block" : "none";
    lblImport.style.display   = IS_ADMIN ? "inline-block" : "none";

    initAddSelectors(); initFilterSelectors(); listenCars();
  });

  /* ===== Editor table ===== */
  function textCell(key,val,idx){ return `<input data-idx="${idx}" data-key="${key}" value="${escapeHTML(val??'')}" ${IS_ADMIN?'':'disabled'} />` }
  function numberCell(key,val,idx){ return `<input type="number" data-idx="${idx}" data-key="${key}" value="${escapeHTML(val??'')}" style="width:110px" ${IS_ADMIN?'':'disabled'}/>` }
  function dateCell(key,val,idx){ return `<input type="date" data-idx="${idx}" data-key="${key}" value="${val??''}" style="width:150px" ${IS_ADMIN?'':'disabled'}/>` }
  function linkCell(key,val,idx,label){
    const safe = val? escapeHTML(val):"";
    return `<div style="display:flex;gap:6px;align-items:center">
        <input data-idx="${idx}" data-key="${key}" value="${safe}" placeholder="https://..." style="min-width:220px" ${IS_ADMIN?'':'disabled'}/>
        ${val?`<a class="btn btn-ghost" href="${safe}" target="_blank" rel="noopener">فتح ${label}</a>`:""}
      </div>`;
  }
  function selectCell(key, arr, val, idx, dataType){
    const options = arr.map(v=>`<option ${v===val?'selected':''} value="${v}">${v}</option>`).join("");
    const dt = dataType?`data-type="${dataType}"`:"";
    const dis = IS_ADMIN? "" : "disabled";
    return `<select data-idx="${idx}" data-key="${key}" ${dt} ${dis}>${options}</select>`;
  }
  function modelCell(key, val, brand, idx){
    const models = MODELS_BY_BRAND[brand] || [];
    const opts = [...models];
    if(val && !opts.includes(val)) opts.unshift(val);
    const dis = IS_ADMIN? "" : "disabled";
    return `<select data-idx="${idx}" data-key="${key}" data-type="model" ${dis}>
      ${opts.map(v=>`<option ${v===val?'selected':''} value="${v}">${v}</option>`).join("")}
    </select>`;
  }

  function renderEditor(){
    const tb = $("#tbody"); tb.innerHTML = "";
    rows.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${selectCell("brand", BRANDS, r.brand, idx, 'brand')}</td>
        <td>${modelCell("model", r.model, r.brand, idx)}</td>
        <td>${numberCell("year", r.year, idx)}</td>
        <td>${selectCell("trim", TRIMS, r.trim, idx)}</td>
        <td>${textCell("color", r.color??"", idx)}</td>
        <td>${textCell("intColor", r.intColor??"", idx)}</td>
        <td>${selectCell("shoot", SHOOT_STATUS, r.shoot, idx)}</td>
        <td>${selectCell("edit", EDIT_STATUS, r.edit, idx)}</td>
        <td>${selectCell("ctype", CONTENT_TYPES, r.ctype, idx)}</td>
        <td>${dateCell("shootDate", r.shootDate, idx)}</td>
        <td>${selectCell("inAgenda", YESNO, r.inAgenda, idx)}</td>
        <td>${textCell("agendaDate", r.agendaDate??"", idx)}</td>
        <td>${selectCell("onSite", YESNO, r.onSite, idx)}</td>
        <td>${linkCell("siteLink", r.siteLink||"", idx, "Page")}</td>
        <td>${textCell("notes", r.notes??"", idx)}</td>
        <td>
          ${IS_ADMIN? `<button class="btn btn-ghost" data-action="dup" data-idx="${idx}">نسخ</button>
          <button class="btn btn-danger" data-action="del" data-idx="${idx}">حذف</button>` : '<span class="muted">—</span>'}
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  /* ===== Readonly table ===== */
  function badgePill(val, kind){
    const cls = kind==="green"?"p-green":kind==="orange"?"p-orange":"p-gray";
    return `<span class="pill ${cls}">${escapeHTML(val)}</span>`;
  }
  function currentListReadonly(){
    return rows.filter(r=>{
      if(filters.brand && r.brand!==filters.brand) return false;
      if(filters.trim && r.trim!==filters.trim) return false;
      if(filters.shoot && r.shoot!==filters.shoot) return false;
      if(filters.edit && r.edit!==filters.edit) return false;
      if(filters.color && !(r.color||"").toLowerCase().includes(filters.color.toLowerCase())) return false;
      if(filters.intColor && !(r.intColor||"").toLowerCase().includes(filters.intColor.toLowerCase())) return false;
      if(filters.agenda && r.inAgenda!==filters.agenda) return false;
      if(filters.q){
        const q = filters.q.trim().toLowerCase();
        const hay = `${r.brand} ${r.model} ${r.trim} ${r.color||""} ${r.intColor||""} ${r.notes||""}`.toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
  }
  function renderFilteredTable(){
    const list = currentListReadonly();
    const tb = $("#filteredTBody");
    tb.innerHTML = "";
    if(!list.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="15" style="padding:14px">لا توجد نتائج مطابقة.</td>`;
      tb.appendChild(tr);
    } else {
      list.forEach(r=>{
        const shootP = r.shoot==="تم التصوير" ? badgePill(r.shoot,"green") :
                       r.shoot==="بانتظار مراجعة" ? badgePill(r.shoot,"orange") : badgePill(r.shoot,"gray");
        const editP  = r.edit==="تم الانتهاء" ? badgePill(r.edit,"green") :
                       r.edit==="جاري" ? badgePill(r.edit,"orange") : badgePill(r.edit,"gray");
        const agendaP= r.inAgenda==="نعم" ? badgePill("نعم","green") : badgePill("لا","gray");
        const siteP  = r.onSite==="نعم" ? badgePill("نعم","green") : badgePill("لا","gray");
        const link   = (r.onSite==="نعم" && r.siteLink) ? `<a href="${escapeHTML(r.siteLink)}" target="_blank" rel="noopener">${escapeHTML(r.siteLink)}</a>` : "—";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHTML(r.brand||"—")}</td>
          <td>${escapeHTML(r.model||"—")}</td>
          <td>${escapeHTML(r.year||"—")}</td>
          <td>${escapeHTML(r.trim||"—")}</td>
          <td>${escapeHTML(r.color||"—")}</td>
          <td>${escapeHTML(r.intColor||"—")}</td>
          <td>${shootP}</td>
          <td>${editP}</td>
          <td>${escapeHTML(r.ctype||"—")}</td>
          <td>${escapeHTML(r.shootDate||"—")}</td>
          <td>${agendaP}</td>
          <td>${escapeHTML(r.agendaDate||"—")}</td>
          <td>${siteP}</td>
          <td>${link}</td>
          <td>${escapeHTML(r.notes||"—")}</td>
        `;
        tb.appendChild(tr);
      });
    }
    $("#flatMeta").textContent = `${list.length} نتيجة — عرض فقط (بدون تعديل)`;
  }

  /* ===== KPIs ===== */
  function updateKPIs(){
    $("#kTotal").textContent   = rows.length;
    $("#kShot").textContent    = rows.filter(r=>r.shoot==="تم التصوير").length;
    $("#kEditing").textContent = rows.filter(r=>r.edit==="جاري").length;
    $("#kAgenda").textContent  = rows.filter(r=>r.inAgenda==="نعم").length;
  }

  /* ===== UI Events ===== */
  document.addEventListener("change", async (e)=>{
    const t = e.target;

    // فلاتر العرض فقط
    if(t.matches("#dBrand,#dTrim,#dShoot,#dEdit,#dAgenda")){
      filters.brand = $("#dBrand").value;
      filters.trim  = $("#dTrim").value;
      filters.shoot = $("#dShoot").value;
      filters.edit  = $("#dEdit").value;
      filters.agenda= $("#dAgenda").value;
      renderFilteredTable();
      return;
    }

    // تعديلات الجدول (Admin فقط)
    if(t.matches("select[data-idx], input[data-idx]") && !t.closest("#filteredTable")){
      if(!IS_ADMIN) return;
      const idx = +t.dataset.idx; const key = t.dataset.key; const val = t.value;
      const row = rows[idx]; if(!row || !row.id) return;

      // تحديث تبعي للموديل عند تغيير العلامة
      let patch = { [key]: val };
      if(key === "brand"){
        const allowed = MODELS_BY_BRAND[val] || [];
        const newModel = allowed.includes(row.model) ? row.model : (allowed[0]||"");
        patch.model = newModel;
      }

      try{
        await updateDoc(doc(db, CARS_COLL, row.id), patch);
      }catch(err){
        alert("⚠️ فشل التعديل: " + (err?.message||err));
      }
    }
  });

  document.addEventListener("input", (e)=>{
    const t = e.target;
    if(t.id==="dSearch"){ filters.q = t.value; renderFilteredTable(); }
    if(t.id==="dColor"){ filters.color = t.value; renderFilteredTable(); }
    if(t.id==="dIntColor"){ filters.intColor = t.value; renderFilteredTable(); }
  });

  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button"); if(!btn) return;
    if(btn.id==="btnExportXLSX"){ exportXLSX(); }
    if(btn.id==="btnTemplate"){ downloadTemplate(); }
    if(btn.id==="btnReset"){ localStorage.removeItem("mzj-cars-tracker"); alert("تم مسح النسخة المحلية فقط."); }
    if(btn.id==="btnAdd"){ if(IS_ADMIN) await addQuick(); else alert("إضافة متاحة للأدمِن فقط."); }
    if(btn.dataset.action==="del"){
      if(!IS_ADMIN) return;
      const idx = +btn.dataset.idx; const row = rows[idx]; if(!row?.id) return;
      if(confirm("حذف هذه السيارة؟")){
        try{ await deleteDoc(doc(db, CARS_COLL, row.id)); }catch(err){ alert("⚠️ فشل الحذف: " + (err?.message||err)); }
      }
    }
    if(btn.dataset.action==="dup"){
      if(!IS_ADMIN) return;
      const idx = +btn.dataset.idx; const r = rows[idx]; if(!r) return;
      const copy = { ...r }; delete copy.id; delete copy.createdAt;
      try{
        await addDoc(collection(db, CARS_COLL), { ...copy, workspaceId: WORKSPACE_ID, createdAt: serverTimestamp() });
      }catch(err){ alert("⚠️ فشل النسخ: " + (err?.message||err)); }
    }
  });

  // استيراد XLSX (إضافة) — Admin فقط
  document.getElementById("xlsxImport").addEventListener("change", async (e)=>{
    if(!IS_ADMIN){ e.target.value=""; return alert("الاستيراد متاح للأدمِن فقط."); }
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (evt)=>{
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type: "array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {defval:""});
        if(!json.length) return alert("الملف فارغ.");
        const headers = ["brand","model","year","trim","color","intColor","shoot","edit","ctype","shootDate","inAgenda","agendaDate","onSite","siteLink","notes"];
        const cols = Object.keys(json[0]||{});
        const ok = headers.every(h=>cols.includes(h));
        if(!ok) return alert("صيغة XLSX غير مطابقة. حمّل الـTemplate أعلاه.");

        const batch = json.map(r=>({
          brand:r.brand||"", model:r.model||"", year:+r.year||2026, trim:r.trim||TRIMS[0],
          color:r.color||"", intColor:r.intColor||"", shoot:r.shoot||SHOOT_STATUS[0],
          edit:r.edit||EDIT_STATUS[0], ctype:r.ctype||CONTENT_TYPES[0],
          shootDate:r.shootDate||"", inAgenda:r.inAgenda||"لا", agendaDate:r.agendaDate||"",
          onSite:r.onSite||"لا", siteLink:r.siteLink||"", notes:r.notes||"",
          workspaceId: WORKSPACE_ID, createdAt: serverTimestamp()
        }));
        for(const docData of batch){ await addDoc(collection(db, CARS_COLL), docData); }
        alert(`تم استيراد ${batch.length} سيارة.`);
      }catch(err){ alert("⚠️ فشل الاستيراد: " + (err?.message||err)); }
    };
    reader.readAsArrayBuffer(file);
    e.target.value="";
  });

  /* ===== Add Quick ===== */
  async function addQuick(){
    const agendaMonth = $("#iAgendaMonth").value;
    const agendaYear  = ($("#iAgendaYear").value||"").trim();
    const agendaDate  = ($("#iInAgenda").value==="نعم" && agendaMonth && agendaYear) ? `${agendaMonth} ${agendaYear}` : "";

    const docData = {
      brand: $("#iBrand").value || "",
      model: $("#iModel").value || "",
      year:  +($("#iYear").value || 2026),
      trim:  $("#iTrim").value || TRIMS[0],
      color: ($("#iColor").value || "").trim(),
      intColor: ($("#iIntColor").value || "").trim(),
      shoot: $("#iShoot").value || SHOOT_STATUS[0],
      edit:  $("#iEdit").value || EDIT_STATUS[0],
      ctype: $("#iType").value || CONTENT_TYPES[0],
      shootDate: $("#iShootDate").value || "",
      inAgenda: $("#iInAgenda").value || "لا",
      agendaDate,
      onSite: $("#iOnSite").value || "لا",
      siteLink: ($("#iOnSite").value==="نعم" ? ($("#iSiteLink").value||"") : ""),
      notes: $("#iNotes").value || "",
      workspaceId: WORKSPACE_ID,
      createdAt: serverTimestamp()
    };

    try{
      await addDoc(collection(db, CARS_COLL), docData);
      // تفريغ حقول بسيطة:
      ["iModel","iColor","iIntColor","iNotes","iShootDate","iSiteLink"].forEach(id=>$("#"+id).value="");
      $("#iInAgenda").value = "لا"; $("#agendaFields").classList.add("hidden");
      $("#iOnSite").value = "لا"; $("#siteLinkField").classList.add("hidden");
    }catch(err){
      alert("⚠️ فشل الإضافة: " + (err?.message||err));
    }
  }

  /* ===== XLSX Export / Template ===== */
  function xlsxHeaders(){ return ["brand","model","year","trim","color","intColor","shoot","edit","ctype","shootDate","inAgenda","agendaDate","onSite","siteLink","notes"]; }
  function exportXLSX(){
    const headers = xlsxHeaders();
    const data = rows.map(r=>{ const o={}; headers.forEach(h=>o[h]=r[h]??""); return o; });
    const ws = XLSX.utils.json_to_sheet(data, {header: headers});
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "MZJ Cars");
    XLSX.writeFile(wb, "mzj-production-tracker.xlsx");
  }
  function downloadTemplate(){
    const headers = xlsxHeaders();
    const sample = [{
      brand:"هيونداي", model:"سوناتا", year:2026, trim:"سمارت",
      color:"أبيض لؤلؤي", intColor:"أسود", shoot:"تم التصوير", edit:"جاري",
      ctype:"ريل", shootDate:"2025-10-12", inAgenda:"نعم", agendaDate:"أكتوبر 2025",
      onSite:"لا", siteLink:"", notes:"مثال: ينتظر فويس"
    }];
    const ws = XLSX.utils.json_to_sheet(sample, {header: headers});
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "mzj-quick-add-template.xlsx");
  }

  /* ===== KPIs refresh stubs ===== */
  function updateKPIs(){
    $("#kTotal").textContent   = rows.length;
    $("#kShot").textContent    = rows.filter(r=>r.shoot==="تم التصوير").length;
    $("#kEditing").textContent = rows.filter(r=>r.edit==="جاري").length;
    $("#kAgenda").textContent  = rows.filter(r=>r.inAgenda==="نعم").length;
  }
</script>
</body>
</html>
