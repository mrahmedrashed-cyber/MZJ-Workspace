<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم — MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--brown);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 20px rgba(62,36,32,.2)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}
    .nav .select{border-radius:10px;border:0;padding:8px 10px}

    .page{padding:18px;display:grid;gap:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:1100px){ .grid.two{grid-template-columns:2fr 1fr} }
    @media(min-width:900px){ .grid.three{grid-template-columns:repeat(3,1fr)} }
    @media(min-width:1100px){ .grid.four{grid-template-columns:repeat(4,1fr)} }

    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 12px 30px rgba(62,36,32,.12);overflow:hidden}
    .panel .head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .panel .body{padding:12px 14px}
    .muted{color:var(--muted)}
    .select,.input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}

    /* KPI tiles */
    .kpis{display:grid;gap:12px}
    @media(min-width:900px){ .kpis{grid-template-columns:repeat(5,1fr)} }
    .kpi{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;display:grid;gap:6px}
    .kpi .lbl{font-size:13px;color:var(--muted)}
    .kpi .val{font-size:26px;font-weight:800;color:var(--brown)}
    .kpi .hint{font-size:12px;color:var(--muted)}

    /* Column counters */
    .cols{display:grid;gap:10px}
    @media(min-width:800px){ .cols{grid-template-columns:repeat(4,1fr)} }
    .colbox{background:#fff8ef;border:1px solid #edd7ca;border-radius:14px;padding:12px}
    .colbox .title{color:var(--brown);font-weight:800}
    .colbox .num{font-size:22px;font-weight:800}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:right}
    th{color:var(--brown);font-weight:800;background:#fffaf5}
    tr:hover td{background:#fffdf9}

    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .badge .dot{inline-size:8px;block-size:8px;border-radius:999px;background:#bc8f74}

    .empty{padding:14px;border:1px dashed #ead8cb;border-radius:12px;color:#8f7f76;background:#fffbf6}

    footer{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19);margin-top:8px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-badge"></span>
      <strong>MZJ Workspace — لوحة التحكم</strong>
    </div>
    <nav class="nav">
      <a id="navDashboard" href="dashboard.html">لوحة التحكم</a>
      <a id="navProjects"  href="projects.html">المشاريع</a>
      <a id="navMembers"   href="members.html">الأعضاء</a>
      <a id="navAdmin"     href="admin.html">الإدارة</a>
      <select id="spaceSelect" class="select"></select>
      <a href="javascript:void(0)" id="btnLogout">تسجيل الخروج</a>
    </nav>
  </header>

  <main class="page">
    <section class="panel">
      <div class="head">
        <div><strong>ملخص الـ Space الحالي</strong></div>
        <div class="muted" id="who"></div>
      </div>
      <div class="body">
        <div class="kpis" id="kpis">
          <div class="kpi"><div class="lbl">إجمالي المهام</div><div class="val" id="k_total">—</div><div class="hint">كل الأعمدة</div></div>
          <div class="kpi"><div class="lbl">متأخرة</div><div class="val" id="k_overdue">—</div><div class="hint">تاريخ تسليم قبل اليوم</div></div>
          <div class="kpi"><div class="lbl">تسليم اليوم</div><div class="val" id="k_today">—</div><div class="hint">تسليم خلال اليوم</div></div>
          <div class="kpi"><div class="lbl">تحت المراجعة</div><div class="val" id="k_review">—</div><div class="hint">“تحت المراجعة”</div></div>
          <div class="kpi"><div class="lbl">غير معيّنة</div><div class="val" id="k_unassigned">—</div><div class="hint">بدون مسؤول</div></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="head">
        <div><strong>عداد الأعمدة</strong></div>
        <div class="muted" id="colsHint">ريل مواصفات / ريل قصير / تصميم صور / يوتيوب / …</div>
      </div>
      <div class="body">
        <div class="cols" id="cols"></div>
      </div>
    </section>

    <div class="grid two">
      <section class="panel">
        <div class="head"><strong>أقرب تسليم (Top 10)</strong></div>
        <div class="body">
          <div id="soonWrap"></div>
        </div>
      </section>

      <section class="panel">
        <div class="head"><strong>توزيع المهام على الأعضاء</strong></div>
        <div class="body">
          <div id="assigneesWrap"></div>
        </div>
      </section>
    </div>

    <section class="panel">
      <div class="head"><strong>نشاط حديث</strong><span class="muted">آخر 15 تحديث</span></div>
      <div class="body" id="activityWrap"></div>
    </section>
  </main>

  <footer>© مجموعة محمد بن ذعار العجمي للسيارات — نجم الطريق</footer>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, onSnapshot,
      query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Config */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    /* UI refs */
    const spaceSelect = document.getElementById('spaceSelect');
    const whoEl       = document.getElementById('who');
    document.getElementById('btnLogout').onclick = async()=>{ await signOut(auth); location.href="login.html"; };

    // KPI refs
    const kTotal=document.getElementById('k_total');
    const kOver=document.getElementById('k_overdue');
    const kToday=document.getElementById('k_today');
    const kRev  =document.getElementById('k_review');
    const kUnas =document.getElementById('k_unassigned');
    const colsBox = document.getElementById('cols');
    const soonWrap = document.getElementById('soonWrap');
    const assigneesWrap = document.getElementById('assigneesWrap');
    const activityWrap  = document.getElementById('activityWrap');

    /* State */
    let CURRENT_USER=null, IS_ADMIN=false;
    let CURRENT_SPACE=null, SPACE_COLUMNS=["ريل مواصفات","ريل قصير","تصميم صور","يوتيوب","تحت المراجعة"];
    let unsubTasks=null;
    let TASKS=[];

    function fmtDate(dstr){
      if(!dstr) return '';
      try{ const d=new Date(dstr+'T00:00:00'); return d.toLocaleDateString('ar-SA'); } catch{ return dstr; }
    }
    function todayYMD(){
      const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    // Auth gate: admin only, otherwise redirect to projects
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER=user;
      const u = await getDoc(doc(db,'users', user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'مستخدم');
      const role = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = role === 'admin';
      whoEl.textContent = `${name} — ${IS_ADMIN?'مدير':'عضو'}`;

      if(!IS_ADMIN){
        // إخفاء الروابط غير المسموحة ثم تحويل للمشاريع
        document.getElementById('navMembers').style.display='none';
        document.getElementById('navAdmin').style.display='none';
        // المستخدم العضو ليس له صلاحية الدخول للوحة التحكم
        location.href="projects.html";
        return;
      }

      bootSpaces();
    });

    // Spaces dropdown + pick latest
    async function bootSpaces(){
      onSnapshot(collection(db,'spaces'), (snap)=>{
        const items=[];
        snap.forEach(d=>{
          const data=d.data()||{};
          if(data.active!==false) items.push({ id:d.id, ...data });
        });
        items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

        spaceSelect.innerHTML='';
        items.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s.id; opt.textContent=s.name;
          spaceSelect.appendChild(opt);
        });

        // select current
        if(!CURRENT_SPACE && items.length){
          CURRENT_SPACE = items[0].id;
          SPACE_COLUMNS = (items[0].columns && items[0].columns.length)? items[0].columns.slice() : SPACE_COLUMNS;
          if(!SPACE_COLUMNS.includes('تحت المراجعة')) SPACE_COLUMNS.push('تحت المراجعة');
          spaceSelect.value = CURRENT_SPACE;
          listenTasks();
        }
      });

      spaceSelect.addEventListener('change', async (e)=>{
        CURRENT_SPACE = e.target.value;
        const d=await getDoc(doc(db,'spaces', CURRENT_SPACE));
        if(d.exists()){
          const cols = d.data().columns || [];
          SPACE_COLUMNS = cols.length? cols.slice() : ["ريل مواصفات","ريل قصير","تصميم صور","يوتيوب"];
          if(!SPACE_COLUMNS.includes('تحت المراجعة')) SPACE_COLUMNS.push('تحت المراجعة');
        }
        listenTasks(true);
      });
    }

    function listenTasks(reset=false){
      if(unsubTasks){ unsubTasks(); unsubTasks=null; }
      if(!CURRENT_SPACE) return;

      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasks = onSnapshot(qy, (snap)=>{
        TASKS=[]; snap.forEach(d=> TASKS.push({ id:d.id, ...(d.data()||{}) }));
        renderAll();
      }, (err)=>{ console.error(err); });
    }

    function renderAll(){
      // KPIs
      const today = todayYMD();
      const total = TASKS.length;
      const overdue = TASKS.filter(t=> t.due && t.due < today).length;
      const dueToday= TASKS.filter(t=> t.due && t.due === today).length;
      const review  = TASKS.filter(t=> t.status==='تحت المراجعة').length;
      const unas    = TASKS.filter(t=> !t.assignee || !t.assignee.uid).length;

      kTotal.textContent = total;
      kOver.textContent  = overdue;
      kToday.textContent = dueToday;
      kRev.textContent   = review;
      kUnas.textContent  = unas;

      // Column counters
      colsBox.innerHTML='';
      SPACE_COLUMNS.forEach(c=>{
        const n = TASKS.filter(t=> t.status===c).length;
        const box=document.createElement('div');
        box.className='colbox';
        box.innerHTML=`<div class="title">${c}</div><div class="num">${n}</div>`;
        colsBox.appendChild(box);
      });

      // Soon due (top 10 by due asc, valid due only)
      const soon = TASKS.filter(t=> t.due).slice().sort((a,b)=> (a.due>b.due?1:-1)).slice(0,10);
      soonWrap.innerHTML = soon.length? `
        <table>
          <thead><tr><th>المهمة</th><th>المسؤول</th><th>التاريخ</th><th>الحالة</th></tr></thead>
          <tbody>
            ${soon.map(t=>`
              <tr>
                <td>${t.name||'-'}</td>
                <td>${t.assignee?`<span class="badge"><span class="dot" style="background:${t.assignee.color||'#bc8f74'}"></span>${t.assignee.name||''}</span>`:'—'}</td>
                <td>${fmtDate(t.due)||'—'}</td>
                <td>${t.status||'—'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">لا توجد تواريخ قريبة حاليًا.</div>`;

      // Assignees distribution (top 10)
      const mapAss={};
      TASKS.forEach(t=>{
        const key = t.assignee?.name || 'غير معيّن';
        mapAss[key] = (mapAss[key]||0)+1;
      });
      const rows = Object.entries(mapAss).sort((a,b)=> b[1]-a[1]).slice(0,10);
      assigneesWrap.innerHTML = rows.length? `
        <table>
          <thead><tr><th>العضو</th><th>عدد المهام</th></tr></thead>
          <tbody>
            ${rows.map(([n,c])=> `<tr><td>${n}</td><td>${c}</td></tr>`).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">لا مهام مسندة بعد.</div>`;

      // Recent activity (approx): آخر 15 حسب createdAt أو edited
      const sorted = TASKS.slice().sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).slice(0,15);
      activityWrap.innerHTML = sorted.length? `
        <table>
          <thead><tr><th>المهمة</th><th>المسؤول</th><th>الحالة</th><th>إنشاء</th><th>روابط</th></tr></thead>
          <tbody>
            ${sorted.map(t=>{
              const linksCount = Array.isArray(t.links)? t.links.length : 0;
              const created = t.createdAt?.seconds ? new Date(t.createdAt.seconds*1000).toLocaleDateString('ar-SA') : '—';
              return `
                <tr>
                  <td>${t.name||'-'}</td>
                  <td>${t.assignee?`<span class="badge"><span class="dot" style="background:${t.assignee.color||'#bc8f74'}"></span>${t.assignee.name||''}</span>`:'—'}</td>
                  <td>${t.status||'—'}</td>
                  <td>${created}</td>
                  <td>${linksCount}</td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      ` : `<div class="empty">لا نشاط حديث.</div>`;
    }
  </script>
</body>
</html>
