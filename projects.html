<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, where, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

  /* Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
    authDomain: "mzj-workspace.firebaseapp.com",
    projectId: "mzj-workspace",
    storageBucket: "mzj-workspace.firebasestorage.app",
    appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
  };
  if (!getApps().length) initializeApp(firebaseConfig);
  const auth = getAuth(); const db = getFirestore(); const storage = getStorage();

  /* Auth / Roles */
  let CURRENT_USER=null, CURRENT_ROLE='member', IS_ADMIN=false;
  window.mzjLogout = async ()=>{ await signOut(auth); location.href="login.html"; };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="login.html"; return; }
    CURRENT_USER = user;
    const u = await getDoc(doc(db,"users", user.uid));
    const name = u.exists()? (u.data().name||user.email) : (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
    CURRENT_ROLE = u.exists()? (u.data().role||'member') : 'member';
    IS_ADMIN = CURRENT_ROLE==='admin';
    document.getElementById('who').textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;

    ['btnNewSpace','btnAddGroup','newGroupName','btnNewTask','btnSpaceManage'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.style.display = IS_ADMIN? '' : 'none';
    });
    document.querySelectorAll('.col-actions').forEach(el=> el.style.display = IS_ADMIN? 'flex' : 'none');
  });

  /* Constants */
  const DEFAULT_COLUMNS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
  const REVIEW_COLUMN   = "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"; // âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  const MIME_TASK   = "application/x-mzj-task";
  const MIME_COLUMN = "application/x-mzj-column";

  /* Spaces / Columns */
  const spaceSelect     = document.getElementById('spaceSelect');
  const newGroupNameEl  = document.getElementById('newGroupName');
  const btnAddGroup     = document.getElementById('btnAddGroup');
  const btnSpaceManage  = document.getElementById('btnSpaceManage');

  let CURRENT_SPACE=null; let SPACE_COLUMNS=DEFAULT_COLUMNS.slice();

  async function ensureReviewColumn(){
    if (!CURRENT_SPACE) return;
    if (SPACE_COLUMNS.includes(REVIEW_COLUMN)) return;
    const cols = SPACE_COLUMNS.concat([REVIEW_COLUMN]);
    try{
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS = cols;
      renderBoardSkeleton(); renderTasks(); fillGroupSelect();
    }catch(e){ console.error(e); }
  }

  async function ensureDefaultSpace(){
    const qy = query(collection(db,'spaces'), where('active','!=', false));
    const snap = await getDocs(qy);
    if (snap.empty){
      const label = new Date().toLocaleDateString('ar-SA',{ year:'numeric', month:'long' });
      const ref = await addDoc(collection(db,'spaces'), { name:label, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true });
      return ref.id;
    } else {
      let id=null, ts=0; snap.forEach(d=>{ const s=d.data()?.createdAt?.seconds||0; if(s>=ts){ts=s; id=d.id;} });
      return id;
    }
  }

  function fillSpaceDropdown(list, selectedId){
    spaceSelect.innerHTML='';
    list.forEach(s=>{
      const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; spaceSelect.appendChild(opt);
    });
    if(selectedId) spaceSelect.value=selectedId;
  }

  onSnapshot(collection(db,'spaces'), snap=>{
    const items=[];
    snap.forEach(d=>{ const data=d.data()||{}; if(data.active!==false) items.push({id:d.id, ...data}); });
    items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    fillSpaceDropdown(items, CURRENT_SPACE);
    if(!CURRENT_SPACE && items.length){
      CURRENT_SPACE = items[0].id;
      SPACE_COLUMNS = items[0].columns?.length? items[0].columns : DEFAULT_COLUMNS;
      renderBoardSkeleton(); listenTasks(); fillGroupSelect(); ensureReviewColumn();
    }
  });

  document.getElementById('btnNewSpace').addEventListener('click', async ()=>{
    if(!IS_ADMIN) return;
    const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù€Space (Ù…Ø«Ø§Ù„: Ù†ÙˆÙÙ…Ø¨Ø± 2025):'); if(!name) return;
    const ref = await addDoc(collection(db,'spaces'), { name, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true });
    CURRENT_SPACE = ref.id; SPACE_COLUMNS = DEFAULT_COLUMNS.slice();
    renderBoardSkeleton(); listenTasks(true); fillGroupSelect(); ensureReviewColumn();
  });

  btnSpaceManage.addEventListener('click', async ()=>{
    if(!IS_ADMIN || !CURRENT_SPACE) return;
    const action = prompt('Ø§ÙƒØªØ¨:\nrename Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©\narchive Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€Space');
    if(!action) return;
    if(action.toLowerCase()==='rename'){
      const nm = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù€Space:'); if(!nm) return;
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { name:nm });
    } else if(action.toLowerCase()==='archive'){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€SpaceØŸ')) return;
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { active:false, archivedAt:serverTimestamp() });
      CURRENT_SPACE=null;
    }
  });

  spaceSelect.addEventListener('change', async (e)=>{
    CURRENT_SPACE = e.target.value;
    const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
    SPACE_COLUMNS = d.exists()? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS) : DEFAULT_COLUMNS;
    renderBoardSkeleton(); listenTasks(true); fillGroupSelect(); ensureReviewColumn();
  });

  btnAddGroup.addEventListener('click', async ()=>{
    if(!IS_ADMIN) return;
    if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
    const name = (newGroupNameEl.value || 'ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§').trim();
    if(!name) return;
    if(SPACE_COLUMNS.includes(name)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');
    const cols = SPACE_COLUMNS.concat([name]);
    await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
    SPACE_COLUMNS = cols; newGroupNameEl.value=''; renderBoardSkeleton(); renderTasks(); fillGroupSelect();
  });

  /* Users */
  let USERS=[];
  async function loadUsers(){
    const snap = await getDocs(collection(db,'users'));
    USERS=[]; snap.forEach(d=>{
      const u=d.data()||{};
      USERS.push({ uid:d.id, name:u.name||d.id.slice(0,6), role:u.role||'member', color:u.color||'#bc8f74' });
    });
  }
  await loadUsers();

  /* Create Task */
  const taskModal = document.getElementById('taskModal');
  const btnNewTask = document.getElementById('btnNewTask');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const btnCancelTask = document.getElementById('btnCancelTask');
  const btnSaveTask = document.getElementById('btnSaveTask');

  const tName = document.getElementById('tName');
  const tDesc = document.getElementById('tDesc');
  const tDue  = document.getElementById('tDue');
  const tFiles= document.getElementById('tFiles');
  const tAssigneeSearch = document.getElementById('tAssigneeSearch');
  const assigneeMenu = document.getElementById('assigneeMenu');
  const assigneeChip = document.getElementById('assigneeChip');
  const tColor = document.getElementById('tColor');
  const tGroup = document.getElementById('tGroup');
  let SELECTED_ASSIGNEE=null;

  function fillGroupSelect(){
    tGroup.innerHTML='';
    (SPACE_COLUMNS||[]).forEach(col=>{
      const opt=document.createElement('option'); opt.value=col; opt.textContent=col; tGroup.appendChild(opt);
    });
  }

  function openCreate(){ if(IS_ADMIN){ taskModal.classList.add('show'); fillGroupSelect(); } }
  function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

  btnNewTask.addEventListener('click', ()=> openCreate());
  btnCloseModal.addEventListener('click', ()=> closeCreate());
  btnCancelTask.addEventListener('click', ()=> closeCreate());
  taskModal.addEventListener('click', (e)=>{ if(e.target===taskModal) closeCreate(); });

  function resetCreateForm(){
    tName.value=''; tDesc.value=''; tDue.value=''; tFiles.value='';
    tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.style.display='none';
    assigneeChip.innerHTML=''; SELECTED_ASSIGNEE=null; tColor.value='#bc8f74';
    fillGroupSelect();
  }

  function renderAssigneeMenu(filter){
    const f=(filter||'').toLowerCase();
    assigneeMenu.innerHTML='';
    USERS.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
      const it=document.createElement('div');
      it.className='dd-item';
      it.innerHTML=`<span class="row"><span class="color-dot" style="background:${u.color||'#bc8f74'}"></span> ${u.name} <span class="muted">(${u.role})</span></span>`;
      it.onclick=()=> selectAssignee(u);
      assigneeMenu.appendChild(it);
    });
    assigneeMenu.style.display='block';
  }
  function selectAssignee(u){
    SELECTED_ASSIGNEE = {...u};
    assigneeChip.innerHTML = `<span class="badge"><span class="dot" style="background:${u.color}"></span>${u.name}</span>`;
    tColor.value = u.color || '#bc8f74';
    assigneeMenu.style.display='none';
  }
  tAssigneeSearch.addEventListener('input', (e)=> renderAssigneeMenu(e.target.value.trim()));
  tAssigneeSearch.addEventListener('focus', ()=> renderAssigneeMenu(tAssigneeSearch.value));
  document.addEventListener('click', (e)=>{ if(!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch) assigneeMenu.style.display='none'; });

  async function uploadAttachmentsFor(taskId, inputEl){
    const files = Array.from(inputEl.files||[]); const out=[];
    for(const file of files){
      const path = `attachments/${taskId}/${Date.now()}_${file.name}`;
      const ref = sRef(storage, path); await uploadBytes(ref,file);
      const url = await getDownloadURL(ref);
      out.push({ name:file.name, url, path });
    }
    return out;
  }

  btnSaveTask.addEventListener('click', async ()=>{
    if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
    if(!IS_ADMIN) return alert('Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ†');

    const name=tName.value.trim(); if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');
    const due=tDue.value||null; const description=tDesc.value||null;
    const assigneeUid=SELECTED_ASSIGNEE?.uid||null; const assigneeName=SELECTED_ASSIGNEE?.name||null;
    const color=(document.getElementById('tColor').value||'#bc8f74').trim();
    const status=tGroup.value || (SPACE_COLUMNS[0]||DEFAULT_COLUMNS[0]);

    try{
      if(assigneeUid){
        await setDoc(doc(db,'users', assigneeUid), { color }, { merge:true });
        const idx=USERS.findIndex(u=>u.uid===assigneeUid); if(idx>-1) USERS[idx].color=color;
      }
      const payload = {
        spaceId: CURRENT_SPACE, name, description, due, status,
        assignee: assigneeUid ? { uid:assigneeUid, name:assigneeName, color } : null,
        attachments: [], links: [],
        createdBy: CURRENT_USER?.uid || null, createdAt: serverTimestamp(), active:true
      };
      const ref = await addDoc(collection(db,'tasks'), payload);
      const atts = await uploadAttachmentsFor(ref.id, tFiles);
      if(atts.length){ await updateDoc(doc(db,'tasks', ref.id), { attachments: atts }); }
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ'); closeCreate();
    }catch(e){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+(e?.message||e)); }
  });

  /* Board & Details */
  const board=document.getElementById('board');
  let TASKS=[]; let unsubTasks=null; let OPEN_TASK=null;

  function renderColumnHeaderActions(container, columnName){
    const actions=document.createElement('div'); actions.className='col-actions'; actions.style.display=IS_ADMIN?'flex':'none';
    const btnRename=document.createElement('button'); btnRename.className='icon'; btnRename.textContent='âœï¸'; btnRename.title='Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆØ¯';
    btnRename.onclick=async ()=>{
      if(!IS_ADMIN) return;
      const nn=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', columnName); if(!nn||nn===columnName) return;
      const cols=SPACE_COLUMNS.map(c=>c===columnName?nn:c); await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS=cols; renderBoardSkeleton(); renderTasks(); fillGroupSelect(); ensureReviewColumn();
    };
    const btnDelete=document.createElement('button'); btnDelete.className='icon'; btnDelete.textContent='ğŸ—‘ï¸'; btnDelete.title='Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯';
    btnDelete.onclick=async ()=>{
      if(!IS_ADMIN) return;
      if(SPACE_COLUMNS.length<=1) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯.');
      const target=prompt(`Ø³ÙŠØªÙ… Ø­Ø°Ù "${columnName}". Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰: \n${SPACE_COLUMNS.join(', ')}`);
      if(!target || !SPACE_COLUMNS.includes(target) || target===columnName) return;
      const affected=TASKS.filter(t=>t.status===columnName);
      for(const t of affected){ try{ await updateDoc(doc(db,'tasks', t.id), { status:target }); }catch{} }
      const cols=SPACE_COLUMNS.filter(c=>c!==columnName);
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS=cols; renderBoardSkeleton(); renderTasks(); fillGroupSelect(); ensureReviewColumn();
    };
    actions.appendChild(btnRename); actions.appendChild(btnDelete); container.appendChild(actions);
  }

  async function persistColumnsOrder(newOrder){
    if (!CURRENT_SPACE) return;
    try{ await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: newOrder }); }
    catch(e){ console.error(e); alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.'); }
  }

  function renderBoardSkeleton(){
    board.innerHTML='';

    (SPACE_COLUMNS||[]).forEach((col, index)=>{
      const sec=document.createElement('section');
      sec.className='col';
      sec.dataset.status=col;
      sec.dataset.index=index;

      sec.innerHTML=`
        <div class="col-head">
          <span class="col-title">${col}</span>
          <div class="grip"><span class="dots">â‹®â‹®</span> Ø§Ø³Ø­Ø¨</div>
          <div class="__actions"></div>
        </div>
        <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
      `;

      // âœ… Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù…Ù‚Ø¨Ø¶ ÙÙ‚Ø·
      const grip = sec.querySelector('.grip');
      if (IS_ADMIN && grip){
        grip.setAttribute('draggable','true');
        grip.addEventListener('dragstart',(e)=>{
          e.dataTransfer.effectAllowed='move';
          e.dataTransfer.setData(MIME_COLUMN, String(index));
        });
      }

      // âœ… Ø¥ÙÙ„Ø§Øª Ø¹Ù…ÙˆØ¯ ÙÙˆÙ‚ Ø¹Ù…ÙˆØ¯ Ø¢Ø®Ø± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
      sec.addEventListener('dragover',(e)=>{
        if (e.dataTransfer.types.includes(MIME_COLUMN)){
          e.preventDefault();
          e.dataTransfer.dropEffect='move';
        }
      });

      sec.addEventListener('drop', async (e)=>{
        if (!e.dataTransfer.types.includes(MIME_COLUMN)) return;
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData(MIME_COLUMN),10);
        const to   = parseInt(sec.dataset.index,10);
        if (isNaN(from)||isNaN(to)||from===to) return;
        const newOrder = SPACE_COLUMNS.slice();
        const [moved] = newOrder.splice(from,1);
        newOrder.splice(to,0,moved);
        SPACE_COLUMNS = newOrder;
        renderBoardSkeleton(); renderTasks(); fillGroupSelect();
        await persistColumnsOrder(newOrder);
      });

      board.appendChild(sec);
      renderColumnHeaderActions(sec.querySelector('.__actions'), col);
    });

    // âœ… Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù†ÙˆØ¹ Ù…Ø³ØªÙ‚Ù„)
    board.querySelectorAll('.dropzone').forEach(zone=>{
      zone.addEventListener('dragover', e=>{
        if (e.dataTransfer.types.includes(MIME_TASK)){
          e.preventDefault();
          zone.classList.add('drag');
        }
      });
      zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
      zone.addEventListener('drop', async (e)=>{
        if (!e.dataTransfer.types.includes(MIME_TASK)) return;
        e.preventDefault(); zone.classList.remove('drag');
        const cardId = e.dataTransfer.getData(MIME_TASK);
        const newStatus = zone.dataset.zone;
        try{ await updateDoc(doc(db,'tasks', cardId), { status:newStatus }); }
        catch(err){ alert('âš ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§ÙÙŠØ©.'); }
      });
    });

    // Ø­Ø¯Ù‘Ø« Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡
    [...board.querySelectorAll('.col')].forEach((colEl,i)=> colEl.dataset.index=i);
  }

  function openDetail(task){
    OPEN_TASK=task;
    const isAssignee = task.assignee?.uid === CURRENT_USER?.uid;
    const canContribute = (IS_ADMIN || isAssignee);

    document.getElementById('dTitle').textContent=task.name||'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
    document.getElementById('dDesc').textContent=task.description||'â€”';
    document.getElementById('dAssignee').innerHTML = task.assignee
      ? `<span class="badge"><span class="dot" style="background:${task.assignee.color||'#bc8f74'}"></span>${task.assignee.name||''}</span>`
      : '<span class="muted">â€”</span>';
    document.getElementById('dDue').textContent=task.due||'â€”';
    document.getElementById('dStatus').textContent=task.status||'â€”';

    const attEl=document.getElementById('dAttachments'); attEl.innerHTML='';
    (task.attachments||[]).forEach(a=>{
      const chip=document.createElement('span'); chip.className='badge';
      chip.innerHTML=`ğŸ“ <a href="${a.url}" target="_blank" rel="noopener">${a.name}</a>`; attEl.appendChild(chip);
    });

    const linksEl=document.getElementById('dLinks'); linksEl.innerHTML='';
    (task.links||[]).forEach(l=>{
      const chip=document.createElement('span'); chip.className='badge';
      chip.innerHTML=`ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${l.title||l.url}</a>`; linksEl.appendChild(chip);
    });

    document.getElementById('dActions').style.display = canContribute ? 'block' : 'none';
    document.getElementById('btnEditTask').style.display = IS_ADMIN ? '' : 'none';
    document.getElementById('btnDeleteTask').style.display = IS_ADMIN ? '' : 'none';

    document.getElementById('detailModal').classList.add('show');
  }
  document.getElementById('btnCloseDetail').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
  document.getElementById('detailModal').addEventListener('click', (e)=>{ if(e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('show'); });

  // âœ… ÙŠÙ†Ù‚Ù„ Ø¥Ù„Ù‰ "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"
  document.getElementById('btnMarkReviewed').addEventListener('click', async ()=>{
    if(!OPEN_TASK) return;
    await ensureReviewColumn();
    try{ await updateDoc(doc(db,'tasks', OPEN_TASK.id), { status: REVIEW_COLUMN }); document.getElementById('detailModal').classList.remove('show'); }
    catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+e.message); }
  });

  document.getElementById('btnEditTask').addEventListener('click', async ()=>{
    if(!IS_ADMIN || !OPEN_TASK) return;
    const newName=prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:', OPEN_TASK.name||''); if(newName===null) return;
    const newDesc=prompt('Ø§Ù„ÙˆØµÙ:', OPEN_TASK.description||''); if(newDesc===null) return;
    const newDue =prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD):', OPEN_TASK.due||''); if(newDue===null) return;
    try{ await updateDoc(doc(db,'tasks', OPEN_TASK.id), { name:newName, description:newDesc, due:newDue }); }
    catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message); }
  });

  document.getElementById('btnDeleteTask').addEventListener('click', async ()=>{
    if(!IS_ADMIN || !OPEN_TASK) return;
    if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
    try{ await deleteDoc(doc(db,'tasks', OPEN_TASK.id)); document.getElementById('detailModal').classList.remove('show'); }
    catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message); }
  });

  function renderTasks(){
    board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

    const byStatus={}; (SPACE_COLUMNS||[]).forEach(s=> byStatus[s]=[]);
    TASKS.forEach(t=>{ (byStatus[t.status]||(byStatus[t.status]=[])).push(t); });

    (SPACE_COLUMNS||[]).forEach(status=>{
      const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
      const list = byStatus[status]||[];
      list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      list.forEach(t=>{
        const card=document.createElement('article'); card.className='card'; card.dataset.id=t.id;
        const ass=t.assignee; const attCount=(t.attachments||[]).length;
        card.innerHTML = `
          <h4>${t.name||'-'}</h4>
          <div class="row" style="margin-top:6px">
            ${ass?`<span class="badge"><span class="dot" style="background:${ass.color||'#bc8f74'}"></span>${ass.name||''}</span>`:''}
            ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
            ${attCount?`<span class="small">ğŸ“ ${attCount}</span>`:''}
          </div>`;

        // âœ… Ø³Ø­Ø¨ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù…ÙŠÙ… ØªØ§ÙŠØ¨ Ø®Ø§Øµ
        card.setAttribute('draggable','true');
        card.addEventListener('dragstart', e=>{
          e.dataTransfer.effectAllowed='move';
          e.dataTransfer.setData(MIME_TASK, t.id);
          e.dataTransfer.setData('text/plain', t.id); // ØªÙˆØ§ÙÙ‚
        });

        card.addEventListener('click', ()=>{ const fresh=TASKS.find(x=>x.id===t.id); if(fresh) openDetail(fresh); });
        zone?.appendChild(card);
      });
    });
  }

  function listenTasks(){
    if(unsubTasks){ unsubTasks(); unsubTasks=null; }
    if(!CURRENT_SPACE) return;
    const qy=query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
    unsubTasks=onSnapshot(qy,(snap)=>{
      TASKS=[]; snap.forEach(d=> TASKS.push({ id:d.id, ...(d.data()||{}) }));
      renderTasks();
    },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.'); });
  }

  /* Notifications (Ø§Ù„Ø¬Ø±Ø³) â€” (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) */
  const bellBtn=document.getElementById('btnBell');
  const bellDot=document.getElementById('bellDot');
  const bellMenu=document.getElementById('bellMenu');

  function renderNotifs(list){
    bellMenu.innerHTML=''; if(!list.length){ bellMenu.innerHTML='<div class="dd-item">Ù„Ø§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>'; return; }
    list.forEach(n=>{
      const it=document.createElement('div'); it.className='dd-item';
      const kind=n.type==='mention'?'ØªÙ… Ø°ÙƒØ±Ùƒ':'ØªÙ… ØªØ¹ÙŠÙŠÙ†Ùƒ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹';
      it.innerHTML=`<div><strong>${kind}</strong> â€” ${n.projectName||'-'}</div><div class="muted" style="font-size:12px">${n.id}</div>`;
      it.onclick=async ()=>{ try{ await updateDoc(doc(db,'notifications', n.id), { read:true }); }catch{} bellMenu.style.display='none'; };
      bellMenu.appendChild(it);
    });
  }
  onAuthStateChanged(auth,(user)=>{
    if(!user) return;
    const qn=query(collection(db,'notifications'), where('toUid','==', user.uid), where('read','==', false));
    onSnapshot(qn,(snap)=>{
      const list=[]; snap.forEach(d=> list.push({ id:d.id, ...(d.data()||{}) }));
      bellDot.style.display=list.length?'inline-block':'none'; bellDot.textContent=list.length||'0'; renderNotifs(list);
    });
  });
  bellBtn?.addEventListener('click', ()=> bellMenu.style.display = (bellMenu.style.display==='block'?'none':'block'));
  document.addEventListener('click', (e)=>{ if(!bellMenu.contains(e.target) && e.target!==bellBtn && !bellBtn.contains(e.target)) bellMenu.style.display='none'; });

  /* Boot */
  (async ()=>{
    if(!CURRENT_SPACE){
      CURRENT_SPACE = await ensureDefaultSpace();
      const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
      SPACE_COLUMNS = d.exists()? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS) : DEFAULT_COLUMNS;
      renderBoardSkeleton(); listenTasks(); fillGroupSelect(); ensureReviewColumn();
    }
  })();
</script>
