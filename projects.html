<!-- Firebase Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
    authDomain: "mzj-workspace.firebaseapp.com",
    projectId: "mzj-workspace"
  });
  const db = getFirestore(app);

  // ğŸ—‚ï¸ Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ù…Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ù€Kanban
  const renderTicket = (t) => {
    const el = document.createElement('article');
    el.className = 'ticket';
    el.innerHTML = `<strong>${t.title}</strong>
                    <small>${t.member||'ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†'} â€” Ù…ÙˆØ¹Ø¯: ${t.due||'-'}</small>
                    <span class="badge">${t.projectName||'Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹'}</span>`;
    el.onclick = async () => {
      const next = t.status==='todo'?'inprogress':(t.status==='inprogress'?'done':'todo');
      await updateDoc(doc(db,'tasks',t.id), { status: next });
      loadKanban();
    };
    return el;
  };

  async function loadKanban(){
    ['col-todo','col-inprogress','col-done'].forEach(id=>{
      const col=document.getElementById(id);
      col.querySelectorAll('.ticket').forEach(n=>n.remove());
    });
    const snap=await getDocs(collection(db,'tasks'));
    snap.forEach(d=>{
      const t={ id:d.id, ...d.data() };
      const target=t.status==='inprogress'?'col-inprogress':(t.status==='done'?'col-done':'col-todo');
      document.getElementById(target).appendChild(renderTicket(t));
    });
  }

  document.getElementById('btnNewProject').addEventListener('click', async ()=>{
    const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ');
    if(!name) return;
    await addDoc(collection(db,'projects'), { name, createdAt: serverTimestamp(), active:true });
    alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
  });

  document.getElementById('btnNewTask').addEventListener('click', async ()=>{
    const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ');
    if(!title) return;
    const projectName = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)');
    const member = prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)');
    const due = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD)');
    await addDoc(collection(db,'tasks'), {
      title, status:'todo', projectName:projectName||null, member:member||null, due:due||null, createdAt: serverTimestamp()
    });
    loadKanban();
  });

  document.getElementById('btnRefresh').addEventListener('click', loadKanban);
  loadKanban();
</script>

<!-- ğŸ”’ ÙƒÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…ÙÙ† / Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const auth = getAuth();
  const db2   = getFirestore();

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const u = await getDoc(doc(db2, "users", user.uid));
    const role = u.exists() ? u.data().role : "member";

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…ÙÙ†
    ["btnNewProject", "btnNewTask"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.style.display = role === "admin" ? "inline-flex" : "none";
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    const name = u.exists() ? u.data().name : "Ø¹Ø¶Ùˆ";
    const topbar = document.querySelector(".brand strong");
    if (topbar) topbar.textContent = `${name} (${role === "admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ"})`;
  });
</script>
