<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial;line-height:1.75}
    a{color:inherit;text-decoration:none}
    .layout{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--brown);color:#fff;box-shadow:0 4px 16px rgba(62,36,32,.18)}
    .brand{display:flex;align-items:center;gap:10px;color:#fff}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}
    .page{padding:20px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
    .kanban{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:900px){.kanban{grid-template-columns:1fr}}
    .col{background:#fff;border-radius:var(--radius);padding:12px;box-shadow:0 6px 22px rgba(62,36,32,.10);display:flex;flex-direction:column;gap:10px}
    .col h3{margin:0;color:var(--brown)}
    .ticket{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px 12px;display:grid;gap:6px;cursor:pointer}
    .ticket small{color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);justify-self:start}
    .foot{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19)}
  </style>
</head>
<body>
  <div class="layout">
    <header class="topbar">
      <a class="brand" href="#" id="brandLink">
        <span class="brand-badge"></span><strong>MZJ Workspace</strong>
      </a>
      <nav class="nav">
        <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="projects.html">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
        <a href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
        <a href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </nav>
    </header>

    <main class="page">
      <div class="toolbar">
        <button class="btn btn-primary" id="btnNewProject">+ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn" id="btnNewTask">+ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button class="btn" id="btnRefresh">ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <section class="kanban">
        <div class="col" id="col-todo"><h3>To Do â€” Ù„Ù„Ø¨Ø¯Ø¡</h3></div>
        <div class="col" id="col-inprogress"><h3>In Progress â€” Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3></div>
        <div class="col" id="col-done"><h3>Done â€” Ù…Ù†Ø¬Ø²</h3></div>
      </section>
    </main>

    <footer class="foot"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></footer>
  </div>

  <!-- Firebase + Firestore (Ø§Ù„Ø£Ø³Ø§Ø³) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    // ğŸ”— Ø³ÙˆÙŠØªØ´Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Vercel / CodePen)
    const CODEPEN = {
      login:     "https://codepen.io/evakkzkq-the-lessful/full/raxqmXB",
      register:  "https://codepen.io/evakkzkq-the-lessful/full/raxqZod",
      dashboard: "https://codepen.io/evakkzkq-the-lessful/full/ogbaPOO",
      projects:  "https://codepen.io/evakkzkq-the-lessful/full/PwZydvZ",
      members:   "https://codepen.io/evakkzkq-the-lessful/full/GgoYXaJ",
      admin:     "https://codepen.io/evakkzkq-the-lessful/full/EaPdeMp"
    };
    const LOCAL = {
      login:"login.html", register:"register.html", dashboard:"dashboard.html",
      projects:"projects.html", members:"members.html", admin:"admin.html"
    };
    const ON_VERCEL = /vercel\.app$/i.test(location.host) || (!/codepen\.io|cdpn\.io/i.test(location.host) && location.host !== '');
    const L = ON_VERCEL ? LOCAL : CODEPEN;
    document.getElementById('brandLink').href = L.dashboard;
    document.querySelectorAll('.nav a').forEach(a=>{
      const t=a.textContent||'';
      if(t.includes('Ù„ÙˆØ­Ø©')) a.href=L.dashboard;
      if(t.includes('Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹')) a.href=L.projects;
      if(t.includes('Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡')) a.href=L.members;
      if(t.includes('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')) a.href=L.admin;
    });

    // âš™ï¸ Firebase init (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);

    const db   = getFirestore();
    const auth = getAuth();

    // ğŸ”’ Ø­Ø§Ø±Ø³ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    window.mzjLogout = async () => { await signOut(auth); location.href = L.login; };
    onAuthStateChanged(auth, (user) => { if (!user) location.href = L.login; });

    // ğŸ—‚ï¸ ØªØ°ÙƒØ±Ø© ÙƒØ§Ù†Ø¨Ø§Ù†
    const renderTicket = (t) => {
      const el = document.createElement('article');
      el.className = 'ticket';
      el.innerHTML = `
        <strong>${t.title}</strong>
        <small>${t.assigneeUid ? ('Ø§Ù„Ù…ÙƒÙ„Ù: ' + t.assigneeUid) : 'ØºÙŠØ± Ù…Ø¹ÙŠÙ‘Ù†'} â€” Ù…ÙˆØ¹Ø¯: ${t.due||'-'}</small>
        <span class="badge">${t.projectId||t.projectName||'Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹'}</span>`;
      el.onclick = async () => {
        // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù‚Ø¯ ØªÙØ´Ù„ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø§Ù„Ù…ÙƒÙ„Ù‘Ù Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)
        const next = t.status==='todo'?'inprogress':(t.status==='inprogress'?'done':'todo');
        try {
          await updateDoc(doc(db,'tasks',t.id), { status: next });
          loadKanban();
        } catch(e){
          alert('âš ï¸ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© (Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ù…ÙƒÙ„Ù‘Ù Ø£Ùˆ Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·).');
          console.error(e);
        }
      };
      return el;
    };

    // ğŸ” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    async function loadKanban(){
      ['col-todo','col-inprogress','col-done'].forEach(id=>{
        const col=document.getElementById(id);
        col.querySelectorAll('.ticket').forEach(n=>n.remove());
      });
      const snap=await getDocs(collection(db,'tasks'));
      snap.forEach(d=>{
        const t={ id:d.id, ...d.data() };
        const target=t.status==='inprogress'?'col-inprogress':(t.status==='done'?'col-done':'col-todo');
        document.getElementById(target).appendChild(renderTicket(t));
      });
    }

    // â• Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ (Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø· Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)
    document.getElementById('btnNewProject').addEventListener('click', async ()=>{
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ'); if(!name) return;
      try{
        await addDoc(collection(db,'projects'), { name, active:true, createdAt: serverTimestamp(), createdBy: auth.currentUser?.uid||null });
        alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'); 
      }catch(e){
        if (e?.code==='permission-denied') alert('âš ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
        else alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
      }
    });

    // â• Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© (ØªØ®Ø²ÙŠÙ† createdBy + assigneeUid)
    document.getElementById('btnNewTask').addEventListener('click', async ()=>{
      const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ'); if(!title) return;
      const projectId = prompt('ID/Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)') || null;
      const assigneeUid = prompt('UID Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…ÙƒÙ„Ù‘Ù (Ù…Ø·Ù„ÙˆØ¨ Ù„ØªÙƒÙ„ÙŠÙÙ‡)') || null;
      const due = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD)') || null;
      try{
        await addDoc(collection(db,'tasks'), {
          title, status:'todo', projectId, assigneeUid, due,
          createdBy: auth.currentUser?.uid || null,
          createdAt: serverTimestamp()
        });
        loadKanban();
      }catch(e){
        if (e?.code==='permission-denied') alert('âš ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
        else alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
      }
    });

    document.getElementById('btnRefresh').addEventListener('click', loadKanban);

    // ğŸš€ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    loadKanban();
  </script>

  <!-- ğŸ‘¥ Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…ÙÙ† + Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ± -->
  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const auth = getAuth();
    const db   = getFirestore();

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      const u = await getDoc(doc(db, "users", user.uid));
      const role = u.exists() ? u.data().role : "member";

      ["btnNewProject", "btnNewTask"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.style.display = role === "admin" ? "inline-flex" : "none";
      });

      const name = u.exists() ? u.data().name : "Ø¹Ø¶Ùˆ";
      const topbar = document.querySelector(".brand strong");
      if (topbar) topbar.textContent = `${name} (${role === "admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ"})`;
    });
  </script>
</body>
</html>
