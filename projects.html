





<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--brown);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 20px rgba(62,36,32,.2)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}

    /* Notifications */
    .notif-wrapper{position:relative;margin-inline-start:4px}
    .notif-bell{
      background:none;border:none;cursor:pointer;
      position:relative;padding:6px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      transition:background .15s;
    }
    .notif-bell:hover{background:rgba(255,255,255,.18)}
    .notif-badge{
      position:absolute;top:-2px;left:-2px;
      min-width:16px;height:16px;border-radius:999px;
      background:#ef4444;color:#fff;font-size:10px;
      display:none;align-items:center;justify-content:center;
      padding:0 4px;
    }
    .notif-dropdown{
      position:absolute;top:130%;inset-inline-end:0;
      width:320px;max-height:360px;overflow-y:auto;
      background:#fff;border-radius:12px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      padding:8px 0;z-index:40;display:none;
    }
    .notif-dropdown-header{
      padding:8px 14px;border-bottom:1px solid #e5e7eb;
      display:flex;align-items:center;justify-content:space-between;
      font-size:13px;color:var(--brown);font-weight:700;
    }
    .notif-dropdown-header button{
      background:none;border:none;color:var(--muted);
      font-size:11px;cursor:pointer;
    }
    .notif-list{max-height:300px;overflow-y:auto}
    .notif-item{
      width:100%;text-align:right;background:none;border:0;
      padding:8px 14px;cursor:pointer;
      display:flex;flex-direction:column;gap:4px;
      border-bottom:1px solid #f3f4f6;
    }
    .notif-item.unread{background:#fff8ef}
    .notif-item-message{font-size:13px;color:var(--text)}
    .notif-item-meta{font-size:11px;color:var(--muted)}

    .page{padding:18px;display:grid;gap:16px}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:800;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .hidden{display:none !important}

    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 12px 30px rgba(62,36,32,.12)}
    .panel .head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .panel .body{padding:12px 14px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select,.input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}
    .btn.danger{background:#b91c1c;color:#fff}
    .btn.xs{padding:4px 8px;font-size:11px;border-radius:999px}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}

    /* Board Ø¹Ø§Ù… */
    .board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}
    .col{background:#fff;border-radius:14px;display:flex;flex-direction:column;min-height:240px;position:relative}
    .col-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #f2e7df;background:#fff8ef;border-top-left-radius:14px;border-top-right-radius:14px;cursor:grab}
    .col-title{color:var(--brown);font-weight:800}
    .col-actions{display:none;gap:6px}
    .col-actions .icon{cursor:pointer;font-size:13px;padding:6px 8px;border:1px solid #e9d8cc;border-radius:10px;background:#fff}
    .col-body{padding:10px;display:grid;gap:10px}
    .dropzone{min-height:120px;border:2px dashed transparent;border-radius:12px;transition:.15s}
    .dropzone.drag{border-color:#e5d2c6;background:#fffaf5}

    .grip{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#6b7280;user-select:none}
    .grip .dots{letter-spacing:2px;font-weight:700}

    /* Cards */
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px;box-shadow:0 8px 20px rgba(62,36,32,.06);cursor:grab}
    .card h4{margin:0;color:var(--brown);font-size:15px;line-height:1.4}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row.between{justify-content:space-between;align-items:flex-start}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .badge .dot{inline-size:8px;block-size:8px;border-radius:999px;background:#bc8f74}
    .small{font-size:12px;color:var(--muted)}
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØ§Ø±Øª Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙÙˆÙ‚Ù‡ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ */
    .card.drag-over{
      outline:2px dashed #e5d2c6;
      outline-offset:2px;
    }

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:16px;z-index:99}
    .modal.show{display:grid}
    .sheet{background:#fff;border-radius:16px;max-width:760px;width:100%;box-shadow:0 30px 80px rgba(62,36,32,.25);display:flex;flex-direction:column;max-height:90vh}
    .sheet .head{padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .sheet .body{padding:12px 12px;display:grid;gap:8px;flex:1;overflow:auto}
    .sheet .footer{padding:10px 12px;border-top:1px solid #eee;background:#fff8ef;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;position:sticky;bottom:0}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:800px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 4px;font-weight:700;color:var(--brown);font-size:13px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-family:inherit;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fff;font-size:12px}
    .chip .chip-actions{display:inline-flex;gap:6px}
    .chip button{border:0;background:#fff;padding:4px 6px;border-radius:8px;cursor:pointer;font-size:11px}
    .chip button:hover{background:#fff8ef}

    /* Ù…Ø±Ø¨Ø¹ ÙˆØµÙ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© (detail) */
    .desc-box{
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      min-height:220px;
      max-height:420px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.6;
      font-size:14px;
      font-family:inherit;
    }

    /* Ù…Ø±Ø¨Ø¹ ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Campaign Task) */
    .campaign-full-desc{
      width: 100%;
      min-height: 520px;
      height: auto;
      max-height: none;
      resize: vertical;
      padding: 14px;
      font-size: 15px;
      line-height: 1.8;
      border: 1px solid #d8b9a4;
      border-radius: 14px;
      background: #fffdfa;
      box-shadow: 0 4px 14px rgba(188,143,116,.25);
      overflow-y: visible;
      white-space: pre-wrap;
    }

    .campaign-desc-wrapper{
      flex:1;
      min-width:260px;
      max-width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .campaign-desc{
      background:#fffdfa;
      border:1px solid #f2e7df;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      line-height:1.8;
      max-height:130px;
      overflow:hidden;
      position:relative;
      color:var(--text);
    }
    .campaign-desc::after{
      content:"";
      position:absolute;
      left:0;right:0;bottom:0;
      height:40px;
      background:linear-gradient(to top,#fffdfa,rgba(255,253,250,0));
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .campaign-desc.expanded{
      max-height:none;
    }
    .campaign-desc.expanded::after{
      opacity:0;
    }
    .btn-see-more{
      align-self:flex-end;
      font-size:12px;
      padding:4px 10px;
    }

    .dropdown-menu{position:absolute;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(62,36,32,.12);display:none;min-width:280px;max-height:260px;overflow:auto;z-index:100}

    @media (max-width: 600px){
      .sheet{max-height:92vh}
      .sheet .footer{position:sticky;bottom:0}
    }

    /* === Daily Task board === */
    .daily-board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.daily-board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:1024px){.daily-board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.daily-board{grid-template-columns:1fr}}

    .daily-week-body{display:grid;gap:10px}
    .daily-day{background:#fdf7f2;border:1px dashed #ecd8c8;border-radius:12px;padding:6px}
    .daily-day-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .daily-day-name{font-size:13px;font-weight:700;color:var(--brown)}
    .day-add{border:0;border-radius:999px;padding:2px 8px;font-size:11px;background:#fff;color:var(--brown);border:1px solid #e5d2c6;cursor:pointer}
    .day-add:hover{background:#fff8ef}
    .daily-drop{min-height:60px;border:2px dashed transparent;border-radius:10px;padding:4px;transition:.15s}
    .daily-drop.drag{border-color:#e5d2c6;background:#fffaf5}

    .daily-card{cursor:grab}
    .daily-card-title{font-size:14px;font-weight:700;color:var(--brown);margin:0 0 2px}
    .daily-card-desc{font-size:12px;color:var(--muted);margin:0;margin-top:2px}

    .daily-done-col .col-head{background:#e1f7ea;border-bottom-color:#bbdec6}
    .daily-done-col .col-title{color:#166534}

    /* Campaign done column */
    .campaign-done-col .col-head{background:#e1f7ea;border-bottom-color:#bbdec6}
    .campaign-done-col .col-title{color:#166534}
  </style>

  <!-- SheetJS (Ù„Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-badge"></span>
      <strong>MZJ Workspace â€” Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</strong>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <!-- Notifications Bell -->
      <div class="notif-wrapper">
        <button id="notifBell" class="notif-bell" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
          <span style="font-size:18px">ğŸ””</span>
          <span id="notifBadge" class="notif-badge">0</span>
        </button>
        <div id="notifDropdown" class="notif-dropdown">
          <div class="notif-dropdown-header">
            <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
            <div>
              <button id="markAllReadBtn" type="button">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>
              <button id="clearAllNotifBtn" type="button">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
          </div>
          <div id="notifList" class="notif-list"></div>
        </div>
      </div>

      <nav class="nav">
        <a id="navDashboard" href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a id="navProjects"  href="projects.html" style="background:rgba(255,255,255,.18)">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
        <a id="navMembers"   href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
        <a id="navAdmin"     href="admin.html">Ø§Ù„Ø­Ù…Ù„Ø§Øª</a>
        <a href="cars.html">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
        <a href="Whiteboard.html">ÙˆØ§ÙŠØª Ø¨ÙˆØ±Ø¯</a>
        <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </nav>
    </div>
  </header>

  <!-- ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¶Ø¹ Ù…Ù„Ù notify.mp3 ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø±) -->
  <audio id="notifSound" src="notify.mp3" preload="auto"></audio>

  <main class="page">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="tabSpaces">Spaces</button>
      <button class="tab" id="tabCampaigns">Campaign</button>
      <button class="tab" id="tabDaily">ğŸ—“ Daily Task â€” Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
    </div>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ Spaces ===== -->
    <section class="panel" id="panelSpaces">
      <div class="head">
        <div class="controls">
          <select id="spaceSelect" class="select"></select>
          <input id="newGroupName" class="input" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ â€” Ù…Ø«Ø§Ù„: ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§" style="min-width:220px;display:none">
          <button class="btn secondary" id="btnAddGroup" style="display:none">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
          <button class="btn secondary" id="btnNewSpace" style="display:none">Space Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn" id="btnNewTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn secondary" id="btnSpaceManage" style="display:none">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€Space</button>
          <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
          <button class="btn secondary" id="btnExportSpace">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <div class="muted" id="who"></div>
      </div>
      <div class="body">
        <div class="board" id="boardSpaces"></div>
      </div>
    </section>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ù…Ù„Ø§Øª ===== -->
    <section class="panel hidden" id="panelCampaigns">
      <div class="head">
        <div class="controls">
          <select id="campaignSelect" class="select"></select>
          <button class="btn" id="btnNewCampaignTask" style="display:none">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯ (Ø­Ù…Ù„Ø©)</button>
          <button class="btn secondary" id="btnNewCampaign" style="display:none">Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        <!-- ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ (Ù…Ø¹ Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯) -->
        <div class="campaign-desc-wrapper">
          <div id="campaignDates" class="campaign-desc">Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>
          <button id="campaignToggle" class="btn secondary btn-see-more" style="display:none">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
        </div>
      </div>
      <div class="body">
        <div class="board" id="boardCampaigns"></div>
      </div>
    </section>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ Daily Task ===== -->
    <section class="panel hidden" id="panelDaily">
      <div class="head">
        <div class="controls">
          <select id="dailyMonthSelect" class="select"></select>
          <span class="muted">Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© â€” Ù…Ù‚Ø³Ù‘Ù… Ø¥Ù„Ù‰ Ù¤ Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø§Ù„Ø³Ø¨Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ù…ÙŠØ³)</span>
        </div>
        <div class="muted" id="dailyMeta"></div>
      </div>
      <div class="body">
        <div class="daily-board" id="dailyBoard"></div>
      </div>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (Spaces / Campaign) -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="head"><strong id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong></div>
      <div class="body">

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</label>
            <select id="carBrand"></select>
          </div>
          <div>
            <label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
            <select id="carModel"></select>
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Ø§Ù„ÙØ¦Ø© (Ø§Ù„ØªØ±Ù…)</label>
            <input id="carTrim" placeholder="Ù…Ø«Ø§Ù„: Ø³Ù…Ø§Ø±Øª / ÙÙ„ ÙƒØ§Ù…Ù„">
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø­Ø±Ùƒ</label>
            <input id="carEngine" placeholder="Ù…Ø«Ø§Ù„: 2000 Ø³ÙŠ Ø³ÙŠ / 1.5 ØªØ±Ø¨Ùˆ">
          </div>
        </div>

        <div class="grid2" style="margin-top:4px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ù„Ù†ØªØ±Ø§ 30 Ø«Ø§Ù†ÙŠØ©">
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="tDue" type="date" placeholder="dd-mm-yyyy">
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="tDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©â€¦ Ù…Ø«Ø§Ù„: Ù…Ù†Ø´Ù† Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ @ahmed @karim"></textarea>

        <div class="grid2">
          <div style="position:relative">
            <label>Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ø¶Ùˆ)</label>
            <input id="tAssigneeSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø«Ù… Ø§Ø®ØªØ±Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡">
            <div id="assigneeMenu" class="dropdown-menu" style="right:0;top:76px;"></div>
            <div id="assigneeChip" class="chips"></div>
          </div>
          <div>
            <label>Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¶Ùˆ / Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <div class="row">
              <input id="tColor" type="color" value="#bc8f74" style="width:70px;height:44px;padding:4px">
              <span class="muted">ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆÙŠØ­ÙØ¸ Ù„Ù„Ø¹Ø¶Ùˆ/Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯ / Ø§Ù„Ø¬Ø±ÙˆØ¨</label>
            <select id="tGroup"></select>
          </div>
          <div></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn secondary" id="btnCancelTask">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="btnSaveTask">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ</button>
        <button class="btn secondary" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„ ØªØ§Ø³Ùƒ -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="head"><strong id="dTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</strong></div>
      <div class="body">
        <label class="small muted" style="margin-top:2px">Ø§Ù„ÙˆØµÙ</label>
        <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙˆØµÙ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ù€ Ctrl+A -->
        <textarea id="dDesc" class="desc-box" readonly></textarea>

        <div class="info" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div><div class="small muted">Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</div><div id="dAssignee"></div></div>
          <div><div class="small muted">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div id="dDue"></div></div>
          <div><div class="small muted">Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ø¹Ù…ÙˆØ¯</div><div id="dStatus"></div></div>
        </div>

        <hr/>

        <div>
          <div class="small muted">Ø±ÙˆØ§Ø¨Ø·</div>
          <div id="dLinks" class="chips"></div>
        </div>

        <div id="dActions" style="margin-top:10px;display:block">
          <div>
            <label>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø±Ø§Ø¨Ø·</label>
            <input id="dLinkTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ">
            <input id="dLinkUrl" class="input" placeholder="https://â€¦">
            <button class="btn secondary" id="btnAddLink" style="margin-top:8px">Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          </div>
          <p class="hint">* Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: Ø§Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©.</p>
        </div>
      </div>
      <div class="footer">
        <button class="btn secondary" id="btnMarkReviewed">âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
        <span style="flex:1"></span>
        <button class="btn" id="btnEditTask" style="display:none">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" id="btnDeleteTask" style="display:none">Ø­Ø°Ù</button>
        <button class="btn secondary" id="btnCloseDetail">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø§Ø­ØªØ±Ø§ÙÙŠ) -->
  <div class="modal" id="dailyModal">
    <div class="sheet">
      <div class="head">
        <strong id="dailyModalTitle">ØªØ§Ø³Ùƒ ÙŠÙˆÙ…ÙŠ</strong>
      </div>
      <div class="body">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="dailyTitle" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø­ØªÙˆÙ‰ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø§Ù…Ø©">
        <label>Ø§Ù„ÙˆØµÙ / Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
        <textarea id="dailyDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ù…Ø®ØªØµØ±Ø© Ù„Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©â€¦"></textarea>
        <p class="hint">* Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª.</p>
      </div>
      <div class="footer">
        <button class="btn secondary" id="btnDailyCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn danger" id="btnDailyDelete" style="display:none">Ø­Ø°Ù</button>
        <button class="btn" id="btnDailySave">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <footer class="footer" style="padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19);">
    <small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small>
  </footer>

  <!-- Firebase & App -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp, arrayUnion, Timestamp, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth(); const db = getFirestore();

    /* Tabs */
    const tabSpaces    = document.getElementById('tabSpaces');
    const tabCampaigns = document.getElementById('tabCampaigns');
    const tabDaily     = document.getElementById('tabDaily');

    const panelSpaces    = document.getElementById('panelSpaces');
    const panelCampaigns = document.getElementById('panelCampaigns');
    const panelDaily     = document.getElementById('panelDaily');

    function switchTab(which){
      const tabs   = { spaces:tabSpaces, campaigns:tabCampaigns, daily:tabDaily };
      const panels = { spaces:panelSpaces, campaigns:panelCampaigns, daily:panelDaily };

      Object.keys(tabs).forEach(k=>{
        if(tabs[k]) tabs[k].classList.toggle('active', k===which);
      });
      Object.keys(panels).forEach(k=>{
        if(panels[k]) panels[k].classList.toggle('hidden', k!==which);
      });
    }
    tabSpaces.onclick    = ()=> switchTab('spaces');
    tabCampaigns.onclick = ()=> switchTab('campaigns');
    tabDaily.onclick     = ()=> switchTab('daily');

    /* Auth / Roles */
    let CURRENT_USER=null, CURRENT_ROLE='member', IS_ADMIN=false;
    let CURRENT_USER_NAME='';
    window.mzjLogout = async ()=>{ await signOut(auth); location.href="login.html"; };

    /* ===== Notifications helpers ===== */
    function initNotifications(currentUser){
      const bell       = document.getElementById('notifBell');
      const dropdown   = document.getElementById('notifDropdown');
      const list       = document.getElementById('notifList');
      const badge      = document.getElementById('notifBadge');
      const markAllBtn = document.getElementById('markAllReadBtn');
      const clearBtn   = document.getElementById('clearAllNotifBtn');
      const soundEl    = document.getElementById('notifSound');

      if(!bell || !dropdown || !list || !badge) return;

      let lastDocs = [];

      bell.addEventListener('click',(e)=>{
        e.stopPropagation();
        const open = dropdown.style.display === 'block';
        dropdown.style.display = open ? 'none' : 'block';
      });

      document.addEventListener('click',(e)=>{
        if(!dropdown.contains(e.target) && e.target!==bell && !bell.contains(e.target)){
          dropdown.style.display='none';
        }
      });

      const notifCol = collection(db,'notifications');
      const qy = query(
        notifCol,
        where('recipientUid','==', currentUser.uid),
        limit(40)
      );

      onSnapshot(qy,(snapshot)=>{
        lastDocs = snapshot.docs;
        list.innerHTML='';
        let unreadCount=0;

        snapshot.docChanges().forEach(change=>{
          const data = change.doc.data()||{};
          if(change.type==='added' && data.read === false && soundEl){
            soundEl.play().catch(()=>{});
          }
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø­ÙŠØ« Ø§Ù„Ø£Ø­Ø¯Ø« ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
        const docsSorted = snapshot.docs.slice().sort((a,b)=>{
          const ad = a.data()?.createdAt;
          const bd = b.data()?.createdAt;
          const at = (ad && ad.toDate) ? ad.toDate().getTime() : 0;
          const bt = (bd && bd.toDate) ? bd.toDate().getTime() : 0;
          return bt - at;
        });

        docsSorted.forEach(docSnap=>{
          const data = docSnap.data()||{};
          const id   = docSnap.id;
          const isUnread = data.read === false;
          if(isUnread) unreadCount++;

          const btn = document.createElement('button');
          btn.type='button';
          btn.className='notif-item'+(isUnread?' unread':'');

          const from = data.senderName || 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹';
          let timeStr='';
          try{
            if(data.createdAt && data.createdAt.toDate){
              const d = data.createdAt.toDate();
              timeStr = d.toLocaleString('ar-SA',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
            }
          }catch{}

          btn.innerHTML = `
            <span class="notif-item-message">${data.message||''}</span>
            <span class="notif-item-meta">${from}${timeStr ? ' â€¢ '+timeStr : ''}</span>
          `;

          btn.addEventListener('click', async ()=>{
            if(isUnread){
              try{ await updateDoc(doc(db,'notifications', id), { read:true }); }catch{}
            }

            // ÙØªØ­ Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
            const taskId = data.taskId;
            if(taskId){
              let opened = false;
              try{
                if(Array.isArray(TASKS_SPACES)){
                  const task = TASKS_SPACES.find(t=> t.id === taskId);
                  if(task){
                    openDetail(task);
                    opened = true;
                  }
                }
              }catch(e){
                console.error('openDetail from cache error', e);
              }

              if(!opened){
                try{
                  const snapTask = await getDoc(doc(db,'tasks', taskId));
                  if(snapTask.exists()){
                    const tdata = snapTask.data()||{};
                    const taskObj = {
                      id: taskId,
                      name: tdata.name||'ØªØ§Ø³Ùƒ',
                      description: tdata.description||'',
                      due: tdata.due||'',
                      status: tdata.status||'',
                      car: tdata.car||null,
                      assignees: tdata.assignees||[],
                      links: tdata.links||[]
                    };
                    openDetail(taskObj);
                    opened = true;
                  }
                }catch(e){
                  console.error('load task by notif error', e);
                }
              }

              if(opened && dropdown){
                dropdown.style.display='none';
              }
            }
          });

          list.appendChild(btn);
        });

        if(unreadCount>0){
          badge.style.display='flex';
          badge.textContent = unreadCount>99?'99+':String(unreadCount);
        }else{
          badge.style.display='none';
        }
      },(err)=>{
        console.error('notifications error', err);
      });

      if(markAllBtn){
        markAllBtn.addEventListener('click', async ()=>{
          const promises=[];
          lastDocs.forEach(d=>{
            const data = d.data()||{};
            if(data.read === false){
              promises.push(updateDoc(doc(db,'notifications', d.id), { read:true }));
            }
          });
          if(promises.length){
            try{ await Promise.all(promises); }catch(e){ console.error(e); }
          }
        });
      }

      if(clearBtn){
        clearBtn.addEventListener('click', async ()=>{
          if(!lastDocs.length) return;
          const promises = [];
          lastDocs.forEach(d=>{
            promises.push(deleteDoc(doc(db,'notifications', d.id)));
          });
          if(promises.length){
            try{ await Promise.all(promises); }catch(e){ console.error(e); }
          }
        });
      }
    }

    /* Common helpers */
    const MIME_TASK   = "application/x-mzj-task";
    const MIME_COLUMN = "application/x-mzj-column";
    const MIME_DAILY  = "application/x-mzj-daily";

    let USERS=[];
    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS=[];
      snap.forEach(d=>{
        const u=d.data()||{};
        const tag = (u.tag || u.username || (u.name ? u.name.split(' ')[0] : d.id.slice(0,6))).toLowerCase();
        USERS.push({
          uid: d.id,
          name: u.name||d.id.slice(0,6),
          role: u.role||'member',
          color: u.color||'#bc8f74',
          email: u.email || u.mail || null,
          tag
        });
      });
    }

    function taskMembersArray(task){
      if(Array.isArray(task.assignees) && task.assignees.length) return task.assignees;
      if(task.assignee) return [task.assignee];
      return [];
    }

    function canManageLinks(task){
      if(IS_ADMIN) return true;
      const members = taskMembersArray(task);
      const myUid = CURRENT_USER?.uid || '';
      return members.some(m=>m.uid === myUid);
    }

    function isCurrentUserTaskMember(task){
      const members = taskMembersArray(task);
      const myUid   = CURRENT_USER?.uid || '';
      return members.some(m => (m.uid === myUid));
    }

    function canUserMarkCampaignDone(task){
      if(IS_ADMIN) return true;
      return isCurrentUserTaskMember(task);
    }


    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ù† Ø§Ù„Ù†Øµ @tag
    function extractMentions(text){
      if(!text) return [];
      const regex = /@([\u0600-\u06FF\w_.-]+)/g;
      const tags = [];
      let m;
      while((m = regex.exec(text)) !== null){
        tags.push(m[1]);
      }
      return [...new Set(tags)];
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ù† Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙØ¹Ù„ÙŠÙŠÙ† Ù…Ù† USERS
    function resolveMentionRecipients(tags){
      const unique = [...new Set((tags||[]).map(t=>t.toLowerCase()))];
      const recipients=[];
      unique.forEach(tag=>{
        const found = USERS.find(u=>{
          const tagField  = (u.tag||'').toLowerCase();
          const nameFirst = (u.name||'').split(' ')[0].toLowerCase();
          const emailUser = (u.email||'').split('@')[0].toLowerCase();
          return tagField===tag || nameFirst===tag || emailUser===tag;
        });
        if(found && !recipients.find(r=>r.uid===found.uid)){
          recipients.push(found);
        }
      });
      return recipients;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù†
    async function createMentionNotifications({taskId, taskName, taskDescription, spaceId, status, assignees}){
      const text = `${taskName||''}\n${taskDescription||''}`;
      const tags = extractMentions(text);
      let recipients = [];

      // 1) Ù„Ùˆ ÙÙŠ Ù…Ù†Ø´Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… @ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„ÙˆØµÙ
      if(tags.length){
        recipients = resolveMentionRecipients(tags).filter(u=> u.uid !== (CURRENT_USER?.uid||''));
      }else if(Array.isArray(assignees) && assignees.length){
        // 2) Ù„Ùˆ Ù…Ø§ÙÙŠØ´ @ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙƒÙ…Ø³ØªÙ„Ù…ÙŠÙ†
        recipients = assignees
          .map(a=> USERS.find(u=> u.uid === (a.uid || a.id || a)))
          .filter(u=> u && u.uid !== (CURRENT_USER?.uid||''));
      }

      if(!recipients.length) return;

      const notifCol = collection(db,'notifications');
      const senderName = CURRENT_USER_NAME || CURRENT_USER?.email || 'Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚';

      const promises = recipients.map(u=>{
        const msg = `ØªÙ… Ù…Ù†Ø´Ù† ${u.tag||u.name} ÙÙŠ ØªØ§Ø³Ùƒ: ${taskName||'-'}`;
        return addDoc(notifCol,{
          recipientUid: u.uid,
          recipientName: u.name,
          senderUid: CURRENT_USER?.uid || null,
          senderName,
          spaceId: spaceId || null,
          taskId,
          status: status || null,
          message: msg,
          type: 'mention',
          createdAt: serverTimestamp(),
          read: false
        });
      });

      try{ await Promise.all(promises); }catch(e){ console.error('mention notifications error', e); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER = user;
      const u = await getDoc(doc(db,"users", user.uid));
      const name = u.exists()? (u.data().name||user.email) : (user.email||'Ù…Ø³ØªØ®Ø¯Ù…');
      CURRENT_ROLE = u.exists()? (u.data().role||'member') : 'member';
      IS_ADMIN = CURRENT_ROLE==='admin';
      CURRENT_USER_NAME = name;

      document.getElementById('who').textContent  = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;
      document.getElementById('who2') && (document.getElementById('who2').textContent = `${name} â€” ${IS_ADMIN?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`);

      ['btnNewSpace','btnAddGroup','newGroupName','btnNewTask','btnSpaceManage','btnNewCampaignTask','btnNewCampaign'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display = IS_ADMIN? '' : 'none';
      });
      document.querySelectorAll('.col-actions').forEach(el=> el.style.display = IS_ADMIN? 'flex' : 'none');

      if(!IS_ADMIN){
        document.getElementById('navDashboard').style.display='none';
        document.getElementById('navMembers').style.display='none';
        document.getElementById('navAdmin').style.display='none';
        if(tabDaily) tabDaily.style.display='none'; // Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¹Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
      }else{
        if(tabDaily) tabDaily.style.display='inline-flex';
      }

      await loadUsers();
      initNotifications(user);
      bootSpaces();
      bootCampaigns();
      if(IS_ADMIN) bootDailyTasks(); // Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·
    });

    /* ===== Spaces logic ===== */
    const DEFAULT_COLUMNS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
    const REVIEW_COLUMN   = "ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    const DONE_STATUS_SPACES = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";

    const spaceSelect     = document.getElementById('spaceSelect');
    const newGroupNameEl  = document.getElementById('newGroupName');
    const btnAddGroup     = document.getElementById('btnAddGroup');
    const btnSpaceManage  = document.getElementById('btnSpaceManage');
    const boardSpaces     = document.getElementById('boardSpaces');
    const btnExportSpace  = document.getElementById('btnExportSpace');

    let CURRENT_SPACE=null; let SPACE_COLUMNS=DEFAULT_COLUMNS.slice();
    let TASKS_SPACES=[]; let unsubTasksSpaces=null; let OPEN_TASK=null;
    let SPACES_CACHE = new Map(); // id -> name

    async function ensureReviewColumn(){
      if (!CURRENT_SPACE) return;
      if (SPACE_COLUMNS.includes(REVIEW_COLUMN)) return;
      const cols = SPACE_COLUMNS.concat([REVIEW_COLUMN]);
      try{
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS = cols;
        renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      }catch(e){ console.error(e); }
    }

    async function ensureDefaultSpace(){
      const qy = query(collection(db,'spaces'), where('active','!=', false), where('type','==', null));
      const snap = await getDocs(qy);
      if (snap.empty){
        const label = new Date().toLocaleDateString('ar-SA',{ year:'numeric', month:'long' });
        const ref = await addDoc(collection(db,'spaces'), {
          name:label, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true
        });
        SPACES_CACHE.set(ref.id, label);
        return ref.id;
      } else {
        let id=null, ts=0;
        snap.forEach(d=>{
          const data=d.data()||{};
          const s=data.createdAt?.seconds||0;
          SPACES_CACHE.set(d.id, data.name||d.id);
          if(s>=ts){ts=s; id=d.id;}
        });
        return id;
      }
    }

    function fillSpaceDropdown(list, selectedId){
      spaceSelect.innerHTML='';
      list.forEach(s=>{
        if(s.type==='campaign') return;
        const opt=document.createElement('option');
        opt.value=s.id; opt.textContent=s.name;
        spaceSelect.appendChild(opt);
        SPACES_CACHE.set(s.id, s.name||s.id);
      });
      if(selectedId) spaceSelect.value=selectedId;
    }

    onSnapshot(collection(db,'spaces'), snap=>{
      const items=[];
      snap.forEach(d=>{
        const data=d.data()||{};
        if(data.active!==false) items.push({id:d.id, ...data});
      });
      const onlySpaces = items.filter(s=> !s.type);
      onlySpaces.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      fillSpaceDropdown(onlySpaces, CURRENT_SPACE);
      if(!CURRENT_SPACE && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect(); ensureReviewColumn();
      }else if(CURRENT_SPACE && !onlySpaces.find(x=>x.id===CURRENT_SPACE) && onlySpaces.length){
        CURRENT_SPACE = onlySpaces[0].id;
        SPACE_COLUMNS = onlySpaces[0].columns?.length? onlySpaces[0].columns : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
      }
    });

    document.getElementById('btnNewSpace')?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù€Space (Ù…Ø«Ø§Ù„: Ù†ÙˆÙÙ…Ø¨Ø± 2025):');
      if(!name) return;
      const ref = await addDoc(collection(db,'spaces'), {
        name, columns:DEFAULT_COLUMNS, createdAt:serverTimestamp(), active:true
      });
      SPACES_CACHE.set(ref.id, name);
      CURRENT_SPACE = ref.id; SPACE_COLUMNS = DEFAULT_COLUMNS.slice();
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnSpaceManage?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const action = prompt('Ø§ÙƒØªØ¨:\nrename Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©\narchive Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€Space');
      if(!action) return;
      if(action.toLowerCase()==='rename'){
        const nm = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù€Space:'); if(!nm) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { name:nm });
        SPACES_CACHE.set(CURRENT_SPACE, nm);
      } else if(action.toLowerCase()==='archive'){
        if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù€SpaceØŸ')) return;
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), {
          active:false, archivedAt:serverTimestamp()
        });
      }
    });

    spaceSelect.addEventListener('change', async (e)=>{
      CURRENT_SPACE = e.target.value;
      const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
      SPACES_CACHE.set(CURRENT_SPACE, d.data()?.name||CURRENT_SPACE);
      SPACE_COLUMNS = d.exists()
        ? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS)
        : DEFAULT_COLUMNS;
      renderBoardSkeletonSpaces(); listenTasksSpaces(true); fillGroupSelect(); ensureReviewColumn();
    });

    btnAddGroup?.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return;
      if(!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const name = (newGroupNameEl.value || 'ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§').trim();
      if(!name) return;
      if(SPACE_COLUMNS.includes(name)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');
      const cols = SPACE_COLUMNS.concat([name]);
      await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
      SPACE_COLUMNS = cols; newGroupNameEl.value='';
      renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
    });

    /* === EXPORT: Space to XLSX === */
    btnExportSpace?.addEventListener('click', ()=>{
      if(!CURRENT_SPACE){ alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{
        const data = TASKS_SPACES.map(t=>{
          const createdAt = t.createdAt?.seconds ? new Date(t.createdAt.seconds*1000) : null;
          const links = Array.isArray(t.links) ? t.links.map(l=> (l.title||l.url)+': '+l.url).join(' | ') : '';
          const members = taskMembersArray(t);
          const membersNames = members.map(m=>m.name).join(' | ');
          const membersUids  = members.map(m=>m.uid).join(' | ');
          const membersColors= members.map(m=>m.color).join(' | ');
          return {
            "Space": SPACES_CACHE.get(t.spaceId)||t.spaceId,
            "Ø§Ù„Ø¹Ù…ÙˆØ¯/Ø§Ù„Ø­Ø§Ù„Ø©": t.status||'',
            "Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ": t.name||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…": t.due||'',
            "Ø§Ù„ÙˆØµÙ": t.description||'',
            "Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersNames,
            "Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersColors,
            "UID Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡": membersUids,
            "Ù…Ø§Ø±ÙƒØ©": t.car?.brand||'',
            "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„": t.car?.model||'',
            "Ø§Ù„ÙØ¦Ø©": t.car?.trim||'',
            "Ø§Ù„Ù…Ø­Ø±Ùƒ": t.car?.engine||'',
            "Ø±ÙˆØ§Ø¨Ø·": links,
            "Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©": t.createdBy||'',
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡": createdAt ? createdAt.toLocaleString('ar-SA') : '',
            "Ù†Ø´Ø·": t.active===false? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
            "Doc ID": t.id
          };
        });

        const counts = SPACE_COLUMNS.map(col=>{
          const n = TASKS_SPACES.filter(t=>t.status===col).length;
          return { "Ø§Ù„Ø¹Ù…ÙˆØ¯": col, "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…": n };
        });

        const wb = XLSX.utils.book_new();
        const wsTasks = XLSX.utils.json_to_sheet(data);
        const wsCols  = XLSX.utils.json_to_sheet(counts);

        XLSX.utils.book_append_sheet(wb, wsTasks, 'Tasks');
        XLSX.utils.book_append_sheet(wb, wsCols,  'Columns');

        const fit = (rows)=> Object.keys(rows[0]||{}).map(k=>{
          const max = rows.reduce((m,r)=> Math.max(m, String(r[k]??'').length), k.length);
          return { wch: Math.min(Math.max(12, max+2), 60) };
        });
        if(data.length)   wsTasks['!cols'] = fit(data);
        if(counts.length) wsCols['!cols']  = fit(counts);

        const spaceName = (SPACES_CACHE.get(CURRENT_SPACE)||'Space').replace(/[\/\\:*?"<>|]/g,'-');
        const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const filename = `MZJ-Space-${spaceName}-${ymd}.xlsx`;
        XLSX.writeFile(wb, filename);
      }catch(err){
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: '+ (err?.message||err));
      }
    });

    /* Users on Spaces modal (Ø¥Ù†Ø´Ø§Ø¡/Ø­ÙØ¸ ØªØ§Ø³Ùƒ) */
    const taskModal      = document.getElementById('taskModal');
    const btnNewTask     = document.getElementById('btnNewTask');
    const btnCloseModal  = document.getElementById('btnCloseModal');
    const btnCancelTask  = document.getElementById('btnCancelTask');
    const btnSaveTask    = document.getElementById('btnSaveTask');

    const tName          = document.getElementById('tName');
    const tDesc          = document.getElementById('tDesc');
    const tDue           = document.getElementById('tDue');
    const tAssigneeSearch= document.getElementById('tAssigneeSearch');
    const assigneeMenu   = document.getElementById('assigneeMenu');
    const assigneeChip   = document.getElementById('assigneeChip');
    const tColor         = document.getElementById('tColor');
    const tGroup         = document.getElementById('tGroup');
    let SELECTED_ASSIGNEES=[];

    /* === Car Selector Data === */
    const CAR_MAP = {
      "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": [
        "Ø³ÙˆÙ†Ø§ØªØ§","Ø§Ù„Ù†ØªØ±Ø§","Ø§ÙƒØ³Ù†Øª","Ø¬Ø±Ø§Ù†Ø¯ i10","ÙƒØ±ÙŠØªØ§","Ø¬Ø±Ø§Ù†Ø¯ ÙƒØ±ÙŠØªØ§","Ø³ØªØ§Ø± Ø¬ÙŠØ²Ø±",
        "ÙÙŠÙ†ÙŠÙˆ","Ø§Ø²ÙŠØ±Ø§","Ø³Ù†ØªØ§ÙÙŠ","ØªÙˆØ³Ø§Ù†","ÙƒÙˆÙ†Ø§","Ø³ØªØ§Ø±ÙŠØ§","Ø¨Ø§Ù„Ø³ÙŠÙŠØ¯"
      ],
      "Ø´Ø§Ù†Ø¬Ø§Ù†": [
        "Ø³ÙŠ Ø§Ø³ 75","Ø³ÙŠ Ø§Ø³ 35","Ø§ÙŠØ¯Ùˆ Ø¨Ù„Ø³","Ø§Ù„ Ø³ÙŠÙÙ†","ÙŠÙˆÙ†ÙŠ ÙƒÙŠ","ÙŠÙˆÙ†ÙŠ ØªÙŠ","ÙŠÙˆÙ†ÙŠ ÙÙŠ",
        "Ø³ÙŠ Ø§Ø³ 95","ÙŠÙˆÙ†ÙŠ Ø§Ø³","Ù‡Ø§Ù†ØªØ± Ø§Ø¨"
      ],
      "Ø´ÙŠØ±ÙŠ": [
        "ØªÙŠØ¬Ùˆ 2 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 8","Ø§Ø±ÙŠØ²Ùˆ 6 Ø¨Ø±Ùˆ","Ø§Ø±ÙŠØ²Ùˆ 5 Ø¨Ø±Ùˆ",
        "Ø£ÙƒØ³ÙŠÙŠØ¯ Ø§Ù„ Ø§ÙƒØ³","ØªÙŠØ¬Ùˆ 8 Ø¨Ø±Ùˆ","ØªÙŠØ¬Ùˆ 7","ØªÙŠØ¬Ùˆ 4 Ø¨Ø±Ùˆ"
      ],
      "ÙÙˆØ±Ø¯": ["Ø±ÙŠÙ†Ø¬Ø±","Ø§ÙƒØ³Ø¨Ù„ÙˆØ±","ØªÙŠØ±ÙŠØªÙˆØ±ÙŠ","ØªÙˆØ±Ø³"],
      "Ø¥Ù… Ø¬ÙŠ": ["Ø¬ÙŠ ØªÙŠ","Ø§Ù… Ø¬ÙŠ 3","Ø§Ù… Ø¬ÙŠ 7","Ø§Ù… Ø¬ÙŠ 5","Ø§ØªØ´ Ø£Ø³","Ø§Ø± Ø§ÙƒØ³ 5","ÙˆÙ†","Ø²Ø¯ Ø£Ø³","ØªÙŠ 60","Ø§Ø± Ø£ÙƒØ³ 9","ÙˆØ§Ù„","Ø§Ø± Ø£ÙƒØ³ 8"],
      "Ù†ÙŠØ³Ø§Ù†": ["Ø§ÙƒØ³ ØªØ±ÙŠÙ„","Ù…Ø§Ø¬Ù†Ø§ÙŠØª","ÙƒÙŠÙƒØ³","ØµÙ†ÙŠ","Ø§ÙƒØ³ ØªÙŠØ±Ø§","Ø§Ù„ØªÙŠÙ…Ø§"]
    };

    const carBrand  = document.getElementById('carBrand');
    const carModel  = document.getElementById('carModel');
    const carTrim   = document.getElementById('carTrim');
    const carEngine = document.getElementById('carEngine');

    function fillBrands(){
      carBrand.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© â€”</option>';
      Object.keys(CAR_MAP).forEach(b=>{
        const opt=document.createElement('option'); opt.value=b; opt.textContent=b;
        carBrand.appendChild(opt);
      });
    }
    function fillModels(brand){
      carModel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ â€”</option>';
      (CAR_MAP[brand]||[]).forEach(m=>{
        const opt=document.createElement('option'); opt.value=m; opt.textContent=m;
        carModel.appendChild(opt);
      });
    }
    function buildAutoTaskName(){
      const parts = [
        carBrand?.value?.trim() || '',
        carModel?.value?.trim() || '',
        carTrim?.value?.trim() || '',
        carEngine?.value?.trim() || ''
      ].filter(Boolean);
      const auto = parts.join(' ').replace(/\s+/g,' ').trim();
      if(auto) tName.value = auto;
    }
    carBrand?.addEventListener('change', ()=>{
      fillModels(carBrand.value);
      buildAutoTaskName();
    });
    [carModel, carTrim, carEngine].forEach(el=>{
      el?.addEventListener('input', buildAutoTaskName);
      el?.addEventListener('change', buildAutoTaskName);
    });
    function initCarSelectors(){
      fillBrands();
      fillModels(carBrand.value||'');
      carTrim.value=''; carEngine.value='';
    }

    function fillGroupSelect(cols=SPACE_COLUMNS){
      tGroup.innerHTML='';
      (cols||[]).forEach(col=>{
        const opt=document.createElement('option'); opt.value=col; opt.textContent=col;
        tGroup.appendChild(opt);
      });
    }

    function renderAssigneeChips(){
      assigneeChip.innerHTML = '';
      if(!SELECTED_ASSIGNEES.length){
        assigneeChip.innerHTML = '<span class="small muted">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯</span>';
        return;
      }
      SELECTED_ASSIGNEES.forEach(u=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.dataset.uid = u.uid;
        chip.innerHTML = `
          <span class="badge">
            <span class="dot" style="background:${u.color||'#bc8f74'}"></span>
            ${u.name}
          </span>
          <span class="chip-actions">
            <button type="button" class="chip-remove" title="Ø¥Ø²Ø§Ù„Ø©">âœ•</button>
          </span>
        `;
        chip.querySelector('.chip-remove').onclick = ()=>{
          SELECTED_ASSIGNEES = SELECTED_ASSIGNEES.filter(a=>a.uid!==u.uid);
          renderAssigneeChips();
        };
        assigneeChip.appendChild(chip);
      });
    }

    function openCreate(cols=SPACE_COLUMNS){
      if(IS_ADMIN){
        const isCampaignTab = !panelCampaigns.classList.contains('hidden');
        if(isCampaignTab){
          tDesc.classList.add('campaign-full-desc');
        }else{
          tDesc.classList.remove('campaign-full-desc');
        }

        taskModal.classList.add('show');
        fillGroupSelect(cols);
        initCarSelectors();
        renderAssigneeChips();
      }
    }
    function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

    btnNewTask.addEventListener('click', ()=> openCreate(SPACE_COLUMNS));
    btnCloseModal.addEventListener('click', ()=> closeCreate());
    btnCancelTask.addEventListener('click', ()=> closeCreate());
    taskModal.addEventListener('click', (e)=>{ if(e.target===taskModal) closeCreate(); });

    function resetCreateForm(){
      tName.value=''; tDesc.value='';
      tDesc.classList.remove('campaign-full-desc');
      tDue.value='';
      tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.style.display='none';
      SELECTED_ASSIGNEES=[]; assigneeChip.innerHTML=''; tColor.value='#bc8f74';
      fillGroupSelect();
      initCarSelectors();
    }

    function renderAssigneeMenu(filter){
      const f=(filter||'').toLowerCase();
      assigneeMenu.innerHTML='';
      USERS.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const it=document.createElement('div');
        it.className='dd-item';
        it.style.padding='8px 10px';
        it.style.cursor='pointer';
        it.innerHTML=`<span class="row"><span class="color-dot" style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${u.color||'#bc8f74'}"></span> ${u.name} <span class="muted">(${u.role})</span></span>`;
        it.onclick=()=> selectAssignee(u);
        assigneeMenu.appendChild(it);
      });
      assigneeMenu.style.display= USERS.length && assigneeMenu.innerHTML ? 'block' : 'none';
    }
    function selectAssignee(user){
      if(!user) return;
      if(!SELECTED_ASSIGNEES.find(u=>u.uid===user.uid)){
        SELECTED_ASSIGNEES.push({...user});
      }
      if(SELECTED_ASSIGNEES.length===1 && user.color){
        tColor.value = user.color;
      }
      assigneeMenu.style.display='none';
      renderAssigneeChips();
    }
    tAssigneeSearch.addEventListener('input', (e)=> renderAssigneeMenu(e.target.value.trim()));
    tAssigneeSearch.addEventListener('focus', ()=> renderAssigneeMenu(tAssigneeSearch.value));
    document.addEventListener('click', (e)=>{
      if(!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch) assigneeMenu.style.display='none';
    });

    /* ===== Campaign logic ===== */
    const CAMPAIGN_DEFAULT_COLS = [
      "Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´",
      "Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","Ø§Ù‚Ø³Ø§Ø· - Ai Generate","Ø¬Ø±Ø§ÙÙŠÙƒ - Ø§Ù‚Ø³Ø§Ø·",
      "Ø§Ù‚Ø³Ø§Ø· Ø´Ø±ÙƒØ§Øª - Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"
    ];

    const campaignSelect     = document.getElementById('campaignSelect');
    const boardCampaigns     = document.getElementById('boardCampaigns');
    const btnNewCampaignTask = document.getElementById('btnNewCampaignTask');
    const btnNewCampaign     = document.getElementById('btnNewCampaign');
    const campaignDates      = document.getElementById('campaignDates');
    const campaignToggle     = document.getElementById('campaignToggle');

    function setCampaignDescription(html){
      if(!campaignDates) return;
      const content = html || "Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
      campaignDates.innerHTML = content;
      campaignDates.classList.remove('expanded');
      if(campaignToggle){
        requestAnimationFrame(()=>{
          const needsToggle = campaignDates.scrollHeight > campaignDates.clientHeight + 4;
          campaignToggle.style.display = needsToggle ? 'inline-flex' : 'none';
          campaignToggle.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
        });
      }
    }

    if(campaignToggle){
      campaignToggle.addEventListener('click', ()=>{
        const expanded = campaignDates.classList.toggle('expanded');
        campaignToggle.textContent = expanded ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØµÙ' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
      });
    }

    let CURRENT_CAMPAIGN = null;
    let CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
    let TASKS_CAMPAIGNS  = [];
    let unsubTasksCampaigns = null;
    let CAMPAIGNS = [];

    function fillCampaignDropdown(list, selectedId){
      campaignSelect.innerHTML='';
      if(!list.length){
        const opt=document.createElement('option');
        opt.value=''; opt.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª â€” Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        campaignSelect.appendChild(opt);
        campaignSelect.disabled = true;
        return;
      }
      campaignSelect.disabled = false;
      list.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.name || 'Ø­Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        campaignSelect.appendChild(opt);
      });
      if(selectedId && list.find(c=>c.id===selectedId)){
        campaignSelect.value=selectedId;
      }else{
        campaignSelect.value=list[0].id;
      }
    }

    function updateCampaignInfo(campaign){
      if(!campaignDates) return;
      if(!campaign){
        setCampaignDescription("Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.");
        return;
      }
      const desc  = campaign.description || campaign.desc || '';
      const start = campaign.startDate || '';
      const end   = campaign.endDate   || '';
      let html = "";

      if(start || end){
        html += `<p style="margin:0 0 6px;font-weight:700;color:var(--brown);">Ø§Ù„ÙØªØ±Ø©: <span style="font-weight:400;">${start || 'â€”'} Ø¥Ù„Ù‰ ${end || 'â€”'}</span></p>`;
      }
      if(desc){
        html += desc;
      }
      if(!html){
        setCampaignDescription("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©.");
      }else{
        setCampaignDescription(html);
      }
    }

    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù…Ù„Ø§Øª type="campaign" Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø­Ù…Ù„Ø© Ø«Ø§Ø¨ØªØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    onSnapshot(
      query(collection(db,'spaces'), where('type','==','campaign')),
      snap=>{
        const arr=[];
        snap.forEach(d=>{
          const data=d.data()||{};
          if(data.active===false) return;
          arr.push({ id:d.id, ...data });
          SPACES_CACHE.set(d.id, data.name||d.id);
        });

        let defaultCampaign =
          arr.find(c=>c.isDefault === true) ||
          arr.find(c=>(c.name||'').includes('Ø­Ù…Ù„Ø© Ø«Ø§Ø¨ØªØ©'));

        if(defaultCampaign){
          arr.sort((a,b)=>{
            if(a.id === defaultCampaign.id) return -1;
            if(b.id === defaultCampaign.id) return 1;
            return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);
          });
        }else{
          arr.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        }

        CAMPAIGNS = arr;

        if(!CAMPAIGNS.length){
          CURRENT_CAMPAIGN = null;
          fillCampaignDropdown([], null);
          boardCampaigns.innerHTML='';
          setCampaignDescription("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø±.");
          if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
          return;
        }

        if(!CURRENT_CAMPAIGN || !CAMPAIGNS.find(c=>c.id===CURRENT_CAMPAIGN)){
          CURRENT_CAMPAIGN = defaultCampaign
            ? defaultCampaign.id
            : (CAMPAIGNS[0]?.id || null);
        }

        fillCampaignDropdown(CAMPAIGNS, CURRENT_CAMPAIGN);

        const found = CAMPAIGNS.find(c=>c.id===CURRENT_CAMPAIGN) || CAMPAIGNS[0];
        CURRENT_CAMPAIGN   = found?.id || null;
        CAMPAIGN_COLUMNS   = found?.columns?.length ? found.columns : CAMPAIGN_DEFAULT_COLS.slice();
        renderBoardSkeletonCampaigns();
        listenTasksCampaigns();
        updateCampaignInfo(found);
      },
      err=>{
        console.error(err);
        setCampaignDescription("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª");
      }
    );

    function bootCampaigns(){
      setCampaignDescription("Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ø­Ù…Ù„Ø©.");

      campaignSelect.addEventListener('change', async (e)=>{
        const id = e.target.value || null;
        CURRENT_CAMPAIGN = id;
        if(!id){
          boardCampaigns.innerHTML='';
          if(unsubTasksCampaigns){unsubTasksCampaigns();unsubTasksCampaigns=null;}
          updateCampaignInfo(null);
          return;
        }
        const d = await getDoc(doc(db,'spaces', id));
        const data = d.data()||{};
        CAMPAIGN_COLUMNS = data.columns?.length ? data.columns : CAMPAIGN_DEFAULT_COLS.slice();
        renderBoardSkeletonCampaigns();
        listenTasksCampaigns();
        updateCampaignInfo({ id, ...data });
      });

      btnNewCampaignTask?.addEventListener('click', ()=>{
        if(!CURRENT_CAMPAIGN) return alert('Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
        fillGroupSelect(CAMPAIGN_COLUMNS);
        openCreate(CAMPAIGN_COLUMNS);
      });

      btnNewCampaign?.addEventListener('click', async ()=>{
        if(!IS_ADMIN) return;
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©:');
        if(!name) return;
        try{
          const ref = await addDoc(collection(db,'spaces'), {
            name,
            type:'campaign',
            columns: CAMPAIGN_DEFAULT_COLS,
            createdAt: serverTimestamp(),
            active: true,
            isDefault: false
          });
          CURRENT_CAMPAIGN = ref.id;
          CAMPAIGN_COLUMNS = CAMPAIGN_DEFAULT_COLS.slice();
          renderBoardSkeletonCampaigns();
          listenTasksCampaigns();
        }catch(err){
          console.error(err);
          alert('âš ï¸ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: '+(err?.message||err));
        }
      });

      boardCampaigns.addEventListener('click', async (e)=>{
        const doneBtn = e.target.closest('.campaign-done-btn');
        if(!doneBtn) return;
        e.stopPropagation();
        const id = doneBtn.dataset.id;
        if(!id) return;

        const task = TASKS_CAMPAIGNS.find(t=> t.id === id);
        if(!task || !canUserMarkCampaignDone(task)){
          alert('Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´Ù† ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
          return;
        }

        try{
          const newOrder = computeOrderAtEnd("ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡");
          await updateTaskStatusAndOrder(id, "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", newOrder);
        }catch(err){
          console.error(err);
          alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
        }
      });
    }

    function renderBoardSkeletonCampaigns(){
      const board=boardCampaigns;
      board.innerHTML='';

      (CAMPAIGN_COLUMNS||[]).forEach((col)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.innerHTML=`
          <div class="col-head" style="cursor:default">
            <span class="col-title">${col}</span>
            <div class="col-actions" style="${IS_ADMIN?'display:flex':'display:none'}">
              <button class="icon" data-act="newtask" title="ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯">â•</button>
            </div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;
        board.appendChild(sec);
        sec.querySelector('.col-actions').addEventListener('click',(e)=>{
          const act=e.target.dataset.act;
          if(act==='newtask'){
            fillGroupSelect(CAMPAIGN_COLUMNS);
            tGroup.value=col;
            openCreate(CAMPAIGN_COLUMNS);
          }
        });
      });
      // Ø¹Ù…ÙˆØ¯ Ø«Ø§Ø¨Øª Ù„Ù€Ù€ "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù„ÙˆØ­Ø©
      (function(){
        const doneCol = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=doneCol;
        sec.innerHTML = `
          <div class="col-head" style="cursor:default">
            <span class="col-title">${doneCol}</span>
            <div class="col-actions" style="display:none"></div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${doneCol}"></div></div>
        `;
        board.appendChild(sec);
      })();

      const doneCol = document.createElement('section');
      doneCol.className = 'col campaign-done-col';
      doneCol.dataset.status = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
      doneCol.innerHTML = `
        <div class="col-head" style="cursor:default">
          <span class="col-title">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
        </div>
        <div class="col-body"><div class="dropzone" data-zone="ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"></div></div>
      `;
      board.appendChild(doneCol);

      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          const newOrder = computeOrderAtEnd(newStatus);
          await updateTaskStatusAndOrder(cardId, newStatus, newOrder);
        });
      });
    }

    function renderMembersBadges(members){
      if(!members.length) return '';
      if(members.length<=2){
        return members.map(m=>`
          <span class="badge">
            <span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}
          </span>
        `).join('');
      }
      const firstTwo = members.slice(0,2).map(m=>`
        <span class="badge">
          <span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}
        </span>
      `).join('');
      const more = members.length-2;
      return firstTwo + `<span class="small">+${more}</span>`;
    }

    function taskOrderValue(t){
      if(typeof t.order === 'number') return t.order;
      if(t.createdAt?.seconds) return t.createdAt.seconds;
      return 0;
    }

    async function updateTaskStatusAndOrder(taskId, newStatus, newOrder){
      const patch = { status:newStatus };
      if(typeof newOrder === 'number' && !Number.isNaN(newOrder)){
        patch.order = newOrder;
      }
      try{
        await updateDoc(doc(db,'tasks', taskId), patch);
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ù†Ù‚Ù„: '+(err?.message||err));
      }
    }

    function computeOrderForDrop(status, targetTaskId, position){
      const tasks = TASKS_CAMPAIGNS
        .filter(t=>t.status===status)
        .slice()
        .sort((a,b)=> taskOrderValue(a)-taskOrderValue(b));

      if(!tasks.length) return 1;

      const idx = tasks.findIndex(t=>t.id===targetTaskId);
      if(idx===-1){
        const last = tasks[tasks.length-1];
        return taskOrderValue(last)+1;
      }

      const target = tasks[idx];
      const targetVal = taskOrderValue(target);

      if(position === 'before'){
        if(idx===0){
          return targetVal - 1;
        }
        const prev = tasks[idx-1];
        const prevVal = taskOrderValue(prev);
        return (prevVal + targetVal)/2;
      }else{
        if(idx===tasks.length-1){
          return targetVal + 1;
        }
        const next = tasks[idx+1];
        const nextVal = taskOrderValue(next);
        return (targetVal + nextVal)/2;
      }
    }

    function computeOrderAtEnd(status){
      const tasks = TASKS_CAMPAIGNS.filter(t=>t.status===status);
      if(!tasks.length) return 1;
      let max = tasks.reduce((m,t)=> Math.max(m, taskOrderValue(t)), 0);
      return max + 1;
    }

    function renderTasksCampaigns(){
      const board=boardCampaigns;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={};
      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(s=> byStatus[s]=[]);
      TASKS_CAMPAIGNS.forEach(t=>{
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      [...(CAMPAIGN_COLUMNS||[]), 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'].forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        if(!zone) return;
        const list = byStatus[status]||[];
        list.sort((a,b)=> taskOrderValue(a)-taskOrderValue(b));
        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='card';
          card.dataset.id=t.id;
          const members = taskMembersArray(t);
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';

          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
          `;

          const footer = document.createElement('div');
          footer.className = 'row between';
          const left = document.createElement('div');
          left.innerHTML = `
            ${members.length? renderMembersBadges(members):''}
            ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
          `;
          footer.appendChild(left);

          const canDone = canUserMarkCampaignDone(t);
          if(t.status !== "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" && canDone){
            const right = document.createElement('div');
            const btn = document.createElement('button');
            btn.className = 'btn secondary xs campaign-done-btn';
            btn.textContent = 'âœ“';
            btn.title = 'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
            btn.dataset.id = t.id;
            right.appendChild(btn);
            footer.appendChild(right);
          }

          card.appendChild(footer);

          card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });

          card.addEventListener('dragover', e=>{
            if(e.dataTransfer.types.includes(MIME_TASK)){
              e.preventDefault();
              card.classList.add('drag-over');
            }
          });
          card.addEventListener('dragleave', ()=>{
            card.classList.remove('drag-over');
          });
          card.addEventListener('drop', async (e)=>{
            if(!e.dataTransfer.types.includes(MIME_TASK)) return;
            e.preventDefault();
            card.classList.remove('drag-over');
            const draggedId = e.dataTransfer.getData(MIME_TASK);
            if(!draggedId || draggedId === t.id) return;
            const zoneEl = card.closest('.dropzone');
            if(!zoneEl) return;
            const status = zoneEl.dataset.zone;
            const rect = card.getBoundingClientRect();
            const mid = rect.top + rect.height/2;
            const position = e.clientY < mid ? 'before' : 'after';
            const newOrder = computeOrderForDrop(status, t.id, position);
            await updateTaskStatusAndOrder(draggedId, status, newOrder);
          });

          card.addEventListener('click', (e)=>{
            if(e.target.closest('.campaign-done-btn')) return;
            openDetail(t);
          });
          zone.appendChild(card);
        });
      });
    }

        function listenTasksCampaigns(){
      if(unsubTasksCampaigns){ unsubTasksCampaigns(); unsubTasksCampaigns=null; }
      if(!CURRENT_CAMPAIGN) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_CAMPAIGN));
      unsubTasksCampaigns = onSnapshot(qy,(snap)=>{
        const raw = [];
        snap.forEach(d=> raw.push({ id:d.id, ...(d.data()||{}) }));
        console.log('tasks snapshot campaigns', raw);

        // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª ÙÙŠ Ø§Ù„Ø­Ù…Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙÙ„ØªØ±Ø©
        TASKS_CAMPAIGNS = raw;

        renderTasksCampaigns();
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Ø§Ù„Ø­Ù…Ù„Ø§Øª).'); });
    }

    /* Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ (Spaces / Campaign) + Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù† */
    btnSaveTask.addEventListener('click', async ()=>{
      const isCampaignTab = !panelCampaigns.classList.contains('hidden');
      const targetSpaceId = isCampaignTab ? CURRENT_CAMPAIGN : CURRENT_SPACE;
      const targetCols    = isCampaignTab ? CAMPAIGN_COLUMNS : SPACE_COLUMNS;

      if(!targetSpaceId) return alert('Ø§Ø®ØªØ± Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹');
      if(!IS_ADMIN) return alert('Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ†');

      if(!tName.value.trim()) buildAutoTaskName();
      const name=tName.value.trim();
      if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');

      const due=tDue.value||null;
      const description=tDesc.value||null;
      const color=(document.getElementById('tColor').value||'#bc8f74').trim();
      const status=tGroup.value || (targetCols[0]||'Ø¹Ù…ÙˆØ¯');

      const car = {
        brand:  carBrand?.value?.trim()  || null,
        model:  carModel?.value?.trim()  || null,
        trim:   carTrim?.value?.trim()   || null,
        engine: carEngine?.value?.trim() || null
      };

      const assigneesPayload = SELECTED_ASSIGNEES.map(u=>({
        uid: u.uid,
        name: u.name,
        color: color
      }));

      try{
        for(const u of assigneesPayload){
          await setDoc(doc(db,'users', u.uid), { color }, { merge:true });
          const idx=USERS.findIndex(x=>x.uid===u.uid);
          if(idx>-1) USERS[idx].color=color;
        }

        const payload = {
          spaceId: targetSpaceId, name, description, due, status,
          car,
          assignees: assigneesPayload.length ? assigneesPayload : null,
          assignee: assigneesPayload.length ? assigneesPayload[0] : null,
          links: [],
          createdBy: CURRENT_USER?.uid || null,
          createdAt: serverTimestamp(),
          active:true,
          order: Date.now()
        };
        const ref = await addDoc(collection(db,'tasks'), payload);

        // ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù†
        await createMentionNotifications({
          taskId: ref.id,
          taskName: name,
          taskDescription: description,
          spaceId: targetSpaceId,
          status,
          assignees: assigneesPayload
        });

        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ');
        closeCreate();
      }catch(e){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+(e?.message||e)); }
    });

    /* Board & Details â€” Spaces */
    function renderColumnHeaderActionsSpaces(container, columnName){
      const actions=document.createElement('div');
      actions.className='col-actions';
      actions.style.display=IS_ADMIN?'flex':'none';

      const btnRename=document.createElement('button');
      btnRename.className='icon';
      btnRename.textContent='âœï¸';
      btnRename.title='Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnRename.onclick=async ()=>{
        if(!IS_ADMIN) return;
        const nn=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', columnName);
        if(!nn||nn===columnName) return;
        const cols=SPACE_COLUMNS.map(c=>c===columnName?nn:c);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };

      const btnDelete=document.createElement('button');
      btnDelete.className='icon';
      btnDelete.textContent='ğŸ—‘ï¸';
      btnDelete.title='Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯';
      btnDelete.onclick=async ()=>{
        if(!IS_ADMIN) return;
        if(SPACE_COLUMNS.length<=1) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…ÙˆØ¯.');
        const target=prompt(`Ø³ÙŠØªÙ… Ø­Ø°Ù "${columnName}". Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰: \n${SPACE_COLUMNS.join(', ')}`);
        if(!target || !SPACE_COLUMNS.includes(target) || target===columnName) return;
        const affected=TASKS_SPACES.filter(t=>t.status===columnName);
        for(const t of affected){
          try{ await updateDoc(doc(db,'tasks', t.id), { status:target }); }catch{}
        }
        const cols=SPACE_COLUMNS.filter(c=>c!==columnName);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS=cols; renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
      };

      actions.appendChild(btnRename);
      actions.appendChild(btnDelete);
      container.appendChild(actions);
    }

    async function persistColumnsOrderSpaces(newOrder){
      if (!CURRENT_SPACE) return;
      try{ await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: newOrder }); }
      catch(e){ console.error(e); alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.'); }
    }

    function renderBoardSkeletonSpaces(){
      const board=boardSpaces;
      board.innerHTML='';
      (SPACE_COLUMNS||[]).forEach((col, index)=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.dataset.index=index;

        sec.innerHTML=`
          <div class="col-head">
            <span class="col-title">${col}</span>
            <span class="grip"><span class="dots">â‹®â‹®</span> Ø§Ø³Ø­Ø¨</span>
            <div class="__actions"></div>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${col}"></div></div>
        `;

        const grip = sec.querySelector('.grip');
        if (IS_ADMIN && grip){
          grip.setAttribute('draggable','true');
          grip.addEventListener('dragstart',(e)=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_COLUMN, String(index));
          });
        }
        sec.addEventListener('dragover',(e)=>{
          if (e.dataTransfer.types.includes(MIME_COLUMN)){
            e.preventDefault(); e.dataTransfer.dropEffect='move';
          }
        });
        sec.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_COLUMN)) return;
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData(MIME_COLUMN),10);
          const to   = parseInt(sec.dataset.index,10);
          if (isNaN(from)||isNaN(to)||from===to) return;
          const newOrder = SPACE_COLUMNS.slice();
          const [moved] = newOrder.splice(from,1);
          newOrder.splice(to,0,moved);
          SPACE_COLUMNS = newOrder;
          renderBoardSkeletonSpaces(); renderTasksSpaces(); fillGroupSelect();
          await persistColumnsOrderSpaces(newOrder);
        });

        board.appendChild(sec);
        renderColumnHeaderActionsSpaces(sec.querySelector('.__actions'), col);
      });

      // Ø¹Ù…ÙˆØ¯ "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù„ÙˆØ­Ø©
      {
        const sec = document.createElement('section');
        sec.className = 'col daily-done-col';
        sec.dataset.status = DONE_STATUS_SPACES;
        sec.innerHTML = `
          <div class="col-head" style="cursor:default">
            <span class="col-title">${DONE_STATUS_SPACES}</span>
          </div>
          <div class="col-body"><div class="dropzone" data-zone="${DONE_STATUS_SPACES}"></div></div>
        `;
        board.appendChild(sec);
      }


      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if (e.dataTransfer.types.includes(MIME_TASK)){
            e.preventDefault(); zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if (!e.dataTransfer.types.includes(MIME_TASK)) return;
          e.preventDefault(); zone.classList.remove('drag');
          const cardId = e.dataTransfer.getData(MIME_TASK);
          const newStatus = zone.dataset.zone;
          try{ await updateDoc(doc(db,'tasks', cardId), { status:newStatus }); }
          catch(err){ alert('âš ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§ÙÙŠØ©.'); }
        });
      });
    }

    
    // Ø²Ø±Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ ÙÙŠ Ù„ÙˆØ­Ø© Spaces (ÙŠÙ†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)
    boardSpaces.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.space-done-btn');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      const task = TASKS_SPACES.find(t=> t.id === id);
      if(!task) return;
      try{
        await updateDoc(doc(db,'tasks', id), { status: DONE_STATUS_SPACES });
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
      }
    });

function renderTasksSpaces(){
      const board=boardSpaces;
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus={}; ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(s=> byStatus[s]=[]);
      TASKS_SPACES.forEach(t=>{
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });

      ([...(SPACE_COLUMNS||[]), DONE_STATUS_SPACES]).forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        const list = byStatus[status]||[];
        list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='card';
          card.dataset.id=t.id;
          const members = taskMembersArray(t);
          const carLine = t.car ? [t.car.brand, t.car.model, t.car.trim, t.car.engine].filter(Boolean).join(' ') : '';
          const canDoneSpace = true;
          card.innerHTML = `
            <h4>${t.name||'-'}</h4>
            ${carLine ? `<div class="small" style="margin-top:4px">ğŸš— ${carLine}</div>` : ''}
            <div class="row between" style="margin-top:6px">
              <div class="row">
                ${members.length? renderMembersBadges(members):''}
                ${t.due?`<span class="small">ğŸ“… ${t.due}</span>`:''}
              </div>
              ${t.status !== DONE_STATUS_SPACES && canDoneSpace ? `
                <button class="btn secondary xs space-done-btn" data-id="${t.id}" title="Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡">âœ“</button>
              ` : ''}
            </div>`;          
card.setAttribute('draggable','true');
          card.addEventListener('dragstart', e=>{
            e.dataTransfer.effectAllowed='move';
            e.dataTransfer.setData(MIME_TASK, t.id);
            e.dataTransfer.setData('text/plain', t.id);
          });
          card.addEventListener('click', ()=> openDetail(t));
          zone?.appendChild(card);
        });
      });
    }

        function listenTasksSpaces(){
      if(unsubTasksSpaces){ unsubTasksSpaces(); unsubTasksSpaces=null; }
      if(!CURRENT_SPACE) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasksSpaces = onSnapshot(qy,(snap)=>{
        const raw = [];
        snap.forEach(d=> raw.push({ id:d.id, ...(d.data()||{}) }));
        console.log('tasks snapshot spaces', raw);

        // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙÙ„ØªØ±Ø©
        TASKS_SPACES = raw;

        renderTasksSpaces();
        if(OPEN_TASK){
          const now = TASKS_SPACES.find(t=>t.id===OPEN_TASK.id);
          if(now) openDetail(now);
        }
      },(err)=>{ console.error(err); alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª (Spaces).'); });
    }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© + Ø±ÙˆØ§Ø¨Ø· (Ù…Ø´ØªØ±ÙƒØ©) */
    function renderDetailAssignees(task){
      const el = document.getElementById('dAssignee');
      el.innerHTML = '';
      const members = taskMembersArray(task);
      if(!members.length){
        el.innerHTML = '<span class="muted">â€”</span>';
        return;
      }
      members.forEach(m=>{
        const span = document.createElement('span');
        span.className='badge';
        span.innerHTML = `<span class="dot" style="background:${m.color||'#bc8f74'}"></span>${m.name||''}`;
        el.appendChild(span);
      });
    }

    function openDetail(task){
      OPEN_TASK=task;
      document.getElementById('dTitle').textContent=task.name||'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
      const dDesc = document.getElementById('dDesc');
      dDesc.value = task.description || '';
      renderDetailAssignees(task);
      document.getElementById('dDue').textContent=task.due||'â€”';
      document.getElementById('dStatus').textContent=task.status||'â€”';

      const showActions = canManageLinks(task);
      document.getElementById('dActions').style.display = showActions ? 'block' : 'none';
      document.getElementById('btnEditTask').style.display = IS_ADMIN ? '' : 'none';
      document.getElementById('btnDeleteTask').style.display = IS_ADMIN ? '' : 'none';

      const reviewBtn = document.getElementById('btnMarkReviewed');
      if (reviewBtn){
        if (task.status === 'assigned'){
          reviewBtn.textContent = 'Ø¨Ø¯Ø£Øª Ø§Ù„Ø´ØºÙ„';
          reviewBtn.style.display = '';
        } else if (task.status === 'in_progress'){
          reviewBtn.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
          reviewBtn.style.display = '';
        } else if (task.status === 'changes_requested'){
          reviewBtn.textContent = 'Ø¹Ø¯Ù„Øª Ùˆ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
          reviewBtn.style.display = '';
        } else {
          reviewBtn.style.display = 'none';
        }
      }

      const linksEl=document.getElementById('dLinks');
      linksEl.innerHTML='';
      (task.links||[]).forEach((l, idx)=>{
        const chip=document.createElement('span'); chip.className='chip'; chip.dataset.idx=idx;
        const title = l.title || l.url;
        chip.innerHTML = `
          ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${title}</a>
          ${showActions?`
            <span class="chip-actions">
              <button class="link-edit" data-idx="${idx}" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
              <button class="link-del"  data-idx="${idx}" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
            </span>`:''}
        `;
        linksEl.appendChild(chip);
      });

      document.getElementById('detailModal').classList.add('show');
    }
    document.getElementById('btnCloseDetail').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
    document.getElementById('detailModal').addEventListener('click', (e)=>{ if(e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('show'); });

    document.getElementById('btnMarkReviewed').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return;
      try{
        const taskRef = doc(db,'tasks', OPEN_TASK.id);
        const snap = await getDoc(taskRef);
        const data = snap.exists() ? (snap.data() || {}) : {};
        const currentStatus = data.status || OPEN_TASK.status || '';
        const now = Timestamp.now();
        const existingTimestamps = data.timestamps || {};
        const existingReviewCycles = Array.isArray(data.reviewCycles) ? data.reviewCycles.slice() : [];

        if (currentStatus === 'assigned'){
          const updatePayload = { status: 'in_progress' };
          if (!existingTimestamps.startedAt){
            updatePayload['timestamps.startedAt'] = now;
          }
          await updateDoc(taskRef, updatePayload);
        } else if (currentStatus === 'in_progress' || currentStatus === 'changes_requested'){
          const round = (existingReviewCycles.length || 0) + 1;
          existingReviewCycles.push({
            round,
            sentForReviewAt: now,
            feedbackAt: null,
            result: 'pending'
          });

          const updatePayload = {
            status: 'ready_for_review',
            reviewCycles: existingReviewCycles,
            'timestamps.lastReadyForReviewAt': now
          };
          if (!existingTimestamps.firstReadyForReviewAt){
            updatePayload['timestamps.firstReadyForReviewAt'] = now;
          }
          await updateDoc(taskRef, updatePayload);
        } else {
          document.getElementById('detailModal').classList.remove('show');
          return;
        }

        document.getElementById('detailModal').classList.remove('show');
      }catch(e){
        console.error(e);
        alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+(e && e.message ? e.message : e));
      }
    });

    document.getElementById('btnEditTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      const newName=prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:', OPEN_TASK.name||''); if(newName===null) return;
      const newDesc=prompt('Ø§Ù„ÙˆØµÙ:', OPEN_TASK.description||''); if(newDesc===null) return;
      const newDue =prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD):', OPEN_TASK.due||''); if(newDue===null) return;
      try{ await updateDoc(doc(db,'tasks', OPEN_TASK.id), { name:newName, description:newDesc, due:newDue }); }
      catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message); }
    });

    document.getElementById('btnDeleteTask').addEventListener('click', async ()=>{
      if(!IS_ADMIN || !OPEN_TASK) return;
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
      try{
        await deleteDoc(doc(db,'tasks', OPEN_TASK.id));
        document.getElementById('detailModal').classList.remove('show');
      }catch(e){ alert('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message); }
    });

    document.getElementById('btnAddLink').addEventListener('click', async ()=>{
      if(!OPEN_TASK) return alert('Ø§ÙØªØ­ Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹');
      if(!canManageLinks(OPEN_TASK)) return alert('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·');
      const title = (document.getElementById('dLinkTitle').value||'Ø±Ø§Ø¨Ø·').trim();
      const url   = (document.getElementById('dLinkUrl').value||'').trim();
      if(!url || !/^https?:\/\//i.test(url)) return alert('Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://');

      try{
        await updateDoc(doc(db,'tasks', OPEN_TASK.id), {
          links: arrayUnion({ title, url, by: CURRENT_USER?.uid || null, at: Timestamp.now() })
        });
        document.getElementById('dLinkTitle').value='';
        document.getElementById('dLinkUrl').value='';
      }catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: '+e.message); }
    });

    /* Boot spaces default */
    async function bootSpaces(){
      if(!CURRENT_SPACE){
        CURRENT_SPACE = await ensureDefaultSpace();
        const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
        SPACE_COLUMNS = d.exists()
          ? (d.data().columns?.length? d.data().columns : DEFAULT_COLUMNS)
          : DEFAULT_COLUMNS;
        renderBoardSkeletonSpaces(); listenTasksSpaces(); fillGroupSelect();
      }
    }

    /* ===== Daily Task logic ===== */

    const DAILY_DAYS = [
      { key:'sat', label:'Ø§Ù„Ø³Ø¨Øª' },
      { key:'sun', label:'Ø§Ù„Ø£Ø­Ø¯' },
      { key:'mon', label:'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†' },
      { key:'tue', label:'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' },
      { key:'wed', label:'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡' },
      { key:'thu', label:'Ø§Ù„Ø®Ù…ÙŠØ³' }
    ];
    const DAILY_WEEKS = [1,2,3,4];

    const dailyMonthSelect = document.getElementById('dailyMonthSelect');
    const dailyBoard       = document.getElementById('dailyBoard');
    const dailyMeta        = document.getElementById('dailyMeta');

    const dailyModal       = document.getElementById('dailyModal');
    const dailyModalTitle  = document.getElementById('dailyModalTitle');
    const dailyTitleInput  = document.getElementById('dailyTitle');
    const dailyDescInput   = document.getElementById('dailyDesc');
    const btnDailySave     = document.getElementById('btnDailySave');
    const btnDailyCancel   = document.getElementById('btnDailyCancel');
    const btnDailyDelete   = document.getElementById('btnDailyDelete');

    let DAILY_MONTH_KEY = null;
    let DAILY_TASKS = [];
    let unsubDailyTasks = null;
    let CURRENT_DAILY_EDIT = null;
    let CURRENT_DAILY_WEEK = null;
    let CURRENT_DAILY_DAY  = null;

    function currentMonthKey(){
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function fillDailyMonthOptions(){
      if(!dailyMonthSelect) return;
      dailyMonthSelect.innerHTML='';
      const now=new Date();
      const year=now.getFullYear();
      for(let m=1;m<=12;m++){
        const key = `${year}-${String(m).padStart(2,'0')}`;
        const monthDate = new Date(year, m-1, 1);
        const label = monthDate.toLocaleDateString('ar-EG-u-ca-gregory',{month:'long'});
        const opt=document.createElement('option');
        opt.value=key; opt.textContent=label;
        dailyMonthSelect.appendChild(opt);
      }
      DAILY_MONTH_KEY = DAILY_MONTH_KEY || currentMonthKey();
      dailyMonthSelect.value = DAILY_MONTH_KEY;
      updateDailyMeta();
    }

    function updateDailyMeta(){
      if(!dailyMeta) return;
      const label = dailyMonthSelect.options[dailyMonthSelect.selectedIndex]?.textContent || '';
      const countMonth = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && !t.completed && t.dayKey!=='note').length;
      const countDone  = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.completed && t.dayKey!=='note').length;
      dailyMeta.textContent = `${label} â€” Ù…Ù‡Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„: ${countMonth} | ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${countDone}`;
    }

    function listenDailyTasks(){
      if(unsubDailyTasks){ unsubDailyTasks(); unsubDailyTasks=null; }
      unsubDailyTasks = onSnapshot(collection(db,'dailyTasks'), (snap)=>{
        DAILY_TASKS=[];
        snap.forEach(d=> DAILY_TASKS.push({ id:d.id, ...(d.data()||{}) }));
        renderDailyBoard();
      },(err)=>{
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.');
      });
    }

    function openDailyModal(mode, task=null){
      if(!IS_ADMIN) return;
      if(mode==='new'){
        CURRENT_DAILY_EDIT = null;
        dailyModalTitle.textContent='ØªØ§Ø³Ùƒ ÙŠÙˆÙ…ÙŠ Ø¬Ø¯ÙŠØ¯';
        dailyTitleInput.value='';
        dailyDescInput.value='';
        btnDailyDelete.style.display='none';
      }else if(mode==='edit' && task){
        CURRENT_DAILY_EDIT = task.id;
        CURRENT_DAILY_WEEK = task.week;
        CURRENT_DAILY_DAY  = task.dayKey;
        dailyModalTitle.textContent= task.dayKey === 'note' ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©' : 'ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ ÙŠÙˆÙ…ÙŠ';
        dailyTitleInput.value = task.title || '';
        dailyDescInput.value  = task.description || '';
        btnDailyDelete.style.display='';
      }
      dailyModal.classList.add('show');
    }

    function closeDailyModal(){
      dailyModal.classList.remove('show');
    }

    btnDailyCancel.addEventListener('click', ()=> closeDailyModal());
    dailyModal.addEventListener('click', (e)=>{ if(e.target===dailyModal) closeDailyModal(); });

    btnDailySave.addEventListener('click', async ()=>{
      if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.');
      const title = (dailyTitleInput.value||'').trim();
      const desc  = (dailyDescInput.value||'').trim() || null;
      if(!title) return alert('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.');

      try{
        if(CURRENT_DAILY_EDIT){
          await updateDoc(doc(db,'dailyTasks', CURRENT_DAILY_EDIT), {
            title,
            description: desc
          });
        }else{
          if(!CURRENT_DAILY_WEEK || !CURRENT_DAILY_DAY){
            alert('Ø§Ù„ÙŠÙˆÙ… ØºÙŠØ± Ù…Ø­Ø¯Ø¯ØŒ Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„.');
            return;
          }
          await addDoc(collection(db,'dailyTasks'), {
            monthKey: DAILY_MONTH_KEY,
            week: CURRENT_DAILY_WEEK,
            dayKey: CURRENT_DAILY_DAY,
            title,
            description: desc,
            completed:false,
            createdAt: serverTimestamp(),
            createdBy: CURRENT_USER?.uid || null
          });
        }
        closeDailyModal();
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: '+(err?.message||err));
      }
    });

    btnDailyDelete.addEventListener('click', async ()=>{
      if(!IS_ADMIN || !CURRENT_DAILY_EDIT) return;
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
      try{
        await deleteDoc(doc(db,'dailyTasks', CURRENT_DAILY_EDIT));
        closeDailyModal();
      }catch(err){
        console.error(err);
        alert('âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: '+(err?.message||err));
      }
    });

    function bootDailyTasks(){
      fillDailyMonthOptions();
      dailyMonthSelect.addEventListener('change', ()=>{
        DAILY_MONTH_KEY = dailyMonthSelect.value;
        renderDailyBoard();
      });
      listenDailyTasks();

      if(dailyBoard){
        dailyBoard.addEventListener('click', async (e)=>{
          const addBtn = e.target.closest('.day-add');
          const noteBtn = e.target.closest('.note-add');

          if(noteBtn){
            if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.');
            const text = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:');
            if(!text || !text.trim()) return;
            try{
              await addDoc(collection(db,'dailyTasks'), {
                monthKey: DAILY_MONTH_KEY,
                week: 0,
                dayKey: 'note',
                title: text.trim(),
                description: null,
                completed:false,
                createdAt: serverTimestamp(),
                createdBy: CURRENT_USER?.uid || null,
                type: 'note'
              });
            }catch(err){
              console.error(err);
              alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: '+(err?.message||err));
            }
            return;
          }

          if(addBtn && !addBtn.classList.contains('note-add')){
            if(!IS_ADMIN) return alert('Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.');
            const week = parseInt(addBtn.dataset.week,10);
            const dayKey = addBtn.dataset.day;
            CURRENT_DAILY_EDIT = null;
            CURRENT_DAILY_WEEK = week;
            CURRENT_DAILY_DAY  = dayKey;
            openDailyModal('new');
            return;
          }

          const doneBtn = e.target.closest('.daily-done-btn');
          if(doneBtn){
            const id = doneBtn.dataset.id;
            const task = DAILY_TASKS.find(t=>t.id===id);
            if(!task) return;
            try{
              await updateDoc(doc(db,'dailyTasks', id), {
                completed:true,
                completedAt: serverTimestamp()
              });
            }catch(err){
              console.error(err);
              alert('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø³Ùƒ: '+(err?.message||err));
            }
            return;
          }

          const cardEl = e.target.closest('.daily-card');
          if(cardEl && !e.target.closest('.daily-done-btn')){
            if(!IS_ADMIN) return;
            const id = cardEl.dataset.id;
            const task = DAILY_TASKS.find(t=>t.id===id);
            if(task){
              CURRENT_DAILY_WEEK = task.week;
              CURRENT_DAILY_DAY  = task.dayKey;
              openDailyModal('edit', task);
            }
          }
        });
      }
    }

    function renderDailyBoard(){
      if(!dailyBoard) return;
      DAILY_MONTH_KEY = DAILY_MONTH_KEY || currentMonthKey();
      if(dailyMonthSelect && dailyMonthSelect.value!==DAILY_MONTH_KEY){
        dailyMonthSelect.value = DAILY_MONTH_KEY;
      }

      dailyBoard.innerHTML='';

      DAILY_WEEKS.forEach(week=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.week=week;
        sec.innerHTML=`
          <div class="col-head" style="cursor:default">
            <span class="col-title">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week}</span>
          </div>
          <div class="col-body daily-week-body"></div>
        `;
        const body=sec.querySelector('.daily-week-body');

        DAILY_DAYS.forEach(day=>{
          const dayBox=document.createElement('div');
          dayBox.className='daily-day';
          dayBox.dataset.week=week;
          dayBox.dataset.day=day.key;
          dayBox.innerHTML=`
            <div class="daily-day-head">
              <span class="daily-day-name">${day.label}</span>
              ${IS_ADMIN?`<button class="day-add" data-week="${week}" data-day="${day.key}">â•</button>`:''}
            </div>
            <div class="daily-drop" data-week="${week}" data-day="${day.key}"></div>
          `;
          body.appendChild(dayBox);
        });

        dailyBoard.appendChild(sec);
      });

      const notesCol=document.createElement('section');
      notesCol.className='col';
      notesCol.dataset.week='notes';
      notesCol.innerHTML=`
        <div class="col-head" style="cursor:default">
          <span class="col-title">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
          ${IS_ADMIN?`<button class="day-add note-add">â•</button>`:''}
        </div>
        <div class="col-body">
          <div class="daily-drop" data-week="notes" data-day="note"></div>
        </div>
      `;
      dailyBoard.appendChild(notesCol);

      const doneCol=document.createElement('section');
      doneCol.className='col daily-done-col';
      doneCol.innerHTML=`
        <div class="col-head" style="cursor:default">
          <span class="col-title">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
        </div>
        <div class="col-body">
          <div class="daily-drop" data-week="done" data-day="done"></div>
        </div>
      `;
      dailyBoard.appendChild(doneCol);

      const activeTasks = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && !t.completed && t.dayKey!=='note');
      const notesTasks  = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.dayKey==='note');
      const doneTasks   = DAILY_TASKS.filter(t=>t.monthKey===DAILY_MONTH_KEY && t.completed && t.dayKey!=='note');

      activeTasks.forEach(t=>{
        const zone = dailyBoard.querySelector(`.daily-drop[data-week="${t.week}"][data-day="${t.dayKey}"]`);
        if(!zone) return;
        const card = buildDailyCard(t,false);
        zone.appendChild(card);
      });

      const notesZone = dailyBoard.querySelector('.daily-drop[data-week="notes"][data-day="note"]');
      notesTasks.forEach(t=>{
        if(!notesZone) return;
        const card = buildNoteCard(t);
        notesZone.appendChild(card);
      });

      const doneZone = dailyBoard.querySelector('.daily-drop[data-week="done"][data-day="done"]');
      doneTasks.forEach(t=>{
        if(!doneZone) return;
        const card = buildDailyCard(t,true);
        doneZone.appendChild(card);
      });

      dailyBoard.querySelectorAll('.daily-drop').forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if(zone.dataset.week==='notes') return;
          if(e.dataTransfer.types.includes(MIME_DAILY)){
            e.preventDefault();
            zone.classList.add('drag');
          }
        });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          if(zone.dataset.week==='notes') return;
          if(!e.dataTransfer.types.includes(MIME_DAILY)) return;
          e.preventDefault();
          zone.classList.remove('drag');
          const id = e.dataTransfer.getData(MIME_DAILY);
          const task = DAILY_TASKS.find(t=>t.id===id);
          if(!task) return;
          const week = zone.dataset.week;
          const day  = zone.dataset.day;
          try{
            if(week==='done'){
              await updateDoc(doc(db,'dailyTasks', id), {
                completed:true,
                completedAt: serverTimestamp()
              });
            }else{
              await updateDoc(doc(db,'dailyTasks', id), {
                week: parseInt(week,10),
                dayKey: day,
                completed:false
              });
            }
          }catch(err){
            console.error(err);
            alert('âš ï¸ ØªØ¹Ø°Ø± Ù†Ù‚Ù„ Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ: '+(err?.message||err));
          }
        });
      });

      updateDailyMeta();
    }

    function buildDailyCard(t, isDone){
      const card=document.createElement('article');
      card.className='card daily-card';
      card.dataset.id=t.id;
      card.setAttribute('draggable','true');

      const title = t.title || '-';
      const desc  = t.description || '';

      const inner=document.createElement('div');
      inner.className='row between';
      const left=document.createElement('div');
      left.innerHTML = `
        <p class="daily-card-title">${title}</p>
        ${desc?`<p class="daily-card-desc">${desc}</p>`:''}
      `;
      inner.appendChild(left);

      if(!isDone){
        const right=document.createElement('div');
        if(IS_ADMIN){
          const btn=document.createElement('button');
          btn.className='btn secondary xs daily-done-btn';
          btn.textContent='ØªÙ…';
          btn.dataset.id=t.id;
          right.appendChild(btn);
        }
        inner.appendChild(right);
      }

      card.appendChild(inner);

      card.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData(MIME_DAILY, t.id);
      });

      return card;
    }

    function buildNoteCard(t){
      const card=document.createElement('article');
      card.className='card daily-card';
      card.dataset.id=t.id;

      const title = t.title || '-';
      const desc  = t.description || '';

      card.innerHTML = `
        <p class="daily-card-title">${title}</p>
        ${desc?`<p class="daily-card-desc">${desc}</p>`:''}
      `;
      return card;
    }
  </script>

</body>
</html>
