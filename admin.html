<!-- Firebase Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
    authDomain: "mzj-workspace.firebaseapp.com",
    projectId: "mzj-workspace"
  });
  const db = getFirestore(app);

  async function refreshProjects(){
    const ul = document.getElementById('projList'); ul.innerHTML='';
    const snap = await getDocs(collection(db,'projects'));
    snap.forEach(d=>{
      const p=d.data();
      const li=document.createElement('li');
      li.textContent = `${p.name||'-'} â€” ${p.department||'-'}`;
      ul.appendChild(li);
    });
  }

  document.getElementById('btnCreateProject').addEventListener('click', async ()=>{
    const name = document.getElementById('projName').value.trim();
    const department = document.getElementById('projDept').value;
    const start = document.getElementById('projStart').value || null;
    if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
    await addDoc(collection(db,'projects'), { name, department, start, active:true, createdAt: serverTimestamp() });
    document.getElementById('projName').value='';
    refreshProjects();
    alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
  });

  refreshProjects();
</script>

<!-- ğŸ”’ ÙƒÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…ÙÙ† / Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const auth = getAuth();
  const db2   = getFirestore();

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const u = await getDoc(doc(db2, "users", user.uid));
    const role = u.exists() ? u.data().role : "member";

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…ÙÙ†
    ["btnCreateProject"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.style.display = role === "admin" ? "inline-flex" : "none";
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    const name = u.exists() ? u.data().name : "Ø¹Ø¶Ùˆ";
    const topbar = document.querySelector(".brand strong");
    if (topbar) topbar.textContent = `${name} (${role === "admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ"})`;
  });
</script>
