<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial;line-height:1.75}
    a{color:inherit;text-decoration:none}
    .layout{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--brown);color:#fff;box-shadow:0 4px 16px rgba(62,36,32,.18)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}
    .page{padding:20px;display:grid;gap:18px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media(max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 8px 26px rgba(62,36,32,.10)}
    .card h3{margin:0 0 12px;color:var(--brown)}
    label{display:block;margin:8px 0 6px;font-weight:700;color:var(--brown)}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-family:inherit}
    textarea{min-height:120px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:12px 14px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f7e9e0;color:var(--brown);padding:6px 10px;border-radius:999px;font-size:13px}
    .chip button{all:unset;cursor:pointer;opacity:.7}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;inset-inline:0 auto;top:calc(100% + 6px);z-index:9999;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(62,36,32,.12);max-height:260px;overflow:auto;display:none}
    .dropdown-menu.show{display:block}
    .dd-item{padding:10px 12px;border-bottom:1px solid #f3f3f3;cursor:pointer}
    .dd-item:hover{background:#fff8ef}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown)}
    .list{display:grid}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #f5f5f5}
    .muted{color:var(--muted)}
    .footer{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19)}
    .hint{font-size:12px;color:var(--muted)}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="layout">
    <header class="topbar">
      <div class="brand">
        <span class="brand-badge"></span>
        <strong>MZJ Workspace â€” Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong>
      </div>
      <nav class="nav">
        <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="projects.html">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
        <a href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
        <a href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </nav>
    </header>

    <main class="page">
      <div class="grid">
        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø§Ø­ØªØ±Ø§ÙÙŠ -->
        <section class="card">
          <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>

          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
          <input id="projName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù…Ù„Ø© Ø£Ù‚Ø³Ø§Ø· Ù†ÙˆÙÙ…Ø¨Ø±"/>

          <div class="row">
            <div>
              <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
              <div class="dropdown">
                <select id="projCategory">
                  <option value="Ø­Ù…Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ©">Ø­Ù…Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ©</option>
                  <option value="Ø¥Ù†ØªØ§Ø¬ Ù…Ø­ØªÙˆÙ‰">Ø¥Ù†ØªØ§Ø¬ Ù…Ø­ØªÙˆÙ‰</option>
                  <option value="Ù…Ø¨ÙŠØ¹Ø§Øª">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                  <option value="ØªØ­Ø³ÙŠÙ† Ù…ÙˆÙ‚Ø¹">ØªØ­Ø³ÙŠÙ† Ù…ÙˆÙ‚Ø¹</option>
                  <option value="Ø¯Ø¹Ù…">Ø¯Ø¹Ù…</option>
                </select>
              </div>
            </div>
            <div>
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <select id="projDept">
                <option>Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
                <option>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                <option>Ø§Ù„Ø¯Ø¹Ù…</option>
                <option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
              <input id="projStart" type="date"/>
            </div>
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
              <input id="projDue" type="date"/>
            </div>
          </div>

          <label>Ø§Ù„ÙˆØµÙ (Ø§ÙƒØªØ¨ @ Ù„Ø°ÙƒØ± Ø¹Ø¶Ùˆ)</label>
          <div class="dropdown">
            <textarea id="projDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹â€¦ Ø§ÙƒØªØ¨ @ Ù„Ø°ÙƒØ± Ø¹Ø¶Ùˆ."></textarea>
            <div id="mentionList" class="dropdown-menu"></div>
          </div>
          <div class="hint">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù€UIDs Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ <code>mentions[]</code>.</div>

          <label>ØªØ¹ÙŠÙŠÙ† Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯)</label>
          <div class="dropdown">
            <input id="assigneeSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆâ€¦"/>
            <div id="assigneeMenu" class="dropdown-menu"></div>
          </div>
          <div id="assigneeChips" class="chips"></div>

          <div class="inline" style="margin-top:12px">
            <button class="btn" id="btnCreateProject">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
            <button class="btn secondary" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <span class="hint">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø°ÙƒÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ù…ÙØ¹ÙŠÙ‘Ù†ÙŠÙ†.</span>
          </div>
        </section>

        <!-- Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ø§ÙŠÙ) -->
        <section class="card">
          <h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
          <div id="projList" class="list">
            <div class="item muted">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
          </div>
        </section>
      </div>
    </main>

    <footer class="footer"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></footer>
  </div>

  <!-- Firebase + Mentions + Assignees + Notifications + Live Projects -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, addDoc, serverTimestamp,
      doc, getDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    // Ø­Ø§Ø±Ø³ Ø§Ù„Ø¯Ø®ÙˆÙ„
    window.mzjLogout = async ()=>{ await signOut(auth); location.href = "login.html"; };
    onAuthStateChanged(auth, (user)=>{ if(!user) location.href="login.html"; });

    // ========= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ø¥ØªØ§Ø­Ø© mentions & multi-select =========
    let USERS = [];                // {uid, name, role}
    let SELECTED_ASSIGNEES = [];   // uids
    let MENTIONS = [];             // uids

    async function loadUsers(){
      try {
        const snap = await getDocs(collection(db,"users"));
        USERS = [];
        snap.forEach(d=>{
          const u = d.data() || {};
          USERS.push({ uid:d.id, name:u.name || d.id.slice(0,6), role:u.role || "member" });
        });
        renderAssigneeMenu('');
        // ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø®Ù„ÙŠÙ‡ ÙØ§Ø¶ÙŠØŒ Ù‡ÙŠØªØ­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ù€@
        renderMentionMenu('');
      } catch (e) {
        console.error("loadUsers()", e);
        alert("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore (users read).");
      }
    }
    await loadUsers();

    // ========= Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† =========
    const elAssSearch = document.getElementById('assigneeSearch');
    const elAssMenu   = document.getElementById('assigneeMenu');
    const elAssChips  = document.getElementById('assigneeChips');

    function renderAssigneeMenu(filter){
      const f = (filter||'').toLowerCase();
      elAssMenu.innerHTML = '';
      USERS.filter(u => u.name.toLowerCase().includes(f)).forEach(u=>{
        const div = document.createElement('div');
        div.className = 'dd-item';
        div.innerHTML = `${u.name} <span class="muted">(${u.role})</span>`;
        div.onclick = ()=> addAssignee(u);
        elAssMenu.appendChild(div);
      });
    }
    function addAssignee(u){
      if (SELECTED_ASSIGNEES.includes(u.uid)) return;
      SELECTED_ASSIGNEES.push(u.uid);
      const chip = document.createElement('span');
      chip.className='chip';
      chip.dataset.uid = u.uid;
      chip.innerHTML = `${u.name}<button title="Ø¥Ø²Ø§Ù„Ø©">âœ•</button>`;
      chip.querySelector('button').onclick = ()=>{
        SELECTED_ASSIGNEES = SELECTED_ASSIGNEES.filter(id=>id!==u.uid);
        chip.remove();
      };
      elAssChips.appendChild(chip);
    }
    elAssSearch.addEventListener('input', (e)=>{
      const val = e.target.value.trim();
      elAssMenu.classList.add('show');
      renderAssigneeMenu(val);
    });
    elAssSearch.addEventListener('focus', ()=>{
      elAssMenu.classList.add('show');
      renderAssigneeMenu(elAssSearch.value);
    });
    document.addEventListener('click', (e)=>{
      if (!elAssMenu.contains(e.target) && e.target!==elAssSearch) elAssMenu.classList.remove('show');
      if (!elMentionMenu.contains(e.target) && e.target!==elDesc) elMentionMenu.classList.remove('show');
    });

    // ========= Mentions (@) Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØµÙ =========
    const elDesc = document.getElementById('projDesc');
    const elMentionMenu = document.getElementById('mentionList');

    function getAtToken(text, caret){
      const i = text.lastIndexOf('@', caret-1);
      if (i === -1) return null;
      const after = text.slice(i+1, caret);
      if (after.includes(' ') || after.includes('\n')) return null;
      return { start:i, query:after.trim() };
    }
    function showMentionMenu(query){
      const f = (query||'').toLowerCase();
      elMentionMenu.innerHTML = '';
      const results = USERS.filter(u => u.name.toLowerCase().includes(f)).slice(0,8);
      if (!results.length){ elMentionMenu.classList.remove('show'); return; }
      results.forEach(u=>{
        const it = document.createElement('div');
        it.className = 'dd-item';
        it.textContent = u.name + (u.role?` (${u.role})`:'');
        it.onclick = ()=> insertMention(u);
        elMentionMenu.appendChild(it);
      });
      elMentionMenu.classList.add('show');
    }
    function insertMention(u){
      const start = elDesc.selectionStart;
      const token = getAtToken(elDesc.value, start);
      if (!token) { elMentionMenu.classList.remove('show'); return; }
      const before = elDesc.value.slice(0, token.start);
      const after  = elDesc.value.slice(start);
      const textToInsert = '@' + u.name + ' ';
      elDesc.value = before + textToInsert + after;
      const pos = before.length + textToInsert.length;
      elDesc.setSelectionRange(pos, pos);
      if (!MENTIONS.includes(u.uid)) MENTIONS.push(u.uid);
      elMentionMenu.classList.remove('show');
      elDesc.focus();
    }
    elDesc.addEventListener('input', ()=>{
      const caret = elDesc.selectionStart;
      const token = getAtToken(elDesc.value, caret);
      if (token) showMentionMenu(token.query); else elMentionMenu.classList.remove('show');
    });
    elDesc.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') elMentionMenu.classList.remove('show'); });
    elDesc.addEventListener('blur', ()=> setTimeout(()=> elMentionMenu.classList.remove('show'), 120));

    // ========= Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =========
    async function createNotifications(uids, projectId, projectName){
      const unique = [...new Set(uids.filter(Boolean))];
      const jobs = unique.map(uid=> addDoc(collection(db,'notifications'), {
        toUid: uid, type: 'project_assigned',
        projectId, projectName, createdAt: serverTimestamp(), read:false
      }));
      try{ await Promise.all(jobs); }catch(e){ console.warn('notify error', e); }
    }

    // ========= Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ =========
    const elName  = document.getElementById('projName');
    const elCat   = document.getElementById('projCategory');
    const elDept  = document.getElementById('projDept');
    const elStart = document.getElementById('projStart');
    const elDue   = document.getElementById('projDue');

    document.getElementById('btnCreateProject').addEventListener('click', async ()=>{
      const name = elName.value.trim();
      if (!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');

      const payload = {
        name,
        category: elCat.value,
        department: elDept.value,
        start: elStart.value || null,
        due: elDue.value || null,
        description: elDesc.value || null,
        assignees: SELECTED_ASSIGNEES,
        mentions: MENTIONS,
        status: 'open',
        active: true,
        createdBy: auth.currentUser?.uid || null,
        createdAt: serverTimestamp()
      };
      try{
        const ref = await addDoc(collection(db,'projects'), payload);
        await createNotifications([...SELECTED_ASSIGNEES, ...MENTIONS], ref.id, name);
        alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­');
        resetForm();
      }catch(e){
        console.error(e);
        if (e?.code==='permission-denied') {
          alert('âš ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…ÙÙ† ÙÙ‚Ø·.\nØªØ£ÙƒØ¯ Ø£Ù† Ø­Ø³Ø§Ø¨Ùƒ role=admin ÙÙŠ users/{UID} ÙˆØ£Ù† Rules Ù…Ù†Ø´ÙˆØ±Ø©.');
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
        }
      }
    });

    function resetForm(){
      elName.value=''; elDesc.value=''; elStart.value=''; elDue.value='';
      SELECTED_ASSIGNEES=[]; MENTIONS=[];
      document.getElementById('assigneeChips').innerHTML='';
      document.getElementById('assigneeSearch').value='';
      document.getElementById('assigneeMenu').classList.remove('show');
      document.getElementById('mentionList').classList.remove('show');
    }
    document.getElementById('btnReset').addEventListener('click', resetForm);

    // ========= Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Live (Ø¨Ø¯ÙˆÙ† orderByØ› ØªØ±ØªÙŠØ¨ ÙŠØ¯ÙˆÙŠ) =========
    const projList = document.getElementById('projList');
    onSnapshot(collection(db,'projects'), (snap)=>{
      projList.innerHTML='';
      if (snap.empty){
        projList.innerHTML = `<div class="item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      const rows=[];
      snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
      rows.sort((a,b)=>{
        const at=(a.createdAt?.seconds||0), bt=(b.createdAt?.seconds||0);
        if (bt !== at) return bt - at;
        return (''+a.name).localeCompare(b.name||'');
      });
      rows.forEach(p=>{
        const membersCount=(p.assignees||[]).length;
        const row=document.createElement('div');
        row.className='item';
        row.innerHTML=`
          <span>
            ${p.name||'-'}
            <span class="badge">${p.category||'â€”'}</span>
            <span class="badge">${p.department||'â€”'}</span>
          </span>
          <span class="muted">
            ${p.start||'â€”'} â†’ ${p.due||'â€”'} â€¢ ğŸ‘¥ ${membersCount}
          </span>`;
        projList.appendChild(row);
      });
    }, (err)=>{
      console.error(err);
      if (err?.code==='permission-denied') alert('âš ï¸ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹.\nØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ØªØ³Ù…Ø­ read Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ†.');
    });
  </script>
</body>
</html>
