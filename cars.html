<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ — Production Tracker (Editor + Readonly Results)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --danger:#ef4444; --shadow:0 6px 20px rgba(0,0,0,.06) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.7}
  .container{max-width:1280px;margin:24px auto;padding:0 16px}
  .topbar{background:linear-gradient(135deg, rgba(62,36,32,.96), rgba(62,36,32,.85));color:#fff;border-radius:16px;padding:20px 18px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{width:42px;height:42px;border-radius:10px;background:var(--beige);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:inset 0 0 0 2px rgba(255,255,255,.35)}
  h1{margin:0;font-size:20px}
  .muted{color:#e8d9cf;font-size:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button,.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--beige);color:#fff}
  .btn-secondary{background:#ffffff1a;color:#fff;border:1px solid #ffffff3a}
  .btn-ghost{background:#fff;color:var(--brown);border:1px solid #ece1d9}
  .btn-danger{background:var(--danger);color:#fff}
  .panel{background:#fff;border:1px solid #f0e6df;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:14px}
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media (max-width:1100px){ .grid-4{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid-4{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid #f0e6df;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .metric{display:flex;align-items:center;justify-content:space-between}
  .metric h3{margin:0;font-size:14px;color:var(--muted)}
  .metric strong{font-size:22px}
  label{font-weight:700;font-size:13px;color:var(--brown);display:block;margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e7dbd2;background:#fff;outline:none;font-size:14px}
  input:focus,select:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.18)}
  .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  @media (max-width:1100px){ .row{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  .table-soft{overflow:auto;border-radius:16px;border:1px solid #f0e6df}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:1400px;background:#fff}
  thead th{position:sticky;top:0;background:#fbf6f1;color:var(--brown);padding:12px 10px;border-bottom:1px solid #f0e6df;font-size:13px;z-index:2;text-align:right}
  tbody td{padding:10px;border-bottom:1px solid #f7eee7;font-size:13px;vertical-align:middle}
  tbody tr:nth-child(even){background:#fffdfa}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #eaded6;font-weight:700;font-size:12px;background:#fff;white-space:nowrap}
  .p-green{background:#ecfdf5;border-color:#a7f3d0}
  .p-orange{background:#fff7ed;border-color:#fed7aa}
  .p-gray{background:#f3f4f6;border-color:#e5e7eb}

  .hidden{display:none !important}
  .banner{margin-top:8px;background:#fff4e6;color:#5b3b2f;border:1px solid #f0e0d6;padding:8px 10px;border-radius:10px}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
  <div class="container">
    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">MZJ</div>
        <div>
          <h1>لوحة متابعة إنتاج المحتوى للسيارات</h1>
          <div id="roleBanner" class="muted"></div>
        </div>
      </div>
      <div class="actions">
        <button id="btnExportXLSX" class="btn btn-secondary">تصدير XLSX</button>
        <label class="btn btn-secondary" for="xlsxImport" style="cursor:pointer">استيراد XLSX (إضافة)</label>
        <input id="xlsxImport" type="file" accept=".xlsx" style="display:none"/>
        <button id="btnTemplate" class="btn btn-ghost">تحميل Template XLSX</button>
        <button id="btnReset" class="btn btn-danger">تفريغ البيانات (محلي)</button>
      </div>
    </div>

    <div id="loginWarn" class="banner hidden">يجب تسجيل الدخول لعرض/إضافة البيانات.</div>

    <!-- KPIs -->
    <div class="grid grid-4 panel" style="margin-top:14px">
      <div class="card metric"><h3>إجمالي السيارات</h3><strong id="kTotal">0</strong></div>
      <div class="card metric"><h3>تم التصوير</h3><strong id="kShot">0</strong></div>
      <div class="card metric"><h3>تحت المونتاج</h3><strong id="kEditing">0</strong></div>
      <div class="card metric"><h3>داخل الأجندة</h3><strong id="kAgenda">0</strong></div>
    </div>

    <!-- إضافة سريعة -->
    <div id="editorPanel" class="panel hidden">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">إضافة سيارة سريعة</h2>
      <div class="row">
        <div><label>العلامة</label><select id="iBrand"></select></div>
        <div><label>الموديل</label><select id="iModel" disabled></select></div>
        <div><label>السنة</label><input id="iYear" type="number" min="2015" max="2030" value="2026"></div>
        <div><label>الفئة</label><select id="iTrim"></select></div>
        <div><label>اللون الخارجي</label><input id="iColor" placeholder="مثال: أبيض لؤلؤي"></div>
        <div><label>اللون الداخلي</label><input id="iIntColor" placeholder="مثال: جلد بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Status – تصوير</label><select id="iShoot"></select></div>
        <div><label>Status – مونتاج</label><select id="iEdit"></select></div>
        <div><label>نوع المحتوى</label><select id="iType"></select></div>
        <div><label>تاريخ التصوير</label><input id="iShootDate" type="date"></div>
        <div><label>داخل الأجندة؟</label><select id="iInAgenda"></select></div>
        <div id="agendaFields" class="hidden">
          <label>تاريخ الأجندة</label>
          <div style="display:flex;gap:8px">
            <select id="iAgendaMonth"></select>
            <input id="iAgendaYear" type="number" min="2020" max="2035" value="">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>مرفوع على الموقع؟</label><select id="iOnSite"></select></div>
        <div id="siteLinkField" class="hidden" style="grid-column: span 2">
          <label>رابط صفحة السيارة (اختياري)</label>
          <input id="iSiteLink" placeholder="https://mzjcars.com/...">
        </div>
        <div style="grid-column: span 2"><label>ملاحظات</label><input id="iNotes" placeholder="مثلاً: ينتظر مراجعة SEO / صور ناقصة"></div>
        <div><label>&nbsp;</label><button id="btnAdd" class="btn btn-primary" style="width:100%">إضافة</button></div>
      </div>
      <div class="muted" style="margin-top:6px">* الحفظ على Firestore (collection: <code>cars_production</code>). الاستيراد XLSX يضيف على الموجود.</div>
    </div>

    <!-- جدول التحرير -->
    <div class="panel table-soft" style="padding:0">
      <table id="carsTable">
        <thead>
          <tr>
            <th>العلامة</th><th>الموديل</th><th>السنة</th><th>الفئة</th>
            <th>اللون الخارجي</th><th>اللون الداخلي</th>
            <th>تصوير</th><th>مونتاج</th><th>نوع المحتوى</th>
            <th>تاريخ التصوير</th><th>داخل الأجندة؟</th><th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th><th>رابط الصفحة</th><th>ملاحظات</th><th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- فلاتر + نتيجة عرض فقط -->
    <div class="panel">
      <h2 style="margin:0 0 10px 0;color:var(--brown);font-size:18px">نتيجة الفلتر (عرض فقط)</h2>
      <div class="row">
        <div><label>العلامة</label><select id="dBrand"><option value="">الكل</option></select></div>
        <div><label>الفئة</label><select id="dTrim"><option value="">الكل</option></select></div>
        <div><label>تصوير</label><select id="dShoot"><option value="">الكل</option></select></div>
        <div><label>مونتاج</label><select id="dEdit"><option value="">الكل</option></select></div>
        <div><label>اللون الخارجي</label><input id="dColor" placeholder="مثال: أبيض"></div>
        <div><label>اللون الداخلي</label><input id="dIntColor" placeholder="مثال: بيج"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>داخل الأجندة؟</label><select id="dAgenda"><option value="">الكل</option></select></div>
        <div style="grid-column: span 5"><label>بحث نصّي</label><input id="dSearch" placeholder="ابحث في الموديل/الملاحظات/الألوان"></div>
      </div>
    </div>

    <div class="panel table-soft" style="padding:0;margin-top:8px">
      <table id="filteredTable">
        <thead>
          <tr>
            <th>العلامة</th>
            <th>الموديل</th>
            <th>السنة</th>
            <th>الفئة</th>
            <th>اللون الخارجي</th>
            <th>اللون الداخلي</th>
            <th>تصوير</th>
            <th>مونتاج</th>
            <th>نوع المحتوى</th>
            <th>تاريخ التصوير</th>
            <th>داخل الأجندة؟</th>
            <th>تاريخ الأجندة</th>
            <th>مرفوع على الموقع؟</th>
            <th>رابط الصفحة</th>
            <th>ملاحظات</th>
          </tr>
        </thead>
        <tbody id="filteredTBody"></tbody>
      </table>
      <div class="muted" id="flatMeta" style="padding:10px"></div>
    </div>
  </div>

<!-- ======================= Firebase + App ======================= -->
<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* ====== إعداد Firebase (عدّل لو عندك مشروع مختلف) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
  authDomain: "mzj-workspace.firebaseapp.com",
  projectId: "mzj-workspace",
  storageBucket: "mzj-workspace.firebasestorage.app",
  appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
};
if (!getApps().length) initializeApp(firebaseConfig);
const auth = getAuth();
const db   = getFirestore();

/* ---------- ثوابت الصفحة (خاصة بهذه الصفحة فقط) ---------- */
const CARS_COL = "cars_production"; // كولكشن مستقل للصفحة دي فقط

/* ---------- بيانات ثابتة للقوائم ---------- */
const BRANDS = ["هيونداي","شانجان","شيري","فورد","ام جي","نيسان"];
const MODELS_BY_BRAND = {
  "هيونداي": ["سوناتا","النترا","اكسنت","جراند i10","كريتا","جراند كريتا","ستار جيزر","فينيو","ازيرا","سنتافي","توسان","كونا","ستاريا","بالسييد"],
  "شانجان": ["سي اس 75","سي اس 35","ايدو بلس","ال سيفن","يوني كي","يوني تي","يوني في","سي اس 95","يوني اس","هانتر اب"],
  "شيري": ["تيجو 2 برو","اريزو 8","اريزو 6 برو","اريزو 5 برو","أكسييد ال اكس","تيجو 8 برة","تيجو 7","تيجو 4 برو"],
  "فورد": ["رينجر","اكسبلور","تيريتوري","تورس"],
  "ام جي": ["جي تي","ام جي 3","ام جي 7","ام جي 5","اتش أس","ار اكس 5","ون","زد أس","تي 60","ار أكس 9","وال","ار أكس 8"],
  "نيسان": ["اكس تريل","ماجنايت","كيكس","صني","اكس تيرا","التيما"]
};
const TRIMS  = ["ستاندر","سمارت","سمارت بلس","كومفورت","فل كامل","ترند","امبيانتي","رويـال"];
const SHOOT_STATUS = ["لم يُصوّر","تم التصوير","بانتظار مراجعة"];
const EDIT_STATUS  = ["لم يبدأ","جاري","تم الانتهاء"];
const CONTENT_TYPES = ["صور","فيديو","ريل","موشن","AI"];
const YESNO = ["لا","نعم"];
const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

/* ---------- عناصر DOM ---------- */
const $ = s=>document.querySelector(s);
const banner = $("#loginWarn");
const roleBanner = $("#roleBanner");
const editor = $("#editorPanel");
const btnAdd = $("#btnAdd");

/* ---------- دور المستخدم ---------- */
let CURRENT_USER = null;
let IS_ADMIN = false;

async function loadRole(uid){
  try{
    const u = await getDoc(doc(db,"users", uid));
    return u.exists() ? (u.data().role || "member") : "member";
  }catch{ return "member"; }
}

/* ---------- تعبئة القوائم ---------- */
function fillSelect(el, arr, withBlank=false, blankLabel="— اختر —"){
  el.innerHTML = withBlank ? `<option value="">${blankLabel}</option>` : "";
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v; el.appendChild(o);
  });
}
function initAddFields(){
  fillSelect($("#iBrand"), BRANDS, true);
  fillSelect($("#iTrim"), TRIMS, true);
  fillSelect($("#iShoot"), SHOOT_STATUS, true);
  fillSelect($("#iEdit"), EDIT_STATUS, true);
  fillSelect($("#iType"), CONTENT_TYPES, true);
  fillSelect($("#iInAgenda"), YESNO, true);
  fillSelect($("#iOnSite"), YESNO, true);
  fillSelect($("#iAgendaMonth"), MONTHS, true);
  $("#iAgendaYear").value = new Date().getFullYear();

  // بعد اختيار العلامة — فعّل الموديل
  $("#iBrand").addEventListener("change", ()=>{
    const b = $("#iBrand").value;
    const models = MODELS_BY_BRAND[b] || [];
    $("#iModel").disabled = models.length===0;
    fillSelect($("#iModel"), models, true);
  });

  // حقول شرطية
  $("#iInAgenda").addEventListener("change", ()=>{
    $("#agendaFields").classList.toggle("hidden", $("#iInAgenda").value!=="نعم");
  });
  $("#iOnSite").addEventListener("change", ()=>{
    $("#siteLinkField").classList.toggle("hidden", $("#iOnSite").value!=="نعم");
  });

  // افتراضيًا اجعل العلامة الأولى مختارة لفتح الموديلات بسرعة (اختياري)
  if(!$("#iBrand").value){
    $("#iBrand").value = BRANDS[0];
    $("#iBrand").dispatchEvent(new Event("change"));
  }
}

/* ---------- جدول التحرير المحلي (عرض + تعديل محلي) ---------- */
let LOCAL_ROWS = []; // سنملأه من Firestore

function escapeHTML(s){ return (s==null?"":String(s)).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
function textCell(v){ return escapeHTML(v??""); }

function renderEditorTable(){
  const tb = $("#tbody"); tb.innerHTML = "";
  LOCAL_ROWS.forEach((r,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${textCell(r.brand)}</td>
      <td>${textCell(r.model)}</td>
      <td>${textCell(r.year)}</td>
      <td>${textCell(r.trim)}</td>
      <td>${textCell(r.color)}</td>
      <td>${textCell(r.intColor)}</td>
      <td>${textCell(r.shoot)}</td>
      <td>${textCell(r.edit)}</td>
      <td>${textCell(r.ctype)}</td>
      <td>${textCell(r.shootDate)}</td>
      <td>${textCell(r.inAgenda)}</td>
      <td>${textCell(r.agendaDate)}</td>
      <td>${textCell(r.onSite)}</td>
      <td>${r.siteLink?`<a href="${escapeHTML(r.siteLink)}" target="_blank" rel="noopener">فتح</a>`:"—"}</td>
      <td>${textCell(r.notes)}</td>
      <td>
        <button class="btn btn-ghost" data-act="dup" data-idx="${idx}">نسخ</button>
        <button class="btn btn-danger" data-act="del" data-idx="${idx}">حذف</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* ---------- KPIs + جدول الفلاتر ---------- */
let FILTERS = {brand:"", trim:"", shoot:"", edit:"", color:"", intColor:"", agenda:"", q:""};

function badge(val, kind){
  const cls = kind==="g"?"p-green":kind==="o"?"p-orange":"p-gray";
  return `<span class="pill ${cls}">${escapeHTML(val)}</span>`;
}
function renderFiltered(){
  const list = LOCAL_ROWS.filter(r=>{
    if(FILTERS.brand && r.brand!==FILTERS.brand) return false;
    if(FILTERS.trim && r.trim!==FILTERS.trim) return false;
    if(FILTERS.shoot && r.shoot!==FILTERS.shoot) return false;
    if(FILTERS.edit && r.edit!==FILTERS.edit) return false;
    if(FILTERS.color && !(r.color||"").toLowerCase().includes(FILTERS.color.toLowerCase())) return false;
    if(FILTERS.intColor && !(r.intColor||"").toLowerCase().includes(FILTERS.intColor.toLowerCase())) return false;
    if(FILTERS.agenda && r.inAgenda!==FILTERS.agenda) return false;
    if(FILTERS.q){
      const hay = `${r.brand} ${r.model} ${r.trim} ${r.color||""} ${r.intColor||""} ${r.notes||""}`.toLowerCase();
      if(!hay.includes(FILTERS.q.toLowerCase())) return false;
    }
    return true;
  });

  const tb = $("#filteredTBody"); tb.innerHTML="";
  if(!list.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="15" style="padding:14px">لا توجد نتائج مطابقة.</td>`;
    tb.appendChild(tr);
  }else{
    list.forEach(r=>{
      const shootP = r.shoot==="تم التصوير" ? badge(r.shoot,"g") : r.shoot==="بانتظار مراجعة" ? badge(r.shoot,"o") : badge(r.shoot,"x");
      const editP  = r.edit==="تم الانتهاء" ? badge(r.edit,"g") : r.edit==="جاري" ? badge(r.edit,"o") : badge(r.edit,"x");
      const agendaP= r.inAgenda==="نعم" ? badge("نعم","g") : badge("لا","x");
      const siteP  = r.onSite==="نعم" ? badge("نعم","g") : badge("لا","x");
      const link   = (r.onSite==="نعم" && r.siteLink) ? `<a href="${escapeHTML(r.siteLink)}" target="_blank" rel="noopener">${escapeHTML(r.siteLink)}</a>` : "—";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(r.brand||"—")}</td>
        <td>${escapeHTML(r.model||"—")}</td>
        <td>${escapeHTML(r.year||"—")}</td>
        <td>${escapeHTML(r.trim||"—")}</td>
        <td>${escapeHTML(r.color||"—")}</td>
        <td>${escapeHTML(r.intColor||"—")}</td>
        <td>${shootP}</td>
        <td>${editP}</td>
        <td>${escapeHTML(r.ctype||"—")}</td>
        <td>${escapeHTML(r.shootDate||"—")}</td>
        <td>${agendaP}</td>
        <td>${escapeHTML(r.agendaDate||"—")}</td>
        <td>${siteP}</td>
        <td>${link}</td>
        <td>${escapeHTML(r.notes||"—")}</td>
      `;
      tb.appendChild(tr);
    });
  }

  $("#flatMeta").textContent = `${list.length} نتيجة — عرض فقط`;
  $("#kTotal").textContent   = LOCAL_ROWS.length;
  $("#kShot").textContent    = LOCAL_ROWS.filter(r=>r.shoot==="تم التصوير").length;
  $("#kEditing").textContent = LOCAL_ROWS.filter(r=>r.edit==="جاري").length;
  $("#kAgenda").textContent  = LOCAL_ROWS.filter(r=>r.inAgenda==="نعم").length;
}

/* ---------- Events ---------- */
document.addEventListener("click",(e)=>{
  const b = e.target.closest("button");
  if(!b) return;

  if(b.id==="btnAdd") handleAdd();
  if(b.id==="btnExportXLSX") exportXLSX();
  if(b.id==="btnTemplate") downloadTemplate();
  if(b.id==="btnReset"){ if(confirm("مسح البيانات المخزنة محليًا (لا يمس Firestore)؟")){ LOCAL_ROWS=[]; renderEditorTable(); renderFiltered(); } }

  if(b.dataset.act==="del"){
    const idx = +b.dataset.idx;
    const item = LOCAL_ROWS[idx];
    if(item?.__id){
      if(confirm("حذف من Firestore؟")) deleteDoc(doc(db, CARS_COL, item.__id));
    }
  }
  if(b.dataset.act==="dup"){
    const idx = +b.dataset.idx;
    const base = LOCAL_ROWS[idx];
    if(base){
      const copy = {...base}; delete copy.__id; copy.createdAt = serverTimestamp();
      addDoc(collection(db, CARS_COL), copy);
    }
  }
});

$("#xlsxImport").addEventListener("change", onImportXLSX);

document.addEventListener("change", (e)=>{
  // فلاتر العرض فقط
  if(e.target.matches("#dBrand,#dTrim,#dShoot,#dEdit,#dAgenda")){
    FILTERS.brand = $("#dBrand").value;
    FILTERS.trim  = $("#dTrim").value;
    FILTERS.shoot = $("#dShoot").value;
    FILTERS.edit  = $("#dEdit").value;
    FILTERS.agenda= $("#dAgenda").value;
    renderFiltered();
  }
});
document.addEventListener("input", (e)=>{
  if(e.target.id==="dSearch"){ FILTERS.q = e.target.value; renderFiltered(); }
  if(e.target.id==="dColor"){ FILTERS.color = e.target.value; renderFiltered(); }
  if(e.target.id==="dIntColor"){ FILTERS.intColor = e.target.value; renderFiltered(); }
});

/* ---------- إضافة سيارة ---------- */
async function handleAdd(){
  if(!IS_ADMIN){ alert("الإضافة للأدمِن فقط"); return; }
  const brand = $("#iBrand").value || "";
  const model = $("#iModel").value || "";
  if(!brand){ alert("اختر العلامة"); return; }
  if(!model){ alert("اختر الموديل"); return; }

  const agendaDate  = ($("#iInAgenda").value==="نعم" && $("#iAgendaMonth").value && $("#iAgendaYear").value)
    ? `${$("#iAgendaMonth").value} ${$("#iAgendaYear").value}` : "";

  const payload = {
    brand,
    model,
    year: +($("#iYear").value || 2026),
    trim: $("#iTrim").value || "",
    color: ($("#iColor").value||"").trim(),
    intColor: ($("#iIntColor").value||"").trim(),
    shoot: $("#iShoot").value || "",
    edit: $("#iEdit").value || "",
    ctype: $("#iType").value || "",
    shootDate: $("#iShootDate").value || "",
    inAgenda: $("#iInAgenda").value || "لا",
    agendaDate,
    onSite: $("#iOnSite").value || "لا",
    siteLink: ($("#iOnSite").value==="نعم" ? ($("#iSiteLink").value||"") : ""),
    notes: $("#iNotes").value || "",
    createdAt: serverTimestamp(),
    createdBy: CURRENT_USER?.uid || null
  };

  try{
    await addDoc(collection(db, CARS_COL), payload);
    // تفريغ السريع:
    ["iModel","iColor","iIntColor","iNotes","iShootDate","iSiteLink"].forEach(id=>$("#"+id).value="");
    $("#iInAgenda").value = "لا"; $("#agendaFields").classList.add("hidden");
    $("#iOnSite").value = "لا"; $("#siteLinkField").classList.add("hidden");
  }catch(e){
    alert("فشل الإضافة: " + (e?.message||e));
  }
}

/* ---------- Firestore Live ---------- */
let unsub = null;
function listenCars(){
  if(unsub){ unsub(); unsub=null; }
  const qy = query(collection(db, CARS_COL), orderBy("createdAt","desc"));
  unsub = onSnapshot(qy, (snap)=>{
    const arr=[];
    snap.forEach(d=> arr.push({ __id:d.id, ...(d.data()||{}) }));
    LOCAL_ROWS = arr;
    renderEditorTable();
    renderFiltered();
  }, (err)=> alert("تعذر قراءة البيانات: "+(err?.message||err)));
}

/* ---------- XLSX I/O ---------- */
function xlsxHeaders(){ return ["brand","model","year","trim","color","intColor","shoot","edit","ctype","shootDate","inAgenda","agendaDate","onSite","siteLink","notes"]; }
function exportXLSX(){
  const headers = xlsxHeaders();
  const data = LOCAL_ROWS.map(r=>{
    const o={}; headers.forEach(h=>o[h]=r[h]??""); return o;
  });
  const ws = XLSX.utils.json_to_sheet(data, {header: headers});
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "MZJ Cars");
  XLSX.writeFile(wb, "mzj-production-tracker.xlsx");
}
function onImportXLSX(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async (evt)=>{
    try{
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, {type: "array"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:""});
      if(!json.length){ alert("الملف فارغ."); return; }
      const req = xlsxHeaders(); const cols = Object.keys(json[0]||{});
      const ok = req.every(h=>cols.includes(h));
      if(!ok){ alert("صيغة XLSX غير مطابقة. حمّل الـTemplate أعلاه."); return; }
      // أضف الصفوف إلى Firestore
      for(const row of json){
        const o={}; req.forEach(h=>o[h]=row[h]??"");
        o.year = +o.year || 2026;
        o.createdAt = serverTimestamp();
        o.createdBy = CURRENT_USER?.uid || null;
        await addDoc(collection(db, CARS_COL), o);
      }
      alert(`تم الاستيراد بنجاح.`);
      e.target.value="";
    }catch(err){
      alert("فشل الاستيراد: "+(err?.message||err));
    }
  };
  reader.readAsArrayBuffer(file);
}
function downloadTemplate(){
  const headers = xlsxHeaders();
  const sample = [{
    brand:"هيونداي", model:"سوناتا", year:2026, trim:"سمارت",
    color:"أبيض لؤلؤي", intColor:"أسود", shoot:"تم التصوير", edit:"جاري",
    ctype:"ريل", shootDate:"2025-10-12", inAgenda:"نعم", agendaDate:"أكتوبر 2025",
    onSite:"لا", siteLink:"", notes:"مثال: ينتظر فويس"
  }];
  const ws = XLSX.utils.json_to_sheet(sample, {header: headers});
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "mzj-quick-add-template.xlsx");
}

/* ---------- Auth Boot ---------- */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    CURRENT_USER = null; IS_ADMIN = false;
    banner.classList.remove("hidden");
    banner.textContent = "أنت غير مسجل دخول — عرض فقط.";
    editor.classList.add("hidden");
    btnAdd.disabled = true;
    // رغم ذلك نعرض البيانات العامة
    listenCars();
    return;
  }
  CURRENT_USER = user;
  const role = await loadRole(user.uid);
  IS_ADMIN = (role === "admin");

  roleBanner.textContent = `UID: ${user.uid.slice(0,6)} • Role: ${role} • Collection: ${CARS_COL}`;
  banner.classList.add("hidden");
  editor.classList.toggle("hidden", !IS_ADMIN);
  btnAdd.disabled = !IS_ADMIN;

  initAddFields();
  // فلاتر
  fillSelect($("#dBrand"), BRANDS, true, "الكل");
  fillSelect($("#dTrim"), TRIMS, true, "الكل");
  fillSelect($("#dShoot"), SHOOT_STATUS, true, "الكل");
  fillSelect($("#dEdit"), EDIT_STATUS, true, "الكل");
  fillSelect($("#dAgenda"), YESNO, true, "الكل");

  listenCars();
});

/* ---------- أول تشغيل لغير المسجلين ---------- */
if(!auth.currentUser){
  // ملء الفلاتر الأساسية
  fillSelect($("#dBrand"), BRANDS, true, "الكل");
  fillSelect($("#dTrim"), TRIMS, true, "الكل");
  fillSelect($("#dShoot"), SHOOT_STATUS, true, "الكل");
  fillSelect($("#dEdit"), EDIT_STATUS, true, "الكل");
  fillSelect($("#dAgenda"), YESNO, true, "الكل");
}
</script>
</body>
</html>
