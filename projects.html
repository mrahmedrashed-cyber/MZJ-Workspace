<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€” MZJ Workspace</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}
    a{color:inherit;text-decoration:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--brown);color:#fff;position:sticky;top:0;z-index:10;box-shadow:0 6px 20px rgba(62,36,32,.2)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{inline-size:28px;block-size:28px;border-radius:8px;background:linear-gradient(135deg,var(--beige),#d9b39a)}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a{padding:8px 12px;border-radius:10px;color:#fff}
    .nav a:hover{background:rgba(255,255,255,.14)}
    #bellDot{position:absolute; top:-4px; inline-size:18px; block-size:18px; background:#e11d48; color:#fff; font-size:12px; display:none; border-radius:999px; text-align:center; line-height:18px}
    .page{padding:18px;display:grid;gap:16px}
    .panel{background:#fff;border-radius:var(--radius);box-shadow:0 12px 30px rgba(62,36,32,.12)}
    .panel .head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .panel .body{padding:12px 14px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select,.input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .btn{padding:10px 12px;border-radius:12px;border:0;background:var(--brown);color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown)}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}

    /* Board */
    .board{display:grid;gap:14px;grid-template-columns:repeat(5,1fr)}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}
    .col{background:#fff;border-radius:14px;display:flex;flex-direction:column;min-height:240px}
    .col-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #f2e7df;background:#fff8ef;border-top-left-radius:14px;border-top-right-radius:14px}
    .col-title{color:var(--brown);font-weight:800}
    .col-body{padding:10px;display:grid;gap:10px}
    .dropzone{min-height:120px;border:2px dashed transparent;border-radius:12px;transition:.15s}
    .dropzone.drag{border-color:#e5d2c6;background:#fffaf5}

    /* Card */
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;box-shadow:0 8px 20px rgba(62,36,32,.06);cursor:grab}
    .card h4{margin:0 0 6px;color:var(--brown);font-size:16px}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#f7e9e0;color:var(--brown);display:inline-flex;align-items:center;gap:6px}
    .badge .dot{inline-size:8px;block-size:8px;border-radius:999px;background:#bc8f74}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .att{display:inline-flex;gap:6px;align-items:center;font-size:12px}
    .att a{color:var(--brown);text-decoration:underline}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:16px}
    .modal.show{display:grid}
    .sheet{background:#fff;border-radius:16px;max-width:820px;width:100%;box-shadow:0 30px 80px rgba(62,36,32,.25)}
    .sheet .head{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .sheet .body{padding:14px 16px;display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:800px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:8px 0 6px;font-weight:700;color:var(--brown)}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-family:inherit}
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:3px solid rgba(188,143,116,.25);border-color:var(--beige)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .color-dot{inline-size:14px;block-size:14px;border-radius:999px;border:1px solid #ddd}
    .footer{padding:16px 18px;color:#fff;background:linear-gradient(180deg,var(--brown),#2f1c19);margin-top:10px}
    .dropdown-menu{position:absolute;right:0;top:calc(100% + 6px);z-index:9999;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(62,36,32,.12);max-height:260px;overflow:auto;min-width:280px;display:none}
    .dropdown-menu.show{display:block}
    .dd-item{padding:10px 12px;border-bottom:1px solid #f3f3f3;cursor:pointer}
    .dd-item:hover{background:#fff8ef}

    /* Settings pill */
    .pill{padding:8px 12px;border-radius:999px;background:#fff8ef;border:1px solid #f2e7df;color:var(--brown);cursor:pointer}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-badge"></span>
      <strong>MZJ Workspace â€” Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</strong>
    </div>
    <nav class="nav">
      <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a href="projects.html">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
      <a href="members.html">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
      <a href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a href="javascript:void(0)" id="btnBell" style="position:relative">ğŸ””<span id="bellDot">0</span></a>
      <a href="javascript:void(0)" onclick="mzjLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </nav>
    <div id="bellMenu" class="dropdown-menu" style="right:12px; top:56px; min-width:320px;"></div>
  </header>

  <main class="page">
    <!-- Spaces & Controls -->
    <section class="panel">
      <div class="head">
        <div class="controls">
          <select id="spaceSelect" class="select"></select>

          <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ -->
          <input id="newGroupName" class="input" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ â€” Ù…Ø«Ø§Ù„: ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§" style="min-width:220px">
          <button class="btn secondary" id="btnAddGroup">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>

          <button class="btn secondary" id="btnNewSpace">Space Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn" id="btnNewTask">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="controls">
          <span class="pill" id="btnOpenDefaults">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</span>
          <span class="muted" id="who"></span>
        </div>
      </div>
      <div class="body">
        <div class="board" id="board"></div>
      </div>
    </section>
  </main>

  <!-- Task Create Modal -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="head">
        <strong>ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong>
        <button class="btn secondary" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="body">
        <div class="grid2">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ù„Ù†ØªØ±Ø§ 30 Ø«Ø§Ù†ÙŠØ©">
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="tDue" type="date">
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="tDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©â€¦"></textarea>

        <div class="grid2">
          <div style="position:relative">
            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input id="tAssigneeSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆâ€¦">
            <div id="assigneeMenu" class="dropdown-menu"></div>
            <div id="assigneeChip" class="chips"></div>
          </div>
          <div>
            <label>Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¶Ùˆ</label>
            <div class="row">
              <input id="tColor" type="color" value="#bc8f74" style="width:70px;height:44px;padding:4px">
              <span class="muted">ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙŠØ­ÙØ¸ Ù„Ù„Ø¹Ø¶Ùˆ</span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯ / Ø§Ù„Ø¬Ø±ÙˆØ¨</label>
            <select id="tGroup"></select>
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</label>
            <input id="tFiles" type="file" multiple>
          </div>
        </div>
      </div>
      <div class="footer" style="display:flex;justify-content:flex-end;gap:10px">
        <button class="btn secondary" id="btnCancelTask">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="btnSaveTask">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ</button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal (view / add attachments/links) -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="head">
        <strong id="dTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</strong>
        <button class="btn secondary" id="btnCloseDetail">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="body">
        <div class="grid2">
          <div>
            <div class="small muted">Ø§Ù„ÙˆØµÙ</div>
            <div id="dDesc" style="white-space:pre-wrap"></div>
          </div>
          <div>
            <div class="small muted">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
            <div id="dAssignee"></div>
            <div class="small muted" style="margin-top:8px">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
            <div id="dDue"></div>
            <div class="small muted" style="margin-top:8px">Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ø¹Ù…ÙˆØ¯</div>
            <div id="dStatus"></div>
          </div>
        </div>

        <hr/>

        <div class="grid2">
          <div>
            <div class="small muted">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</div>
            <div id="dAttachments" class="chips"></div>
          </div>
          <div>
            <div class="small muted">Ø±ÙˆØ§Ø¨Ø·</div>
            <div id="dLinks" class="chips"></div>
          </div>
        </div>

        <div id="dActions" style="margin-top:10px;display:none">
          <div class="grid2">
            <div>
              <label>Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª</label>
              <input id="dFiles" type="file" multiple>
              <button class="btn" id="btnUploadMore" style="margin-top:8px">Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
            </div>
            <div>
              <label>Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</label>
              <input id="dLinkTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ">
              <input id="dLinkUrl" class="input" placeholder="https://â€¦">
              <button class="btn secondary" id="btnAddLink" style="margin-top:8px">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
            </div>
          </div>
          <p class="hint">* ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù…ÙÙ† Ø£Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø· Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª/Ø±ÙˆØ§Ø¨Ø·.</p>
        </div>
      </div>
      <div class="footer"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></div>
    </div>
  </div>

  <footer class="footer"><small>Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚</small></footer>

  <!-- Firebase & App -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc,
      onSnapshot, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBVNNtGz9zGefzmNIosRrwgJGROsu5SNIw",
      authDomain: "mzj-workspace.firebaseapp.com",
      projectId: "mzj-workspace",
      storageBucket: "mzj-workspace.firebasestorage.app",
      appId: "1:1043260904465:web:8742de3a3ac727ae1e8db0"
    };
    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();
    const storage = getStorage();

    // Auth guard + Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
    let CURRENT_USER = null;
    let CURRENT_ROLE = 'member';
    window.mzjLogout = async ()=>{ await signOut(auth); location.href="login.html"; };
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      CURRENT_USER = user;
      const u = await getDoc(doc(db,"users", user.uid));
      const name = u.exists()? (u.data().name || user.email) : (user.email || 'Ù…Ø³ØªØ®Ø¯Ù…');
      CURRENT_ROLE = u.exists()? (u.data().role || 'member') : 'member';
      document.getElementById('who').textContent = `${name} â€” ${CURRENT_ROLE==='admin'?'Ù…Ø¯ÙŠØ±':'Ø¹Ø¶Ùˆ'}`;

      const isAdmin = (CURRENT_ROLE==='admin');
      ['btnNewSpace','btnAddGroup','newGroupName','btnOpenDefaults'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.style.display = isAdmin? '' : 'none';
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DEFAULT_FALLBACK = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨"];
    async function getDefaultColumns(){
      const s = await getDoc(doc(db,'settings','app'));
      return s.exists() && Array.isArray(s.data().defaultColumns) && s.data().defaultColumns.length
        ? s.data().defaultColumns
        : DEFAULT_FALLBACK;
    }
    async function setDefaultColumns(cols){
      await setDoc(doc(db,'settings','app'), { defaultColumns: cols }, { merge:true });
    }

    // Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø³Ø·Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø£Ø¯Ù…ÙÙ†)
    document.getElementById('btnOpenDefaults').addEventListener('click', async ()=>{
      if (CURRENT_ROLE!=='admin') return;
      const current = (await getDefaultColumns()).join(', ');
      const next = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„:', current);
      if (!next) return;
      const cols = next.split(',').map(s=>s.trim()).filter(Boolean);
      if (!cols.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø©!');
      await setDefaultColumns(cols);
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.\nØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù…Ø¹ Ø£ÙŠ Space Ø¬Ø¯ÙŠØ¯.');
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Spaces â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const spaceSelect     = document.getElementById('spaceSelect');
    const newGroupNameEl  = document.getElementById('newGroupName');
    const btnAddGroup     = document.getElementById('btnAddGroup');

    let CURRENT_SPACE = null;      // spaceId
    let SPACE_COLUMNS = DEFAULT_FALLBACK.slice();

    async function ensureDefaultSpace(){
      const snap = await getDocs(collection(db,'spaces'));
      if (snap.empty){
        const now = new Date();
        const label = now.toLocaleDateString('ar-SA',{ year:'numeric', month:'long' });
        const defaults = await getDefaultColumns();
        const ref = await addDoc(collection(db,'spaces'), {
          name: label, columns: defaults, createdAt: serverTimestamp(), active:true
        });
        return ref.id;
      } else {
        let firstId=null, firstTs=0;
        snap.forEach(d=>{
          const ts = d.data()?.createdAt?.seconds || 0;
          if (ts>=firstTs){ firstTs=ts; firstId=d.id; }
        });
        return firstId;
      }
    }

    function fillSpaceDropdown(list, selectedId){
      spaceSelect.innerHTML='';
      list.forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s.id; opt.textContent=s.name; spaceSelect.appendChild(opt);
      });
      if (selectedId) spaceSelect.value = selectedId;
    }

    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù€Spaces
    onSnapshot(collection(db,'spaces'), snap=>{
      const items=[];
      snap.forEach(d=> items.push({id:d.id, ...(d.data()||{})}));
      items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      fillSpaceDropdown(items, CURRENT_SPACE);
      if (!CURRENT_SPACE && items.length){ 
        CURRENT_SPACE = items[0].id; 
        SPACE_COLUMNS = items[0].columns?.length ? items[0].columns : DEFAULT_FALLBACK; 
        renderBoardSkeleton(); listenTasks(); fillGroupSelect();
      }
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Space Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø£Ø¯Ù…ÙÙ†) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ settings
    document.getElementById('btnNewSpace').addEventListener('click', async ()=>{
      if (CURRENT_ROLE!=='admin') return;
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù€Space (Ù…Ø«Ø§Ù„: Ù†ÙˆÙÙ…Ø¨Ø± 2025):');
      if (!name) return;
      try{
        const defaults = await getDefaultColumns();
        const ref = await addDoc(collection(db,'spaces'), {
          name, columns: defaults, createdAt: serverTimestamp(), active:true
        });
        CURRENT_SPACE = ref.id; SPACE_COLUMNS = defaults.slice();
        renderBoardSkeleton(); listenTasks(true); fillGroupSelect();
      }catch(e){
        alert('âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Space ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…ÙÙ†.');
      }
    });

    // ØªØºÙŠÙŠØ± Ø§Ù„Ù€Space
    spaceSelect.addEventListener('change', async (e)=>{
      CURRENT_SPACE = e.target.value;
      const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
      SPACE_COLUMNS = d.exists()? (d.data().columns?.length ? d.data().columns : DEFAULT_FALLBACK) : DEFAULT_FALLBACK;
      renderBoardSkeleton(); listenTasks(true); fillGroupSelect();
    });

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø£Ø¯Ù…ÙÙ†)
    btnAddGroup.addEventListener('click', async ()=>{
      if (CURRENT_ROLE!=='admin') return;
      if (!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ù‹Ø§');
      const name = (newGroupNameEl.value || 'ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§').trim();
      if (!name) return;
      if (SPACE_COLUMNS.includes(name)) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
      try{
        const cols = SPACE_COLUMNS.concat([name]);
        await updateDoc(doc(db,'spaces', CURRENT_SPACE), { columns: cols });
        SPACE_COLUMNS = cols;
        newGroupNameEl.value = '';
        renderBoardSkeleton(); renderTasks(); fillGroupSelect();
      }catch(e){
        alert('âš ï¸ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ ØªØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…ÙÙ†.');
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Users & Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let USERS = []; // {uid,name,role,color}
    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS=[]; snap.forEach(d=>{
        const u=d.data()||{};
        USERS.push({ uid:d.id, name:u.name||d.id.slice(0,6), role:u.role||'member', color:u.color||'#bc8f74' });
      });
    }
    await loadUsers();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Task Create Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const taskModal = document.getElementById('taskModal');
    const btnNewTask = document.getElementById('btnNewTask');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancelTask = document.getElementById('btnCancelTask');
    const btnSaveTask = document.getElementById('btnSaveTask');

    const tName = document.getElementById('tName');
    const tDesc = document.getElementById('tDesc');
    const tDue  = document.getElementById('tDue');
    const tFiles= document.getElementById('tFiles');
    const tAssigneeSearch = document.getElementById('tAssigneeSearch');
    const assigneeMenu = document.getElementById('assigneeMenu');
    const assigneeChip = document.getElementById('assigneeChip');
    const tColor = document.getElementById('tColor');
    const tGroup = document.getElementById('tGroup');

    let SELECTED_ASSIGNEE = null; // {uid,name,color}

    function fillGroupSelect(){
      tGroup.innerHTML='';
      (SPACE_COLUMNS||[]).forEach(col=>{
        const opt=document.createElement('option');
        opt.value=col; opt.textContent=col;
        tGroup.appendChild(opt);
      });
    }

    function openCreate(){ taskModal.classList.add('show'); fillGroupSelect(); }
    function closeCreate(){ taskModal.classList.remove('show'); resetCreateForm(); }

    btnNewTask.addEventListener('click', ()=> openCreate());
    btnCloseModal.addEventListener('click', ()=> closeCreate());
    btnCancelTask.addEventListener('click', ()=> closeCreate());
    taskModal.addEventListener('click', (e)=>{ if(e.target===taskModal) closeCreate(); });

    function resetCreateForm(){
      tName.value=''; tDesc.value=''; tDue.value=''; tFiles.value='';
      tAssigneeSearch.value=''; assigneeMenu.innerHTML=''; assigneeMenu.classList.remove('show');
      assigneeChip.innerHTML=''; SELECTED_ASSIGNEE=null; tColor.value='#bc8f74';
      fillGroupSelect();
    }

    function renderAssigneeMenu(filter){
      const f=(filter||'').toLowerCase();
      assigneeMenu.innerHTML='';
      USERS.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const it=document.createElement('div');
        it.className='dd-item';
        it.innerHTML = `<span class="row"><span class="color-dot" style="background:${u.color||'#bc8f74'}"></span> ${u.name} <span class="muted">(${u.role})</span></span>`;
        it.onclick=()=> selectAssignee(u);
        assigneeMenu.appendChild(it);
      });
      assigneeMenu.classList.add('show');
    }
    function selectAssignee(u){
      SELECTED_ASSIGNEE = { ...u };
      assigneeChip.innerHTML = `<span class="badge"><span class="dot" style="background:${u.color}"></span>${u.name}</span>`;
      tColor.value = u.color || '#bc8f74';
      assigneeMenu.classList.remove('show');
    }
    tAssigneeSearch.addEventListener('input', (e)=>{
      renderAssigneeMenu(e.target.value.trim());
    });
    tAssigneeSearch.addEventListener('focus', ()=>{
      renderAssigneeMenu(tAssigneeSearch.value);
    });
    document.addEventListener('click', (e)=>{
      if (!assigneeMenu.contains(e.target) && e.target!==tAssigneeSearch) assigneeMenu.classList.remove('show');
    });

    async function uploadAttachmentsFor(taskId, inputEl){
      const files = Array.from(inputEl.files||[]);
      const out = [];
      for (const file of files){
        const path = `attachments/${taskId}/${Date.now()}_${file.name}`;
        const ref = sRef(storage, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        out.push({ name:file.name, url, path });
      }
      return out;
    }

    btnSaveTask.addEventListener('click', async ()=>{
      if (!CURRENT_SPACE) return alert('Ø§Ø®ØªØ± Space Ø£ÙˆÙ„Ø§Ù‹');
      const name = tName.value.trim();
      if (!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø³Ùƒ');
      const due = tDue.value || null;
      const description = tDesc.value || null;
      const assigneeUid = SELECTED_ASSIGNEE?.uid || null;
      const assigneeName= SELECTED_ASSIGNEE?.name || null;
      const color = (document.getElementById('tColor').value || '#bc8f74').trim();
      const status = tGroup.value || (SPACE_COLUMNS[0] || DEFAULT_FALLBACK[0]);

      try{
        if (assigneeUid){
          await setDoc(doc(db,'users', assigneeUid), { color }, { merge:true });
          const idx = USERS.findIndex(u=>u.uid===assigneeUid);
          if (idx>-1) USERS[idx].color=color;
        }

        const payload = {
          spaceId: CURRENT_SPACE,
          name, description, due,
          status,
          assignee: assigneeUid ? { uid: assigneeUid, name: assigneeName, color } : null,
          attachments: [],
          links: [],
          createdBy: CURRENT_USER?.uid || null,
          createdAt: serverTimestamp(),
          active:true
        };
        const ref = await addDoc(collection(db,'tasks'), payload);
        const atts = await uploadAttachmentsFor(ref.id, tFiles);
        if (atts.length){
          await updateDoc(doc(db,'tasks', ref.id), { attachments: atts });
        }
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ');
        closeCreate();
      }catch(e){
        console.error(e);
        if (e?.code==='permission-denied') alert('âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.');
        else alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+e.message);
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Board & Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const board = document.getElementById('board');
    let TASKS = []; // cache
    let unsubTasks = null;

    function renderBoardSkeleton(){
      board.innerHTML='';
      (SPACE_COLUMNS||[]).forEach(col=>{
        const sec=document.createElement('section');
        sec.className='col';
        sec.dataset.status=col;
        sec.innerHTML=`
          <div class="col-head">
            <span class="col-title">${col}</span>
          </div>
          <div class="col-body">
            <div class="dropzone" data-zone="${col}"></div>
          </div>`;
        board.appendChild(sec);
      });

      // DnD handlers
      board.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag'); });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
        zone.addEventListener('drop', async (e)=>{
          e.preventDefault(); zone.classList.remove('drag');
          const taskId = e.dataTransfer.getData('text/plain');
          const newStatus = zone.dataset.zone;
          try{
            await updateDoc(doc(db,'tasks', taskId), { status:newStatus });
          }catch(err){
            console.error(err);
            alert('âš ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§ÙÙŠØ©.');
          }
        });
      });
    }

    function openDetail(task){
      const modal = document.getElementById('detailModal');
      const isAssignee = task.assignee?.uid === CURRENT_USER?.uid;
      const canContribute = (CURRENT_ROLE==='admin' || isAssignee);

      document.getElementById('dTitle').textContent = task.name || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
      document.getElementById('dDesc').textContent  = task.description || 'â€”';
      document.getElementById('dAssignee').innerHTML = task.assignee
        ? `<span class="badge"><span class="dot" style="background:${task.assignee.color||'#bc8f74'}"></span>${task.assignee.name||''}</span>`
        : '<span class="muted">â€”</span>';
      document.getElementById('dDue').textContent    = task.due || 'â€”';
      document.getElementById('dStatus').textContent = task.status || 'â€”';

      // attachments
      const attEl = document.getElementById('dAttachments');
      attEl.innerHTML='';
      (task.attachments||[]).forEach(a=>{
        const chip=document.createElement('span');
        chip.className='badge';
        chip.innerHTML=`ğŸ“ <a href="${a.url}" target="_blank" rel="noopener">${a.name}</a>`;
        attEl.appendChild(chip);
      });

      // links
      const linksEl = document.getElementById('dLinks');
      linksEl.innerHTML='';
      (task.links||[]).forEach(l=>{
        const chip=document.createElement('span');
        chip.className='badge';
        chip.innerHTML=`ğŸ”— <a href="${l.url}" target="_blank" rel="noopener">${l.title||l.url}</a>`;
        linksEl.appendChild(chip);
      });

      // actions (only admin or assignee)
      const actions = document.getElementById('dActions');
      actions.style.display = canContribute ? 'block' : 'none';

      // bind buttons
      const fileInput = document.getElementById('dFiles');
      const btnUpload = document.getElementById('btnUploadMore');
      const btnAddLink= document.getElementById('btnAddLink');
      const linkTitle = document.getElementById('dLinkTitle');
      const linkUrl   = document.getElementById('dLinkUrl');

      btnUpload.onclick = async ()=>{
        try{
          const atts = await uploadAttachmentsFor(task.id, fileInput);
          if (atts.length){
            const next = (task.attachments||[]).concat(atts);
            await updateDoc(doc(db,'tasks', task.id), { attachments: next });
            fileInput.value='';
          }
        }catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª: '+e.message); }
      };
      btnAddLink.onclick = async ()=>{
        const title = (linkTitle.value||'Ø±Ø§Ø¨Ø·').trim();
        const url   = (linkUrl.value||'').trim();
        if (!url) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø§Ø¨Ø·');
        try{
          const next = (task.links||[]).concat([{ title, url }]);
          await updateDoc(doc(db,'tasks', task.id), { links: next });
          linkTitle.value=''; linkUrl.value='';
        }catch(e){ alert('âš ï¸ ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø·: '+e.message); }
      };

      modal.classList.add('show');
    }
    document.getElementById('btnCloseDetail').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
    document.getElementById('detailModal').addEventListener('click', (e)=>{
      if (e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('show');
    });

    function renderTasks(){
      board.querySelectorAll('.dropzone').forEach(z=> z.innerHTML='');

      const byStatus = {};
      (SPACE_COLUMNS||[]).forEach(s=> byStatus[s]=[]);
      TASKS.forEach(t=>{
        (byStatus[t.status]||(byStatus[t.status]=[])).push(t);
      });
      (SPACE_COLUMNS||[]).forEach(status=>{
        const zone = board.querySelector(`.dropzone[data-zone="${CSS.escape(status)}"]`);
        const list = byStatus[status]||[];
        list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        list.forEach(t=>{
          const card=document.createElement('article');
          card.className='card'; card.draggable=true; card.dataset.id=t.id;
          const ass = t.assignee;
          const attCount = (t.attachments||[]).length;
          card.innerHTML=`
            <h4>${t.name||'-'}</h4>
            <div class="row">
              ${ass ? `<span class="badge"><span class="dot" style="background:${ass.color||'#bc8f74'}"></span>${ass.name||''}</span>` : ''}
              ${t.due ? `<span class="small">ğŸ“… ${t.due}</span>`:''}
              ${attCount? `<span class="small att">ğŸ“ ${attCount} Ù…Ø±ÙÙ‚</span>`:''}
            </div>
            ${t.description? `<div class="small" style="margin-top:6px">${t.description}</div>`:''}
          `;
          card.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', t.id); });
          card.addEventListener('click', ()=>{
            const fresh = TASKS.find(x=>x.id===t.id);
            if (fresh) openDetail(fresh);
          });
          zone?.appendChild(card);
        });
      });
    }

    function listenTasks(){
      if (unsubTasks) { unsubTasks(); unsubTasks=null; }
      if (!CURRENT_SPACE) return;
      const qy = query(collection(db,'tasks'), where('spaceId','==', CURRENT_SPACE));
      unsubTasks = onSnapshot(qy, (snap)=>{
        TASKS=[]; snap.forEach(d=> TASKS.push({ id:d.id, ...(d.data()||{}) }));
        renderTasks();
      }, (err)=>{
        console.error(err);
        alert('âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ†.');
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Notifications Bell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const bellBtn  = document.getElementById('btnBell');
    const bellDot  = document.getElementById('bellDot');
    const bellMenu = document.getElementById('bellMenu');

    function renderNotifs(list){
      bellMenu.innerHTML='';
      if (!list.length){ bellMenu.innerHTML='<div class="dd-item">Ù„Ø§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>'; return; }
      list.forEach(n=>{
        const it=document.createElement('div');
        const kind = n.type==='mention' ? 'ØªÙ… Ø°ÙƒØ±Ùƒ' : 'ØªÙ… ØªØ¹ÙŠÙŠÙ†Ùƒ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹';
        it.className='dd-item';
        it.innerHTML=`<div><strong>${kind}</strong> â€” ${n.projectName||'-'}</div><div class="muted" style="font-size:12px">${n.id}</div>`;
        it.onclick=async ()=>{
          try{ await updateDoc(doc(db,'notifications', n.id), { read:true }); }catch{}
          bellMenu.classList.remove('show');
        };
        bellMenu.appendChild(it);
      });
    }
    onAuthStateChanged(auth, (user)=>{
      if (!user) return;
      const qn = query(collection(db,'notifications'),
        where('toUid','==', user.uid),
        where('read','==', false),
        );
      onSnapshot(qn,(snap)=>{
        const list=[]; snap.forEach(d=> list.push({ id:d.id, ...(d.data()||{}) }));
        bellDot.style.display = list.length ? 'inline-block' : 'none';
        bellDot.textContent = list.length || '0';
        renderNotifs(list);
      });
    });
    bellBtn?.addEventListener('click', ()=> bellMenu.classList.toggle('show'));
    document.addEventListener('click', (e)=>{
      if (!bellMenu.contains(e.target) && e.target!==bellBtn && !bellBtn.contains(e.target)) bellMenu.classList.remove('show');
    });

    // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
    (async ()=>{
      if (!CURRENT_SPACE){
        CURRENT_SPACE = await ensureDefaultSpace();
        const d = await getDoc(doc(db,'spaces', CURRENT_SPACE));
        SPACE_COLUMNS = d.exists()? (d.data().columns?.length ? d.data().columns : await getDefaultColumns()) : await getDefaultColumns();
        renderBoardSkeleton(); listenTasks(); fillGroupSelect();
      }
    })();
  </script>
</body>
</html>
